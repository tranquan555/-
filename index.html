<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Hiện Đại</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" integrity="sha512-vsweODo68mUuH+gxjNWzKWykValMhawjkZXtwiDAxPKi3MfSq+GlvM9m8xCkKMp9i6ZrmtYU3Nz+XYdxSX6rlg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --bg-color: #121212;
            --text-color: #ffffff;
            --sidebar-bg-color: #212121;
            --sidebar-item-hover-bg: rgba(255, 255, 255, 0.1);
            --chat-header-bg-color: #212121;
            --message-bubble-ai-bg: #424242;
            --message-bubble-user-bg: #3498db;
            --input-area-bg-color: #212121;
            --input-border-color: #555;
            --input-bg-color: #333;
            --modal-backdrop-color: rgba(0,0,0,0.8);
            --modal-content-bg-color: #333;
            --modal-border-color: #555;
            --button-primary-bg-color: #3498db;
            --button-primary-hover-bg-color: #2980b9;
            --code-block-bg-color: #272822;
            --confirmation-color: #4CAF50;
            --error-color: #F44336;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            transition: background-color 0.3s, color 0.3s;
            height: 100vh; /* Ensure full viewport height */
            overflow: hidden; /* Prevent body scroll */
        }

        .sidebar {
            width: 250px;
            background-color: var(--sidebar-bg-color);
            color: white;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease-in-out, background-color 0.3s;
            transform: translateX(0);
            z-index: 1000;
            height: 100vh;
            overflow-y: auto;
            position: fixed;
            top: 0;
            left: 0;
        }

        .sidebar.hidden {
            transform: translateX(-250px);
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .sidebar-header h3 {
            margin: 0;
            font-size: 1.5em;
        }

        .menu-icon {
            font-size: 1.5em;
            cursor: pointer;
            color: white;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-menu li {
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-menu li:last-child {
            border-bottom: none;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .sidebar-menu a:hover, .sidebar-menu a.active {
            background-color: var(--sidebar-item-hover-bg);
        }

        .sidebar-menu a i {
            margin-right: 8px;
        }

        .submenu {
            margin-left: 25px; /* Increased indent */
            padding-left: 10px;
            border-left: 2px solid rgba(255, 255, 255, 0.2);
            display: none; /* Initially hidden */
             list-style: none; /* Remove bullets */
        }

        .submenu.active {
            display: block;
        }

        .submenu li{
             padding: 0;
             border: none;
        }

        .submenu a {
            padding: 5px 15px;
            font-size: 0.9em;
            display: block;
        }
        .submenu a:hover, .submenu a.active {
            background-color: var(--sidebar-item-hover-bg);
        }
          .history-search {
            padding: 0 0 10px; /* Reduced padding */
        }

        .history-search input[type="text"] {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid var(--input-border-color);
            background-color: var(--input-bg-color);
            color: white;
        }
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0; /* Reduced padding */

        }

        .history-item:hover {
            background-color: var(--sidebar-item-hover-bg);
        }

        .history-item button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1em;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .history-item button:hover {
            opacity: 1;
        }

        .settings-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .settings-option label {
            margin-right: 10px;
        }

        .settings-option select, .settings-option input[type="color"], .settings-option input[type="checkbox"], .settings-option input[type="text"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid var(--input-border-color);
            background-color: var(--input-bg-color);
            color: white;
        }

        .settings-option input[type="color"] {
            width: 30px;
            height: 30px;
            padding: 0;
            cursor: pointer;
        }

        .settings-option input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        .settings-option input[type="color"]::-webkit-color-swatch { border: 1px solid #555; border-radius: 3px; }
        .settings-option input[type="color"]::-moz-color-swatch-wrapper { padding: 0; }
        .settings-option input[type="color"]::-moz-color-swatch { border: 1px solid #555; border-radius: 3px; }

        .settings-buttons {
            margin-top: 20px;
            text-align: right;
        }

        .settings-buttons button {
             background-color: var(--button-primary-bg-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
            transition: background-color 0.3s ease;
        }

        .settings-buttons button:hover {
            background-color: var(--button-primary-hover-bg-color);
        }

        .chat-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            margin-left: 250px; /* Add margin to prevent overlap with sidebar */
        }

        .chat-header {
             background-color: var(--chat-header-bg-color);
            padding: 15px 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            z-index: 999;
            transition: background-color 0.3s;
        }

        .chat-header h2 {
            margin: 0;
            font-size: 1.3em;
        }

        .message-area {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            background-color: var(--chat-bg-color);
            transition: background-color 0.3s;
            position: relative;
            aria-live="polite";
        }

        .loading-spinner {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--button-primary-bg-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .loading-spinner.show {
            opacity: 1;
            visibility: visible;
        }

        @keyframes spin {
            0% { transform: rotate(0deg) translateX(-50%); }
            100% { transform: rotate(360deg) translateX(-50%); }
        }

        .message-bubble {
           background-color: var(--message-bubble-ai-bg);
            color: #ffffff;
            border-radius: 10px;
            padding: 10px 15px;
            margin-bottom: 10px;
            max-width: 70%;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            overflow-wrap: break-word; /* Handles long words */
            hyphens: auto;  /*  hyphenation */
        }

        .message-bubble.user {
            background-color: var(--message-bubble-user-bg);
            color: white;
            align-self: flex-end;
        }

        .input-area {
            background-color: var(--input-area-bg-color);
            padding: 15px 20px;
            border-top: 1px solid #333;
            display: flex;
            align-items: center;
            transition: background-color 0.3s;
            position: sticky; /* Make input area sticky */
            bottom: 0; /* Stick to the bottom */
            z-index: 100; /* Ensure it's above messages */
        }

        .input-area textarea {
            flex-grow: 1;
            border: 1px solid var(--input-border-color);
            border-radius: 5px;
            padding: 10px;
            resize: none;
            font-size: 1em;
            height: 40px;
            overflow-y: auto;
            background-color: var(--input-bg-color);
            color: white;
            transition: border-color 0.3s, background-color 0.3s, color 0.3s;
        }
        .input-area textarea:hover, .input-area textarea:focus {
            border-color: #aaa;
            outline: none;
            box-shadow: 0 0 5px rgba(170,170,170,0.3);
        }

        .input-area button, .input-area .attach-button {
            background-color: var(--button-primary-bg-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
            transition: background-color 0.3s ease;
            font-size: 1em;
            height: auto;
        }

        .input-area button:hover, .input-area button:focus, .input-area .attach-button:hover, .input-area .attach-button:focus {
            background-color: var(--button-primary-hover-bg-color);
            outline: none;
        }

        .input-area .attach-button {
            background-color: transparent;
            color: #ccc;
            padding: 10px;
            margin-left: 5px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
        }
        .input-area .attach-button input[type="file"] {
            display: none; /* Hide the actual file input */
        }

        .input-area .attach-button:hover {
            background-color: #444;
            color: #ddd;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: var(--modal-backdrop-color);
            role="dialog";
            aria-modal="true";
        }

        .modal-content {
             background-color: var(--modal-content-bg-color);
            margin: 15% auto;
            padding: 20px;
            border: 1px solid var(--modal-border-color);
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.4);
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close-button:hover,
        .close-button:focus {
            color: white;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-header {
            padding-bottom: 10px;
            border-bottom: 1px solid var(--modal-border-color);
            margin-bottom: 15px;
        }

        .modal-body {
            padding: 10px 0;
        }

        .modal-body input[type="text"] {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid var(--modal-border-color);
            border-radius: 5px;
            background-color: #444;
            color: white;
        }

        .modal-body input[type="text"]:focus {
            outline-color: var(--button-primary-bg-color);
        }

        .modal-footer {
            padding-top: 15px;
            border-top: 1px solid var(--modal-border-color);
            text-align: right;
        }

        .modal-footer button {
            background-color: var(--button-primary-bg-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
            transition: background-color 0.3s ease;
        }

        .modal-footer button:hover {
            background-color: var(--button-primary-hover-bg-color);
        }

        .icon {
            display: inline-block;
            width: 1em;
            height: 1em;
            stroke-width: 0;
            stroke: currentColor;
            fill: currentColor;
        }

        pre[class*="language-"] {
            background-color: var(--code-block-bg-color) !important;
            color: #f8f8f2;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            overflow-x: auto;
            position: relative;
        }

        code[class*="language-"] {
            color: inherit;
            background: none;
            font-size: 0.9em;
        }

        .copy-code-button {
            position: absolute;
            top: 0.5em;
            right: 0.5em;
            padding: 0.5em;
            background-color: var(--button-primary-bg-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            opacity: 0.8;
            transition: opacity 0.3s;
        }

        .copy-code-button:hover {
            opacity: 1;
        }

        .confirmation-message, .error-message {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 10px 20px;
            border-radius: 5px;
            color: white;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s, visibility 0.5s;
            z-index: 1100;
            aria-live="assertive";
        }

        .confirmation-message.show, .error-message.show {
            opacity: 1;
            visibility: visible;
        }

        .confirmation-message.show {
            background-color: var(--confirmation-color);
        }

        .error-message.show {
            background-color: var(--error-color);
        }

        .copied-message {
             position: absolute;
            top: 0.5em;
            right: 4em;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.5em 0.8em;
            border-radius: 5px;
            font-size: 0.8em;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .copied-message.show {
            opacity: 1;
            visibility: visible;
        }

        @media (max-width: 768px) {
           .sidebar {
                width: 200px;
                transform: translateX(-200px);
            }
            .sidebar.hidden {
                transform: translateX(0);
            }
            .chat-container {
                margin-left: 0; /* Remove margin on smaller screens */
            }
            .chat-header h2 {
                font-size: 1.1em;
            }
            .message-area {
                padding: 15px;
            }
            .input-area {
                padding: 10px 15px;
            }
            .input-area button, .input-area .attach-button {
                padding: 8px 12px;
                font-size: 0.9em;
            }
        }

        @media (max-width: 480px) {
            .chat-header h2 {
                font-size: 1em;
            }
            .message-bubble {
                max-width: 85%;
                padding: 8px 12px;
                font-size: 0.95em;
            }
            .input-area textarea {
                font-size: 0.95em;
                height: 30px;
            }
            .sidebar-header h3 {
                font-size: 1.3em;
            }
            .sidebar-menu a {
                padding: 6px 10px;
                font-size: 0.95em;
            }
        }
    </style>
</head>
<body role="document" onclick="handleBodyClick(event)">
    <aside class="sidebar" aria-label="Navigation menu">
        <div class="sidebar-header">
            <h3>Menu</h3>
            <i class="fas fa-times menu-icon" onclick="toggleSidebar()"></i>
        </div>
        <ul class="sidebar-menu">
            <li><a href="#" onclick="newChat()"><i class="fas fa-plus"></i>Đoạn chat mới</a></li>
            <li><a href="#" onclick="openSaveHistoryModal()"><i class="fas fa-save"></i>Lưu lịch sử này</a></li>
            <li>
                <a href="#" onclick="toggleSubmenu('history-submenu', event)"><i class="fas fa-history"></i>Lịch sử đã lưu</a>
                <ul class="submenu" id="history-submenu">
                    <li class="history-search">
                        <input type="text" id="historySearchInput" placeholder="Tìm kiếm lịch sử..." aria-label="Tìm kiếm lịch sử chat đã lưu">
                    </li>
                </ul>
            </li>
            <li>
                <a href="#" onclick="toggleSubmenu('settings-submenu', event)"><i class="fas fa-cog"></i>Cài đặt</a>
                <ul class="submenu" id="settings-submenu">
                    <li class="settings-option">
                        <label for="api-key">API Key</label>
                        <input type="text" id="api-key" placeholder="Nhập API Key của bạn" aria-label="Nhập API Key">
                    </li>
                    <li class="settings-option">
                        <label for="auto-save">Tự động lưu</label>
                        <input type="checkbox" id="auto-save">
                    </li>
                    <li class="settings-option">
                        <label for="history-name-first-question">Tên lịch sử là câu hỏi đầu</label>
                        <input type="checkbox" id="history-name-first-question">
                    </li>
                    <li class="settings-option">
                        <label for="theme-select">Giao diện code</label>
                        <select id="theme-select" aria-label="Chọn giao diện màu cho code">
                            <option value="prism-tomorrow">Tomorrow</option>
                            <option value="prism">Default</option>
                            <option value="prism-okaidia">Okaidia</option>
                            <option value="prism-solarizeddark">Solarized Dark</option>
                            <option value="prism-twilight">Twilight</option>
                        </select>
                    </li>
                    <li class="settings-option">
                        <label for="bg-color">Màu nền</label>
                        <input type="color" id="bg-color" value="#121212">
                    </li>
                    <li class="settings-option">
                        <label for="text-color">Màu chữ</label>
                        <input type="color" id="text-color" value="#ffffff">
                    </li>
                     <li class="settings-option">
                        <label for="chat-bg-color">Màu nền hộp chat</label>
                        <input type="color" id="chat-bg-color" value="#212121" aria-label="Chọn màu nền khu vực chat">
                    </li>
                    <li class="settings-buttons">
                        <button onclick="saveSettings()">Lưu</button>
                        <button onclick="undoSettings()">Hoàn tác</button>
                    </li>
                </ul>
            </li>
        </ul>
    </aside>

    <div class="chat-container">
        <header class="chat-header">
            <i class="fas fa-bars menu-icon" onclick="toggleSidebar()" aria-label="Mở/đóng menu"></i>
            <h2>AI Chat</h2>
        </header>
        <main id="message-area" class="message-area">
            <div class="loading-spinner" id="loading-spinner"></div>
        </main>
        <form class="input-area" role="form">
             <label for="file-upload" class="attach-button">
                <i class="fas fa-paperclip"></i>
                <input type="file" id="file-upload" accept="*" onchange="handleFileUpload(event)"/>
            </label>
            <textarea id="message-input" placeholder="Nhập tin nhắn..." aria-label="Nhập tin nhắn"></textarea>
            <button type="button" onclick="sendMessage()" aria-label="Gửi tin nhắn">Gửi</button>
        </form>
    </div>

    <div id="saveHistoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-button" onclick="closeSaveHistoryModal()">×</span>
                <h2>Lưu lịch sử</h2>
            </div>
            <div class="modal-body">
                <input type="text" id="historyNameInput" placeholder="Nhập tên lịch sử">
            </div>
            <div class="modal-footer">
                <button type="button" onclick="saveHistory()">Lưu</button>
                <button type="button" onclick="closeSaveHistoryModal()">Hủy</button>
            </div>
        </div>
    </div>

    <div class="copied-message" id="copied-confirmation">Đã sao chép!</div>
    <div class="confirmation-message" id="action-confirmation"></div>
    <div class="error-message" id="api-error-message"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-NlKI+oQZ+gGt9ggTpO+LgQo9oWdO2h5p/8lr/VCdGDTvKXZMq+gIHv5voW9e8GlS/g5Wjyxm3CqjG7W7Vf6y+g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js" integrity="sha512-jLCHmr5IU189O2jGuQj+3Tyzu1xoJsOO3CcWueUMrRcJ9iWl2uV09Szwvjy9VyttAr6Q1l7Tqsj+z82FTz1zvg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>
        const sidebar = document.querySelector('.sidebar');
        const messageArea = document.getElementById('message-area');
        const messageInput = document.getElementById('message-input');
        const historySubmenu = document.getElementById('history-submenu');
        const settingsSubmenu = document.getElementById('settings-submenu');
        const saveHistoryModal = document.getElementById('saveHistoryModal');
        const historyNameInput = document.getElementById('historyNameInput');
        const copiedConfirmation = document.getElementById('copied-confirmation');
        const themeSelect = document.getElementById('theme-select');
        const loadingSpinner = document.getElementById('loading-spinner');
        const actionConfirmation = document.getElementById('action-confirmation');
        const apiErrorMessage = document.getElementById('api-error-message');
        const historySearchInput = document.getElementById('historySearchInput');

        let activeSubmenu = null;
        let chatHistory = [];
        let savedHistories = JSON.parse(localStorage.getItem('chatHistories')) || {};
        let settings = JSON.parse(localStorage.getItem('chatSettings')) || {
            apiKey: '', // Initialize API key
            autoSaveHistory: false,
            historyNameFirstQuestion: false,
            theme: 'prism-tomorrow',
            bgColor: '#121212',
            textColor: '#ffffff',
            chatBgColor: '#212121'
        };
        let filteredHistories = { ...savedHistories };

        // Apply initial settings
        applySettings();
        loadSavedHistoryList();
        messageInput.focus();

       function toggleSidebar() {
            sidebar.classList.toggle('hidden');
        }

        function toggleSubmenu(submenuId, event) {
            event.preventDefault();
            const submenu = document.getElementById(submenuId);
            if (activeSubmenu && activeSubmenu !== submenu) {
                activeSubmenu.classList.remove('active');
            }
            submenu.classList.toggle('active');
            activeSubmenu = submenu.classList.contains('active') ? submenu : null;

            if (submenuId === 'history-submenu' && submenu.classList.contains('active')) {
                historySearchInput.focus();
            }
        }

        function handleBodyClick(event) {
            if (activeSubmenu && !sidebar.contains(event.target) && !event.target.closest('.sidebar-menu li a')) {
                activeSubmenu.classList.remove('active');
                activeSubmenu = null;
            }
        }

        function newChat() {
            chatHistory = [];
            messageArea.innerHTML = `<div class="loading-spinner" id="loading-spinner"></div>`;
            loadingSpinner = document.getElementById('loading-spinner'); // Re-assign
            messageInput.value = '';
            messageInput.focus();
            loadSavedHistoryList();
        }


        function sendMessage() {
            const messageText = messageInput.value.trim();
            if (messageText) {
                addUserMessage(messageText);
                messageInput.value = '';
                messageInput.focus();
                showLoading();
                generateAIResponse                generateAIResponse(messageText)
                    .then(aiResponse => {
                        addAIMessage(aiResponse);
                    })
                    .catch(error => {
                        console.error('Lỗi API:', error);
                        displayErrorMessage(error.message || 'Đã xảy ra lỗi khi giao tiếp với AI. Vui lòng thử lại.');
                        addAIMessageBubbleOnError('Đã xảy ra lỗi khi nhận phản hồi từ AI.');
                    })
                    .finally(() => {
                        hideLoading();
                    });
            }
        }

        function addUserMessage(message) {
            chatHistory.push({ sender: 'user', text: message });
            displayMessage('user', message);
        }

        function addAIMessage(message) {
            chatHistory.push({ sender: 'ai', text: message });
            displayMessage('ai', message);
            if (settings.autoSaveHistory) {
                saveCurrentHistoryAuto();
            }
        }

        function displayMessage(sender, message) {
            const messageBubble = document.createElement('div');
            messageBubble.classList.add('message-bubble', sender);

            if (typeof message === 'string' && message.startsWith('<code>') && message.endsWith('</code>')) {
                const codeContent = message.substring(6, message.length - 7);
                const pre = document.createElement('pre');
                pre.classList.add('language-javascript');
                const code = document.createElement('code'); // Create <code> element
                code.classList.add('language-javascript');
                code.textContent = codeContent; // Set textContent first for Prism to work correctly
                pre.appendChild(code);

                Prism.highlightElement(code); // Highlight after appending

                const copyButton = document.createElement('button');
                copyButton.classList.add('copy-code-button');
                copyButton.innerHTML = '<i class="fas fa-clipboard"></i>';
                copyButton.title = 'Sao chép mã';
                const copiedSpan = document.createElement('span');
                copiedSpan.classList.add('copied-message');
                copiedSpan.textContent = 'Đã sao chép!';
                pre.appendChild(copiedSpan);

                copyButton.addEventListener('click', () => {
                    navigator.clipboard.writeText(codeContent).then(() => {
                        copiedSpan.classList.add('show'); // Show copied message *within* the code block
                        setTimeout(() => {
                            copiedSpan.classList.remove('show');
                        }, 2000);
                    }).catch(err => {
                        console.error('Không thể sao chép mã: ', err);
                        displayErrorMessage('Lỗi khi sao chép mã.');
                    });
                });
                pre.appendChild(copyButton);
                messageBubble.appendChild(pre);

            } else if (typeof message === 'object' && message.type === 'file') {
                // File message handling
                const fileLink = document.createElement('a');
                fileLink.href = message.url;
                fileLink.textContent = message.name;
                fileLink.target = '_blank'; // Open in new tab
                fileLink.rel = 'noopener noreferrer'; // Security best practice
                messageBubble.appendChild(fileLink);

            } else {
                // Regular text message
              messageBubble.innerHTML = message; // Use innerHTML to handle potential line breaks
            }

            messageArea.appendChild(messageBubble);
            messageArea.scrollTop = messageArea.scrollHeight;
        }


        function generateAIResponse(userMessage) {
            return new Promise((resolve, reject) => {
                // Use the API key from settings
                const apiKey = settings.apiKey;

                if (!apiKey) {
                    reject(new Error("Vui lòng nhập API Key trong phần Cài đặt.")); // Reject if no API key
                    return;
                }

                //  Simulate API call (REPLACE with actual API call)
                setTimeout(() => {
                    if (Math.random() < 0.8) {
                        if (userMessage.toLowerCase().includes('code')) {
                             resolve(`Phản hồi từ AI (với code):\n<code>function helloWorld() {\n  console.log("Xin chào thế giới!");\n}\nhelloWorld();</code>\nĐây là một đoạn mã JavaScript đơn giản.`);
                        } else {
                            resolve(`Phản hồi từ AI cho: "${userMessage}"`);
                        }

                    } else {
                        reject(new Error('Lỗi API không xác định. Vui lòng thử lại sau.'));
                    }
                }, 800);
            });
        }


        function addAIMessageBubbleOnError(errorMessage) {
            const messageBubble = document.createElement('div');
            messageBubble.classList.add('message-bubble', 'ai', 'error');
            messageBubble.textContent = errorMessage;
            messageArea.appendChild(messageBubble);
            messageArea.scrollTop = messageArea.scrollHeight;
        }

        function openSaveHistoryModal() {
            saveHistoryModal.style.display = "block";
            if (settings.historyNameFirstQuestion && chatHistory.length > 0 && chatHistory[0].sender === 'user') {
                historyNameInput.value = chatHistory[0].text.substring(0, 50);
            } else {
                historyNameInput.value = '';
            }
        }

        function closeSaveHistoryModal() {
            saveHistoryModal.style.display = "none";
        }

        function saveHistory() {
            const historyName = historyNameInput.value.trim();
            if (historyName) {
                savedHistories[historyName] = chatHistory;
                localStorage.setItem('chatHistories', JSON.stringify(savedHistories));
                loadSavedHistoryList();
                closeSaveHistoryModal();
                displayConfirmationMessage(`Lịch sử chat "${historyName}" đã được lưu.`);
            } else {
                alert('Vui lòng nhập tên lịch sử.');
            }
        }

        function loadSavedHistoryList() {
             historySubmenu.innerHTML = `<li class="history-search">
                        <input type="text" id="historySearchInput" placeholder="Tìm kiếm lịch sử...">
                    </li>`;
            const historySearchInputElem = document.getElementById('historySearchInput');
            historySearchInputElem.addEventListener('input', handleHistorySearch);

            filteredHistories = searchHistories(historySearchInputElem.value);

              historySubmenu.innerHTML += Object.keys(filteredHistories).map(historyName => `
                <li class="history-item">
                    <a href="#" onclick="loadHistory('${historyName}')">${historyName}</a>
                    <button onclick="deleteHistory('${historyName}')"><i class="fas fa-trash"></i></button>
                </li>
            `).join('');
        }

       function handleHistorySearch(event) {
            const searchTerm = event.target.value.toLowerCase();
            filteredHistories = searchHistories(searchTerm);
            historySubmenu.innerHTML = `<li class="history-search">
                        <input type="text" id="historySearchInput" placeholder="Tìm kiếm lịch sử...">
                    </li>`; // Clear and re-add
            const historySearchInputElem = document.getElementById('historySearchInput');  //Re-get
            historySearchInputElem.addEventListener('input', handleHistorySearch); // Re-attach

             historySubmenu.innerHTML += Object.keys(filteredHistories).map(historyName => `
                <li class="history-item">
                    <a href="#" onclick="loadHistory('${historyName}')">${historyName}</a>
                    <button onclick="deleteHistory('${historyName}')"><i class="fas fa-trash"></i></button>
                </li>
            `).join('');
        }

        function searchHistories(searchTerm) {
            const results = {};
            for (const historyName in savedHistories) {
                if (historyName.toLowerCase().includes(searchTerm)) {
                    results[historyName] = savedHistories[historyName];
                }
            }
            return results;
        }

        function loadHistory(historyName) {
            chatHistory = savedHistories[historyName];
            messageArea.innerHTML = `<div class="loading-spinner" id="loading-spinner"></div>`; // Keep spinner
            loadingSpinner = document.getElementById('loading-spinner');
            hideLoading();
            messageArea.innerHTML = '';
            chatHistory.forEach(message => {
                displayMessage(message.sender, message.text);
            });
            toggleSubmenu('history-submenu', { preventDefault: () => {} });
        }

        function deleteHistory(historyName) {
            if (confirm(`Bạn có chắc chắn muốn xóa lịch sử "${historyName}"?`)) {
                delete savedHistories[historyName];
                localStorage.setItem('chatHistories', JSON.stringify(savedHistories));
                loadSavedHistoryList();
                displayConfirmationMessage(`Lịch sử "${historyName}" đã được xóa.`);
            }
        }

        function saveCurrentHistoryAuto() {
            if (chatHistory.length > 0) {
                let autoSaveName = 'Auto Save - ' + new Date().toLocaleString();
                if (settings.historyNameFirstQuestion && chatHistory[0].sender === 'user') {
                    autoSaveName = chatHistory[0].text.substring(0, 50) + ' (Auto Saved)';
                }
                savedHistories[autoSaveName] = chatHistory;
                localStorage.setItem('chatHistories', JSON.stringify(savedHistories));
                loadSavedHistoryList();
            }
        }

        // Initialize settings inputs
        document.getElementById('api-key').value = settings.apiKey;
        document.getElementById('auto-save').checked = settings.autoSaveHistory;
        document.getElementById('history-name-first-question').checked = settings.historyNameFirstQuestion;
        document.getElementById('theme-select').value = settings.theme;
        document.getElementById('bg-color').value = settings.bgColor;
        document.getElementById('text-color').value = settings.textColor;
        document.getElementById('chat-bg-color').value = settings.chatBgColor;

        function saveSettings() {
            settings.apiKey = document.getElementById('api-key').value;
            settings.autoSaveHistory = document.getElementById('auto-save').checked;
            settings.historyNameFirstQuestion = document.getElementById('history-name-first-question').checked;
            settings.theme = document.getElementById('theme-select').value;
            settings.bgColor = document.getElementById('bg-color').value;
            settings.textColor = document.getElementById('text-color').value;
            settings.chatBgColor = document.getElementById('chat-bg-color').value;
            localStorage.setItem('chatSettings', JSON.stringify(settings));
            applySettings();
            toggleSubmenu('settings-submenu', { preventDefault: () => {} });
            displayConfirmationMessage('Cài đặt đã được lưu.');
        }

        function undoSettings() {
            settings = JSON.parse(localStorage.getItem('chatSettings')) || {
                apiKey: '', // Reset API key
                autoSaveHistory: false,
                historyNameFirstQuestion: false,
                theme: 'prism-tomorrow',
                bgColor: '#121212',
                textColor: '#ffffff',
                chatBgColor: '#212121'
            };
            document.getElementById('api-key').value = settings.apiKey;
            document.getElementById('auto-save').checked = settings.autoSaveHistory;
            document.getElementById('history-name-first-question').checked = settings.historyNameFirstQuestion;
            document.getElementById('theme-select').value = settings.theme;
            document.getElementById('bg-color').value = settings.bgColor;
            document.getElementById('text-color').value = settings.textColor;
            document.getElementById('chat-bg-color').value = settings.chatBgColor;
            applySettings();
            toggleSubmenu('settings-submenu', { preventDefault: () => {} });
            displayConfirmationMessage('Cài đặt đã được hoàn tác.');
        }

        function applySettings() {
            document.body.style.backgroundColor = settings.bgColor;
            document.body.style.color = settings.textColor;
            messageArea.style.backgroundColor = settings.chatBgColor;

            const prismThemeLink = document.querySelector('link[href*="prism"]');
            let newThemeHref = `https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/${settings.theme}.min.css`;

            if (settings.theme === 'prism') {
                newThemeHref = `https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.css`;
            } else if (!settings.theme.startsWith('prism-')) {
                newThemeHref = `https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css`;
                console.warn(`Invalid Prism.js theme name: ${settings.theme}. Falling back to tomorrow theme.`);
            }

            prismThemeLink.href = newThemeHref;

            document.documentElement.style.setProperty('--bg-color', settings.bgColor);
            document.documentElement.style.setProperty('--text-color', settings.textColor);
            document.documentElement.style.setProperty('--chat-bg-color', settings.chatBgColor);
             document.documentElement.style.setProperty('--sidebar-bg-color', settings.bgColor);
             document.documentElement.style.setProperty('--chat-header-bg-color', settings.bgColor);
             document.documentElement.style.setProperty('--input-area-bg-color', settings.bgColor);
             document.documentElement.style.setProperty('--modal-content-bg-color', settings.bgColor);
        }

        function showLoading() {
            loadingSpinner.classList.add('show');
        }

        function hideLoading() {
            loadingSpinner.classList.remove('show');
        }

        function displayConfirmationMessage(message) {
            const confirmationElem = document.getElementById('action-confirmation');
            confirmationElem.textContent = message;
            confirmationElem.classList.add('show');
            setTimeout(() => {
                confirmationElem.classList.remove('show');
            }, 3000);
        }

        function displayErrorMessage(message) {
            const errorElem = document.getElementById('api-error-message');
            errorElem.textContent = message;
            errorElem.classList.add('show');
            setTimeout(() => {
                errorElem.classList.remove('show');
            }, 5000);
        }

        // File upload handler
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                // In a real application, you'd upload the file to a server here.
                // For this example, we'll just create a data URL.
                const reader = new FileReader();
                reader.onload = (e) => {
                    const fileMessage = {
                        type: 'file',
                        name: file.name,
                        url: e.target.result, // Data URL or server URL
                    };
                    addUserMessage(fileMessage); // Treat file as a user message (for display)
                    // You could also send the file to the AI, if your API supports it.
                };
                reader.readAsDataURL(file); // Read as Data URL for preview (images, small files)
                // For larger files, upload to a server and send the link to the AI.
            }
            // Reset input so you can re-upload the same file
             event.target.value = null;
        }


        window.onclick = function(event) {
            if (event.target == saveHistoryModal) {
                closeSaveHistoryModal();
            }
        }
    </script>
</body>
</html>