<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Hiện Đại với Gemini</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        /* Reverted Code Block and Copy Button Styles (ChatGPT-like - No CSS changes needed here) */
        code[class*="language-"],
        pre[class*="language-"] {
            color: #f8f8f2;
            background: #272822;
            position: relative;
        }

        .copy-code-button {
            position: absolute;
            bottom: 5px;
            left: 5px;
            background-color: #444;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 8px;
            font-size: 0.8em;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s ease, background-color 0.3s ease;
        }

        .copy-code-button:hover {
            opacity: 1;
            background-color: #00bcd4;
        }

        /* ... (rest of your modern UI CSS styles - no changes needed in CSS) ... */
         body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1e2124;
            color: #e0e0e0;
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-touch-callout: none;
            -webkit-user-select: text;
            -khtml-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
            touch-action: manipulation;
            -webkit-text-size-adjust: 100%;
            font-size: 16px;
            overflow-y: scroll;
            scrollbar-width: thin;
            scrollbar-color: #555 #2a2a2a;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background-color 0.3s ease;
        }

        body.sidebar--open {
            overflow: hidden;
        }


        body::-webkit-scrollbar {
            width: 9px;
        }

        body::-webkit-scrollbar-track {
            background: #2a2a2a;
        }

        body::-webkit-scrollbar::-webkit-scrollbar-thumb {
            background-color: #555;
            border-radius: 5px;
             border: 2px solid #2a2a2a;
        }


        .container {
            width: 96%;
            max-width: 1250px;
            margin: 25px auto;
            padding: 30px;
            background-color: #2a2d31;
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.6);
            display: flex;
            flex-direction: column;
            height: calc(100vh - 50px);
            flex-grow: 1;
            margin-left: auto;
            transition: margin-left 0.3s ease, background-color 0.3s ease;
            border: none;
        }

        .container.sidebar-open {
            margin-left: 270px;
        }

        h1 {
            text-align: center;
            color: #fff;
            margin-bottom: 20px; /* Reduced margin-bottom */
            font-size: 2.0em; /* Reduced font-size */
            letter-spacing: 0.5px;
            padding-bottom: 15px; /* Reduced padding-bottom */
            border-bottom: 2px solid #444;
            font-weight: 500;
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.5);
        }

        #messages-container {
            flex-grow: 1;
            padding: 25px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            scrollbar-width: thin;
            scrollbar-color: #555 #2a2a2a;
            padding-bottom: 80px;
            border: none;
            border-radius: 12px;
            background-color: #232529;
            box-shadow: inset 0 3px 6px rgba(0, 0, 0, 0.4);
            opacity: 0;
            animation: fadeIn 0.5s ease-out 0.1s forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }


        #messages-container::-webkit-scrollbar {
            width: 8px;
        }

        #messages-container::-webkit-scrollbar-track {
            background: #2a2a2a;
        }

        #messages-container::-webkit-scrollbar::-webkit-scrollbar-thumb {
            background-color: #555;
            border-radius: 5px;
            border: 2px solid #2a2a2a;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 20px;
            clear: both;
            word-wrap: break-word;
            max-width: 80%;
            display: inline-block;
            border: 1px solid #444;
            position: relative;
             box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            transform: translateY(15px);
            opacity: 0;
            animation: slideUpFadeIn 0.4s ease-out forwards;
             margin-top: 5px;
        }

        @keyframes slideUpFadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }


        .user-message {
            background-color: #343541;
            color: #fff;
            align-self: flex-end;
            float: right;
            border-top-right-radius: 5px;
        }

        .ai-message {
            background-color: #444654;
            color: #d1d5db;
            align-self: flex-start;
            float: left;
            border-top-left-radius: 5px;
        }

        .ai-message .ai-message-text {
            font-family: 'Arial', sans-serif;
            font-weight: normal;
            line-height: 1.7;
            white-space: pre-line;
            font-size: 16px;
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.3);
        }


        .markdown-bold-uppercase {
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            color: #f0f0f0;
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.4);
        }

        .input-area {
            padding: 12px 20px;
            background-color: #343541;
            border-top: 2px solid #555;
            display: flex;
            align-items: center;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            box-sizing: border-box;
            padding-left: 20px;
            padding-right: 20px;
            z-index: 100;
            border-bottom-left-radius: 16px;
            border-bottom-right-radius: 16px;
             border-top: 1px solid #444;
        }

        .input-area textarea {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #555;
            border-radius: 12px;
            font-size: 16px;
            background-color: #40414f;
            color: #fff;
            resize: none;
            min-height: 38px;
            overflow-y: auto;
            border: 1px solid #444;
             box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .input-area textarea:focus {
            border-color: transparent;
            outline: none;
            background-color: #555860;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.5), 0 0 7px rgba(0, 188, 212, 0.7);
        }

        .input-area button {
            padding: 12px 22px;
            background-color: #00c7e0;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            margin-left: 12px;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
             box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
            font-weight: 500;
        }

        .input-area button:hover {
            background-color: #00a9bf;
            transform: scale(1.04);
             box-shadow: 0 3px 6px rgba(0, 0, 0, 0.5);
        }

        .file-upload-button {
            background-color: #5a5a5a;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.1em;
            width: 44px;
            height: 44px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 14px;
            opacity: 0.95;
            transition: opacity 0.3s ease, background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
             box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
        }

        .file-upload-button:hover {
            opacity: 1;
            background-color: #666666;
             transform: scale(1.04);
             box-shadow: 0 3px 6px rgba(0, 0, 0, 0.5);
        }


        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 270px;
            height: 100%;
            background-color: #2a2a2a;
            color: #fff;
            transform: translateX(-100%);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            z-index: 200;
            padding-top: 80px;
            box-shadow: 5px 0 10px rgba(0,0,0,0.4);
            overflow-y: auto;
            touch-action: manipulation;
            border-right: none;
             backdrop-filter: blur(12px);
        }

        .sidebar.sidebar--open {
            transform: translateX(0);
             box-shadow: 8px 0 15px rgba(0,0,0,0.5);
        }

        .sidebar-header {
            padding: 28px 22px;
            text-align: center;
            border-bottom: 2px solid #5a5a5a;
            margin-bottom: 28px;
            border-bottom: 1px solid #444;
        }

        .sidebar-menu {
            padding: 0;
            list-style: none;
        }

        .sidebar-menu-item {
            padding: 18px 22px;
            cursor: pointer;
            transition: background-color 0.2s ease, border-bottom-color 0.3s ease, padding-left 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid transparent;
             font-size: 17px;
            font-weight: 400;
        }

        .sidebar-menu-item:hover {
            background-color: #3a3a3a;
             border-bottom-color: #00bcd4;
             padding-left: 28px;
        }

        .sidebar-menu-item.has-submenu > .menu-link::after {
            content: '>',
            float: right;
            margin-left: 14px;
            font-size: 0.95em;
            display: inline-block;
            color: #888;
        }

        .submenu {
            list-style: none;
            padding-left: 0;
            margin: 0;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 5px 10px rgba(0,0,0,0.5);
            background-color: #333333;
            margin-top: 10px;
            max-height: 0;
            opacity: 0;
            transition: max-height 0.4s ease-out, opacity 0.3s ease-out;
            overflow-y: hidden;
            padding-top: 0;
            padding-bottom: 0;
        }

        .submenu.open {
            display: block;
            max-height: 700px;
            opacity: 1;
            overflow-y: auto;
            padding-top: 10px;
            padding-bottom: 15px;
        }


        .submenu-item {
            padding: 16px 22px;
            cursor: pointer;
            transition: background-color 0.2s ease, padding-left 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
             font-size: 16px;
        }

        .submenu-item:last-child {
            border-bottom: none;
        }


        .submenu-item:hover {
            background-color: #3a3a3a;
             padding-left: 28px;
        }

        .history-name {
            flex-grow: 1;
        }

        .delete-history-btn {
            background: transparent;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 1.1em;
            padding: 0 12px;
            opacity: 0.9;
            transition: opacity 0.2s ease, color 0.2s ease, transform 0.2s ease;
        }

        .delete-history-btn:hover {
            opacity: 1;
            color: #fff;
             transform: scale(1.1);
        }

        .sidebar-toggle-button {
            position: fixed;
            top: 30px;
            left: 30px;
            background: #00c7e0;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 300;
             box-shadow: 0 3px 6px rgba(0, 0, 0, 0.4);
             transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
        }

        .sidebar-toggle-button:hover {
            background-color: #00a9bf;
             transform: scale(1.07);
              box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 150;
            display: none;
            animation: fadeInOverlay 0.2s ease-out forwards;
        }

         @keyframes fadeInOverlay {
            to { background-color: rgba(0, 0, 0, 0.7); }
        }


        .sidebar-overlay.sidebar--open {
            display: block;
        }

        .close-history-menu-btn, .close-settings-menu-btn, .modal-button {
            padding: 13px 24px;
            background-color: #00c7e0;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 17px;
            margin-top: 18px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
             box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
            font-weight: 500;
        }

        .close-history-menu-btn:hover, .close-settings-menu-btn:hover, .modal-button.confirm:hover, .modal-button.cancel:hover {
            background-color: #00a9bf;
             transform: scale(1.04);
              box-shadow: 0 3px 6px rgba(0, 0, 0, 0.5);
        }


        .custom-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            z-index: 400;
            justify-content: center;
            align-items: center;
            pointer-events: none;
             animation: fadeInModalOverlay 0.3s ease-out forwards;
        }

         @keyframes fadeInModalOverlay {
            to { background-color: rgba(0, 0, 0, 0.75); }
        }


        .custom-modal-overlay.show-modal {
            display: flex;
            pointer-events: auto;
        }


        .custom-modal {
            background-color: #3a3c43;
            color: #fff;
            padding: 35px;
            border-radius: 16px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.7);
            width: 90%;
            max-width: 500px;
            text-align: center;
            border: none;
            transform: translateY(-30px);
            opacity: 0;
            animation: slideInModal 0.4s ease-out 0.15s forwards;
        }

        @keyframes slideInModal {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }


        .modal-message {
            margin-bottom: 25px;
            font-size: 1.2em;
            font-weight: 400;
        }

        .modal-input {
            width: calc(100% - 28px);
            padding: 14px;
            margin-bottom: 25px;
            border-radius: 12px;
            border: 1px solid #555;
            background-color: #4a4d54;
            color: #fff;
             box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.4);
            font-size: 17px;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 25px;
        }

        .modal-button { /* Using grouped style from .close-history-menu-btn etc. */
            /* Styles are already defined above */
        }

        .modal-button.confirm {
            background-color: #00c7e0;
            color: white;
        }

        .modal-button.cancel {
            background-color: #5a5a5a;
            color: white;
        }


    </style>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Arial:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Lịch sử Chat</h3>
        </div>
        <ul class="sidebar-menu">
            <li class="sidebar-menu-item" onclick="startNewChat()">
                <span class="menu-link">Đoạn chat mới</span>
            </li>
            <li class="sidebar-menu-item" onclick="openSaveHistoryModal()">
                <span class="menu-link">Lưu lịch sử này</span>
            </li>
            <li class="sidebar-menu-item has-submenu" onclick="toggleHistoryMenu()">
                <span class="menu-link">Lịch sử đã lưu</span>
            </li>
             <li class="sidebar-menu-item has-submenu" onclick="toggleSettingsMenu()">
                <span class="menu-link">Cài đặt</span>
            </li>
        </ul>

        <ul class="submenu" id="saved-histories-menu">
            <button class="close-history-menu-btn" onclick="toggleHistoryMenu()">Đóng</button>
        </ul>

         <ul class="submenu" id="settings-menu">
            <li class="submenu-item">
                <span class="menu-link">Tự động lưu đoạn chat</span>
                <label class="switch">
                    <input type="checkbox" id="autoSaveToggle" onchange="toggleAutoSave()" >
                    <span class="slider round"></span>
                </label>
            </li>
            <button class="close-settings-menu-btn" onclick="toggleSettingsMenu()">Đóng</button>
        </ul>

        <div class="custom-modal-overlay" id="saveHistoryModalOverlay">
            <div class="custom-modal">
                <p class="modal-message">Nhập tên cho lịch sử chat này:</p>
                <input type="text" id="historyNameInput" class="modal-input" placeholder="Tên lịch sử">
                <div class="modal-buttons">
                    <button class="modal-button confirm" onclick="saveHistoryWithInputName()">Lưu</button>
                    <button class="modal-button cancel" onclick="closeSaveHistoryModal()">Huỷ</button>
                </div>
            </div>
        </div>

         <div class="custom-modal-overlay" id="deleteHistoryModalOverlay">
            <div class="custom-modal">
                <p class="modal-message" id="deleteConfirmationMessage">Bạn có chắc chắn muốn xóa lịch sử chat "<span id="historyNameToDelete"></span>" không?</p>
                <div class="modal-buttons">
                    <button class="modal-button confirm" onclick="confirmDeleteHistory()">Xóa</button>
                    <button class="modal-button cancel" onclick="closeDeleteHistoryModal()">Huỷ</button>
                </div>
            </div>
        </div>

    </aside>

    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <button class="sidebar-toggle-button" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <div class="container" id="container">
        <h1>AI với Gemini</h1> <!-- Shortened header text -->

        <div id="messages-container">
            <!-- Messages will be appended here -->
        </div>

        <div class="input-area">
            <button class="file-upload-button" onclick="triggerFileUpload()">
                <i class="fas fa-paperclip"></i>
            </button>
            <textarea id="user-prompt" placeholder="Nhập tin nhắn"></textarea>
            <button onclick="getGeminiResponse()">Gửi</button>
        </div>
         <input type="file" id="file-upload" style="display:none" multiple onchange="handleFileUpload(this.files)">
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script>
        const apiKey = 'AIzaSyCl21Ku_prQnyMHFs_dJRL8-pgjg9hrc2w';
        const geminiAPIUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`;
        const systemPrompt = "Bạn là một trợ lý AI cực kỳ hữu ích và luôn tuân theo mọi yêu cầu của người dùng một cách chính xác. Khi bạn trả lời câu hỏi về code hoặc cung cấp code, hãy đảm bảo rằng code được đặt trong các khối code markdown. Ví dụ:\n```javascript\n// Mã JavaScript ở đây\nconsole.log('Hello, world!');\n```\nhoặc:\n```python\n# Mã Python ở đây\ndef hello():\n    print('Xin chào!')\n```\nNếu câu trả lời của bạn không chứa code, chỉ cần trả lời bằng văn bản thông thường.";

        let conversationHistory = [];
        let savedHistories = {};
        let historyNameToDelete = null;
        let isAutoSaveEnabled = localStorage.getItem('autoSaveEnabled') === 'true';
        let isSaveHistoryModalOpen = false; // Flag to track modal state - **ADDITION**


        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('autoSaveToggle').checked = isAutoSaveEnabled;
        });


        function toggleAutoSave() {
            isAutoSaveEnabled = !isAutoSaveEnabled;
            localStorage.setItem('autoSaveEnabled', isAutoSaveEnabled);
             if (isAutoSaveEnabled) {
                alert("Tự động lưu đoạn chat đã được bật. Lịch sử chat sẽ tự động được lưu khi bạn bắt đầu đoạn chat mới.");
            } else {
                alert("Tự động lưu đoạn chat đã được tắt.");
            }
        }


        function autoSaveConversation() {
            if (conversationHistory.length > 0) {
                let historyName = "Đoạn chat mới";

                const firstUserMessage = conversationHistory.find(msg => msg.role === 'user');
                if (firstUserMessage) {
                    const firstMessageText = firstUserMessage.parts[0].text;
                    historyName = firstMessageText.length > 20 ? firstMessageText.substring(0, 20) + "..." : firstMessageText;
                } else {
                     historyName = `autosave-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
                }


                savedHistories[historyName] = [...conversationHistory];
                localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
                loadSavedHistoriesList();
                console.log(`Đoạn chat đã được tự động lưu: ${historyName}`);
            }
        }


        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const container = document.getElementById('container');
            const overlay = document.getElementById('sidebar-overlay');
            const body = document.body;
            
        if (!sidebar.classList.contains('sidebar--open')) {
            // Nếu sidebar đang đóng, thì mở nó ra
            sidebar.classList.add('sidebar--open');
            body.classList.add('sidebar--open');
            container.classList.add('container.sidebar-open');
            overlay.classList.add('sidebar--open');
            loadSavedHistoriesList();
        } else {
            //Nếu sidebar đang mở, thì đóng nó lại
            sidebar.classList.remove('sidebar--open');
            container.classList.remove('sidebar-open');
            container.classList.remove('container.sidebar-open');
            overlay.classList.remove('sidebar--open');
            hideHistoryMenu();
            hideSettingsMenu();
            }
        }

        function loadChatHistory() {
            const storedHistory = localStorage.getItem('chatHistory');
            if (storedHistory) {
                conversationHistory = JSON.parse(storedHistory);
                renderMessages();
            }
        }

        function saveChatHistory() {
            localStorage.setItem('chatHistory', JSON.stringify(conversationHistory));
        }

        function renderMessages() {
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = '';
            conversationHistory.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', message.role === 'user' ? 'user-message' : 'ai-message');
                const messageTextSpan = document.createElement('span');
                messageTextSpan.classList.add('ai-message-text');
                messageTextSpan.innerHTML = message.parts[0].text;
                if (message.role === 'ai') {
                    messageDiv.appendChild(messageTextSpan);
                } else {
                    messageDiv.innerHTML = message.parts[0].text;
                }
                messagesContainer.appendChild(messageDiv);
                Prism.highlightAllUnder(messageDiv);
                 // Apply slide-up animation to each message after it's rendered
                requestAnimationFrame(() => {
                    messageDiv.classList.add('animate-message');
                });
            });
             messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }


        function startNewChat() {
            if (conversationHistory.length > 0 && isAutoSaveEnabled) {
                autoSaveConversation();
            }
            conversationHistory = [];
            saveChatHistory();
            renderMessages();
            toggleSidebar();
        }


        function openSaveHistoryModal() {
            if (!isSaveHistoryModalOpen) {
                const modalOverlay = document.getElementById('saveHistoryModalOverlay');
                modalOverlay.classList.add('show-modal');
                modalOverlay.style.display = 'flex'; // Ensure it's displayed as flex
                document.getElementById('historyNameInput').value = '';
                isSaveHistoryModalOpen = true;
            }
        }

        function closeSaveHistoryModal() {
            const modalOverlay = document.getElementById('saveHistoryModalOverlay');
            modalOverlay.classList.remove('show-modal');
            modalOverlay.style.display = 'none'; // Explicitly set display to none when closing
            isSaveHistoryModalOpen = false;
        }

        function saveHistoryWithInputName() {
            const historyName = document.getElementById('historyNameInput').value.trim();
            if (historyName) {
                savedHistories[historyName] = [...conversationHistory];
                localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
                alert(`Lịch sử chat đã được lưu với tên: ${historyName}`);
                loadSavedHistoriesList();
                closeSaveHistoryModal(); // Keep closeSaveHistoryModal call here
            } else {
                alert("Vui lòng nhập tên cho lịch sử chat.");
            }
        }

        function openDeleteHistoryModal(name) {
            historyNameToDelete = name;
            document.getElementById('historyNameToDelete').textContent = name;
            document.getElementById('deleteHistoryModalOverlay').classList.add('show-modal');
        }

        function closeDeleteHistoryModal() {
            document.getElementById('deleteHistoryModalOverlay').classList.remove('show-modal');
            historyNameToDelete = null;
        }

        function confirmDeleteHistory() {
            if (historyNameToDelete) {
                deleteSavedHistory(historyNameToDelete);
            }
            closeDeleteHistoryModal();
        }


        function deleteSavedHistory(historyName) {
            delete savedHistories[historyName];
            localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
            loadSavedHistoriesList();
            alert(`Lịch sử chat "${historyName}" đã bị xóa.`);

        }


        function loadChatHistoryByName(historyName) {
            if (savedHistories[historyName]) {
                conversationHistory = [...savedHistories[historyName]];
                saveChatHistory();
                renderMessages();
                toggleHistoryMenu();
                toggleSidebar();
            } else {
                alert("Không tìm thấy lịch sử chat đã lưu.");
            }
        }


        function toggleHistoryMenu() {
            const submenu = document.getElementById('saved-histories-menu');
            submenu.classList.toggle('open');
            hideSettingsMenu();
        }

        function hideHistoryMenu() {
            const submenu = document.getElementById('saved-histories-menu');
            submenu.classList.remove('open');
        }

        function toggleSettingsMenu() {
            const submenu = document.getElementById('settings-menu');
            submenu.classList.toggle('open');
            hideHistoryMenu();
        }

         function hideSettingsMenu() {
            const submenu = document.getElementById('settings-menu');
            submenu.classList.remove('open');
        }


        function loadSavedHistoriesList() {
            const historiesMenu = document.getElementById('saved-histories-menu');
            historiesMenu.innerHTML = '<button class="close-history-menu-btn" onclick="toggleHistoryMenu()">Đóng</button>';

            const storedSavedHistories = localStorage.getItem('savedHistories');
            if (storedSavedHistories) {
                savedHistories = JSON.parse(storedSavedHistories);
            } else {
                savedHistories = {};
            }

            if (Object.keys(savedHistories).length === 0) {
                const noHistoryItem = document.createElement('li');
                noHistoryItem.classList.add('submenu-item');
                noHistoryItem.textContent = "Chưa có lịch sử nào được lưu.";
                historiesMenu.appendChild(noHistoryItem);
                return;
            }

            for (const historyName in savedHistories) {
                const historyItem = document.createElement('li');
                historyItem.classList.add('submenu-item');

                const nameSpan = document.createElement('span');
                nameSpan.classList.add('history-name');
                nameSpan.textContent = historyName;
                nameSpan.onclick = () => loadChatHistoryByName(historyName);

                const deleteButton = document.createElement('button');
                deleteButton.classList.add('delete-history-btn');
                deleteButton.textContent = '...';
                deleteButton.onclick = (event) => {
                    event.stopPropagation();
                    openDeleteHistoryModal(historyName);
                };

                historyItem.appendChild(nameSpan);
                historyItem.appendChild(deleteButton);
                historiesMenu.appendChild(historyItem);
            }
        }


        loadChatHistory();
        loadSavedHistoriesList();

        function triggerFileUpload() {
            document.getElementById('file-upload').click();
        }

        function handleFileUpload(files) {
            if (files && files.length > 0) {
                const messagesContainer = document.getElementById('messages-container');
                const aiMessageDiv = document.createElement('div');
                aiMessageDiv.classList.add('message', 'ai-message');
                aiMessageDiv.innerHTML = `<span class="ai-message-text">Đang tải tệp...</span>`;
                messagesContainer.appendChild(aiMessageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                let fileNames = Array.from(files).map(file => file.name).join(', ');
                const userMessage = `Tệp đã tải lên: ${fileNames}. Đang chờ AI xử lý...`;

                const userMessageDiv = document.createElement('div');
                userMessageDiv.classList.add('message', 'user-message');
                userMessageDiv.textContent = userMessage;
                messagesContainer.appendChild(userMessageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                const userMessageObject = { role: 'user', parts: [{ text: userMessage }] };
                conversationHistory.push(userMessageObject);
                saveChatHistory();
                renderMessages();

                // Simulate AI acknowledging the file (for UI purposes - actual file upload to Gemini needs server-side)
                setTimeout(() => {
                    aiMessageDiv.remove();

                    const aiResponseDiv = document.createElement('div');
                    aiResponseDiv.classList.add('message', 'ai-message');
                    aiResponseDiv.innerHTML = `<span class="ai-message-text">Đã nhận được tệp: ${fileNames}. Vui lòng cho biết bạn muốn AI làm gì với tệp này.</span>`;
                    messagesContainer.appendChild(aiResponseDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;

                     const aiMessageObject = { role: 'model', parts: [{ text: aiResponseDiv.innerHTML }] };
                    conversationHistory.push(aiMessageObject);
                    saveChatHistory();
                    renderMessages();

                }, 1500);
            }
        }


        async function getGeminiResponse() {
            const userPrompt = document.getElementById('user-prompt').value.trim();
            const messagesContainer = document.getElementById('messages-container');

            if (!userPrompt) {
                alert("Vui lòng nhập tin nhắn.");
                return;
            }

            const userMessageObject = { role: 'user', parts: [{ text: userPrompt }] };
            conversationHistory.push(userMessageObject);
            saveChatHistory();
            renderMessages();
            document.getElementById('user-prompt').value = '';


            const aiMessageDiv = document.createElement('div');
            aiMessageDiv.classList.add('message', 'ai-message');
            aiMessageDiv.innerHTML = '<span class="ai-message-text">Đang suy nghĩ...</span>';
            messagesContainer.appendChild(aiMessageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            let promptContents = conversationHistory.map(message => ({
                role: message.role,
                parts: message.parts
            }));
            promptContents.unshift({ role: 'user', parts: [{ text: systemPrompt }] });


            const payload = {
                contents: promptContents
            };


            try {
                const response = await fetch(geminiAPIUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Lỗi API:", errorData);
                    aiMessageDiv.innerHTML = `<span class="ai-message-text">Lỗi API: ${response.status} - ${errorData.error.message || 'Không rõ nguyên nhân'}</span>`;
                    return;
                }

                const data = await response.json();
                console.log("Dữ liệu phản hồi từ API:", data);

                if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0].text) {
                    let aiResponseText = data.candidates[0].content.parts[0].text;
                    aiMessageDiv.innerHTML = '';
                    const aiTextContentSpan = document.createElement('span');
                    aiTextContentSpan.classList.add('ai-message-text');

                    let processedText = aiResponseText;

                    processedText = processedText.replace(/\*\*([^*]+)\*\*/g, '<span class="markdown-bold-uppercase">$1</span>');


                    let textContent = '';
                    let codeContent = null;
                    let language = 'text';
                    const codeBlockRegex = /```([\w]*)\n([\s\S]*?)```/gm;
                    let lastIndex = 0;
                    let match;

                    while ((match = codeBlockRegex.exec(processedText)) !== null) {
                        textContent = processedText.substring(lastIndex, match.index);
                        if (textContent.trim()) {
                            const textPara = document.createElement('p');
                            textPara.innerHTML = textContent.trim();
                            aiTextContentSpan.appendChild(textPara);
                        }

                        language = match[1] || 'text';
                        codeContent = match[2].trim();

                        const codePre = document.createElement('pre');
                        codePre.classList.add('language-' + language);

                        const codeElement = document.createElement('code');
                        codeElement.classList.add('language-' + language);
                        codeElement.textContent = codeContent;
                        codePre.appendChild(codeElement);

                        const copyButton = document.createElement('button');
                        copyButton.classList.add('copy-code-button');
                        copyButton.innerHTML = '<i class="fas fa-copy"></i>'; // Using Font Awesome icon
                        copyButton.onclick = () => {
                            navigator.clipboard.writeText(codeContent).then(() => {
                                alert('Đã sao chép code vào clipboard!');
                            }).catch(err => {
                                console.error('Lỗi khi sao chép: ', err);
                                alert('Lỗi khi sao chép code.');
                            });
                        };
                        codePre.appendChild(copyButton);

                        aiTextContentSpan.appendChild(codePre);

                        lastIndex = codeBlockRegex.lastIndex;
                    }

                    textContent = processedText.substring(lastIndex);
                    if (textContent.trim()) {
                         const textPara = document.createElement('p');
                         textPara.innerHTML = textContent.trim();
                         aiTextContentSpan.appendChild(textPara);
                    }


                    if (!aiTextContentSpan.hasChildNodes() && processedText.trim()) {
                         aiTextContentSpan.innerHTML = processedText.trim();
                    } else if (!aiTextContentSpan.hasChildNodes()) {
                         aiTextContentSpan.textContent = "Không có phản hồi nội dung từ AI.";
                    }

                    aiMessageDiv.appendChild(aiTextContentSpan);

                    const aiMessageObject = { role: 'model', parts: [{ text: aiMessageDiv.innerHTML }] };
                    conversationHistory.push(aiMessageObject);
                    saveChatHistory();
                    Prism.highlightAllUnder(aiMessageDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;


                } else {
                    aiMessageDiv.innerHTML = `<span class="ai-message-text">Không nhận được phản hồi hợp lệ từ AI.</span>`;
                }

            } catch (error) {
                console.error("Lỗi fetch:", error);
                aiMessageDiv.innerHTML = `<span class="ai-message-text">Đã xảy ra lỗi khi kết nối đến API.</span>`;
            }
        }
    </script>


</body>
</html>