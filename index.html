<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Hiện Đại</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* CSS Reset và biến màu sắc */
        :root {
            --bg-color: #202123;
            --container-bg: #343541;
            --text-color: #fff;
            --ai-bg: #444654;
            --user-bg: #303030;
            --primary-color: #00a8e8; /* Màu chủ đạo giống ChatGPT */
            --secondary-color: #555;
            --border-color: #444;
            --scrollbar-thumb: #666;
            --scrollbar-track: #2a2a2a;
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            line-height: 1.6; /* Tăng khoảng cách dòng */
            user-scalable: no; /* Chặn zoom toàn trang */
        }

        .container {
            width: 95%;
            max-width: 1200px;
            margin: 20px auto;
            padding: 25px;
            background-color: var(--container-bg);
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            height: 100vh; /* Full height container */
            flex-grow: 1;
            margin-left: auto;
            transition: margin-left 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .container.sidebar-open {
            margin-left: 250px; /* Khoảng trống khi sidebar mở */
        }

        h1 {
            text-align: center;
            color: var(--text-color);
            margin-bottom: 20px;
            font-size: 2.5em; /* Lớn hơn một chút */
            letter-spacing: 0.5px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        #messages-container {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            scrollbar-width: thin;
            scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track);
            padding-bottom: 70px; /* Đủ chỗ cho input area */
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-color);
            margin-bottom: 15px; /* Khoảng cách với input area */
            scroll-behavior: smooth; /* Thêm cuộn mượt */
        }

        #messages-container::-webkit-scrollbar {
            width: 8px;
        }

        #messages-container::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
        }

        #messages-container::-webkit-scrollbar-thumb {
            background-color: var(--scrollbar-thumb);
            border-radius: 4px;
        }

        .message {
            margin-bottom: 12px;
            padding: 12px 18px; /* Lớn hơn một chút */
            border-radius: 20px; /* Bo tròn hơn */
            clear: both;
            word-wrap: break-word;
            max-width: 85%; /* Tin nhắn rộng hơn một chút */
            display: inline-block;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); /* Thêm bóng đổ nhẹ */
            position: relative; /* Để định vị nút copy code và chỉnh sửa tại chỗ */
        }

        .user-message {
            background-color: var(--user-bg);
            color: var(--text-color);
            align-self: flex-end;
            float: right;
            border-top-right-radius: 4px;
            border-bottom-right-radius: 20px; /* Bo tròn phải nhiều hơn */
            border-top-left-radius: 20px;
        }

        .ai-message {
            background-color: var(--ai-bg);
            color: var(--text-color);
            align-self: flex-start;
            float: left;
            border-top-left-radius: 4px;
            border-bottom-left-radius: 20px; /* Bo tròn trái nhiều hơn */
            border-top-right-radius: 20px;
        }

        .message-content {
            /* Nội dung tin nhắn, span này sẽ được thay thế bằng textarea khi chỉnh sửa */
        }

        .edit-textarea {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 18px;
            background-color: var(--bg-color);
            color: var(--text-color);
            resize: vertical; /* Cho phép resize dọc */
            min-height: 45px;
            overflow-y: auto;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
            width: 100%; /* Chiếm hết chiều rộng của message */
            box-sizing: border-box; /* Đảm bảo padding và border không làm tăng kích thước */
            margin-bottom: 10px; /* Khoảng cách với nút Save/Cancel */
            display: block; /* Đảm bảo nó là block-level element để chiếm hết chiều rộng */
        }

        .edit-actions {
            text-align: right; /* Căn phải nút Save/Cancel */
            margin-top: -5px; /* Kéo lên gần textarea hơn */
        }

        .edit-button, .cancel-edit-button {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
            margin-left: 5px;
        }

        .edit-button {
            background-color: var(--primary-color);
            color: var(--text-color);
        }

        .edit-button:hover {
            background-color: #008ac5;
        }

        .cancel-edit-button {
            background-color: var(--secondary-color);
            color: var(--text-color);
        }

        .cancel-edit-button:hover {
            background-color: #666;
        }


        .message-options {
            position: absolute; /* Định vị tuyệt đối bên trong message */
            top: 10px;
            right: 10px;
            display: inline-block;
        }

        .options-button {
            background: transparent;
            border: none;
            color: var(--secondary-color);
            cursor: pointer;
            font-size: 1em;
            padding: 5px;
            opacity: 0.7;
            transition: opacity 0.2s ease, color 0.2s ease;
        }

        .options-button:hover {
            opacity: 1;
            color: var(--text-color);
        }

        .options-menu {
            position: absolute;
            top: 100%; /* Đặt menu xuống dưới nút */
            right: 0;
            background-color: var(--container-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 5px 0;
            list-style: none;
            margin: 0;
            z-index: 10;
            display: none; /* Ẩn mặc định */
        }

        .options-menu.show {
            display: block; /* Hiển thị khi có class 'show' */
        }

        .options-menu li {
            padding: 8px 15px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            color: var(--text-color);
        }

        .options-menu li:hover {
            background-color: var(--ai-bg);
        }


        .input-area {
            padding: 15px 20px;
            background-color: var(--container-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            box-sizing: border-box;
            padding-left: 20px;
            padding-right: 20px;
            z-index: 100;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
            border-top: 1px solid var(--border-color);
        }

        .input-area textarea {
            flex-grow: 1;
            padding: 12px; /* Lớn hơn một chút */
            border: 1px solid var(--border-color);
            border-radius: 10px; /* Bo tròn hơn */
            font-size: 18px; /* Lớn hơn một chút */
            background-color: var(--bg-color);
            color: var(--text-color);
            resize: none;
            min-height: 45px; /* Cao hơn một chút */
            overflow-y: auto;
            border: 1px solid var(--border-color);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3); /* Thêm bóng đổ trong */
        }

        .input-area textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 8px rgba(0, 168, 232, 0.5);
        }

        .input-area button {
            padding: 12px 25px; /* Lớn hơn một chút */
            background-color: var(--primary-color);
            color: var(--text-color);
            border: none;
            border-radius: 10px; /* Bo tròn hơn */
            cursor: pointer;
            font-size: 18px; /* Lớn hơn một chút */
            margin-left: 12px; /* Khoảng cách lớn hơn */
            transition: background-color 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); /* Thêm bóng đổ */
        }

        .input-area button:hover {
            background-color: #008ac5; /* Màu tối hơn khi hover */
        }

        .input-area button:disabled {
            background-color: var(--secondary-color); /* Màu xám khi disabled */
            cursor: not-allowed;
        }


        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            height: 100%;
            background-color: var(--container-bg);
            color: var(--text-color);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 200;
            padding-top: 60px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.2);
            overflow-y: auto;
            touch-action: manipulation;
            border-right: 1px solid var(--border-color);
        }

        .sidebar.sidebar--open {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-menu {
            padding: 0;
            list-style: none;
        }

        .sidebar-menu-item {
            padding: 15px 20px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid transparent;
            transition: border-bottom-color 0.3s ease;
        }

        .sidebar-menu-item:hover {
            background-color: var(--ai-bg);
            border-bottom-color: var(--primary-color);
        }

        .sidebar-menu-item.has-submenu > .menu-link::after {
            content: '>';
            float: right;
            margin-left: 10px;
            font-size: 0.8em;
            display: inline-block;
        }

        .submenu {
            list-style: none;
            padding-left: 0;
            margin: 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            background-color: #2c2c2c;
            margin-top: 5px;
            max-height: 0;
            opacity: 0;
            transition: max-height 0.3s ease-out, opacity 0.2s ease-out;
            overflow-y: hidden;
            padding-top: 0;
            padding-bottom: 0;
        }

        .submenu.open {
            display: block;
            max-height: 500px;
            opacity: 1;
            overflow-y: auto;
            padding-top: 5px;
            padding-bottom: 10px;
        }


        .submenu-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }

        .submenu-item:last-child {
            border-bottom: none;
        }


        .submenu-item:hover {
            background-color: var(--ai-bg);
        }

        .history-name {
            flex-grow: 1;
        }

        .delete-history-btn {
            background: transparent;
            border: none;
            color: var(--secondary-color);
            cursor: pointer;
            font-size: 1em;
            padding: 0 8px;
            opacity: 0.7;
            transition: opacity 0.2s ease, color 0.2s ease;
        }

        .delete-history-btn:hover {
            opacity: 1;
            color: var(--text-color);
        }

        .sidebar-toggle-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: var(--primary-color);
            color: var(--text-color);
            border: none;
            border-radius: 50%;
            width: 45px; /* Lớn hơn một chút */
            height: 45px; /* Lớn hơn một chút */
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 300;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); /* Thêm bóng đổ */
        }

        .sidebar-toggle-button:hover {
            background-color: #008ac5; /* Màu tối hơn khi hover */
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 150;
            display: none;
        }

        .sidebar-overlay.sidebar--open {
            display: block;
        }

        .close-history-menu-btn {
            background-color: var(--primary-color);
            color: var(--text-color);
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            cursor: pointer;
            margin-top: 10px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            transition: background-color 0.3s ease;
        }

        .close-history-menu-btn:hover {
            background-color: #008ac5; /* Màu tối hơn khi hover */
        }

        .custom-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 400;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }

        .custom-modal-overlay.show-modal {
            display: flex;
            pointer-events: auto;
        }


        .custom-modal {
            background-color: var(--container-bg);
            color: var(--text-color);
            padding: 25px; /* Lớn hơn một chút */
            border-radius: 12px; /* Bo tròn hơn */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            width: 85%; /* Rộng hơn một chút */
            max-width: 450px; /* Max width lớn hơn */
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .modal-message {
            margin-bottom: 20px; /* Khoảng cách lớn hơn */
            font-size: 1.1em; /* Lớn hơn một chút */
        }

        .modal-input {
            width: calc(100% - 24px); /* Tính toán lại padding */
            padding: 12px; /* Lớn hơn một chút */
            margin-bottom: 20px; /* Khoảng cách lớn hơn */
            border-radius: 10px; /* Bo tròn hơn */
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 1em;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 20px; /* Khoảng cách lớn hơn */
        }

        .modal-button {
            padding: 12px 25px; /* Lớn hơn một chút */
            border: none;
            border-radius: 10px; /* Bo tròn hơn */
            cursor: pointer;
            font-size: 18px; /* Lớn hơn một chút */
            transition: background-color 0.3s ease;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); /* Thêm bóng đổ */
        }

        .modal-button.confirm {
            background-color: var(--primary-color);
            color: var(--text-color);
        }

        .modal-button.confirm:hover {
            background-color: #008ac5; /* Màu tối hơn khi hover */
        }

        .modal-button.cancel {
            background-color: var(--secondary-color);
            color: var(--text-color);
        }

        .modal-button.cancel:hover {
            background-color: #666;
        }


        code[class*="language-"],
        pre[class*="language-"] {
            color: #f8f8f2;
            background: #272822;
            text-shadow: none;
            font-size: 0.9em;
            border-radius: 10px;
            padding: 15px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.4;
            margin-bottom: 15px;
            position: relative;
            z-index: 1; /* Đảm bảo code block không bị che */
        }
        .token.comment, .token.prolog, .token.doctype, .token.cdata { color: #6c6767; }
        .token.punctuation { color: #f8f8f2; }
        .token.namespace { opacity: .7; }
        .token.property, .token.tag, .token.constant, .token.symbol, .token.deleted { color: #f92672; }
        .token.boolean, .token.number { color: #ae81ff; }
        .token.selector, .token.attr-name, .token.string, .token.char, .token.builtin, .token.inserted { color: #a6e22e; }
        .token.operator, .token.entity, .token.url, .language-css .token.string, .style .token.string { color: #f8f8f2; background: none; }
        .token.atrule, .token.attr-value, .token.keyword { color: var(--primary-color); }
        .token.function, .token.class-name { color: #e6db74; }
        .token.regex, .token.important, .token.variable { color: #fd971f; }
        .token.important, .token.bold { font-weight: bold; }
        .token.italic { font-style: italic; }
        .token.entity { cursor: help; }

        .copy-code-button {
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: var(--secondary-color);
            color: var(--text-color);
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.8em;
            opacity: 0.7;
            transition: opacity 0.2s ease, background-color 0.2s ease;
            z-index: 2; /* Đảm bảo nút copy nằm trên code block */
        }

        .copy-code-button:hover {
            opacity: 1;
            background-color: #777;
        }
        .copy-code-button.copied {
            background-color: var(--primary-color);
            opacity: 1;
            pointer-events: none; /* Ngăn chặn click sau khi đã copy */
        }


    </style>

</head>
<body>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Lịch sử Chat</h3>
        </div>
        <ul class="sidebar-menu">
            <li class="sidebar-menu-item" onclick="openSaveHistoryModal()">
                <span class="menu-link">Lưu hội thoại hiện tại</span>
            </li>
            <li class="sidebar-menu-item has-submenu" onclick="toggleHistoryMenu()">
                <span class="menu-link">Lịch sử đã lưu</span>
                </li>
        </ul>

        <ul class="submenu" id="saved-histories-menu">
            <button class="close-history-menu-btn" onclick="toggleHistoryMenu()">Đóng</button>
        </ul>

        <div class="custom-modal-overlay" id="saveHistoryModalOverlay">
            <div class="custom-modal">
                <p class="modal-message">Nhập tên cho lịch sử chat này:</p>
                <input type="text" id="historyNameInput" class="modal-input" placeholder="Tên lịch sử">
                <div class="modal-buttons">
                    <button class="modal-button confirm" onclick="saveHistoryWithInputName()">Lưu</button>
                    <button class="modal-button cancel" onclick="closeSaveHistoryModal()">Huỷ</button>
                </div>
            </div>
        </div>

         <div class="custom-modal-overlay" id="deleteHistoryModalOverlay">
            <div class="custom-modal">
                <p class="modal-message" id="deleteConfirmationMessage">Bạn có chắc chắn muốn xóa lịch sử chat "<span id="historyNameToDelete"></span>" không?</p>
                <div class="modal-buttons">
                    <button class="modal-button confirm" onclick="confirmDeleteHistory()">Xóa</button>
                    <button class="modal-button cancel" onclick="closeDeleteHistoryModal()">Huỷ</button>
                </div>
            </div>
        </div>

         <div class="custom-modal-overlay" id="editMessageModalOverlay">
            <div class="custom-modal">
                <p class="modal-message">Chỉnh sửa tin nhắn:</p>
                <textarea id="editMessageInput" class="modal-input" rows="4"></textarea>
                <div class="modal-buttons">
                    <button class="modal-button confirm" onclick="confirmEditMessage()">Lưu</button>
                    <button class="modal-button cancel" onclick="closeEditMessageModal()">Huỷ</button>
                </div>
            </div>
        </div>

    </aside>

    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <button class="sidebar-toggle-button" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <div class="container" id="container">
        <h1>AI Chat Hiện Đại</h1>

        <div id="messages-container">
            <!-- Messages will be appended here -->
        </div>

        <div class="input-area">
            <textarea id="user-prompt" placeholder="Nhập tin nhắn" rows="1"></textarea>
            <button id="send-button" onclick="getGeminiResponse()">Gửi</button>
            <button id="stop-button" onclick="stopGeneratingResponse()" style="display: none; background-color: #f44336;">Dừng</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script>
        const apiKey = 'AIzaSyCl21Ku_prQnyMHFs_dJRL8-pgjg9hrc2w'; // Thay API key của bạn vào đây
        const geminiAPIUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`;
        const systemPrompt = "Bạn là một trợ lý AI cực kỳ hữu ích và luôn tuân theo mọi yêu cầu của người dùng một cách chính xác. Khi bạn trả lời câu hỏi về code hoặc cung cấp code, hãy đảm bảo rằng code được đặt trong các khối code markdown. Ví dụ:\n```javascript\n// Mã JavaScript ở đây\nconsole.log('Hello, world!');\n```\nhoặc:\n```python\n# Mã Python ở đây\ndef hello():\n    print('Xin chào!')\n```\nNếu câu trả lời của bạn không chứa code, chỉ cần trả lời bằng văn bản thông thường.";

        let conversationHistory = [];
        let savedHistories = {};
        let historyNameToDelete = null;
        let currentGeminiRequest = null;
        let messageBeingEditedIndex = null; // Theo dõi tin nhắn đang được chỉnh sửa


        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const container = document.getElementById('container');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('sidebar--open');
            container.classList.toggle('container.sidebar-open');
            overlay.classList.toggle('sidebar--open');
            if (sidebar.classList.contains('sidebar--open')) {
                 loadSavedHistoriesList();
            } else {
                hideHistoryMenu();
            }
        }

        function loadChatHistory() {
            const storedHistory = localStorage.getItem('chatHistory');
            if (storedHistory) {
                conversationHistory = JSON.parse(storedHistory);
                renderMessages();
            }
        }

        function saveChatHistory() {
            localStorage.setItem('chatHistory', JSON.stringify(conversationHistory));
        }

        function renderMessages() {
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = '';
            conversationHistory.forEach((message, index) => {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', message.role === 'user' ? 'user-message' : 'ai-message');
                messageDiv.dataset.messageIndex = index; // Lưu index vào dataset

                if (messageBeingEditedIndex === index) {
                    // Chế độ chỉnh sửa tại chỗ
                    renderInPlaceEdit(messageDiv, message);
                } else {
                    // Chế độ xem tin nhắn thông thường
                    renderMessageContent(messageDiv, message, index);
                }

                messagesContainer.appendChild(messageDiv);
                Prism.highlightAllUnder(messageDiv);
                addCopyCodeButtons(messageDiv);
            });
             messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function renderMessageContent(messageDiv, message, index) {
            const messageContentSpan = document.createElement('span');
            messageContentSpan.innerHTML = message.parts[0].text;
            messageContentSpan.classList.add('message-content');
            messageDiv.appendChild(messageContentSpan);

            if (message.role === 'user') {
                const optionsButton = document.createElement('button');
                optionsButton.classList.add('options-button');
                optionsButton.innerHTML = '<i class="fas fa-ellipsis-v"></i>';
                const optionsMenu = document.createElement('ul');
                optionsMenu.classList.add('options-menu');
                optionsMenu.innerHTML = `
                    <li onclick="startInPlaceEdit(${index})">Chỉnh sửa</li>
                    <li onclick="deleteMessage(${index})">Xóa</li>
                `;
                optionsButton.onclick = (event) => {
                    event.stopPropagation();
                    toggleOptionsMenu(optionsMenu, optionsButton);
                };
                messageDiv.appendChild(optionsButton);
                messageDiv.appendChild(optionsMenu);
            }
        }

        function renderInPlaceEdit(messageDiv, message) {
            const editTextarea = document.createElement('textarea');
            editTextarea.value = message.parts[0].text;
            editTextarea.classList.add('edit-textarea');
            messageDiv.appendChild(editTextarea);
            editTextarea.focus(); // Focus vào textarea khi bắt đầu chỉnh sửa

            const editActionsDiv = document.createElement('div');
            editActionsDiv.classList.add('edit-actions');
            editActionsDiv.innerHTML = `
                <button class="edit-button" onclick="confirmInPlaceEdit(${messageDiv.dataset.messageIndex})">Lưu</button>
                <button class="cancel-edit-button" onclick="cancelInPlaceEdit(${messageDiv.dataset.messageIndex})">Hủy</button>
            `;
            messageDiv.appendChild(editActionsDiv);
        }


        function startInPlaceEdit(messageIndex) {
            messageBeingEditedIndex = messageIndex;
            renderMessages(); // Gọi lại renderMessages để chuyển sang chế độ chỉnh sửa
        }

        function cancelInPlaceEdit(messageIndex) {
            messageBeingEditedIndex = null; // Hủy chế độ chỉnh sửa
            renderMessages(); // Gọi lại renderMessages để trở về chế độ xem
        }

        function confirmInPlaceEdit(messageIndex) {
            const messageDiv = document.querySelector(`.message[data-message-index='${messageIndex}']`);
            if (!messageDiv) return;
            const editTextarea = messageDiv.querySelector('.edit-textarea');
            if (!editTextarea) return;

            const newMessageText = editTextarea.value.trim();
            if (newMessageText) {
                conversationHistory[messageIndex].parts[0].text = newMessageText;
                saveChatHistory();
            }
            messageBeingEditedIndex = null; // Kết thúc chế độ chỉnh sửa
            renderMessages(); // Render lại tin nhắn đã chỉnh sửa
        }


        function addCopyCodeButtons(messageDiv) {
            messageDiv.querySelectorAll('pre code').forEach(codeBlock => {
                const preBlock = codeBlock.parentNode; // Lấy thẻ <pre>
                const copyButton = document.createElement('button');
                copyButton.classList.add('copy-code-button');
                copyButton.textContent = 'Sao chép';

                copyButton.addEventListener('click', function() {
                    const codeText = codeBlock.textContent;
                    navigator.clipboard.writeText(codeText).then(() => {
                        copyButton.textContent = 'Đã sao chép!';
                        copyButton.classList.add('copied');
                        setTimeout(() => {
                            copyButton.textContent = 'Sao chép';
                            copyButton.classList.remove('copied');
                        }, 2000); // Reset text sau 2 giây
                    }).catch(err => {
                        console.error('Không thể sao chép code: ', err);
                        copyButton.textContent = 'Lỗi sao chép';
                    });
                });
                preBlock.appendChild(copyButton); // Thêm nút vào <pre>
            });
        }


        function toggleOptionsMenu(menu, button) {
            // Đóng tất cả các menu options đang mở khác
            document.querySelectorAll('.options-menu.show').forEach(m => {
                if (m !== menu) {
                    m.classList.remove('show');
                }
            });
            menu.classList.toggle('show');

            // Đóng menu khi click ra ngoài
            if (menu.classList.contains('show')) {
                document.addEventListener('click', function closeMenu(event) {
                    if (!menu.contains(event.target) && !button.contains(event.target)) {
                        menu.classList.remove('show');
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }
        }


        function openSaveHistoryModal() {
            document.getElementById('saveHistoryModalOverlay').classList.add('show-modal');
            document.getElementById('historyNameInput').value = '';
        }

        function closeSaveHistoryModal() {
            document.getElementById('saveHistoryModalOverlay').classList.remove('show-modal');
        }

        function saveHistoryWithInputName() {
            const historyName = document.getElementById('historyNameInput').value.trim();
            if (historyName) {
                savedHistories[historyName] = [...conversationHistory];
                localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
                alert(`Lịch sử chat đã được lưu với tên: ${historyName}`);
                loadSavedHistoriesList();
                closeSaveHistoryModal();
            } else {
                alert("Vui lòng nhập tên cho lịch sử chat.");
            }
        }

        function openDeleteHistoryModal(name) {
            historyNameToDelete = name;
            document.getElementById('historyNameToDelete').textContent = name;
            document.getElementById('deleteHistoryModalOverlay').classList.add('show-modal');
        }

        function closeDeleteHistoryModal() {
            document.getElementById('deleteHistoryModalOverlay').classList.remove('show-modal');
            historyNameToDelete = null;
        }

        function confirmDeleteHistory() {
            if (historyNameToDelete) {
                deleteSavedHistory(historyNameToDelete);
            }
            closeDeleteHistoryModal();
        }


        function deleteSavedHistory(historyName) {
            delete savedHistories[historyName];
            localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
            loadSavedHistoriesList();
            alert(`Lịch sử chat "${historyName}" đã bị xóa.`);

        }


        function loadChatHistoryByName(historyName) {
            if (savedHistories[historyName]) {
                conversationHistory = [...savedHistories[historyName]];
                saveChatHistory();
                renderMessages();
                toggleHistoryMenu();
                toggleSidebar();
            } else {
                alert("Không tìm thấy lịch sử chat đã lưu.");
            }
        }


        function toggleHistoryMenu() {
            const submenu = document.getElementById('saved-histories-menu');
            submenu.classList.toggle('open');
        }

        function hideHistoryMenu() {
            const submenu = document.getElementById('saved-histories-menu');
            submenu.classList.remove('open');
        }


        function loadSavedHistoriesList() {
            const historiesMenu = document.getElementById('saved-histories-menu');
            historiesMenu.innerHTML = '<button class="close-history-menu-btn" onclick="toggleHistoryMenu()">Đóng</button>';

            const storedSavedHistories = localStorage.getItem('savedHistories');
            if (storedSavedHistories) {
                savedHistories = JSON.parse(storedSavedHistories);
            } else {
                savedHistories = {};
            }

            if (Object.keys(savedHistories).length === 0) {
                const noHistoryItem = document.createElement('li');
                noHistoryItem.classList.add('submenu-item');
                noHistoryItem.textContent = "Chưa có lịch sử nào được lưu.";
                historiesMenu.appendChild(noHistoryItem);
                return;
            }

            for (const historyName in savedHistories) {
                const historyItem = document.createElement('li');
                historyItem.classList.add('submenu-item');

                const nameSpan = document.createElement('span');
                nameSpan.classList.add('history-name');
                nameSpan.textContent = historyName;
                nameSpan.onclick = () => loadChatHistoryByName(historyName);

                const deleteButton = document.createElement('button');
                deleteButton.classList.add('delete-history-btn');
                deleteButton.textContent = '...';
                deleteButton.onclick = (event) => {
                    event.stopPropagation();
                    openDeleteHistoryModal(historyName);
                };

                historyItem.appendChild(nameSpan);
                historyItem.appendChild(deleteButton);
                historiesMenu.appendChild(historyItem);
            }
        }


        loadChatHistory();
        loadSavedHistoriesList();


        async function getGeminiResponse() {
            const userPrompt = document.getElementById('user-prompt').value.trim();
            if (!userPrompt) {
                alert("Vui lòng nhập tin nhắn.");
                return;
            }

            const sendButton = document.getElementById('send-button');
            const stopButton = document.getElementById('stop-button');
            const inputArea = document.querySelector('.input-area textarea');

            sendButton.disabled = true;
            stopButton.style.display = 'inline-block';
            inputArea.disabled = true;


            const userMessageObject = { role: 'user', parts: [{ text: userPrompt }] };
            conversationHistory.push(userMessageObject);
            saveChatHistory();
            renderMessages();
            document.getElementById('user-prompt').value = '';
            adjustTextareaHeight();

            const messagesContainer = document.getElementById('messages-container');
            const aiMessageDiv = document.createElement('div');
            aiMessageDiv.classList.add('message', 'ai-message');
            messagesContainer.appendChild(aiMessageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            let promptContents = conversationHistory.map(message => ({
                role: message.role,
                parts: message.parts
            }));
            promptContents.unshift({ role: 'user', parts: [{ text: systemPrompt }] });


            const payload = {
                contents: promptContents
            };

            try {
                currentGeminiRequest = fetch(geminiAPIUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const response = await currentGeminiRequest;

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Lỗi API:", errorData);
                    aiMessageDiv.textContent = `Lỗi API: ${response.status} - ${errorData.error.message || 'Không rõ nguyên nhân'}`;
                    return;
                }

                const data = await response.json();
                console.log("Dữ liệu phản hồi từ API:", data);

                if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0].text) {
                    let aiResponseText = data.candidates[0].content.parts[0].text;
                    aiMessageDiv.innerHTML = aiResponseText; // Gán trực tiếp nội dung phản hồi
                    const aiMessageObject = { role: 'model', parts: [{ text: aiResponseText }] };
                    conversationHistory.push(aiMessageObject);
                    saveChatHistory();
                    renderMessages(); // Gọi lại renderMessages để highlight code và thêm nút copy
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;


                } else {
                    aiMessageDiv.textContent = "Không nhận được phản hồi hợp lệ từ AI.";
                }

            } catch (error) {
                if (error.name === 'AbortError') {
                    aiMessageDiv.textContent = "Đã dừng tạo phản hồi.";
                } else {
                    console.error("Lỗi fetch:", error);
                    aiMessageDiv.textContent = "Đã xảy ra lỗi khi kết nối đến API.";
                }
            } finally {
                sendButton.disabled = false;
                stopButton.style.display = 'none';
                inputArea.disabled = false;
                currentGeminiRequest = null;
            }
        }

        function stopGeneratingResponse() {
            if (currentGeminiRequest) {
                currentGeminiRequest.controller.abort();
                currentGeminiRequest = null;
            }
        }

        (function() {
            const originalFetch = window.fetch;
            window.fetch = function(url, options = {}) {
                const controller = new AbortController();
                const signal = controller.signal;
                options.signal = signal;
                const promise = originalFetch(url, options);
                promise.controller = controller;
                return promise;
            };
        })();


        function openEditMessageModal(messageIndex) {
            messageBeingEdited = messageIndex;
            document.getElementById('editMessageInput').value = conversationHistory[messageIndex].parts[0].text;
            document.getElementById('editMessageModalOverlay').classList.add('show-modal');
        }

        function closeEditMessageModal() {
            document.getElementById('editMessageModalOverlay').classList.remove('show-modal');
            messageBeingEdited = null;
        }

        function confirmEditMessage() {
            if (messageBeingEdited !== null) {
                const newMessageText = document.getElementById('editMessageInput').value.trim();
                if (newMessageText) {
                    conversationHistory[messageBeingEdited].parts[0].text = newMessageText;
                    saveChatHistory();
                    renderMessages();
                }
                closeEditMessageModal();
                messageBeingEdited = null;
            }
        }

        function deleteMessage(messageIndex) {
            conversationHistory.splice(messageIndex, 1);
            saveChatHistory();
            renderMessages();
        }

        document.addEventListener('DOMContentLoaded', function() {
            const textarea = document.getElementById('user-prompt');
            textarea.addEventListener('input', adjustTextareaHeight);
            adjustTextareaHeight();
        });

        function adjustTextareaHeight() {
            const textarea = document.getElementById('user-prompt');
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
            if (parseInt(textarea.style.height) > 200) {
                textarea.style.overflowY = 'scroll';
            } else {
                textarea.style.overflowY = 'hidden';
            }
        }


    </script>
</body>
</html>