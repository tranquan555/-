<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Hiện Đại với Gemini</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        /* CSS Variables for theming */
        :root {
            --body-bg-color: #1e2124;
            --container-bg-color: #25272b;
            --text-color: #d1d5db;
            --heading-color: #fff;
            --message-user-bg-color: #343541;
            --message-ai-bg-color: #444654;
            --input-area-bg-color: #343541;
            --input-border-top-color: #555;
            --textarea-bg-color: #40414f;
            --button-primary-color: #00bcd4;
            --button-primary-hover-color: #0097a7;
            --button-secondary-color: #555;
            --button-secondary-hover-color: #666;
            --sidebar-bg-color: #252525;
            --sidebar-header-border-bottom-color: #444;
            --sidebar-item-hover-color: #343541;
            --sidebar-submenu-bg-color: #2c2c2c;
            --modal-overlay-bg-color: rgba(0, 0, 0, 0.7);
            --modal-bg-color: #343541;
            --code-bg-color: #272822;
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--body-bg-color);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-touch-callout: none;
            -webkit-user-select: text;
            -khtml-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
            touch-action: manipulation;
            -webkit-text-size-adjust: 100%;
            font-size: 16px;
            overflow-y: scroll;
            scrollbar-width: thin;
            scrollbar-color: #444 #252525;
        }

        body::-webkit-scrollbar {
            width: 8px;
        }

        body::-webkit-scrollbar-track {
            background: #252525;
        }

        body::-webkit-scrollbar::-webkit-scrollbar-thumb {
            background-color: #444;
            border-radius: 4px;
        }


        .container {
            width: 95%;
            max-width: 1200px;
            margin: 20px auto;
            padding: 30px;
            background-color: var(--container-bg-color);
            border-radius: 16px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            height: calc(100vh - 40px);
            flex-grow: 1;
            margin-left: auto;
            transition: margin-left 0.3s ease;
            border: 1px solid #333;
        }

        .container.sidebar-open {
            margin-left: 250px;
        }

        h1 {
            text-align: center;
            color: var(--heading-color);
            margin-bottom: 25px;
            font-size: 2.5em;
            letter-spacing: 0.5px;
            padding-bottom: 20px;
            border-bottom: 2px solid #444;
        }

        #messages-container {
            flex-grow: 1;
            padding: 25px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            scrollbar-width: thin;
            scrollbar-color: #555 #252525;
            padding-bottom: 80px;
            border: none;
            border-radius: 12px;
            background-color: var(--body-bg-color);
             box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        #messages-container::-webkit-scrollbar {
            width: 8px;
        }

        #messages-container::-webkit-scrollbar-track {
            background: #252525;
        }

        #messages-container::-webkit-scrollbar::-webkit-scrollbar-thumb {
            background-color: #555;
            border-radius: 4px;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 20px;
            clear: both;
            word-wrap: break-word;
            max-width: 80%;
            display: inline-block;
             box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .user-message {
            background-color: var(--message-user-bg-color);
            color: var(--text-color); /* User message text color same as default text */
            align-self: flex-end;
            float: right;
            border-top-right-radius: 5px;
        }

        .ai-message {
            background-color: var(--message-ai-bg-color);
            color: var(--text-color);
            align-self: flex-start;
            float: left;
            border-top-left-radius: 5px;
        }

        .ai-message .ai-message-text {
            font-family: 'Arial', sans-serif;
            font-weight: normal;
            line-height: 1.7;
            white-space: pre-line;
            font-size: 16px;
        }

        .markdown-bold-uppercase {
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            color: #f0f0f0;
        }

        .input-area {
            padding: 12px 20px;
            background-color: var(--input-area-bg-color);
            border-top: 2px solid var(--input-border-top-color);
            display: flex;
            align-items: center;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            box-sizing: border-box;
            padding-left: 20px;
            padding-right: 20px;
            z-index: 100;
            border-bottom-left-radius: 16px;
            border-bottom-right-radius: 16px;
             border-top: 1px solid #444;
        }

        .input-area textarea {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #555;
            border-radius: 12px;
            font-size: 16px;
            background-color: var(--textarea-bg-color);
            color: var(--text-color);
            resize: none;
            min-height: 38px;
            overflow-y: auto;
            border: 1px solid #444;
             box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .input-area textarea:focus {
            border-color: #00bcd4;
            outline: none;
            box-shadow: 0 0 6px rgba(0, 188, 212, 0.6);
        }

        .input-area button {
            padding: 12px 22px;
            background-color: var(--button-primary-color);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            margin-left: 12px;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .input-area button:hover {
            background-color: var(--button-primary-hover-color);
            transform: scale(1.03);
        }

        .file-upload-button {
            background-color: var(--button-secondary-color);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1em;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 12px;
            opacity: 0.9;
            transition: opacity 0.3s ease, background-color 0.3s ease, transform 0.2s ease;
        }

        .file-upload-button:hover {
            opacity: 1;
            background-color: var(--button-secondary-hover-color);
             transform: scale(1.03);
        }


        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            height: 100%;
            background-color: var(--sidebar-bg-color);
            color: #fff;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 200;
            padding-top: 70px;
            box-shadow: 4px 0 8px rgba(0,0,0,0.3);
            overflow-y: auto;
            touch-action: manipulation;
            border-right: 1px solid #444;
             backdrop-filter: blur(10px);
        }

        .sidebar.sidebar--open {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 25px 20px;
            text-align: center;
            border-bottom: 2px solid var(--sidebar-header-border-bottom-color);
            margin-bottom: 25px;
            border-bottom: 1px solid #444;
        }

        .sidebar-menu {
            padding: 0;
            list-style: none;
        }

        .sidebar-menu-item {
            padding: 16px 20px;
            cursor: pointer;
            transition: background-color 0.2s ease, border-bottom-color 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid transparent;
        }

        .sidebar-menu-item:hover {
            background-color: var(--sidebar-item-hover-color);
             border-bottom-color: #00bcd4;
        }

        .sidebar-menu-item.has-submenu > .menu-link::after {
            content: '>';
            float: right;
            margin-left: 12px;
            font-size: 0.9em;
            display: inline-block;
            color: #aaa;
        }

        .submenu {
            list-style: none;
            padding-left: 0;
            margin: 0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
            background-color: var(--sidebar-submenu-bg-color);
            margin-top: 8px;
            max-height: 0;
            opacity: 0;
            transition: max-height 0.4s ease-out, opacity 0.3s ease-out;
            overflow-y: hidden;
            padding-top: 0;
            padding-bottom: 0;
        }

        .submenu.open {
            display: block;
            max-height: 600px;
            opacity: 1;
            overflow-y: auto;
            padding-top: 8px;
            padding-bottom: 12px;
        }


        .submenu-item {
            padding: 14px 20px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }

        .submenu-item:last-child {
            border-bottom: none;
        }


        .submenu-item:hover {
            background-color: var(--sidebar-item-hover-color);
        }

        .history-name {
            flex-grow: 1;
        }

        .delete-history-btn {
            background: transparent;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 1em;
            padding: 0 10px;
            opacity: 0.8;
            transition: opacity 0.2s ease, color 0.2s ease;
        }

        .delete-history-btn:hover {
            opacity: 1;
            color: #fff;
        }

        .sidebar-toggle-button {
            position: fixed;
            top: 25px;
            left: 25px;
            background: var(--button-primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 300;
             box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
             transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .sidebar-toggle-button:hover {
            background-color: var(--button-primary-hover-color);
             transform: scale(1.05);
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 150;
            display: none;
        }

        .sidebar-overlay.sidebar--open {
            display: block;
        }

        .close-history-menu-btn, .close-settings-menu-btn {
            background-color: var(--button-primary-color);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            cursor: pointer;
            margin-top: 15px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .close-history-menu-btn:hover, .close-settings-menu-btn:hover {
            background-color: var(--button-primary-hover-color);
             transform: scale(1.03);
        }

        .custom-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-overlay-bg-color);
            z-index: 400;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }

        .custom-modal-overlay.show-modal {
            display: flex;
            pointer-events: auto;
        }


        .custom-modal {
            background-color: var(--modal-bg-color);
            color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.6);
            width: 85%;
            max-width: 450px;
            text-align: center;
            border: 1px solid #444;
        }

        .modal-message {
            margin-bottom: 20px;
            font-size: 1.1em;
        }

        .modal-input {
            width: calc(100% - 24px);
            padding: 12px;
            margin-bottom: 20px;
            border-radius: 10px;
            border: 1px solid #555;
            background-color: #40414f;
            color: #fff;
             box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .modal-button {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: 1px solid #444;
        }

        .modal-button.confirm {
            background-color: var(--button-primary-color);
            color: white;
        }

        .modal-button.confirm:hover {
            background-color: var(--button-primary-hover-color);
             transform: scale(1.03);
        }

        .modal-button.cancel {
            background-color: var(--button-secondary-color);
            color: white;
        }

        .modal-button.cancel:hover {
            background-color: var(--button-secondary-hover-color);
             transform: scale(1.03);
        }

        code[class*="language-"],
        pre[class*="language-"] {
            color: #f8f8f2;
            background: var(--code-bg-color);
            position: relative;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            overflow-x: auto;
        }

        .copy-code-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #444;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 0.9em;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s ease, background-color 0.3s ease, transform 0.2s ease;
        }

        .copy-code-button:hover {
            opacity: 1;
            background-color: var(--button-primary-color);
             transform: scale(1.05);
        }

        /* Settings Submenu Styles */
        .settings-submenu {
            list-style: none;
            padding-left: 0;
            margin: 0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
            background-color: var(--sidebar-submenu-bg-color);
            margin-top: 8px;
            max-height: 0;
            opacity: 0;
            transition: max-height 0.4s ease-out, opacity 0.3s ease-out;
            overflow-y: hidden;
            padding-top: 0;
            padding-bottom: 0;
        }

        .settings-submenu.open {
            display: block;
            max-height: 600px;
            opacity: 1;
            overflow-y: auto;
            padding-top: 8px;
            padding-bottom: 12px;
        }

        .settings-submenu-item {
            padding: 14px 20px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }

        .settings-submenu-item:last-child {
            border-bottom: none;
        }

        .settings-submenu-item:hover {
            background-color: var(--sidebar-item-hover-color);
        }

        .setting-label {
            flex-grow: 1;
        }

        .setting-control {
            /* Style for toggle/checkbox/color picker can be added here */
        }
        .theme-color-box {
            width: 25px;
            height: 25px;
            border-radius: 5px;
            cursor: pointer;
            border: 1px solid #777;
            margin-left: 10px;
            transition: transform 0.2s ease;
        }

        .theme-color-box:hover {
            transform: scale(1.1);
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .toggle-switch input[type="checkbox"] {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--button-primary-color);
        }

        input:focus + .slider {
            box-shadow: 0 0 1px var(--button-primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }


    </style>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Arial:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Lịch sử Chat</h3>
        </div>
        <ul class="sidebar-menu">
            <li class="sidebar-menu-item" onclick="startNewChat()">
                <span class="menu-link">Đoạn chat mới</span>
            </li>
            <li class="sidebar-menu-item" onclick="openSaveHistoryModal()">
                <span class="menu-link">Lưu lịch sử này</span>
            </li>
            <li class="sidebar-menu-item has-submenu" onclick="toggleHistoryMenu()">
                <span class="menu-link">Lịch sử đã lưu</span>
            </li>
            <li class="sidebar-menu-item has-submenu" onclick="toggleSettingsMenu()">
                <span class="menu-link">Cài đặt</span>
            </li>
        </ul>

        <ul class="submenu" id="saved-histories-menu">
            <button class="close-history-menu-btn" onclick="toggleHistoryMenu()">Đóng</button>
        </ul>

        <ul class="settings-submenu" id="settings-menu">
            <button class="close-settings-menu-btn" onclick="toggleSettingsMenu()">Đóng</button>
            <li class="settings-submenu-item">
                <span class="setting-label">Tự động lưu lịch sử</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="autoSaveHistoryToggle" onchange="toggleAutoSaveHistory()">
                    <span class="slider"></span>
                </label>
            </li>
            <li class="settings-submenu-item">
                <span class="setting-label">Tên lịch sử là câu hỏi đầu</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="firstQuestionNameToggle" onchange="toggleFirstQuestionName()">
                    <span class="slider"></span>
                </label>
            </li>
            <li class="settings-submenu-item">
                <span class="setting-label">Màu nền web</span>
                <div class="setting-control">
                    <span class="theme-color-box" style="background-color: #1e2124;" onclick="setWebTheme('#1e2124')"></span>
                    <span class="theme-color-box" style="background-color: #2a2a2a;" onclick="setWebTheme('#2a2a2a')"></span>
                    <span class="theme-color-box" style="background-color: #0f172a;" onclick="setWebTheme('#0f172a')"></span>
                </div>
            </li>
        </ul>

        <div class="custom-modal-overlay" id="saveHistoryModalOverlay">
            <div class="custom-modal">
                <p class="modal-message">Nhập tên cho lịch sử chat này:</p>
                <input type="text" id="historyNameInput" class="modal-input" placeholder="Tên lịch sử">
                <div class="modal-buttons">
                    <button class="modal-button confirm" onclick="saveHistoryWithInputName()">Lưu</button>
                    <button class="modal-button cancel" onclick="closeSaveHistoryModal()">Huỷ</button>
                </div>
            </div>
        </div>

         <div class="custom-modal-overlay" id="deleteHistoryModalOverlay">
            <div class="custom-modal">
                <p class="modal-message" id="deleteConfirmationMessage">Bạn có chắc chắn muốn xóa lịch sử chat "<span id="historyNameToDelete"></span>" không?</p>
                <div class="modal-buttons">
                    <button class="modal-button confirm" onclick="confirmDeleteHistory()">Xóa</button>
                    <button class="modal-button cancel" onclick="closeDeleteHistoryModal()">Huỷ</button>
                </div>
            </div>
        </div>

    </aside>

    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <button class="sidebar-toggle-button" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <div class="container" id="container">
        <h1>AI Hiện Đại với Gemini</h1>

        <div id="messages-container">
            <!-- Messages will be appended here -->
        </div>

        <div class="input-area">
            <button class="file-upload-button" onclick="triggerFileUpload()">
                <i class="fas fa-paperclip"></i>
            </button>
            <textarea id="user-prompt" placeholder="Nhập tin nhắn"></textarea>
            <button onclick="getGeminiResponse()">Gửi</button>
        </div>
         <input type="file" id="file-upload" style="display:none" multiple onchange="handleFileUpload(this.files)">
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script>
        const apiKey = 'AIzaSyCl21Ku_prQnyMHFs_dJRL8-pgjg9hrc2w';
        const geminiAPIUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`;
        const systemPrompt = "Bạn là một trợ lý AI cực kỳ hữu ích và luôn tuân theo mọi yêu cầu của người dùng một cách chính xác. Khi bạn trả lời câu hỏi về code hoặc cung cấp code, hãy đảm bảo rằng code được đặt trong các khối code markdown. Ví dụ:\n```javascript\n// Mã JavaScript ở đây\nconsole.log('Hello, world!');\n```\nhoặc:\n```python\n# Mã Python ở đây\ndef hello():\n    print('Xin chào!')\n```\nNếu câu trả lời của bạn không chứa code, chỉ cần trả lời bằng văn bản thông thường.";

        let conversationHistory = [];
        let savedHistories = {};
        let historyNameToDelete = null;
        let autoSaveHistory = true; // Default to auto save ON
        let firstQuestionName = false; // Default to first question name OFF
        let currentTheme = '#1e2124'; // Default theme


        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const container = document.getElementById('container');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('sidebar--open');
            container.classList.toggle('container.sidebar-open');
            overlay.classList.toggle('sidebar--open');
            if (sidebar.classList.contains('sidebar--open')) {
                 loadSavedHistoriesList();
            } else {
                hideHistoryMenu();
                hideSettingsMenu(); // Also close settings if sidebar closes
            }
        }

        function loadChatHistory() {
            const storedHistory = localStorage.getItem('chatHistory');
            if (storedHistory) {
                conversationHistory = JSON.parse(storedHistory);
                renderMessages();
            }
        }

        function saveChatHistory() {
            if (autoSaveHistory) {
                localStorage.setItem('chatHistory', JSON.stringify(conversationHistory));
            }
        }

        function renderMessages() {
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = '';
            conversationHistory.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', message.role === 'user' ? 'user-message' : 'ai-message');
                const messageTextSpan = document.createElement('span');
                messageTextSpan.classList.add('ai-message-text');
                messageTextSpan.innerHTML = message.parts[0].text;
                if (message.role === 'ai') {
                    messageDiv.appendChild(messageTextSpan);
                } else {
                    messageDiv.innerHTML = message.parts[0].text;
                }
                messagesContainer.appendChild(messageDiv);
                Prism.highlightAllUnder(messageDiv);
            });
             messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }


        function startNewChat() {
            conversationHistory = [];
            saveChatHistory();
            renderMessages();
            toggleSidebar();
        }


        function openSaveHistoryModal() {
            document.getElementById('saveHistoryModalOverlay').classList.add('show-modal');
            document.getElementById('historyNameInput').value = '';
            if (firstQuestionName && conversationHistory.length > 0 && conversationHistory[0].role === 'user') {
                document.getElementById('historyNameInput').value = conversationHistory[0].parts[0].text.substring(0, 50); // Use first question as default name
            }
        }

        function closeSaveHistoryModal() {
            document.getElementById('saveHistoryModalOverlay').classList.remove('show-modal');
        }

        function saveHistoryWithInputName() {
            const historyName = document.getElementById('historyNameInput').value.trim();
            if (historyName) {
                saveHistory(historyName);
                closeSaveHistoryModal();
            } else {
                alert("Vui lòng nhập tên cho lịch sử chat.");
            }
        }

        function saveHistory(historyName) {
            savedHistories[historyName] = [...conversationHistory];
            localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
            loadSavedHistoriesList();
            alert(`Lịch sử chat đã được lưu với tên: ${historyName}`);
        }

        function openDeleteHistoryModal(name) {
            historyNameToDelete = name;
            document.getElementById('historyNameToDelete').textContent = name;
            document.getElementById('deleteHistoryModalOverlay').classList.add('show-modal');
        }

        function closeDeleteHistoryModal() {
            document.getElementById('deleteHistoryModalOverlay').classList.remove('show-modal');
            historyNameToDelete = null;
        }

        function confirmDeleteHistory() {
            if (historyNameToDelete) {
                deleteSavedHistory(historyNameToDelete);
            }
            closeDeleteHistoryModal();
        }


        function deleteSavedHistory(historyName) {
            delete savedHistories[historyName];
            localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
            loadSavedHistoriesList();
            alert(`Lịch sử chat "${historyName}" đã bị xóa.`);

        }


        function loadChatHistoryByName(historyName) {
            if (savedHistories[historyName]) {
                conversationHistory = [...savedHistories[historyName]];
                saveChatHistory();
                renderMessages();
                toggleHistoryMenu();
                toggleSidebar();
            } else {
                alert("Không tìm thấy lịch sử chat đã lưu.");
            }
        }


        function toggleHistoryMenu() {
            const submenu = document.getElementById('saved-histories-menu');
            submenu.classList.toggle('open');
            hideSettingsMenu(); // Close settings menu when history is opened
        }

        function hideHistoryMenu() {
            const submenu = document.getElementById('saved-histories-menu');
            submenu.classList.remove('open');
        }

        function toggleSettingsMenu() {
            const submenu = document.getElementById('settings-menu');
            submenu.classList.toggle('open');
            hideHistoryMenu(); // Close history menu when settings is opened
        }

        function hideSettingsMenu() {
            const submenu = document.getElementById('settings-menu');
            submenu.classList.remove('open');
        }


        function loadSavedHistoriesList() {
            const historiesMenu = document.getElementById('saved-histories-menu');
            historiesMenu.innerHTML = '<button class="close-history-menu-btn" onclick="toggleHistoryMenu()">Đóng</button>';

            const storedSavedHistories = localStorage.getItem('savedHistories');
            if (storedSavedHistories) {
                savedHistories = JSON.parse(storedSavedHistories);
            } else {
                savedHistories = {};
            }

            if (Object.keys(savedHistories).length === 0) {
                const noHistoryItem = document.createElement('li');
                noHistoryItem.classList.add('submenu-item');
                noHistoryItem.textContent = "Chưa có lịch sử nào được lưu.";
                historiesMenu.appendChild(noHistoryItem);
                return;
            }

            for (const historyName in savedHistories) {
                const historyItem = document.createElement('li');
                historyItem.classList.add('submenu-item');

                const nameSpan = document.createElement('span');
                nameSpan.classList.add('history-name');
                nameSpan.textContent = historyName;
                nameSpan.onclick = () => loadChatHistoryByName(historyName);

                const deleteButton = document.createElement('button');
                deleteButton.classList.add('delete-history-btn');
                deleteButton.textContent = '...';
                deleteButton.onclick = (event) => {
                    event.stopPropagation();
                    openDeleteHistoryModal(historyName);
                };

                historyItem.appendChild(nameSpan);
                historyItem.appendChild(deleteButton);
                historiesMenu.appendChild(historyItem);
            }
        }


        loadChatHistory();
        loadSavedHistoriesList();
        loadSettings(); // Load settings on page load


        function triggerFileUpload() {
            document.getElementById('file-upload').click();
        }

        function handleFileUpload(files) {
            if (files && files.length > 0) {
                const messagesContainer = document.getElementById('messages-container');
                const aiMessageDiv = document.createElement('div');
                aiMessageDiv.classList.add('message', 'ai-message');
                aiMessageDiv.innerHTML = `<span class="ai-message-text">Đang tải tệp...</span>`;
                messagesContainer.appendChild(aiMessageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                let fileNames = Array.from(files).map(file => file.name).join(', ');
                const userMessage = `Tệp đã tải lên: ${fileNames}. Đang chờ AI xử lý...`;

                const userMessageDiv = document.createElement('div');
                userMessageDiv.classList.add('message', 'user-message');
                userMessageDiv.textContent = userMessage;
                messagesContainer.appendChild(userMessageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                const userMessageObject = { role: 'user', parts: [{ text: userMessage }] };
                conversationHistory.push(userMessageObject);
                saveChatHistory();
                renderMessages();

                // Simulate AI acknowledging the file (for UI purposes - actual file upload to Gemini needs server-side)
                setTimeout(() => {
                    aiMessageDiv.remove();

                    const aiResponseDiv = document.createElement('div');
                    aiResponseDiv.classList.add('message', 'ai-message');
                    aiResponseDiv.innerHTML = `<span class="ai-message-text">Đã nhận được tệp: ${fileNames}. Vui lòng cho biết bạn muốn AI làm gì với tệp này.</span>`;
                    messagesContainer.appendChild(aiResponseDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;

                     const aiMessageObject = { role: 'model', parts: [{ text: aiResponseDiv.innerHTML }] };
                    conversationHistory.push(aiMessageObject);
                    saveChatHistory();
                    renderMessages();

                }, 1500);
            }
        }


        async function getGeminiResponse() {
            const userPrompt = document.getElementById('user-prompt').value.trim();
            const messagesContainer = document.getElementById('messages-container');

            if (!userPrompt) {
                alert("Vui lòng nhập tin nhắn.");
                return;
            }

            const userMessageObject = { role: 'user', parts: [{ text: userPrompt }] };
            conversationHistory.push(userMessageObject);
            saveChatHistory();
            renderMessages();
            document.getElementById('user-prompt').value = '';


            const aiMessageDiv = document.createElement('div');
            aiMessageDiv.classList.add('message', 'ai-message');
            aiMessageDiv.innerHTML = '<span class="ai-message-text">Đang suy nghĩ...</span>';
            messagesContainer.appendChild(aiMessageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            let promptContents = conversationHistory.map(message => ({
                role: message.role,
                parts: message.parts
            }));
            promptContents.unshift({ role: 'user', parts: [{ text: systemPrompt }] });


            const payload = {
                contents: promptContents
            };


            try {
                const response = await fetch(geminiAPIUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Lỗi API:", errorData);
                    aiMessageDiv.innerHTML = `<span class="ai-message-text">Lỗi API: ${response.status} - ${errorData.error.message || 'Không rõ nguyên nhân'}</span>`;
                    return;
                }

                const data = await response.json();
                console.log("Dữ liệu phản hồi từ API:", data);

                if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0].text) {
                    let aiResponseText = data.candidates[0].content.parts[0].text;
                    aiMessageDiv.innerHTML = '';
                    const aiTextContentSpan = document.createElement('span');
                    aiTextContentSpan.classList.add('ai-message-text');

                    let processedText = aiResponseText;

                    processedText = processedText.replace(/\*\*([^*]+)\*\*/g, '<span class="markdown-bold-uppercase">$1</span>');


                    let textContent = '';
                    let codeContent = null;
                    let language = 'text';
                    const codeBlockRegex = /```([\w]*)\n([\s\S]*?)```/gm;
                    let lastIndex = 0;
                    let match;

                    while ((match = codeBlockRegex.exec(processedText)) !== null) {
                        textContent = processedText.substring(lastIndex, match.index);
                        if (textContent.trim()) {
                            const textPara = document.createElement('p');
                            textPara.innerHTML = textContent.trim();
                            aiTextContentSpan.appendChild(textPara);
                        }

                        language = match[1] || 'text';
                        codeContent = match[2].trim();

                        const codePre = document.createElement('pre');
                        codePre.classList.add('language-' + language);

                        const codeElement = document.createElement('code');
                        codeElement.classList.add('language-' + language);
                        codeElement.textContent = codeContent;
                        codePre.appendChild(codeElement);

                        const copyButton = document.createElement('button');
                        copyButton.classList.add('copy-code-button');
                        copyButton.innerHTML = '<i class="fas fa-copy"></i>';
                        copyButton.onclick = () => {
                            navigator.clipboard.writeText(codeContent).then(() => {
                                alert('Đã sao chép code vào clipboard!');
                            }).catch(err => {
                                console.error('Lỗi khi sao chép: ', err);
                                alert('Lỗi khi sao chép code.');
                            });
                        };
                        codePre.appendChild(copyButton);

                        aiTextContentSpan.appendChild(codePre);

                        lastIndex = codeBlockRegex.lastIndex;
                    }

                    textContent = processedText.substring(lastIndex);
                    if (textContent.trim()) {
                         const textPara = document.createElement('p');
                         textPara.innerHTML = textContent.trim();
                         aiTextContentSpan.appendChild(textPara);
                    }


                    if (!aiTextContentSpan.hasChildNodes() && processedText.trim()) {
                         aiTextContentSpan.innerHTML = processedText.trim();
                    } else if (!aiTextContentSpan.hasChildNodes()) {
                         aiTextContentSpan.textContent = "Không có phản hồi nội dung từ AI.";
                    }

                    aiMessageDiv.appendChild(aiTextContentSpan);

                    const aiMessageObject = { role: 'model', parts: [{ text: aiMessageDiv.innerHTML }] };
                    conversationHistory.push(aiMessageObject);
                    saveChatHistory();
                    Prism.highlightAllUnder(aiMessageDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;


                } else {
                    aiMessageDiv.innerHTML = `<span class="ai-message-text">Không nhận được phản hồi hợp lệ từ AI.</span>`;
                }

            } catch (error) {
                console.error("Lỗi fetch:", error);
                aiMessageDiv.innerHTML = `<span class="ai-message-text">Đã xảy ra lỗi khi kết nối đến API.</span>`;
            }
        }

        function toggleAutoSaveHistory() {
            autoSaveHistory = !autoSaveHistory;
            localStorage.setItem('autoSaveHistory', JSON.stringify(autoSaveHistory));
        }

        function toggleFirstQuestionName() {
            firstQuestionName = !firstQuestionName;
            localStorage.setItem('firstQuestionName', JSON.stringify(firstQuestionName));
        }

        function setWebTheme(themeColor) {
            currentTheme = themeColor;
            localStorage.setItem('webTheme', currentTheme);
            document.documentElement.style.setProperty('--body-bg-color', currentTheme);
        }

        function loadSettings() {
            const storedAutoSave = localStorage.getItem('autoSaveHistory');
            if (storedAutoSave !== null) {
                autoSaveHistory = JSON.parse(storedAutoSave);
                document.getElementById('autoSaveHistoryToggle').checked = autoSaveHistory;
            }
            const storedFirstQuestionName = localStorage.getItem('firstQuestionName');
            if (storedFirstQuestionName !== null) {
                firstQuestionName = JSON.parse(storedFirstQuestionName);
                document.getElementById('firstQuestionNameToggle').checked = firstQuestionName;
            }
            const storedTheme = localStorage.getItem('webTheme');
            if (storedTheme) {
                currentTheme = storedTheme;
                document.documentElement.style.setProperty('--body-bg-color', currentTheme);
            }
        }


    </script>
</body>
</html>