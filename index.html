<!DOCTYPE html>
<html>
<head>
    <title>AI Chatbot - Gemini API</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        /* CSS Dark Mode hiện đại và Responsive (giữ nguyên - không thay đổi) */
        :root {
            --bg-color: #121212;
            --text-color: #f0f0f0;
            --primary-color: #64ffda;
            --secondary-bg: #1e1e1e;
            --border-color: #333;
            --message-user-bg: #2962ff;
            --message-ai-bg: #4caf50;
            --button-bg: #3498db;
            --button-hover-bg: #2980b9;
            --menu-bg: #252525;
            --loading-color: #ffc107;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-top: 20px;
            margin-bottom: 30px;
        }

        .container {
            width: 95%;
            max-width: 800px;
            background-color: var(--secondary-bg);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            margin-bottom: 30px;
        }

        /* Menu danh mục (giữ nguyên) */
        .menu-container {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .menu-button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            background-color: var(--button-bg);
            color: var(--text-color);
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s ease-in-out;
        }

        .menu-button:hover {
            background-color: var(--button-hover-bg);
            transform: scale(1.05);
        }

        .menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--menu-bg);
            border-radius: 5px;
            overflow: hidden;
            display: none;
            transform-origin: top right;
            transform: scaleY(0);
            transition: transform 0.3s ease-out;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            z-index: 10;
        }

        .menu-dropdown.active {
            display: block;
            transform: scaleY(1);
        }

        .menu-dropdown button {
            display: block;
            width: 100%;
            padding: 10px 20px;
            border: none;
            background-color: transparent;
            color: var(--text-color);
            text-align: left;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .menu-dropdown button:hover {
            background-color: #333;
        }


        /* Form đăng nhập/đăng ký (giữ nguyên) */
        .auth-container {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            margin-bottom: 20px;
        }

        .auth-container h2 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .auth-container label {
            margin-bottom: 8px;
            color: #ccc;
        }

        .auth-container input {
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 16px;
            background-color: var(--secondary-bg);
            color: var(--text-color);
            transition: border-color 0.3s;
        }

        .auth-container input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(100, 255, 218, 0.2);
        }

        .auth-container button {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            background-color: var(--button-bg);
            color: var(--text-color);
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s ease-in-out;
        }

        .auth-container button:hover {
            background-color: var(--button-hover-bg);
            transform: scale(1.02);
        }

        .auth-switch {
            text-align: center;
            margin-top: 10px;
            color: #aaa;
        }

        .auth-switch a {
            color: var(--primary-color);
            text-decoration: none;
        }

        .auth-switch a:hover {
            text-decoration: underline;
        }

        /* Hiển thị tên người dùng (giữ nguyên) */
        #username-display {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
        }

        #username-display.logged-out-message {
            color: #e74c3c;
        }


        /* Chat container (giữ nguyên) */
        #chat-container {
            border: 1px solid var(--border-color);
            padding: 20px;
            height: 400px;
            overflow-y: scroll;
            margin-bottom: 20px;
            border-radius: 8px;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) var(--secondary-bg);
            position: relative; /* Cần thiết cho loading indicator */
        }

        /* Chrome, Safari and Opera */
        #chat-container::-webkit-scrollbar {
            width: 8px;
        }

        #chat-container::-webkit-scrollbar-track {
            background-color: var(--secondary-bg);
            border-radius: 10px;
        }

        #chat-container::-webkit-scrollbar-thumb {
            background-color: var(--primary-color);
            border-radius: 10px;
        }

        .user-message, .ai-message, .loading-message {
            padding: 10px 15px;
            border-radius: 20px;
            margin-bottom: 10px;
            max-width: 80%;
            clear: both;
            word-wrap: break-word;
        }

        .user-message {
            background-color: var(--message-user-bg);
            color: var(--text-color);
            align-self: flex-end;
            text-align: right;
        }

        .ai-message {
            background-color: var(--message-ai-bg);
            color: var(--text-color);
            align-self: flex-start;
            text-align: left;
        }

        .loading-message {
            background-color: var(--secondary-bg);
            color: var(--loading-color);
            align-self: flex-start;
            text-align: left;
            font-style: italic;
        }


        /* Input container (giữ nguyên) */
        #input-container {
            display: flex;
            margin-bottom: 20px;
        }


        #send-button, #upload-button {
            padding: 12px 20px;
            border: none;
            background-color: var(--button-bg);
            color: var(--text-color);
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s ease-in-out;
        }

        #send-button {
            border-radius: 0 5px 5px 0;
            flex-grow: 1;
        }

        #upload-button {
            border-radius: 5px 0 0 5px;
            margin-right: 0;
        }


        #send-button:hover, #upload-button:hover {
            background-color: var(--button-hover-bg);
            transform: scale(1.02);
        }


        /* API Key container (ĐÃ XÓA KHỎI HTML) - CSS không cần thiết nữa */
        #api-key-container {
            display: none; /* Ẩn hoàn toàn vì không còn trong HTML */
            margin-bottom: 20px; /* Không còn tác dụng */
        }

        #api-key-input {
            padding: 12px; /* Không còn tác dụng */
            width: calc(100% - 26px); /* Không còn tác dụng */
            border: 1px solid var(--border-color); /* Không còn tác dụng */
            border-radius: 5px; /* Không còn tác dụng */
            font-size: 16px; /* Không còn tác dụng */
            background-color: var(--secondary-bg); /* Không còn tác dụng */
            color: var(--text-color); /* Không còn tác dụng */
            transition: border-color 0.3s; /* Không còn tác dụng */
        }

        #api-key-input:focus {
            border-color: var(--primary-color); /* Không còn tác dụng */
            outline: none; /* Không còn tác dụng */
            box-shadow: 0 0 0 2px rgba(100, 255, 218, 0.2); /* Không còn tác dụng */
        }

        /* Nút chat mới và tải lại lịch sử (ẩn trong menu) - giữ nguyên */
        #new-chat-button, #load-history-button {
            display: none;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            color: var(--text-color);
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s ease-in-out;
            margin-bottom: 20px;
            margin-right: 10px;
        }

        #new-chat-button {
            background-color: #27ae60;
        }

        #new-chat-button:hover {
            background-color: #219653;
        }

        #load-history-button {
            background-color: #f39c12;
        }

        #load-history-button:hover {
            background-color: #e67e22;
        }


        /* Ẩn container chat và prompt khi chưa đăng nhập (giữ nguyên) */
        #chat-interface-container {
            display: none;
        }

        /* Responsive adjustments (giữ nguyên) */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 24px;
                margin-bottom: 20px;
            }

            #chat-container {
                height: 300px;
            }

            #input-container {
                flex-direction: column;
            }


            #send-button, #upload-button {
                border-radius: 5px;
                width: 100%;
                margin-bottom: 10px;
            }

            #upload-button {
                margin-right: 0;
                border-radius: 5px;
            }

            #send-button {
                border-radius: 5px;
                margin-bottom: 0;
            }


            .menu-button {
                font-size: 14px;
                padding: 8px 12px;
            }
            .menu-dropdown button {
                padding: 10px 15px;
                font-size: 14px;
            }
        }


    </style>
</head>
<body>

    <div class="container">
        <h1>AI Chatbot - Gemini API</h1>

        <div class="menu-container">
            <button class="menu-button" onclick="toggleMenu()">Danh mục</button>
            <div class="menu-dropdown" id="menuDropdown">
                <button onclick="startNewChat()">Bắt đầu cuộc trò chuyện mới</button>
                <button onclick="loadChatHistory()">Tải lại lịch sử</button>
                <button onclick="logoutUser()">Đăng xuất</button>
            </div>
        </div>

        <!-- Container đăng nhập/đăng ký (giữ nguyên) -->
        <div id="auth-forms-container">
            <div id="login-form" class="auth-container">
                <h2>Đăng nhập</h2>
                <label for="login-username">Tên người dùng:</label>
                <input type="text" id="login-username" placeholder="Nhập tên người dùng">
                <label for="login-password">Mật khẩu:</label>
                <input type="password" id="login-password" placeholder="Nhập mật khẩu">
                <button onclick="loginUser()">Đăng nhập</button>
                <div class="auth-switch">
                    <a href="#" onclick="showRegisterForm(); return false;">Chưa có tài khoản? Đăng ký ngay</a>
                </div>
            </div>

            <div id="register-form" class="auth-container" style="display: none;">
                <h2>Đăng ký</h2>
                <label for="register-username">Tên người dùng:</label>
                <input type="text" id="register-username" placeholder="Chọn tên người dùng">
                <label for="register-password">Mật khẩu:</label>
                <input type="password" id="register-password" placeholder="Chọn mật khẩu">
                <button onclick="registerUser()">Đăng ký</button>
                <div class="auth-switch">
                    <a href="#" onclick="showLoginForm(); return false;">Đã có tài khoản? Đăng nhập</a>
                </div>
            </div>
        </div>

        <!-- Hiển thị tên người dùng / thông báo đăng ký (giữ nguyên) -->
        <div id="username-display"></div>

        <!-- Container giao diện chat (ẩn khi chưa đăng nhập) -->
        <div id="chat-interface-container" style="display: none;">


            <div id="chat-container">
                <!-- Tin nhắn chat sẽ hiển thị ở đây -->
            </div>


            <div id="input-container">
                <input type="file" id="file-upload" style="display: none;" accept=".txt">
                <button id="upload-button" onclick="document.getElementById('file-upload').click();">Tải tệp lên</button>
                <button id="send-button" onclick="sendMessage()">Gửi</button>
            </div>
        </div>
    </div>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const promptInput = document.getElementById('prompt-input');
        const apiKeyInput = document.getElementById('api-key-input'); // Vẫn giữ lại để tránh lỗi tham chiếu cũ
        const usernameDisplay = document.getElementById('username-display');
        const chatInterfaceContainer = document.getElementById('chat-interface-container');
        const authFormsContainer = document.getElementById('auth-forms-container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginUsernameInput = document.getElementById('login-username');
        const loginPasswordInput = document.getElementById('login-password');
        const registerUsernameInput = document.getElementById('register-username');
        const registerPasswordInput = document.getElementById('register-password');
        const fileUploadInput = document.getElementById('file-upload');
        const menuDropdown = document.getElementById('menuDropdown');


        let conversationHistory = [];
        let currentUsername = '';
        let isLoading = false;

        // API Key Gemini của bạn (CỐ ĐỊNH TRONG CODE)
        const GEMINI_API_KEY_DEFAULT = 'AIzaSyCl21Ku_prQnyMHFs_dJRL8-pgjg9hrc2w';
        let currentApiKey = GEMINI_API_KEY_DEFAULT;
        const FIXED_PROMPT = "Bạn là một trợ lý AI hữu ích, thông minh và luôn trả lời một cách chi tiết và chính xác. Hãy giúp người dùng giải quyết mọi vấn đề và cung cấp thông tin tốt nhất có thể.";


        // --- Hàm hỗ trợ writeFile (mô phỏng lưu file) ---
        function writeFile(filepath, data) {
            localStorage.setItem(filepath, JSON.stringify(data));
        }

        // --- Hàm hỗ trợ readFile (mô phỏng đọc file) ---
        function readFile(filepath) {
            const data = localStorage.getItem(filepath);
            return data ? JSON.parse(data) : null;
        }


        // --- Menu Danh mục (giữ nguyên) ---
        function toggleMenu() {
            menuDropdown.classList.toggle('active');
        }

        window.addEventListener('click', function(event) {
            if (!event.target.matches('.menu-button')) {
                if (menuDropdown.classList.contains('active')) {
                    menuDropdown.classList.remove('active');
                }
            }
        });


        // --- Chuyển đổi form đăng nhập/đăng ký (giữ nguyên) ---
        function showRegisterForm() {
            loginForm.style.display = 'none';
            registerForm.style.display = 'block';
            usernameDisplay.textContent = '';
        }

        function showLoginForm() {
            registerForm.style.display = 'none';
            loginForm.style.display = 'block';
            usernameDisplay.textContent = '';
        }


        // --- Quản lý người dùng và đăng nhập/đăng ký (CẬP NHẬT LƯU FILE) ---
        function registerUser() {
            const username = registerUsernameInput.value.trim();
            const password = registerPasswordInput.value.trim();

            if (!username || !password) {
                alert("Vui lòng nhập tên người dùng và mật khẩu.");
                return;
            }

            // Mô phỏng đường dẫn file thông tin người dùng
            const userFilePath = `user/${username}/info.json`;

            if (readFile(userFilePath)) { // Kiểm tra "file" tồn tại
                alert("Tên người dùng đã tồn tại. Vui lòng chọn tên người dùng khác.");
                return;
            }

            // Lưu thông tin người dùng vào "file" info.json
            writeFile(userFilePath, { username: username, password: password });
            alert("Đăng ký thành công. Vui lòng đăng nhập.");
            showLoginForm();
        }


        function loginUser() {
            const username = loginUsernameInput.value.trim();
            const password = loginPasswordInput.value.trim();

            if (!username || !password) {
                alert("Vui lòng nhập tên người dùng và mật khẩu.");
                return;
            }

            // Mô phỏng đường dẫn file thông tin người dùng
            const userFilePath = `user/${username}/info.json`;
            const userInfo = readFile(userFilePath); // Đọc thông tin từ "file"

            if (userInfo && userInfo.password === password) {
                currentUsername = username;
                saveUsername(username);
                displayUsername();
                authFormsContainer.style.display = 'none';
                chatInterfaceContainer.style.display = 'block';
                loadChatHistory();
            } else {
                alert("Đăng nhập thất bại. Tên người dùng hoặc mật khẩu không đúng.");
            }
        }

        function logoutUser() {
            currentUsername = '';
            localStorage.removeItem('geminiChatCurrentUsername');
            localStorage.removeItem(`chatHistory_${currentUsername}`);
            conversationHistory = [];
            chatContainer.innerHTML = '';
            chatInterfaceContainer.style.display = 'none';
            authFormsContainer.style.display = 'block';
            usernameDisplay.textContent = '';
            menuDropdown.classList.remove('active');
        }


        function saveUsername(username) {
            localStorage.setItem('geminiChatCurrentUsername', username);
        }

        function getUsername() {
            return localStorage.getItem('geminiChatCurrentUsername') || '';
        }

        function displayUsername() {
            currentUsername = getUsername();
            if (currentUsername) {
                usernameDisplay.textContent = `Chào mừng, ${currentUsername}!`;
                usernameDisplay.className = '';
            } else {
                usernameDisplay.textContent = 'Bạn cần đăng ký và đăng nhập để sử dụng chatbot.';
                usernameDisplay.className = 'logged-out-message';
            }
        }

        function checkLoginStatus() {
            if (getUsername()) {
                currentUsername = getUsername();
                displayUsername();
                authFormsContainer.style.display = 'none';
                chatInterfaceContainer.style.display = 'block';
                loadChatHistory();
            } else {
                authFormsContainer.style.display = 'block';
                chatInterfaceContainer.style.display = 'none';
                displayUsername();
            }
        }
        checkLoginStatus();


        // --- Quản lý lịch sử chat (CẬP NHẬT LƯU FILE) ---
        function loadChatHistory() {
            if (!currentUsername) return;

            // Mô phỏng đường dẫn file lịch sử chat
            const historyFilePath = `user/${currentUsername}/history.json`;
            const history = readFile(historyFilePath); // Đọc lịch sử từ "file"

            if (history) {
                conversationHistory = history;
                chatContainer.innerHTML = '';
                conversationHistory.forEach(message => {
                    if (message.role === 'user') {
                        addUserMessageToUI(message.parts[0].text, 'user-message');
                    } else if (message.role === 'model') {
                        addAiMessageToUI(message.parts[0].text, 'ai-message');
                    }
                });
                chatContainer.scrollTop = chatContainer.scrollHeight;
            } else {
                chatContainer.innerHTML = '';
                conversationHistory = [];
            }
            menuDropdown.classList.remove('active');
        }


        function saveChatHistory() {
            if (currentUsername) {
                // Mô phỏng đường dẫn file lịch sử chat
                const historyFilePath = `user/${currentUsername}/history.json`;
                writeFile(historyFilePath, conversationHistory); // Lưu lịch sử vào "file"
            }
        }

        function clearChatHistory() {
            if (currentUsername) {
                saveChatHistory();
                conversationHistory = [];
                // Mô phỏng đường dẫn file lịch sử chat (không xóa "file", chỉ làm trống lịch sử)
                // const historyFilePath = `user/${currentUsername}/history.json`;
                // localStorage.removeItem(historyFilePath); // Không xóa file, chỉ làm trống nội dung
                chatContainer.innerHTML = '';
            }
        }

        function startNewChat() {
            clearChatHistory();
            menuDropdown.classList.remove('active');
        }


        // --- Xử lý tải tệp (giữ nguyên) ---
        fileUploadInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                let fileContent = event.target.result;
                sendMessage(fileContent);
            };
            reader.readAsText(file);
        });


        // --- Gửi và nhận tin nhắn (giữ nguyên) ---
        function sendMessage(userMessageFromFile = null) {
            if (!currentUsername) {
                alert("Bạn cần đăng nhập để sử dụng chatbot.");
                return;
            }

            let userMessage;
            if (userMessageFromFile) {
                userMessage = userMessageFromFile;
            } else {
                userMessage = promptInput.value;
                promptInput.value = '';
            }


            if (!userMessage && !userMessageFromFile) {
                return;
            }

            const apiKey = currentApiKey;


            addUserMessage(userMessage);
            showLoadingIndicator();

            const combinedPrompt = `${FIXED_PROMPT}\n\n${userMessage}`;

            sendToGeminiAPI(apiKey, combinedPrompt);
        }

        function addUserMessage(message) {
            addUserMessageToUI(message, 'user-message');
            conversationHistory.push({ role: "user", parts: [{ text: message }] });
            saveChatHistory();
        }

        function addUserMessageToUI(message, className) {
            const messageDiv = document.createElement('div');
            messageDiv.className = className;
            messageDiv.textContent = message;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }


        function addAiMessage(message) {
            hideLoadingIndicator();
            addAiMessageToUI(message, 'ai-message');
            conversationHistory.push({ role: "model", parts: [{ text: message }] });
            saveChatHistory();
        }

        function addAiMessageToUI(message, className) {
            const messageDiv = document.createElement('div');
            messageDiv.className = className;
            messageDiv.textContent = message;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // --- Hiển thị/Ẩn "Đang tải..." (giữ nguyên) ---
        function showLoadingIndicator() {
            if (!isLoading) {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'loading-message';
                loadingDiv.textContent = 'Đang tải...';
                loadingDiv.id = 'loading-temp-message';
                chatContainer.appendChild(loadingDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                isLoading = true;
            }
        }

        function hideLoadingIndicator() {
            const loadingMessage = document.getElementById('loading-temp-message');
            if (loadingMessage) {
                loadingMessage.remove();
                isLoading = false;
            }
        }


        async function sendToGeminiAPI(apiKey, prompt) {
            const apiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent';

            const requestBody = {
                contents: conversationHistory.concat([{ role: "user", parts: [{ text: prompt }] }])
            };

            try {
                const response = await fetch(`${apiUrl}?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    hideLoadingIndicator();
                    const errorData = await response.json();
                    console.error("API Error:", errorData);
                    let errorMessage = `Lỗi API: ${response.status}`;
                    if (errorData.error && errorData.error.message) {
                        errorMessage += ` - ${errorData.error.message}`;
                    } else {
                        errorMessage += ` - Không rõ lỗi. Vui lòng kiểm tra API Key và kết nối mạng.`;
                    }
                    addAiMessage(errorMessage);
                    return;
                }

                const data = await response.json();
                if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0].text) {
                    const aiResponse = data.candidates[0].content.parts[0].text;
                    addAiMessage(aiResponse);
                } else {
                    hideLoadingIndicator();
                    addAiMessage("Không nhận được phản hồi hợp lệ từ AI.");
                }

            } catch (error) {
                hideLoadingIndicator();
                console.error("Fetch error:", error);
                addAiMessage("Lỗi kết nối đến API. Vui lòng kiểm tra kết nối mạng của bạn.");
            }
        }
    </script>

</body>
</html>