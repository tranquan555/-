<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat với Gemini</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style> /* Same styles as before - included for completeness */
        :root {
            --bg-color: #202123;
            --text-color: #e8eaed;
            --primary-color: #00bcd4; /* Turquoise */
            --secondary-color: #35363a;
            --accent-color: #434448;
            --message-bg-user: #343541;
            --message-bg-ai: #444654;
            --code-bg: #272822; /* Darker for code blocks */
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .container {
            width: 95%;
            max-width: 1200px;
            margin: 20px auto;
            padding: 25px;
            background-color: var(--secondary-color);
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            height: 100vh;
            flex-grow: 1;
            margin-left: auto;
            transition: margin-left 0.3s ease;
            border: 1px solid #333;
        }

        .container.sidebar-open {
            margin-left: 250px;
        }

        h1 {
            text-align: center;
            color: #fff;
            margin-bottom: 20px;
            font-size: 2.2em;
            letter-spacing: 0.3px;
            padding-bottom: 15px;
            border-bottom: 1px solid #444;
        }

        #messages-container {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            scrollbar-width: thin;
            scrollbar-color: #555 #252525;
            padding-bottom: 70px;
            border: 1px solid #333;
            border-radius: 8px;
            background-color: var(--bg-color);
        }

        #messages-container::-webkit-scrollbar {
            width: 8px;
        }

        #messages-container::-webkit-scrollbar-track {
            background: #252525;
        }

        #messages-container::-webkit-scrollbar-thumb {
            background-color: #555;
            border-radius: 4px;
        }

        .message {
            margin-bottom: 12px;
            padding: 10px 14px;
            border-radius: 15px;
            clear: both;
            word-wrap: break-word;
            max-width: 80%;
            display: inline-block;
            border: 1px solid #444;
            animation: fadeIn 0.3s ease-in-out; /* Add animation */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            background-color: var(--message-bg-user);
            color: #fff;
            align-self: flex-end;
            float: right;
            border-top-right-radius: 3px;
        }

        .ai-message {
            background-color: var(--message-bg-ai);
            color: var(--text-color);
            align-self: flex-start;
            float: left;
            border-top-left-radius: 3px;
        }

       .ai-message .code-block {
            background-color: var(--code-bg);
            padding: 10px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 5px 0;
            white-space: pre-wrap; /* Important for keeping code formatting */
        }

        .input-area {
            padding: 15px 20px;
            background-color: var(--secondary-color);
            border-top: 1px solid #555;
            display: flex;
            align-items: center;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            box-sizing: border-box;
            padding-left: 20px;
            padding-right: 20px;
            z-index: 100;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
             border-top: 1px solid #444;
        }

        .input-area textarea {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #555;
            border-radius: 8px;
            font-size: 16px;
            background-color: var(--accent-color);
            color: var(--text-color);
            resize: none;
            min-height: 40px;
            overflow-y: auto;
            border: 1px solid #444;
        }

        .input-area textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 5px rgba(0, 188, 212, 0.5);
        }

        .input-area button {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-left: 10px;
            transition: background-color 0.3s ease;
        }

        .input-area button:hover {
            background-color: #0097a7;
        }

        /* Sidebar styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            height: 100%;
            background-color: var(--secondary-color);
            color: var(--text-color);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 200;
            padding-top: 60px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.2);
            overflow-y: auto;
            touch-action: manipulation;
            border-right: 1px solid #444;
        }

        .sidebar.sidebar--open {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #555;
            margin-bottom: 20px;
            border-bottom: 1px solid #444;
        }

        .sidebar-menu {
            padding: 0;
            list-style: none;
        }

        .sidebar-menu-item {
            padding: 15px 20px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid transparent;
            transition: border-bottom-color 0.3s ease;
        }

        .sidebar-menu-item:hover {
            background-color: var(--accent-color);
            border-bottom-color: var(--primary-color);
        }

        .sidebar-menu-item.has-submenu > .menu-link::after {
            content: '>';
            float: right;
            margin-left: 10px;
            font-size: 0.8em;
            display: inline-block;
        }

        .submenu {
            list-style: none;
            padding-left: 0;
            margin: 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            background-color: #2c2c2c;
            margin-top: 5px;
            max-height: 0;
            opacity: 0;
            transition: max-height 0.3s ease-out, opacity 0.2s ease-out;
            overflow-y: hidden;
            padding-top: 0;
            padding-bottom: 0;
        }

        .submenu.open {
            display: block;
            max-height: 500px;
            opacity: 1;
            overflow-y: auto;
            padding-top: 5px;
            padding-bottom: 10px;
        }


        .submenu-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }

        .submenu-item:last-child {
            border-bottom: none;
        }


        .submenu-item:hover {
            background-color: var(--accent-color);
        }

        .history-name {
            flex-grow: 1;
        }

        .delete-history-btn {
            background: transparent;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 1em;
            padding: 0 8px;
            opacity: 0.7;
            transition: opacity 0.2s ease, color 0.2s ease;
        }

        .delete-history-btn:hover {
            opacity: 1;
            color: #fff;
        }

        .sidebar-toggle-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 300;
        }

        .sidebar-toggle-button:hover {
            background-color: #0097a7;
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 150;
            display: none;
        }

        .sidebar-overlay.sidebar--open {
            display: block;
        }

        .close-history-menu-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            cursor: pointer;
            margin-top: 10px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            transition: background-color 0.3s ease;
        }

        .close-history-menu-btn:hover {
            background-color: #0097a7;
        }

        /* Modal Styles */
        .custom-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 400;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }

        .custom-modal-overlay.show-modal {
            display: flex;
            pointer-events: auto;
        }


        .custom-modal {
            background-color: var(--secondary-color);
            color: var(--text-color);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            width: 80%;
            max-width: 400px;
            text-align: center;
            border: 1px solid #444;
        }

        .modal-message {
            margin-bottom: 15px;
        }

        .modal-input {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid #555;
            background-color: var(--accent-color);
            color: var(--text-color);
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .modal-button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
            border: 1px solid #444;
        }

        .modal-button.confirm {
            background-color: var(--primary-color);
            color: white;
        }

        .modal-button.confirm:hover {
            background-color: #0097a7;
        }

        .modal-button.cancel {
            background-color: #555;
            color: white;
        }

        .modal-button.cancel:hover {
            background-color: #666;
        }

        /* Loading Indicator */
        .loading-indicator {
            display: none;
            text-align: center;
            margin-top: 10px;
            font-style: italic;
            color: #888;
        }

        .loading-indicator.active {
            display: block;
        }

        /* Code Styling */
        code[class*="language-"],
        pre[class*="language-"] {
            color: #f8f8f2;
            background: var(--code-bg);
        }
        .token.comment, .token.prolog, .token.doctype, .token.cdata { color: #6c6767; }
        .token.punctuation { color: #f8f8f2; }
        .token.namespace { opacity: .7; }
        .token.property, .token.tag, .token.constant, .token.symbol, .token.deleted { color: #f92672; }
        .token.boolean, .token.number { color: #ae81ff; }
        .token.selector, .token.attr-name, .token.string, .token.char, .token.builtin, .token.inserted { color: #a6e22e; }
        .token.operator, .token.entity, .token.url, .language-css .token.string, .style .token.string { color: #f8f8f2; background: none; }
        .token.atrule, .token.attr-value, .token.keyword { color: var(--primary-color); }
        .token.function, .token.class-name { color: #e6db74; }
        .token.regex, .token.important, .token.variable { color: #fd971f; }
        .token.important, .token.bold { font-weight: bold; }
        .token.italic { font-style: italic; }
        .token.entity { cursor: help; }

        /* Download Button Style */
        .code-download-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 5px;
            display: inline-block; /* Make it inline */
            text-decoration: none; /* Remove underline from link */
        }

        .code-download-button:hover {
            background-color: #0097a7;
        }

        /* Error Message Style */
        .error-message {
            color: #ff4d4d; /* Red */
            margin-top: 5px;
            font-style: italic;
        }

        .history-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid #444;
        }

        .history-list-item:last-child {
            border-bottom: none;
        }

        .history-list-item:hover {
            background-color: var(--accent-color);
        }

        .history-name {
            cursor: pointer;
            flex-grow: 1;
        }

        .history-actions {
            display: flex;
            gap: 5px;
        }

        .history-actions button {
            background: transparent;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 1em;
            padding: 0;
            opacity: 0.7;
            transition: opacity 0.2s ease, color 0.2s ease;
        }

        .history-actions button:hover {
            opacity: 1;
            color: #fff;
        }
    </style>

</head>
<body>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Lịch sử Chat</h3>
        </div>
        <ul class="sidebar-menu">
            <li class="sidebar-menu-item" onclick="startNewChat()">
                <span class="menu-link">Bắt đầu Chat mới</span>
            </li>
            <li class="sidebar-menu-item" onclick="openSaveHistoryModal()">
                <span class="menu-link">Lưu lịch sử này</span>
            </li>
            <li class="sidebar-menu-item has-submenu" onclick="toggleHistoryMenu()">
                <span class="menu-link">Lịch sử đã lưu</span>
            </li>
        </ul>

        <ul class="submenu" id="saved-histories-menu">
            <button class="close-history-menu-btn" onclick="toggleHistoryMenu()">Đóng</button>
            <div id="history-list-container"></div>
        </ul>

        <div class="custom-modal-overlay" id="saveHistoryModalOverlay">
            <div class="custom-modal">
                <p class="modal-message">Nhập tên cho lịch sử chat này:</p>
                <input type="text" id="historyNameInput" class="modal-input" placeholder="Tên lịch sử">
                <div class="modal-buttons">
                    <button class="modal-button confirm" onclick="saveHistoryWithInputName()">Lưu</button>
                    <button class="modal-button cancel" onclick="closeSaveHistoryModal()">Huỷ</button>
                </div>
                <div class="error-message" id="saveHistoryError"></div>
            </div>
        </div>

         <div class="custom-modal-overlay" id="deleteHistoryModalOverlay">
            <div class="custom-modal">
                <p class="modal-message" id="deleteConfirmationMessage">Bạn có chắc chắn muốn xóa lịch sử chat "<span id="historyNameToDelete"></span>" không?</p>
                <div class="modal-buttons">
                    <button class="modal-button confirm" onclick="confirmDeleteHistory()">Xóa</button>
                    <button class="modal-button cancel" onclick="closeDeleteHistoryModal()">Huỷ</button>
                </div>
            </div>
        </div>

    </aside>

    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <button class="sidebar-toggle-button" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <div class="container" id="container">
        <h1>AI Chat với Gemini</h1>

        <div id="messages-container" aria-live="polite">
            <!-- Messages will be appended here -->
        </div>

        <div class="loading-indicator" id="loading-indicator">Đang tải...</div>
        <div class="error-message" id="api-error-message"></div>

        <div class="input-area">
            <textarea id="user-prompt" placeholder="Nhập tin nhắn"></textarea>
            <button onclick="getGeminiResponse()">Gửi</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script>
        const apiKey = 'AIzaSyCl21Ku_prQnyMHFs_dJRL8-pgjg9hrc2w'; // Replace with your actual API key
        const geminiAPIUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`;
        const systemPrompt = "Bạn là một trợ lý AI cực kỳ hữu ích và luôn tuân theo mọi yêu cầu của người dùng một cách chính xác. Khi bạn trả lời câu hỏi về code hoặc cung cấp code, hãy đảm bảo rằng code được đặt trong các khối code markdown. Ví dụ:\n```javascript\n// Mã JavaScript ở đây\nconsole.log('Hello, world!');\n```\nhoặc:\n```python\n# Mã Python ở đây\ndef hello():\n    print('Xin chào!')\n```\nNếu câu trả lời của bạn không chứa code, chỉ cần trả lời bằng văn bản thông thường.";

        let conversationHistory = [];
        let savedHistories = {};
        let historyNameToDelete = null;

        // Helper function to generate a unique ID
        function generateId() {
            return Math.random().toString(36).substring(2, 15);
        }

        // Function to sanitize HTML to prevent XSS attacks
        function sanitizeHTML(text) {
            const element = document.createElement('div');
            element.innerText = text;
            return element.innerHTML;
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const container = document.getElementById('container');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('sidebar--open');
            container.classList.toggle('container.sidebar-open');
            overlay.classList.toggle('sidebar--open');
            if (sidebar.classList.contains('sidebar--open')) {
                 loadSavedHistoriesList();
            } else {
                hideHistoryMenu();
            }
        }

        function loadChatHistory() {
            const storedHistory = localStorage.getItem('chatHistory');
            if (storedHistory) {
                conversationHistory = JSON.parse(storedHistory);
                renderMessages();
            }
        }

        function saveChatHistory() {
            localStorage.setItem('chatHistory', JSON.stringify(conversationHistory));
        }

         function renderMessages() {
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = '';
            conversationHistory.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', message.role === 'user' ? 'user-message' : 'ai-message');

                // Sanitize the message text
                let sanitizedText = sanitizeHTML(message.parts[0].text);
                messageDiv.innerHTML = sanitizedText; // Use innerHTML for sanitized content

                messagesContainer.appendChild(messageDiv);
                Prism.highlightAllUnder(messageDiv);
            });
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }


        function openSaveHistoryModal() {
            document.getElementById('saveHistoryModalOverlay').classList.add('show-modal');
            document.getElementById('historyNameInput').value = '';
            document.getElementById('saveHistoryError').textContent = ''; // Clear any previous errors
        }

        function closeSaveHistoryModal() {
            document.getElementById('saveHistoryModalOverlay').classList.remove('show-modal');
        }

        function saveHistoryWithInputName() {
            const historyName = document.getElementById('historyNameInput').value.trim();
            const saveHistoryError = document.getElementById('saveHistoryError');

            if (!historyName) {
                saveHistoryError.textContent = "Vui lòng nhập tên cho lịch sử chat.";
                return;
            }

            if (typeof savedHistories !== 'object') {
                savedHistories = {}; // Initialize if it's not an object
            }

            savedHistories[historyName] = [...conversationHistory];
            localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
            alert(`Lịch sử chat đã được lưu với tên: ${historyName}`);
            loadSavedHistoriesList();
            closeSaveHistoryModal();
        }


        function openDeleteHistoryModal(name) {
            historyNameToDelete = name;
            document.getElementById('historyNameToDelete').textContent = name;
            document.getElementById('deleteHistoryModalOverlay').classList.add('show-modal');
        }

        function closeDeleteHistoryModal() {
            document.getElementById('deleteHistoryModalOverlay').classList.remove('show-modal');
            historyNameToDelete = null;
        }

        function confirmDeleteHistory() {
            if (historyNameToDelete) {
                deleteSavedHistory(historyNameToDelete);
            }
            closeDeleteHistoryModal();
        }

        function deleteSavedHistory(historyName) {
            if (typeof savedHistories === 'object' && savedHistories !== null && historyName in savedHistories) {
                delete savedHistories[historyName];
                localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
                loadSavedHistoriesList();
                alert(`Lịch sử chat "${historyName}" đã bị xóa.`);
            } else {
                console.error("History not found or invalid savedHistories:", historyName, savedHistories);
                alert("Không tìm thấy lịch sử để xóa.");
            }
        }

        function loadChatHistoryByName(historyName) {
             const storedSavedHistories = localStorage.getItem('savedHistories');
            if (storedSavedHistories) {
                savedHistories = JSON.parse(storedSavedHistories);
            } else {
                savedHistories = {};
            }
            if (savedHistories[historyName]) {
                conversationHistory = [...savedHistories[historyName]];
                saveChatHistory();
                renderMessages();
                toggleHistoryMenu();
                toggleSidebar();
            } else {
                alert("Không tìm thấy lịch sử chat đã lưu.");
            }
        }

        function toggleHistoryMenu() {
            const submenu = document.getElementById('saved-histories-menu');
            submenu.classList.toggle('open');
        }

        function hideHistoryMenu() {
            const submenu = document.getElementById('saved-histories-menu');
            submenu.classList.remove('open');
        }

        function loadSavedHistoriesList() {
            const historyListContainer = document.getElementById('history-list-container');
            historyListContainer.innerHTML = '';

            const storedSavedHistories = localStorage.getItem('savedHistories');
            if (storedSavedHistories) {
                savedHistories = JSON.parse(storedSavedHistories);
            } else {
                savedHistories = {};
            }

            if (Object.keys(savedHistories).length === 0) {
                const noHistoryItem = document.createElement('div');
                noHistoryItem.classList.add('history-list-item');
                noHistoryItem.textContent = "Chưa có lịch sử nào được lưu.";
                historyListContainer.appendChild(noHistoryItem);
                return;
            }

            for (const historyName in savedHistories) {
                if (savedHistories.hasOwnProperty(historyName)) {
                    const historyItem = document.createElement('div');
                    historyItem.classList.add('history-list-item');

                    const nameSpan = document.createElement('span');
                    nameSpan.classList.add('history-name');
                    nameSpan.textContent = historyName;
                    nameSpan.onclick = () => loadChatHistoryByName(historyName);

                    const actionsDiv = document.createElement('div');
                    actionsDiv.classList.add('history-actions');

                    const deleteButton = document.createElement('button');
                    deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i>'; // Trash icon
                    deleteButton.onclick = (event) => {
                        event.stopPropagation();
                        openDeleteHistoryModal(historyName);
                    };

                    actionsDiv.appendChild(deleteButton);
                    historyItem.appendChild(nameSpan);
                    historyItem.appendChild(actionsDiv);

                    historyListContainer.appendChild(historyItem);
                }
            }
        }

        function startNewChat() {
            conversationHistory = []; // Clear the current history
            localStorage.removeItem('chatHistory'); // Remove stored history
            renderMessages(); // Re-render to show empty chat
            alert("Đã bắt đầu một cuộc trò chuyện mới.");
        }


        loadChatHistory();
        loadSavedHistoriesList();

        async function getGeminiResponse() {
            const userPrompt = document.getElementById('user-prompt').value.trim();
            const messagesContainer = document.getElementById('messages-container');
            const loadingIndicator = document.getElementById('loading-indicator');
            const apiErrorMessage = document.getElementById('api-error-message');

            apiErrorMessage.textContent = ''; // Clear any previous error messages

            if (!userPrompt) {
                alert("Vui lòng nhập tin nhắn.");
                return;
            }

            const userMessageObject = { role: 'user', parts: [{ text: userPrompt }] };
            conversationHistory.push(userMessageObject);
            saveChatHistory();
            renderMessages();
            document.getElementById('user-prompt').value = '';

            // Create and append the AI message container immediately
            const aiMessageDiv = document.createElement('div');
            aiMessageDiv.classList.add('message', 'ai-message');
            messagesContainer.appendChild(aiMessageDiv);

            // Show loading indicator
            loadingIndicator.classList.add('active');
            messagesContainer.scrollTop = messagesContainer.scrollHeight; // Scroll to bottom

            let promptContents = conversationHistory.map(message => ({
                role: message.role,
                parts: message.parts
            }));
            promptContents.unshift({ role: 'user', parts: [{ text: systemPrompt }] });


            const payload = {
                contents: promptContents
            };

            try {
                const response = await fetch(geminiAPIUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Lỗi API:", errorData);
                    apiErrorMessage.textContent = `Lỗi API: ${response.status} - ${errorData.error.message || 'Không rõ nguyên nhân'}`;
                    aiMessageDiv.textContent = `Lỗi: ${response.status} - ${errorData.error.message || 'Không rõ nguyên nhân'}`; // Show basic error in the chat
                    return;
                }

                const data = await response.json();
                console.log("Dữ liệu phản hồi từ API:", data);

                if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0].text) {
                    let aiResponseText = data.candidates[0].content.parts[0].text;
                    aiMessageDiv.innerHTML = ''; // Clear the "Đang suy nghĩ..." message

                    // **Handle triple quotes for code blocks**
                    aiResponseText = aiResponseText.replace(/'''([\s\S]*?)'''/g, (match, code) => {
                        // Find the language if specified after the first set of triple quotes
                        const codeParts = code.split('\n');
                        const language = codeParts.shift().trim(); //get language
                        const codeText = codeParts.join('\n').trim(); // Code text
                        const languageClass = language ? `language-${language}` : 'language-plaintext'; // Construct Prism class

                        // Return Prism-formatted code block
                        return `<pre><code class="${languageClass}">${sanitizeHTML(codeText)}</code></pre>`;
                    });

                    // Simulate streaming effect
                    let index = 0;
                    const typingSpeed = 20; // milliseconds per character
                    const fullText = aiResponseText;

                    function typeNextCharacter() {
                        if (index < fullText.length) {
                            aiMessageDiv.innerHTML += fullText.charAt(index); // Append next character
                            index++;
                            messagesContainer.scrollTop = messagesContainer.scrollHeight; // Keep scrolling down
                            setTimeout(typeNextCharacter, typingSpeed);  // Call itself recursively
                        } else {
                            // Once typing is complete:
                            loadingIndicator.classList.remove('active');
                            Prism.highlightAllUnder(aiMessageDiv);
                             // Add the download button after the text has finished streaming
                            addCodeDownloadButtons(aiMessageDiv);
                            const aiMessageObject = { role: 'model', parts: [{ text: aiMessageDiv.innerHTML }] };
                            conversationHistory.push(aiMessageObject);
                            saveChatHistory();

                        }
                    }

                    typeNextCharacter();  // Start the typing animation


                } else {
                    aiMessageDiv.textContent = "Không nhận được phản hồi hợp lệ từ AI.";
                }

            } catch (error) {
                console.error("Lỗi fetch:", error);
                apiErrorMessage.textContent = "Đã xảy ra lỗi khi kết nối đến API.";
                aiMessageDiv.textContent = "Đã xảy ra lỗi khi kết nối đến API.";
            } finally {
                 loadingIndicator.classList.remove('active');
                 messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

         function addCodeDownloadButtons(messageDiv) {
            const codeBlocks = messageDiv.querySelectorAll('pre > code'); // Select code blocks
            codeBlocks.forEach(codeBlock => {
                const language = codeBlock.className.replace('language-', '');
                const codeText = codeBlock.textContent;

                // Create download button
                const downloadButton = document.createElement('a');
                downloadButton.textContent = `Tải xuống code ${language}`;
                downloadButton.classList.add('code-download-button'); // Add CSS class
                downloadButton.href = 'data:text/plain;charset=utf-8,' + encodeURIComponent(codeText);
                downloadButton.download = `code.${language}`;

                // Append button after code block
                codeBlock.parentNode.parentNode.appendChild(downloadButton);  // Append after the pre tag
            });
        }

    </script>
</body>
</html>