--- START OF FILE new_page.html ---

<!DOCTYPE html>
<html>
<head>
    <title>AI Chatbot - Gemini API</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        /* CSS Dark Mode hiện đại và Responsive - ChatGPT Interface Style - UPDATED Buttons & Layout */
        :root {
            --bg-color: #121212;
            --text-color: #f0f0f0;
            --primary-color: #64ffda;
            --secondary-bg: #1e1e1e;
            --border-color: #333;
            --message-user-bg: #3498db;
            --message-ai-bg: #4a5568;
            --button-bg: #3498db;
            --button-hover-bg: #2980b9;
            --menu-bg: #252525;
            --loading-color: #ffc107;
            --history-list-bg: #252525;
            --history-list-item-hover: #333;
            --auth-input-bg: #333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow: hidden; /* Disable zoom */
        }

        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-top: 20px;
            margin-bottom: 20px;
            animation: fadeIn 1s ease-out;
        }

        .container {
            width: 98%;
            max-width: 1000px;
            background-color: var(--secondary-bg);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            margin-bottom: 25px;
            animation: slideUp 0.8s ease-out;
            display: flex;
            flex-direction: column;
        }

         /* Custom Button Style */
        .custom-button {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background-color: var(--button-bg);
            color: var(--text-color);
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            outline: none;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            user-select: none; /* Ngăn chọn văn bản khi nhấp */
        }

        .custom-button:hover {
            background-color: var(--button-hover-bg);
            transform: translateY(-2px); /* Nút nhô lên khi hover */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        }

        .custom-button:active {
            background-color: var(--button-hover-bg);
            transform: translateY(0); /* Nút lún xuống khi active */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        /* Menu Styles */
        .menu-container {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }

       .menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--menu-bg);
            border-radius: 10px;
            overflow: hidden;
            display: none;
            transform-origin: top right;
            transform: scaleY(0);
            transition: transform 0.3s ease-in-out;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            width: 250px;
        }

        .menu-dropdown.active {
            display: block;
            transform: scaleY(1);
        }

        .menu-dropdown .custom-button {
            width: 100%;
            padding: 12px;
            border-radius: 0;
            box-shadow: none;
            text-align: left;
            justify-content: flex-start;
        }

        .menu-dropdown .custom-button:hover {
            background-color: var(--history-list-item-hover);
            transform: none;
        }

        /* History Modal */
        .history-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--secondary-bg);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
            z-index: 1001;
            width: 80%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .history-modal.active {
            display: block;
        }

        .history-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .history-item {
            background-color: var(--history-list-bg);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.3s;
            position: relative;
        }

        .history-item:hover {
            background-color: var(--history-list-item-hover);
        }

        .history-item-content {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 40px;
        }

        .history-item-delete {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #aaa;
            font-size: 1.2em;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .history-item-delete:hover {
            opacity: 1;
            color: #eee;
        }

        .history-modal-close {
             padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background-color: var(--button-bg);
            color: var(--text-color);
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            outline: none;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            user-select: none;
        }

        .history-modal-close:hover {
           background-color: var(--button-hover-bg);
            transform: translateY(-2px); /* Nút nhô lên khi hover */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        }

        .history-modal-close:active {
             background-color: var(--button-hover-bg);
            transform: translateY(0); /* Nút lún xuống khi active */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        /* Auth Forms */
        .auth-container {
            width: 90%;
            max-width: 400px;
            padding: 20px;
            border-radius: 10px;
            background-color: var(--secondary-bg);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            margin-bottom: 20px;
        }

        .auth-container h2 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .auth-container label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-color);
        }

        .auth-container input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: none;
            background-color: var(--auth-input-bg);
            color: var(--text-color);
            font-size: 16px;
            box-sizing: border-box;
            outline: none;
        }

        .auth-container .custom-button {
            width: 100%;
        }

        .auth-switch {
            text-align: center;
            margin-top: 15px;
        }

        .auth-switch a {
            color: var(--primary-color);
            text-decoration: none;
            transition: color 0.3s;
        }

        .auth-switch a:hover {
            color: var(--button-hover-bg);
        }

        /* Chat Interface */
        #chat-container {
            border: none;
            padding: 0;
            height: calc(100vh - 300px);
            overflow-y: scroll;
            margin-bottom: 15px;
            border-radius: 0;
            background-color: transparent;
            display: flex;
            flex-direction: column;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) transparent;
            position: relative;
            flex: 2;
            min-height: 200px;
        }

        /* Code Block */
        .code-block {
            background-color: #282c34;
            color: #abb2bf;
            padding: 15px;
            border-radius: 10px;
            overflow-x: auto;
            position: relative;
            margin-bottom: 10px;
        }

        .code-block pre {
            white-space: pre-wrap;
        }

        .code-block .custom-button {
            position: absolute;
            bottom: 10px;
            right: 10px; /* Changed to right for better visibility */
            left: auto;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 14px;
        }

        /* Input Container */
        #input-container {
            display: flex;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--secondary-bg);
            border-top: 1px solid var(--border-color);
            padding: 10px;
            align-items: center;
            box-sizing: border-box;
            max-width: 1000px;
        }

        #upload-button {
            width: 35px;
            height: 35px;
            margin-right: 10px;
            font-size: 1.2em;
        }

        #prompt-input {
            flex-grow: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            background-color: transparent;
            color: var(--text-color);
            transition: border-color 0.3s;
            outline: none;
            margin-right: 10px;
        }

        #send-button {
            width: 35px;
            height: 35px;
        }

        .user-message, .ai-message, .loading-message {
            padding: 10px 15px;
            border-radius: 15px;
            margin-bottom: 8px;
            max-width: 90%;
            clear: both;
            word-wrap: break-word;
            animation: messageAppear 0.4s ease-out forwards;
            transform-origin: top;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
        }

        .user-message {
            background-color: var(--message-user-bg);
            color: var(--text-color);
            align-self: flex-end;
            text-align: right;
        }

        .ai-message {
            background-color: var(--message-ai-bg);
            color: var(--text-color);
            align-self: flex-start;
            text-align: left;
        }

        .loading-message {
            background-color: transparent;
            color: var(--loading-color);
            align-self: flex-start;
            text-align: left;
            font-style: italic;
            animation: blinkLoading 1.5s infinite;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            #chat-container {
                height: calc(100vh - 250px);
            }

            #input-container {
                flex-direction: column;
                align-items: stretch;
            }

            #prompt-input {
                margin-bottom: 8px;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>AI Chatbot - Gemini API</h1>

        <div class="menu-container">
            <button id="menuButton" class="custom-button" onclick="toggleMenu()">Danh mục</button>
            <div class="menu-dropdown" id="menuDropdown">
                <button class="custom-button" onclick="startNewChatConfirmation()">Bắt đầu cuộc trò chuyện mới</button>
                <button class="custom-button" id="loadHistoryButton" onclick="showHistoryModal()">Tải lại lịch sử</button>
                <button class="custom-button" onclick="downloadChatHistory()">Tải xuống lịch sử chat</button>
                <button class="custom-button" onclick="logoutUser()">Đăng xuất</button>
            </div>
        </div>

        <!-- History Modal -->
        <div class="history-modal" id="historyModal">
            <h2>Lịch Sử Chat</h2>
            <ul class="history-list" id="historyList">
                <!-- History items will be added here -->
            </ul>
            <button class="custom-button history-modal-close" onclick="hideHistoryModal()">Đóng</button>
        </div>

        <!-- Auth Forms -->
        <div id="auth-forms-container">
            <div id="login-form" class="auth-container">
                <h2>Đăng nhập</h2>
                <label for="login-username">Tên người dùng:</label>
                <input type="text" id="login-username" placeholder="Nhập tên người dùng">
                <label for="login-password">Mật khẩu:</label>
                <input type="password" id="login-password" placeholder="Nhập mật khẩu">
                <button class="custom-button" onclick="loginUser()">Đăng nhập</button>
                <div class="auth-switch">
                    <a href="#" onclick="showRegisterForm(); return false;">Chưa có tài khoản? Đăng ký ngay</a>
                </div>
            </div>

            <div id="register-form" class="auth-container" style="display: none;">
                <h2>Đăng ký</h2>
                <label for="register-username">Tên người dùng:</label>
                <input type="text" id="register-username" placeholder="Chọn tên người dùng">
                <label for="register-password">Mật khẩu:</label>
                <input type="password" id="register-password" placeholder="Chọn mật khẩu">
                <button class="custom-button" onclick="registerUser()">Đăng ký</button>
                <div class="auth-switch">
                    <a href="#" onclick="showLoginForm(); return false;">Đã có tài khoản? Đăng nhập</a>
                </div>
            </div>
        </div>

        <!-- Username Display -->
        <div id="username-display"></div>

        <!-- Chat Interface -->
        <div id="chat-interface-container" style="display: none;">
            <div id="chat-container">
                <!-- Chat messages -->
            </div>

            <div id="input-container">
                <button id="uploadButton" class="custom-button" onclick="triggerFileUpload()"></button>
                <input type="text" id="prompt-input" placeholder="Nhập tin nhắn..." onkeydown="if (event.keyCode == 13) { sendMessage(); return false; }">
                <button id="sendButton" class="custom-button" onclick="sendMessage()">➡</button>
                <input type="file" id="file-upload" style="display: none;" accept=".txt">
            </div>
        </div>
    </div>

    <script>
    // Disable zoom
    document.addEventListener('gesturestart', function (e) {
        e.preventDefault();
    });

    document.addEventListener('touchmove', function(event) {
      if (event.scale !== 1) {
        event.preventDefault();
      }
    }, false);

    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(event) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
            event.preventDefault();
        }
        lastTouchEnd = now;
    }, false);

        // Globals
        const chatContainer = document.getElementById('chat-container');
        const promptInput = document.getElementById('prompt-input');
        const usernameDisplay = document.getElementById('username-display');
        const chatInterfaceContainer = document.getElementById('chat-interface-container');
        const authFormsContainer = document.getElementById('auth-forms-container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginUsernameInput = document.getElementById('login-username');
        const loginPasswordInput = document.getElementById('login-password');
        const registerUsernameInput = document.getElementById('register-username');
        const registerPasswordInput = document.getElementById('register-password');
        const fileUpload = document.getElementById('file-upload');
        const menuDropdown = document.getElementById('menuDropdown');
        const historyModal = document.getElementById('historyModal');
        const historyList = document.getElementById('historyList');
        const menuButton = document.getElementById('menuButton');
        const uploadButton = document.getElementById('uploadButton');
        const sendButton = document.getElementById('sendButton');

        let currentUsername = '';
        let isLoading = false;
        let currentHistoryKey = null;
        const GEMINI_API_KEY_DEFAULT = 'AIzaSyCl21Ku_prQnyMHFs_dJRL8-pgjg9hrc2w';
        let currentApiKey = GEMINI_API_KEY_DEFAULT;
        const FIXED_PROMPT = "Bạn là một trợ lý AI hữu ích, thông minh và luôn trả lời một cách chi tiết và chính xác. Hãy giúp người dùng giải quyết mọi vấn đề và cung cấp thông tin tốt nhất có thể.";
        const MODEL_NAME = "gemini-2.0-flash-exp";

        // Helper Functions
        const writeFile = (filepath, data) => localStorage.setItem(filepath, JSON.stringify(data));
        const readFile = (filepath) => {
            const data = localStorage.getItem(filepath);
            return data ? JSON.parse(data) : null;
        };
    function triggerFileUpload() {
            fileUpload.click();
        }

        // Menu Functions
        let menuActive = false;
        function toggleMenu() {
            menuActive = !menuActive;
            menuDropdown.classList.toggle('active', menuActive);
        }

         // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.menu-container')) {
                menuActive = false;
                menuDropdown.classList.remove('active');
            }
         });


        // History Modal Functions
        function showHistoryModal() {
            historyModal.classList.add('active');
            loadHistoryList();
            menuDropdown.classList.remove('active'); // Đóng menu khi mở modal
        }

        function hideHistoryModal() {
            historyModal.classList.remove('active');
            currentHistoryKey = null;

            // Kiểm tra xem menu có đang mở không và đóng nếu cần
            if (menuActive) {
                menuActive = false;
                 menuDropdown.classList.remove('active');

            }
         }



        // Auth Functions
        function registerUser() {
            const username = registerUsernameInput.value.trim();
            const password = registerPasswordInput.value.trim();

            if (!username || !password) {
                alert("Vui lòng nhập tên người dùng và mật khẩu.");
                return;
            }

            const userFilePath = `user/${username}/info.json`;

            if (readFile(userFilePath)) {
                alert("Tên người dùng đã tồn tại. Vui lòng chọn tên người dùng khác.");
                return;
            }

            writeFile(userFilePath, { username: username, password: password });
            alert("Đăng ký thành công. Vui lòng đăng nhập.");
            showLoginForm();
        }

        function loginUser() {
            const username = loginUsernameInput.value.trim();
            const password = loginPasswordInput.value.trim();

            if (!username || !password) {
                alert("Vui lòng nhập tên người dùng và mật khẩu.");
                return;
            }

            const userFilePath = `user/${username}/info.json`;
            const userInfo = readFile(userFilePath);

            if (userInfo && userInfo.password === password) {
                currentUsername = username;
                saveUsername(username);
                displayUsername();
                authFormsContainer.style.display = 'none';
                chatInterfaceContainer.style.display = 'block';
                loadChatHistory();
            } else {
                alert("Đăng nhập thất bại. Tên người dùng hoặc mật khẩu không đúng.");
            }
        }

        function logoutUser() {
            currentUsername = '';
            localStorage.removeItem('geminiChatCurrentUsername');
            conversationHistory = [];
            chatContainer.innerHTML = '';
            chatInterfaceContainer.style.display = 'none';
            authFormsContainer.style.display = 'block';
            usernameDisplay.textContent = '';
            menuActive = false;
             menuDropdown.classList.remove('active');

            hideHistoryModal();
            saveChatHistory();
        }

        function saveUsername(username) {
            localStorage.setItem('geminiChatCurrentUsername', username);
        }

        function getUsername() {
            return localStorage.getItem('geminiChatCurrentUsername') || '';
        }

        function displayUsername() {
            currentUsername = getUsername();
            if (currentUsername) {
                usernameDisplay.textContent = `Chào mừng, ${currentUsername}!`;
                usernameDisplay.className = '';
            } else {
                usernameDisplay.textContent = 'Bạn cần đăng ký và đăng nhập để sử dụng chatbot.';
                usernameDisplay.className = 'logged-out-message';
            }
        }

        function checkLoginStatus() {
            if (getUsername()) {
                currentUsername = getUsername();
                displayUsername();
                authFormsContainer.style.display = 'none';
                chatInterfaceContainer.style.display = 'block';
                loadChatHistory();
            } else {
                authFormsContainer.style.display = 'block';
                chatInterfaceContainer.style.display = 'none';
                displayUsername();
            }
        }

        function showLoginForm() {
            loginForm.style.display = 'block';
            registerForm.style.display = 'none';
        }

        function showRegisterForm() {
            loginForm.style.display = 'none';
            registerForm.style.display = 'block';
        }

        // Chat Functions
        function loadChatHistory() {
            if (!currentUsername) return;

            const historyKeys = getHistorySessionKeys();
            if (historyKeys.length > 0) {
                const latestHistoryKey = historyKeys[historyKeys.length - 1];
                loadSpecificHistory(latestHistoryKey);
            } else {
                chatContainer.innerHTML = '';
                conversationHistory = [];
            }
             menuDropdown.classList.remove('active');
            hideHistoryModal();
        }

          function loadHistoryList() {
            if (!currentUsername) return;

            historyList.innerHTML = '';
            const historyKeys = getHistorySessionKeys();

            historyKeys.forEach(key => {
                const historyItem = document.createElement('li');
                historyItem.className = 'history-item';

                const historyName = key.split('/').pop().replace(/_/g, ' ').replace(/\.json$/, '');
                const historyItemContent = document.createElement('span');
                historyItemContent.className = 'history-item-content';
                historyItemContent.textContent = historyName;
                historyItemContent.onclick = () => loadSpecificHistory(key, historyName);
                historyItem.appendChild(historyItemContent);


                const deleteButton = document.createElement('button');
                deleteButton.className = 'history-item-delete';
                deleteButton.innerHTML = '✕';
                deleteButton.onclick = (event) => {
                    event.stopPropagation();
                    deleteChatHistory(key);
                    loadHistoryList();
                };
                historyItem.appendChild(deleteButton);

                historyList.appendChild(historyItem);
            });
        }

        function deleteChatHistory(historyKey) {
            const confirmDelete = confirm("Bạn có chắc chắn muốn xóa lịch sử chat này?");
            if (confirmDelete) {
                localStorage.removeItem(historyKey);
                loadHistoryList();
                chatContainer.innerHTML = '';
                conversationHistory = [];
            }
        }

         function loadSpecificHistory(historyKey, historyName) {
            try {
                const history = readFile(historyKey);
                if (history) {
                    currentHistoryKey = historyKey; // set current History key

                    conversationHistory = history;
                    chatContainer.innerHTML = '';

                    // Add history name as a user message
                    addUserMessageToUI(`Bạn đang xem lịch sử: ${historyName}`, 'ai-message');

                    conversationHistory.forEach(message => {
                        if (message.role === 'user') {
                            addUserMessageToUI(message.parts[0].text, 'user-message');
                        } else if (message.role === 'model') {
                            addAiMessage(message.parts[0].text); // Use addAiMessage to handle code blocks correctly
                        }
                    });
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    menuActive = false;
                     menuDropdown.classList.remove('active');
                    hideHistoryModal();
                } else {
                    console.warn(`Không tìm thấy lịch sử chat với key: ${historyKey}`);
                }
            } catch (error) {
                console.error("Lỗi khi tải lịch sử chat:", error);
                alert("Lỗi khi tải lịch sử chat. Vui lòng thử lại sau.");
            }
        }
         function saveChatHistory() {
             if (!currentUsername) return;

             let historyName = prompt("Vui lòng nhập tên cho cuộc trò chuyện này:", "Cuộc trò chuyện mới");
             if (!historyName) {
                 historyName = "Cuộc trò chuyện mới";
             }

             const historyKeys = getHistorySessionKeys();
             let sessionIndex = historyKeys.length;
             let newHistoryKey = `user/${currentUsername}/history_${historyName}.json`;
             let existingKey = localStorage.getItem(newHistoryKey);

             if (existingKey) {
                console.log("lưu thành công")
             } else {
                 localStorage.setItem(newHistoryKey, JSON.stringify(conversationHistory));
                 console.log("lưu thành công")
             }


        }

        function clearChatHistory() {
            if (currentUsername) {
                conversationHistory = [];
                chatContainer.innerHTML = '';
            }
        }

        function startNewChatConfirmation() {
            const confirmNewChat = confirm("Bạn có chắc chắn muốn bắt đầu cuộc trò chuyện mới? Lịch sử chat hiện tại sẽ được lưu lại.");
            if (confirmNewChat) {
                saveChatHistory();
                startNewChat();
            }
        }

        function startNewChat() {
            clearChatHistory();
          menuActive = false;
             menuDropdown.classList.remove('active');
            hideHistoryModal();
            currentHistoryKey = null;

        }

        function downloadChatHistory() {
            if (conversationHistory.length === 0) {
                alert("Không có lịch sử chat để tải xuống.");
                return;
            }

            const historyText = conversationHistory.map(message => `${message.role.toUpperCase()}: ${message.parts[0].text}`).join('\n\n');
            const blob = new Blob([historyText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat_history_${currentUsername}_${new Date().toLocaleDateString()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            menuActive = false;
             menuDropdown.classList.remove('active');
            hideHistoryModal();
        }

        function getHistorySessionKeys() {
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(`user/${currentUsername}/history_`) && key.endsWith('.json')) {
                    keys.push(key);
                }
            }
            return keys.sort();
        }

        // Send/Receive Functions
        function sendMessage(userMessageFromFile = null) {
            if (!currentUsername) {
                alert("Bạn cần đăng nhập để sử dụng chatbot.");
                return;
            }

            let userMessage = userMessageFromFile || promptInput.value;
            promptInput.value = '';

            if (!userMessage) return;

            addUserMessage(userMessage);
            showLoadingIndicator();

            const combinedPrompt = `${FIXED_PROMPT}\n\n${userMessage}`;
            sendToGeminiAPI(currentApiKey, combinedPrompt);
        }

         function addUserMessage(message) {
            addUserMessageToUI(message, 'user-message');
            conversationHistory.push({ role: "user", parts: [{ text: message }] });

            if (currentHistoryKey) {
                localStorage.setItem(currentHistoryKey, JSON.stringify(conversationHistory));
            }
        }

       function addUserMessageToUI(message, className) {
            const messageDiv = document.createElement('div');
            messageDiv.className = className;
            messageDiv.textContent = message;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

         function addAiMessage(message) {
            hideLoadingIndicator();

            const messageDiv = document.createElement('div');
            messageDiv.className = 'ai-message';
            messageDiv.style.textAlign = 'left';

            let content;
            if (message.startsWith("```") && message.endsWith("```")) {
                content = `<div class="code-block">
                             <pre>${message.slice(3, -3)}</pre>
                             <button class="custom-button copy-button" onclick="copyCode(this)">Sao chép</button>
                         </div>`;
            } else {
                content = message;
            }

            messageDiv.innerHTML = content;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            conversationHistory.push({ role: "model", parts: [{ text: message }] });

            if (currentHistoryKey) {
                localStorage.setItem(currentHistoryKey, JSON.stringify(conversationHistory));
            }
        }

       function copyCode(button) {
            const pre = button.parentNode.querySelector('pre');
            navigator.clipboard.writeText(pre.textContent)
                .then(() => {
                    alert('Đã sao chép code!');
                })
                .catch(err => {
                    console.error('Không thể sao chép: ', err);
                });
        }


        // API Call
        async function sendToGeminiAPI(apiKey, prompt) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent`;

            const requestBody = {
                contents: conversationHistory.concat([{ role: "user", parts: [{ text: prompt }] }])
            };

            try {
                const response = await fetch(`${apiUrl}?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                if (!response.ok) {
                    hideLoadingIndicator();
                    const errorData = await response.json();
                    console.error("API Error:", errorData);
                    let errorMessage = `Lỗi API: ${response.status}`;
                    if (errorData.error && errorData.error.message) {
                        errorMessage += ` - ${errorData.error.message}`;
                    } else {
                        errorMessage += ` - Không rõ lỗi. Vui lòng kiểm tra API Key và kết nối mạng.`;
                    }
                    addAiMessage(errorMessage);
                    return;
                }

                const data = await response.json();
                if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0].text) {
                    const aiResponse = data.candidates[0].content.parts[0].text;
                    addAiMessage(aiResponse);
                } else {
                    hideLoadingIndicator();
                    addAiMessage("Không nhận được phản hồi hợp lệ từ AI.");
                }

            } catch (error) {
                hideLoadingIndicator();
                console.error("Fetch error:", error);
                addAiMessage("Lỗi kết nối đến API. Vui lòng kiểm tra kết nối mạng của bạn.");
            }
        }

        // Loading Indicator
        function showLoadingIndicator() {
            if (!isLoading) {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'loading-message';
                loadingDiv.textContent = 'Đang tải...';
                loadingDiv.id = 'loading-temp-message';
                chatContainer.appendChild(loadingDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                isLoading = true;
            }
        }

        function hideLoadingIndicator() {
            const loadingMessage = document.getElementById('loading-temp-message');
            if (loadingMessage) {
                loadingMessage.remove();
                isLoading = false;
            }
        }

        // Initial Check
        checkLoginStatus();

          // Prevent zoom on double tap
        document.addEventListener('dblclick', function(event) {
            event.preventDefault();
        });

      fileUpload.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                let fileContent = event.target.result;
                sendMessage(fileContent);
                alert(`Tệp "${file.name}" đã tải lên thành công.`);
            };
            reader.readAsText(file);
        });
    </script>

</body>
</html>