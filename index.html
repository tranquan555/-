--- START OF FILE vip1.html ---
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Hiện Đại với Gemini</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1e2124;
            color: #d1d5db;
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-touch-callout: none;
            -webkit-user-select: text;
            -khtml-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
            touch-action: manipulation;
            -webkit-text-size-adjust: 100%;
        }

        .container {
            width: 95%;
            max-width: 1200px;
            margin: 20px auto;
            padding: 25px;
            background-color: #25272b;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            height: 100vh;
            flex-grow: 1;
            margin-left: auto;
            transition: margin-left 0.3s ease;
            border: 1px solid #333;
        }

        .container.sidebar-open {
            margin-left: 250px;
        }

        h1 {
            text-align: center;
            color: #fff;
            margin-bottom: 20px;
            font-size: 2.2em;
            letter-spacing: 0.3px;
            padding-bottom: 15px;
            border-bottom: 1px solid #444;
        }

        #messages-container {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            scrollbar-width: thin;
            scrollbar-color: #555 #252525;
            padding-bottom: 70px;
            border: 1px solid #333;
            border-radius: 8px;
            background-color: #1e2124;
        }

        #messages-container::-webkit-scrollbar {
            width: 8px;
        }

        #messages-container::-webkit-scrollbar-track {
            background: #252525;
        }

        #messages-container::-webkit-scrollbar::-webkit-scrollbar-thumb {
            background-color: #555;
            border-radius: 4px;
        }

        .message {
            margin-bottom: 12px;
            padding: 10px 14px;
            border-radius: 15px;
            clear: both;
            word-wrap: break-word;
            max-width: 80%;
            display: inline-block;
            border: 1px solid #444;
            position: relative;
        }

        .user-message {
            background-color: #343541;
            color: #fff;
            align-self: flex-end;
            float: right;
            border-top-right-radius: 3px;
        }

        .ai-message {
            background-color: #444654;
            color: #d1d5db;
            align-self: flex-start;
            float: left;
            border-top-left-radius: 3px;
        }

        .ai-message .ai-message-text {
            font-family: 'Arial', sans-serif;
            font-weight: normal;
            line-height: 1.6;
            white-space: pre-line;
        }

        .markdown-bold-uppercase {
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* New style for inline code using *`` */
        .markdown-code-inline {
            font-family: monospace;
            background-color: #333;
            color: #f8f8f2; /* light code text color */
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.9em;
        }


        .input-area {
            padding: 10px 20px;
            background-color: #343541;
            border-top: 1px solid #555;
            display: flex;
            align-items: center;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            box-sizing: border-box;
            padding-left: 20px;
            padding-right: 20px;
            z-index: 100;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
             border-top: 1px solid #444;
        }

        .input-area textarea {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #555;
            border-radius: 8px;
            font-size: 16px;
            background-color: #40414f;
            color: #fff;
            resize: none;
            min-height: 35px;
            overflow-y: auto;
            border: 1px solid #444;
        }

        .input-area textarea:focus {
            border-color: #00bcd4;
            outline: none;
            box-shadow: 0 0 5px rgba(0, 188, 212, 0.5);
        }

        .input-area button {
            padding: 10px 20px;
            background-color: #00bcd4;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-left: 10px;
            transition: background-color 0.3s ease;
        }

        .input-area button:hover {
            background-color: #0097a7;
        }

        .file-upload-button {
            background-color: #555;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 10px;
            opacity: 0.8;
            transition: opacity 0.3s ease, background-color 0.3s ease;
        }

        .file-upload-button:hover {
            opacity: 1;
            background-color: #666;
        }


        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            height: 100%;
            background-color: #252525;
            color: #fff;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 200;
            padding-top: 60px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.2);
            overflow-y: auto;
            touch-action: manipulation;
            border-right: 1px solid #444;
        }

        .sidebar.sidebar--open {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #555;
            margin-bottom: 20px;
            border-bottom: 1px solid #444;
        }

        .sidebar-menu {
            padding: 0;
            list-style: none;
        }

        .sidebar-menu-item {
            padding: 15px 20px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid transparent;
            transition: border-bottom-color 0.3s ease;
        }

        .sidebar-menu-item:hover {
            background-color: #343541;
             border-bottom-color: #00bcd4;
        }

        .sidebar-menu-item.has-submenu > .menu-link::after {
            content: '>';
            float: right;
            margin-left: 10px;
            font-size: 0.8em;
            display: inline-block;
        }

        .submenu {
            list-style: none;
            padding-left: 0;
            margin: 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            background-color: #2c2c2c;
            margin-top: 5px;
            max-height: 0;
            opacity: 0;
            transition: max-height 0.3s ease-out, opacity 0.2s ease-out;
            overflow-y: hidden;
            padding-top: 0;
            padding-bottom: 0;
        }

        .submenu.open {
            display: block;
            max-height: 500px;
            opacity: 1;
            overflow-y: auto;
            padding-top: 5px;
            padding-bottom: 10px;
        }


        .submenu-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }

        .submenu-item:last-child {
            border-bottom: none;
        }


        .submenu-item:hover {
            background-color: #343541;
        }

        .history-name {
            flex-grow: 1;
        }

        .delete-history-btn {
            background: transparent;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 1em;
            padding: 0 8px;
            opacity: 0.7;
            transition: opacity 0.2s ease, color 0.2s ease;
        }

        .delete-history-btn:hover {
            opacity: 1;
            color: #fff;
        }

        .sidebar-toggle-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #00bcd4;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 300;
        }

        .sidebar-toggle-button:hover {
            background-color: #0097a7;
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 150;
            display: none;
        }

        .sidebar-overlay.sidebar--open {
            display: block;
        }

        .close-history-menu-btn {
            background-color: #00bcd4;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            cursor: pointer;
            margin-top: 10px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            transition: background-color 0.3s ease;
        }

        .close-history-menu-btn:hover {
            background-color: #0097a7;
        }

        .custom-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 400;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }

        .custom-modal-overlay.show-modal {
            display: flex;
            pointer-events: auto;
        }


        .custom-modal {
            background-color: #343541;
            color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            width: 80%;
            max-width: 400px;
            text-align: center;
            border: 1px solid #444;
        }

        .modal-message {
            margin-bottom: 15px;
        }

        .modal-input {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid #555;
            background-color: #40414f;
            color: #fff;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .modal-button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
            border: 1px solid #444;
        }

        .modal-button.confirm {
            background-color: #00bcd4;
            color: white;
        }

        .modal-button.confirm:hover {
            background-color: #0097a7;
        }

        .modal-button.cancel {
            background-color: #555;
            color: white;
        }

        .modal-button.cancel:hover {
            background-color: #666;
        }

        code[class*="language-"],
        pre[class*="language-"] {
            color: #f8f8f2;
            background: #272822;
            position: relative;
        }

        .token.comment, .token.prolog, .token.doctype, .token.cdata { color: #6c6767; }
        .token.punctuation { color: #f8f8f2; }
        .token.namespace { opacity: .7; }
        .token.property, .token.tag, .token.constant, .token.symbol, .token.deleted { color: #f92672; }
        .token.boolean, .token.number { color: #ae81ff; }
        .token.selector, .token.attr-name, .token.string, .token.char, .token.builtin, .token.inserted { color: #a6e22e; }
        .token.operator, .token.entity, .token.url, .language-css .token.string, .style .token.string { color: #f8f8f2; background: none; }
        .token.atrule, .token.attr-value, .token.keyword { color: #00bcd4; }
        .token.function, .token.class-name { color: #e6db74; }
        .token.regex, .token.important, .token.variable { color: #fd971f; }
        .token.important, .token.bold { font-weight: bold; }
        .token.italic { font-style: italic; }
        .token.entity { cursor: help; }

        .copy-code-button {
            position: absolute;
            bottom: 5px;
            left: 5px;
            background-color: #444;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 8px;
            font-size: 0.8em;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s ease, background-color 0.3s ease;
        }

        .copy-code-button:hover {
            opacity: 1;
            background-color: #00bcd4;
        }


    </style>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Arial:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Lịch sử Chat</h3>
        </div>
        <ul class="sidebar-menu">
            <li class="sidebar-menu-item" onclick="startNewChat()">
                <span class="menu-link">Đoạn chat mới</span>
            </li>
            <li class="sidebar-menu-item" onclick="openSaveHistoryModal()">
                <span class="menu-link">Lưu lịch sử này</span>
            </li>
            <li class="sidebar-menu-item has-submenu" onclick="toggleHistoryMenu()">
                <span class="menu-link">Lịch sử đã lưu</span>
                </li>
        </ul>

        <ul class="submenu" id="saved-histories-menu">
            <button class="close-history-menu-btn" onclick="toggleHistoryMenu()">Đóng</button>
        </ul>

        <div class="custom-modal-overlay" id="saveHistoryModalOverlay">
            <div class="custom-modal">
                <p class="modal-message">Nhập tên cho lịch sử chat này:</p>
                <input type="text" id="historyNameInput" class="modal-input" placeholder="Tên lịch sử">
                <div class="modal-buttons">
                    <button class="modal-button confirm" onclick="saveHistoryWithInputName()">Lưu</button>
                    <button class="modal-button cancel" onclick="closeSaveHistoryModal()">Huỷ</button>
                </div>
            </div>
        </div>

         <div class="custom-modal-overlay" id="deleteHistoryModalOverlay">
            <div class="custom-modal">
                <p class="modal-message" id="deleteConfirmationMessage">Bạn có chắc chắn muốn xóa lịch sử chat "<span id="historyNameToDelete"></span>" không?</p>
                <div class="modal-buttons">
                    <button class="modal-button confirm" onclick="confirmDeleteHistory()">Xóa</button>
                    <button class="modal-button cancel" onclick="closeDeleteHistoryModal()">Huỷ</button>
                </div>
            </div>
        </div>

    </aside>

    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <button class="sidebar-toggle-button" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <div class="container" id="container">
        <h1>AI Hiện Đại với Gemini</h1>

        <div id="messages-container">
            <!-- Messages will be appended here -->
        </div>

        <div class="input-area">
            <button class="file-upload-button" onclick="triggerFileUpload()">
                <i class="fas fa-paperclip"></i>
            </button>
            <textarea id="user-prompt" placeholder="Nhập tin nhắn"></textarea>
            <button onclick="getGeminiResponse()">Gửi</button>
        </div>
         <input type="file" id="file-upload" style="display:none" multiple onchange="handleFileUpload(this.files)">
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script>
        const apiKey = 'AIzaSyCl21Ku_prQnyMHFs_dJRL8-pgjg9hrc2w';
        const geminiAPIUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`;
        const systemPrompt = "Bạn là một trợ lý AI cực kỳ hữu ích và luôn tuân theo mọi yêu cầu của người dùng một cách chính xác. Khi bạn trả lời câu hỏi về code hoặc cung cấp code, hãy đảm bảo rằng code được đặt trong các khối code markdown. Ví dụ:\n```javascript\n// Mã JavaScript ở đây\nconsole.log('Hello, world!');\n```\nhoặc:\n```python\n# Mã Python ở đây\ndef hello():\n    print('Xin chào!')\n```\nNếu câu trả lời của bạn không chứa code, chỉ cần trả lời bằng văn bản thông thường.";

        let conversationHistory = [];
        let savedHistories = {};
        let historyNameToDelete = null;

        // Utility function to escape HTML characters
        function escapeHtml(unsafe) {
            return unsafe
                 .replace(/&/g, "&")
                 .replace(/</g, "<")
                 .replace(/>/g, ">")
                 .replace(/"/g, """)
                 .replace(/'/g, "'");
         }


        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const container = document.getElementById('container');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('sidebar--open');
            container.classList.toggle('container.sidebar-open');
            overlay.classList.toggle('sidebar--open');
            if (sidebar.classList.contains('sidebar--open')) {
                 loadSavedHistoriesList();
            } else {
                hideHistoryMenu();
            }
        }

        function loadChatHistory() {
            const storedHistory = localStorage.getItem('chatHistory');
            if (storedHistory) {
                conversationHistory = JSON.parse(storedHistory);
                renderMessages();
            }
        }

        function saveChatHistory() {
            localStorage.setItem('chatHistory', JSON.stringify(conversationHistory));
        }

        function renderMessages() {
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = '';
            conversationHistory.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', message.role === 'user' ? 'user-message' : 'ai-message');
                const messageTextSpan = document.createElement('span');
                messageTextSpan.classList.add('ai-message-text');
                messageTextSpan.innerHTML = message.parts[0].text;
                if (message.role === 'ai') {
                    messageDiv.appendChild(messageTextSpan);
                } else {
                    messageDiv.innerHTML = message.parts[0].text;
                }
                messagesContainer.appendChild(messageDiv);
                Prism.highlightAllUnder(messageDiv);
            });
             messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }


        function startNewChat() {
            conversationHistory = [];
            saveChatHistory();
            renderMessages();
            toggleSidebar();
        }


        function openSaveHistoryModal() {
            document.getElementById('saveHistoryModalOverlay').classList.add('show-modal');
            document.getElementById('historyNameInput').value = '';
        }

        function closeSaveHistoryModal() {
            document.getElementById('saveHistoryModalOverlay').classList.remove('show-modal');
        }

        function saveHistoryWithInputName() {
            const historyName = document.getElementById('historyNameInput').value.trim();
            if (historyName) {
                savedHistories[historyName] = [...conversationHistory];
                localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
                alert(`Lịch sử chat đã được lưu với tên: ${historyName}`);
                loadSavedHistoriesList();
                closeSaveHistoryModal();
            } else {
                alert("Vui lòng nhập tên cho lịch sử chat.");
            }
        }

        function openDeleteHistoryModal(name) {
            historyNameToDelete = name;
            document.getElementById('historyNameToDelete').textContent = name;
            document.getElementById('deleteHistoryModalOverlay').classList.add('show-modal');
        }

        function closeDeleteHistoryModal() {
            document.getElementById('deleteHistoryModalOverlay').classList.remove('show-modal');
            historyNameToDelete = null;
        }

        function confirmDeleteHistory() {
            if (historyNameToDelete) {
                deleteSavedHistory(historyNameToDelete);
            }
            closeDeleteHistoryModal();
        }


        function deleteSavedHistory(historyName) {
            delete savedHistories[historyName];
            localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
            loadSavedHistoriesList();
            alert(`Lịch sử chat "${historyName}" đã bị xóa.`);

        }


        function loadChatHistoryByName(historyName) {
            if (savedHistories[historyName]) {
                conversationHistory = [...savedHistories[historyName]];
                saveChatHistory();
                renderMessages();
                toggleHistoryMenu();
                toggleSidebar();
            } else {
                alert("Không tìm thấy lịch sử chat đã lưu.");
            }
        }


        function toggleHistoryMenu() {
            const submenu = document.getElementById('saved-histories-menu');
            submenu.classList.toggle('open');
        }

        function hideHistoryMenu() {
            const submenu = document.getElementById('saved-histories-menu');
            submenu.classList.remove('open');
        }


        function loadSavedHistoriesList() {
            const historiesMenu = document.getElementById('saved-histories-menu');
            historiesMenu.innerHTML = '<button class="close-history-menu-btn" onclick="toggleHistoryMenu()">Đóng</button>';

            const storedSavedHistories = localStorage.getItem('savedHistories');
            if (storedSavedHistories) {
                savedHistories = JSON.parse(storedSavedHistories);
            } else {
                savedHistories = {};
            }

            if (Object.keys(savedHistories).length === 0) {
                const noHistoryItem = document.createElement('li');
                noHistoryItem.classList.add('submenu-item');
                noHistoryItem.textContent = "Chưa có lịch sử nào được lưu.";
                historiesMenu.appendChild(noHistoryItem);
                return;
            }

            for (const historyName in savedHistories) {
                const historyItem = document.createElement('li');
                historyItem.classList.add('submenu-item');

                const nameSpan = document.createElement('span');
                nameSpan.classList.add('history-name');
                nameSpan.textContent = historyName;
                nameSpan.onclick = () => loadChatHistoryByName(historyName);

                const deleteButton = document.createElement('button');
                deleteButton.classList.add('delete-history-btn');
                deleteButton.textContent = '...';
                deleteButton.onclick = (event) => {
                    event.stopPropagation();
                    openDeleteHistoryModal(historyName);
                };

                historyItem.appendChild(nameSpan);
                historyItem.appendChild(deleteButton);
                historiesMenu.appendChild(historyItem);
            }
        }


        loadChatHistory();
        loadSavedHistoriesList();

        function triggerFileUpload() {
            document.getElementById('file-upload').click();
        }

        function handleFileUpload(files) {
            if (files && files.length > 0) {
                const messagesContainer = document.getElementById('messages-container');
                const aiMessageDiv = document.createElement('div');
                aiMessageDiv.classList.add('message', 'ai-message');
                aiMessageDiv.innerHTML = `<span class="ai-message-text">Đang tải tệp...</span>`;
                messagesContainer.appendChild(aiMessageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                let fileNames = Array.from(files).map(file => file.name).join(', ');
                const userMessage = `Tệp đã tải lên: ${fileNames}. Đang chờ AI xử lý...`;

                const userMessageDiv = document.createElement('div');
                userMessageDiv.classList.add('message', 'user-message');
                userMessageDiv.textContent = userMessage;
                messagesContainer.appendChild(userMessageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                const userMessageObject = { role: 'user', parts: [{ text: userMessage }] };
                conversationHistory.push(userMessageObject);
                saveChatHistory();
                renderMessages();

                // Simulate AI acknowledging the file (for UI purposes - actual file upload to Gemini needs server-side)
                setTimeout(() => {
                    aiMessageDiv.remove();

                    const aiResponseDiv = document.createElement('div');
                    aiResponseDiv.classList.add('message', 'ai-message');
                    aiResponseDiv.innerHTML = `<span class="ai-message-text">Đã nhận được tệp: ${fileNames}. Vui lòng cho biết bạn muốn AI làm gì với tệp này.</span>`;
                    messagesContainer.appendChild(aiResponseDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;

                     const aiMessageObject = { role: 'model', parts: [{ text: aiResponseDiv.innerHTML }] };
                    conversationHistory.push(aiMessageObject);
                    saveChatHistory();
                    renderMessages();

                }, 1500);
            }
        }


        async function getGeminiResponse() {
            const userPrompt = document.getElementById('user-prompt').value.trim();
            const messagesContainer = document.getElementById('messages-container');

            if (!userPrompt) {
                alert("Vui lòng nhập tin nhắn.");
                return;
            }

            const userMessageObject = { role: 'user', parts: [{ text: userPrompt }] };
            conversationHistory.push(userMessageObject);
            saveChatHistory();
            renderMessages();
            document.getElementById('user-prompt').value = '';


            const aiMessageDiv = document.createElement('div');
            aiMessageDiv.classList.add('message', 'ai-message');
            aiMessageDiv.innerHTML = '<span class="ai-message-text">Đang suy nghĩ...</span>';
            messagesContainer.appendChild(aiMessageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            let promptContents = conversationHistory.map(message => ({
                role: message.role,
                parts: message.parts
            }));
            promptContents.unshift({ role: 'user', parts: [{ text: systemPrompt }] });


            const payload = {
                contents: promptContents
            };


            try {
                const response = await fetch(geminiAPIUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Lỗi API:", errorData);
                    aiMessageDiv.innerHTML = `<span class="ai-message-text">Lỗi API: ${response.status} - ${errorData.error.message || 'Không rõ nguyên nhân'}</span>`;
                    return;
                }

                const data = await response.json();
                console.log("Dữ liệu phản hồi từ API:", data);

                if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0].text) {
                    let aiResponseText = data.candidates[0].content.parts[0].text;

                    // 1. Escape HTML entities FIRST
                    let processedText = escapeHtml(aiResponseText);


                    // 2. Process *``inline code``* markdown
                    processedText = processedText.replace(/\*`([^`]+)`\*/g, '<span class="markdown-code-inline">$1</span>');

                    // 3. Process **bold uppercase** markdown
                    processedText = processedText.replace(/\*\*([^*]+)\*\*/g, '<span class="markdown-bold-uppercase">$1</span>');


                    aiMessageDiv.innerHTML = ''; // Clear "Đang suy nghĩ..."
                    const aiTextContentSpan = document.createElement('span');
                    aiTextContentSpan.classList.add('ai-message-text');


                    let textContent = '';
                    let codeContent = null;
                    let language = 'text';
                    const codeBlockRegex = /```([\w]*)\n([\s\S]*?)```/gm;
                    let lastIndex = 0;
                    let match;

                    while ((match = codeBlockRegex.exec(processedText)) !== null) {
                        textContent = processedText.substring(lastIndex, match.index);
                        if (textContent.trim()) {
                            const textPara = document.createElement('p');
                            textPara.innerHTML = textContent.trim();
                            aiTextContentSpan.appendChild(textPara);
                        }

                        language = match[1] || 'text';
                        codeContent = match[2].trim();

                        const codePre = document.createElement('pre');
                        codePre.classList.add('language-' + language);
                        const codeElement = document.createElement('code');
                        codeElement.classList.add('language-' + language);
                        codeElement.textContent = codeContent;
                        codePre.appendChild(codeElement);

                        const copyButton = document.createElement('button');
                        copyButton.classList.add('copy-code-button');
                        copyButton.innerHTML = '<i class="fas fa-copy"></i>';
                        copyButton.onclick = () => {
                            navigator.clipboard.writeText(codeContent).then(() => {
                                alert('Đã sao chép code vào clipboard!');
                            }).catch(err => {
                                console.error('Lỗi khi sao chép: ', err);
                                alert('Lỗi khi sao chép code.');
                            });
                        };
                        codePre.appendChild(copyButton);

                        aiTextContentSpan.appendChild(codePre);

                        lastIndex = codeBlockRegex.lastIndex;
                    }

                    textContent = processedText.substring(lastIndex);
                    if (textContent.trim()) {
                         const textPara = document.createElement('p');
                         textPara.innerHTML = textContent.trim();
                         aiTextContentSpan.appendChild(textPara);
                    }


                    if (!aiTextContentSpan.hasChildNodes() && processedText.trim()) {
                         aiTextContentSpan.innerHTML = processedText.trim();
                    } else if (!aiTextContentSpan.hasChildNodes()) {
                         aiTextContentSpan.textContent = "Không có phản hồi nội dung từ AI.";
                    }

                    aiMessageDiv.appendChild(aiTextContentSpan);

                    const aiMessageObject = { role: 'model', parts: [{ text: aiMessageDiv.innerHTML }] };
                    conversationHistory.push(aiMessageObject);
                    saveChatHistory();
                    Prism.highlightAllUnder(aiMessageDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;


                } else {
                    aiMessageDiv.innerHTML = `<span class="ai-message-text">Không nhận được phản hồi hợp lệ từ AI.</span>`;
                }

            } catch (error) {
                console.error("Lỗi fetch:", error);
                aiMessageDiv.innerHTML = `<span class="ai-message-text">Đã xảy ra lỗi khi kết nối đến API.</span>`;
            }
        }
    </script>
</body>
</html>