--- START OF FILE new_page 3.html ---
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Hiện Đại với Gemini</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        /* Dark Mode ChatGPT-like Styles */
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1e2124; /* Dark background - ChatGPT dark grey */
            color: #d1d5db; /* Light grey text color */
            display: flex;
            flex-direction: column;
            align-items: center; /* Center container horizontally */
            min-height: 100vh;
        }

        .container {
            width: 95%;
            max-width: 1200px; /* Wider container for chat layout */
            margin: 20px auto; /* Reduced top margin */
            padding: 0; /* No padding for container */
            background-color: transparent; /* Container is transparent */
            border-radius: 0; /* No rounded corners */
            box-shadow: none; /* No shadow */
            display: flex;
            flex-direction: column;
            height: 100vh; /* Full viewport height */
        }

        h1 {
            text-align: center;
            color: #fff; /* White title - Optional, maybe remove in ChatGPT layout */
            margin-bottom: 10px; /* Reduced margin */
            font-size: 1.8em; /* Smaller title */
            letter-spacing: 0.3px;
            padding: 20px 0;
        }

        #messages-container {
            flex-grow: 1; /* Messages take up most space */
            padding: 20px;
            overflow-y: auto; /* Scrollable messages */
            display: flex;
            flex-direction: column;
            scrollbar-width: thin; /* For Firefox */
            scrollbar-color: #555 #252525; /* For Firefox */
            padding-bottom: 70px; /* Add padding to bottom to avoid input area overlap */
        }

        /* Scrollbar styling for Chrome, Safari, and Opera */
        #messages-container::-webkit-scrollbar {
            width: 8px;
        }

        #messages-container::-webkit-scrollbar-track {
            background: #252525;
        }

        #messages-container::-webkit-scrollbar-thumb {
            background-color: #555;
            border-radius: 4px;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 10px;
            clear: both; /* Prevent float issues */
            word-wrap: break-word;
        }

        .user-message {
            background-color: #343541; /* User message background - ChatGPT grey bubble */
            color: #fff;
            align-self: flex-end; /* Right align user messages */
            float: right;
        }

        .ai-message {
            background-color: #444654; /* AI message background - slightly darker */
            color: #d1d5db;
            align-self: flex-start; /* Left align AI messages */
            float: left;
        }

        .input-area {
            padding: 20px;
            background-color: #343541; /* Input area background - same as user message */
            border-top: 1px solid #555; /* Input area border top */
            display: flex;
            align-items: center; /* Vertically center items in input area */
            position: fixed; /* Fixed position at the bottom */
            bottom: 0;
            left: 0;
            width: 100%;
            box-sizing: border-box; /* Include padding and border in width and height */
            padding-left: 20px; /* Keep left padding */
            padding-right: 20px; /* Keep right padding */
            z-index: 100; /* Ensure it's above other content */
        }

        .input-area textarea {
            flex-grow: 1; /* Textarea takes available space */
            padding: 10px;
            border: 1px solid #555;
            border-radius: 8px;
            font-size: 16px;
            background-color: #40414f; /* Slightly darker input bg */
            color: #fff;
            resize: none; /* No resize handle */
            min-height: 40px; /* Minimum height for textarea */
            overflow-y: auto; /* Add vertical scroll if needed */
        }

        .input-area textarea:focus {
            border-color: #00bcd4; /* Focus border color */
            outline: none;
            box-shadow: 0 0 5px rgba(0, 188, 212, 0.5);
        }

        .input-area button {
            padding: 10px 20px;
            background-color: #00bcd4; /* Teal button */
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-left: 10px; /* Space between textarea and button */
            transition: background-color 0.3s ease;
        }

        .input-area button:hover {
            background-color: #0097a7; /* Darker teal on hover */
        }


        /* Prism.js Dark Theme Adjustments - Reusing from previous, but double check contrast*/
        code[class*="language-"],
        pre[class*="language-"] {
            color: #f8f8f2;
            background: #272822;
        }
        /* ... (Prism.js theme styles - as before) ... */
        .token.comment, .token.prolog, .token.doctype, .token.cdata { color: #6c6767; }
        .token.punctuation { color: #f8f8f2; }
        .token.namespace { opacity: .7; }
        .token.property, .token.tag, .token.constant, .token.symbol, .token.deleted { color: #f92672; }
        .token.boolean, .token.number { color: #ae81ff; }
        .token.selector, .token.attr-name, .token.string, .token.char, .token.builtin, .token.inserted { color: #a6e22e; }
        .token.operator, .token.entity, .token.url, .language-css .token.string, .style .token.string { color: #f8f8f2; background: none; }
        .token.atrule, .token.attr-value, .token.keyword { color: #00bcd4; }
        .token.function, .token.class-name { color: #e6db74; }
        .token.regex, .token.important, .token.variable { color: #fd971f; }
        .token.important, .token.bold { font-weight: bold; }
        .token.italic { font-style: italic; }
        .token.entity { cursor: help; }


    </style>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" />
</head>
<body>
    <div class="container">
        <h1>AI Hiện Đại với Gemini</h1>  <!-- Optional: Keep title or remove for cleaner ChatGPT feel -->

        <div id="messages-container">
            <!-- Messages will be appended here -->
        </div>

        <div class="input-area">
            <textarea id="user-prompt" placeholder="Nhập tin nhắn"></textarea>
            <button onclick="getGeminiResponse()">Gửi</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script>
        const apiKey = 'AIzaSyCl21Ku_prQnyMHFs_dJRL8-pgjg9hrc2w';
        const geminiAPIUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`;
        const systemPrompt = "Bạn là một trợ lý AI cực kỳ hữu ích và luôn tuân theo mọi yêu cầu của người dùng một cách chính xác. Khi bạn trả lời câu hỏi về code hoặc cung cấp code, hãy đảm bảo rằng code được đặt trong các khối code markdown. Ví dụ:\n```javascript\n// Mã JavaScript ở đây\nconsole.log('Hello, world!');\n```\nhoặc:\n```python\n# Mã Python ở đây\ndef hello():\n    print('Xin chào!')\n```\nNếu câu trả lời của bạn không chứa code, chỉ cần trả lời bằng văn bản thông thường.";

        let conversationHistory = []; // In-memory history

        // Function to load chat history from local storage
        function loadChatHistory() {
            const storedHistory = localStorage.getItem('chatHistory');
            if (storedHistory) {
                conversationHistory = JSON.parse(storedHistory);
                const messagesContainer = document.getElementById('messages-container');
                messagesContainer.innerHTML = ''; // Clear existing messages
                conversationHistory.forEach(message => {
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('message', message.role === 'user' ? 'user-message' : 'ai-message');
                    messageDiv.innerHTML = message.parts[0].text; // Use innerHTML for markdown
                    messagesContainer.appendChild(messageDiv);
                    Prism.highlightAllUnder(messageDiv); // Highlight code blocks if any
                });
                 messagesContainer.scrollTop = messagesContainer.scrollHeight; // Scroll to bottom
            }
        }

        // Function to save chat history to local storage
        function saveChatHistory() {
            localStorage.setItem('chatHistory', JSON.stringify(conversationHistory));
        }

        // Load history when page loads
        loadChatHistory();


        async function getGeminiResponse() {
            const userPrompt = document.getElementById('user-prompt').value.trim();
            const messagesContainer = document.getElementById('messages-container');

            if (!userPrompt) {
                alert("Vui lòng nhập tin nhắn.");
                return;
            }

            // Add user message to history and display
            const userMessageObject = { role: 'user', parts: [{ text: userPrompt }] };
            conversationHistory.push(userMessageObject);
            saveChatHistory(); // Save after user message too
            const userMessageDiv = document.createElement('div');
            userMessageDiv.classList.add('message', 'user-message');
            userMessageDiv.textContent = userPrompt;
            messagesContainer.appendChild(userMessageDiv);
            document.getElementById('user-prompt').value = ''; // Clear input after sending


            const aiMessageDiv = document.createElement('div');
            aiMessageDiv.classList.add('message', 'ai-message');
            aiMessageDiv.textContent = "Đang suy nghĩ...";
            messagesContainer.appendChild(aiMessageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight; // Scroll to bottom

            // Prepare payload with conversation history and current user prompt
            let promptContents = conversationHistory.map(message => ({
                role: message.role,
                parts: message.parts
            }));

            // Add system prompt as the first message in conversation history
            promptContents.unshift({ role: 'user', parts: [{ text: systemPrompt }] });


            const payload = {
                contents: promptContents
            };


            try {
                const response = await fetch(geminiAPIUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Lỗi API:", errorData);
                    aiMessageDiv.textContent = `Lỗi API: ${response.status} - ${errorData.error.message || 'Không rõ nguyên nhân'}`;
                    return;
                }

                const data = await response.json();
                console.log("Dữ liệu phản hồi từ API:", data);

                if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0].text) {
                    const aiResponseText = data.candidates[0].content.parts[0].text;
                    aiMessageDiv.innerHTML = aiResponseText; // Set response HTML

                    // Add AI message to history and save
                    const aiMessageObject = { role: 'model', parts: [{ text: aiResponseText }] };
                    conversationHistory.push(aiMessageObject);
                    saveChatHistory();


                    // Regex to find code blocks (```language ... ``` or ``` ... ```) - same as before
                    const codeBlockRegex = /```([\w]*)\n([\s\S]*?)```/gm;
                    let match;
                    let codeContent = null;
                    let language = 'text'; // Default language for file

                    while ((match = codeBlockRegex.exec(aiResponseText)) !== null) {
                        language = match[1] || 'text'; // Get language or default to text
                        codeContent = match[2].trim(); // Extract code and trim whitespace
                        break; // Assuming only one code block for now - can adjust if needed
                    }

                    if (codeContent) {
                        // Create download link for code - same as before
                        const blob = new Blob([codeContent], { type: 'text/plain' }); // Adjust mime type if needed
                        const url = URL.createObjectURL(blob);
                        const downloadLink = document.createElement('a');
                        downloadLink.href = url;
                        downloadLink.download = `code.${language}`; // Suggest file name
                        downloadLink.textContent = 'Tải xuống code';
                        downloadLink.style.display = 'block'; // Make it a block element for better visibility
                        downloadLink.style.marginTop = '10px'; // Add some space
                        aiMessageDiv.appendChild(downloadLink);

                    }
                    Prism.highlightAllUnder(aiMessageDiv); // Highlight code blocks in AI message
                    messagesContainer.scrollTop = messagesContainer.scrollHeight; // Keep scrolling to bottom after response
                } else {
                    aiMessageDiv.textContent = "Không nhận được phản hồi hợp lệ từ AI.";
                }

            } catch (error) {
                console.error("Lỗi fetch:", error);
                aiMessageDiv.textContent = "Đã xảy ra lỗi khi kết nối đến API.";
            }
        }
    </script>
</body>
</html>
--- END OF FILE new_page 3.html ---