<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Hiện Đại với Gemini</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* General Styles */
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #202123; /* Dark background */
            color: #e8eaed; /* Light text */
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .container {
            width: 95%;
            max-width: 1200px;
            margin: 20px auto;
            padding: 25px;
            background-color: #303134; /* Darker container */
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            flex-grow: 1;
            margin-left: auto;
            transition: margin-left 0.3s ease;
            border: 1px solid #3e3f42;
        }

        .container.sidebar-open {
            margin-left: 250px;
        }

        h1 {
            text-align: center;
            color: #fff;
            margin-bottom: 20px;
            font-size: 2.2em;
            letter-spacing: 0.3px;
            padding-bottom: 15px;
            border-bottom: 1px solid #444;
        }

        /* Message Container Styles */
        #messages-container {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            scrollbar-width: thin;
            scrollbar-color: #555 #252525;
            padding-bottom: 70px;
            border: 1px solid #3e3f42; /* Added border */
            border-radius: 8px;
            background-color: #202123; /* Darker background */
        }

        #messages-container::-webkit-scrollbar {
            width: 8px;
        }

        #messages-container::-webkit-scrollbar-track {
            background: #252525;
        }

        #messages-container::-webkit-scrollbar-thumb {
            background-color: #555;
            border-radius: 4px;
        }

        .message {
            margin-bottom: 12px;
            padding: 10px 14px;
            border-radius: 15px;
            clear: both;
            word-wrap: break-word;
            max-width: 80%;
            display: inline-block;
            border: 1px solid #3e3f42; /* Added border */
            position: relative; /* For avatar positioning */
            padding-left: 50px; /* Space for avatar */
            min-height: 40px; /* Ensure enough height for the avatar */
        }


        .message .avatar {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #5f6368; /* Google-like avatar color */
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 16px;
            overflow: hidden;
        }

        .message .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-message {
            background-color: #343541;
            color: #fff;
            align-self: flex-end;
            float: right;
            border-top-right-radius: 3px;
        }

        .ai-message {
            background-color: #444654;
            color: #e8eaed;
            align-self: flex-start;
            float: left;
            border-top-left-radius: 3px;
        }

        /* Input Area Styles */
        .input-area {
            padding: 15px 20px;
            background-color: #343541;
            border-top: 1px solid #555;
            display: flex;
            align-items: center;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            box-sizing: border-box;
            padding-left: 20px;
            padding-right: 20px;
            z-index: 100;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
            border-top: 1px solid #444;
        }

        .input-area textarea {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #555;
            border-radius: 8px;
            font-size: 16px;
            background-color: #40414f;
            color: #fff;
            resize: none;
            min-height: 40px;
            overflow-y: auto;
            border: 1px solid #444;
        }

        .input-area textarea:focus {
            border-color: #8ab4f8; /* Google-like focus color */
            outline: none;
        }

        .input-area button {
            padding: 10px 20px;
            background-color: #8ab4f8; /* Google-like blue */
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-left: 10px;
        }

        .input-area button:hover {
            background-color: #669df6;
        }


        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            height: 100%;
            background-color: #202123; /* Dark background */
            color: #e8eaed; /* Light text */
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 200;
            padding-top: 60px;
            overflow-y: auto;
            touch-action: manipulation;
            border-right: 1px solid #3e3f42;
        }

        .sidebar.sidebar--open {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #3e3f42;
            margin-bottom: 20px;
        }

        .sidebar-menu {
            padding: 0;
            list-style: none;
        }

        .sidebar-menu-item {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid transparent;
        }

        .sidebar-menu-item:hover {
            background-color: #3e3f42;
        }

        .sidebar-menu-item.has-submenu > .menu-link::after {
            content: '>';
            float: right;
            margin-left: 10px;
            font-size: 0.8em;
            display: inline-block;
        }

        .submenu {
            list-style: none;
            padding-left: 0;
            margin: 0;
            border-radius: 8px;
            overflow: hidden;
            background-color: #2a2b2d; /* Slightly lighter dark */
            margin-top: 5px;
            max-height: 0;
            opacity: 0;
            transition: max-height 0.3s ease-out, opacity 0.2s ease-out;
            overflow-y: hidden;
            padding-top: 0;
            padding-bottom: 0;
        }

        .submenu.open {
            display: block;
            max-height: 500px;
            opacity: 1;
            overflow-y: auto;
            padding-top: 5px;
            padding-bottom: 10px;
        }

        .submenu-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #3e3f42;
        }

        .submenu-item:last-child {
            border-bottom: none;
        }

        .submenu-item:hover {
            background-color: #3e3f42;
        }

        .history-name {
            flex-grow: 1;
        }

        .delete-history-btn {
            background: transparent;
            border: none;
            color: #70757a; /* Softer color */
            cursor: pointer;
            font-size: 1em;
            padding: 0 8px;
            opacity: 0.7;
        }

        .delete-history-btn:hover {
            opacity: 1;
            color: #e8eaed;
        }

        .sidebar-toggle-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #8ab4f8; /* Google-like blue */
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 300;
        }

        .sidebar-toggle-button:hover {
            background-color: #669df6;
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 150;
            display: none;
        }

        .sidebar-overlay.sidebar--open {
            display: block;
        }

        .close-history-menu-btn {
            background-color: #8ab4f8; /* Google-like blue */
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            cursor: pointer;
            margin-top: 10px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .close-history-menu-btn:hover {
            background-color: #669df6;
        }

        /* Modal Styles */
        .custom-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 400;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }

        .custom-modal-overlay.show-modal {
            display: flex;
            pointer-events: auto;
        }

        .custom-modal {
            background-color: #303134; /* Dark background */
            color: #e8eaed; /* Light text */
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 400px;
            text-align: center;
            border: 1px solid #3e3f42;
        }

        .modal-message {
            margin-bottom: 15px;
        }

        .modal-input {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid #555;
            background-color: #40414f;
            color: #fff;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .modal-button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            border: 1px solid #3e3f42;
        }

        .modal-button.confirm {
            background-color: #8ab4f8; /* Google-like blue */
            color: white;
        }

        .modal-button.confirm:hover {
            background-color: #669df6;
        }

        .modal-button.cancel {
            background-color: #555;
            color: white;
        }

        .modal-button.cancel:hover {
            background-color: #666;
        }

        /* Code Highlighting Styles (Prism.js) */
        code[class*="language-"],
        pre[class*="language-"] {
            color: #f8f8f2;
            background: #272822;
            /* Removed shadows and effects from code blocks */
        }
        .token.comment, .token.prolog, .token.doctype, .token.cdata { color: #6c6767; }
        .token.punctuation { color: #f8f8f2; }
        .token.namespace { opacity: .7; }
        .token.property, .token.tag, .token.constant, .token.symbol, .token.deleted { color: #f92672; }
        .token.boolean, .token.number { color: #ae81ff; }
        .token.selector, .token.attr-name, .token.string, .token.char, .token.builtin, .token.inserted { color: #a6e22e; }
        .token.operator, .token.entity, .token.url, .language-css .token.string, .style .token.string { color: #f8f8f2; background: none; }
        .token.atrule, .token.attr-value, .token.keyword { color: #00bcd4; }
        .token.function, .token.class-name { color: #e6db74; }
        .token.regex, .token.important, .token.variable { color: #fd971f; }
        .token.important, .token.bold { font-weight: bold; }
        .token.italic { font-style: italic; }
        .token.entity { cursor: help; }

        /* Utility Classes */
        .hidden { display: none !important; }
        .code-buttons {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
        }

        .code-buttons button {
            background-color: #555;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.8em;
             /* Removed effects from copy buttons */
        }

        .code-buttons button:hover {
            background-color: #666;
        }
    </style>
</head>
<body>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Lịch sử Chat</h3>
        </div>
        <ul class="sidebar-menu">
            <li class="sidebar-menu-item" onclick="openSaveHistoryModal()">
                <span class="menu-link">Lưu lịch sử này</span>
            </li>
            <li class="sidebar-menu-item has-submenu" onclick="toggleHistoryMenu()">
                <span class="menu-link">Lịch sử đã lưu</span>
                </li>
        </ul>

        <ul class="submenu" id="saved-histories-menu">
            <button class="close-history-menu-btn" onclick="toggleHistoryMenu()">Đóng</button>
        </ul>

        <div class="custom-modal-overlay" id="saveHistoryModalOverlay">
            <div class="custom-modal">
                <p class="modal-message">Nhập tên cho lịch sử chat này:</p>
                <input type="text" id="historyNameInput" class="modal-input" placeholder="Tên lịch sử">
                <div class="modal-buttons">
                    <button class="modal-button confirm" onclick="saveHistoryWithInputName()">Lưu</button>
                    <button class="modal-button cancel" onclick="closeSaveHistoryModal()">Huỷ</button>
                </div>
            </div>
        </div>

         <div class="custom-modal-overlay" id="deleteHistoryModalOverlay">
            <div class="custom-modal">
                <p class="modal-message" id="deleteConfirmationMessage">Bạn có chắc chắn muốn xóa lịch sử chat "<span id="historyNameToDelete"></span>" không?</p>
                <div class="modal-buttons">
                    <button class="modal-button confirm" onclick="confirmDeleteHistory()">Xóa</button>
                    <button class="modal-button cancel" onclick="closeDeleteHistoryModal()">Huỷ</button>
                </div>
            </div>
        </div>

    </aside>

    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <button class="sidebar-toggle-button" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <div class="container" id="container">
        <h1>AI Hiện Đại với Gemini</h1>

        <div id="messages-container">
            <!-- Messages will be appended here -->
        </div>

        <div class="input-area">
            <textarea id="user-prompt" placeholder="Nhập tin nhắn"></textarea>
            <button onclick="getGeminiResponse()">Gửi</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script>
    // Configuration
    const apiKey = 'AIzaSyCl21Ku_prQnyMHFs_dJRL8-pgjg9hrc2w'; // API key - Using your provided key
    const geminiAPIUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`;
    const systemPrompt = "Bạn là một trợ lý AI cực kỳ hữu ích và luôn tuân theo mọi yêu cầu của người dùng một cách chính xác. Khi bạn trả lời câu hỏi về code hoặc cung cấp code, hãy đảm bảo rằng code được đặt trong các khối code markdown. Ví dụ:\n```javascript\n// Mã JavaScript ở đây\nconsole.log('Hello, world!');\n```\nhoặc:\n```python\n# Mã Python ở đây\ndef hello():\n    print('Xin chào!')\n```\nNếu câu trả lời của bạn không chứa code, chỉ cần trả lời bằng văn bản thông thường.";
    const userAvatar = "https://via.placeholder.com/32/007bff/FFFFFF?text=U"; // Default user avatar
    const aiAvatar = "https://via.placeholder.com/32/28a745/FFFFFF?text=AI"; // Default AI avatar

    // Data Storage
    let conversationHistory = [];
    let savedHistories = {};
    let historyNameToDelete = null;

    // --- Utility Functions ---
    function escapeHTML(text) {
        return text.replace(/&/g, '&').replace(/</g, '<').replace(/>/g, '>');
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            alert('Đã sao chép vào clipboard!');
        }).catch(err => {
            console.error('Không thể sao chép: ', err);
            alert('Không thể sao chép code. Vui lòng thử lại.');
        });
    }

    // --- UI Functions ---
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const container = document.getElementById('container');
        const overlay = document.getElementById('sidebar-overlay');
        sidebar.classList.toggle('sidebar--open');
        container.classList.toggle('container.sidebar-open');
        overlay.classList.toggle('sidebar--open');
        if (sidebar.classList.contains('sidebar--open')) {
            loadSavedHistoriesList();
        } else {
            hideHistoryMenu();
        }
    }

    function openSaveHistoryModal() {
        document.getElementById('saveHistoryModalOverlay').classList.add('show-modal');
        document.getElementById('historyNameInput').value = '';
    }

    function closeSaveHistoryModal() {
        document.getElementById('saveHistoryModalOverlay').classList.remove('show-modal');
    }

    function openDeleteHistoryModal(name) {
        historyNameToDelete = name;
        document.getElementById('historyNameToDelete').textContent = name;
        document.getElementById('deleteHistoryModalOverlay').classList.add('show-modal');
    }

    function closeDeleteHistoryModal() {
        document.getElementById('deleteHistoryModalOverlay').classList.remove('show-modal');
        historyNameToDelete = null;
    }

    function toggleHistoryMenu() {
        const submenu = document.getElementById('saved-histories-menu');
        submenu.classList.toggle('open');
    }

    function hideHistoryMenu() {
        const submenu = document.getElementById('saved-histories-menu');
        submenu.classList.remove('open');
    }

    // --- Data Management Functions ---
    function loadChatHistory() {
        const storedHistory = localStorage.getItem('chatHistory');
        if (storedHistory) {
            conversationHistory = JSON.parse(storedHistory);
            renderMessages();
        }
    }

    function saveChatHistory() {
        localStorage.setItem('chatHistory', JSON.stringify(conversationHistory));
    }

    function saveHistoryWithInputName() {
        const historyName = document.getElementById('historyNameInput').value.trim();
        if (historyName) {
            savedHistories[historyName] = [...conversationHistory];
            localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
            alert(`Lịch sử chat đã được lưu với tên: ${historyName}`);
            loadSavedHistoriesList();
            closeSaveHistoryModal();
        } else {
            alert("Vui lòng nhập tên cho lịch sử chat.");
        }
    }

    function confirmDeleteHistory() {
        if (historyNameToDelete) {
            deleteSavedHistory(historyNameToDelete);
        }
        closeDeleteHistoryModal();
    }

    function deleteSavedHistory(historyName) {
        delete savedHistories[historyName];
        localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
        loadSavedHistoriesList();
        alert(`Lịch sử chat "${historyName}" đã bị xóa.`);
    }

    function loadChatHistoryByName(historyName) {
        if (savedHistories[historyName]) {
            conversationHistory = [...savedHistories[historyName]];
            saveChatHistory();
            renderMessages();
            toggleHistoryMenu();
            toggleSidebar();
        } else {
            alert("Không tìm thấy lịch sử chat đã lưu.");
        }
    }

    function loadSavedHistoriesList() {
        const historiesMenu = document.getElementById('saved-histories-menu');
        historiesMenu.innerHTML = '<button class="close-history-menu-btn" onclick="toggleHistoryMenu()">Đóng</button>';

        const storedSavedHistories = localStorage.getItem('savedHistories');
        if (storedSavedHistories) {
            savedHistories = JSON.parse(storedSavedHistories);
        } else {
            savedHistories = {};
        }

        if (Object.keys(savedHistories).length === 0) {
            const noHistoryItem = document.createElement('li');
            noHistoryItem.classList.add('submenu-item');
            noHistoryItem.textContent = "Chưa có lịch sử nào được lưu.";
            historiesMenu.appendChild(noHistoryItem);
            return;
        }

        for (const historyName in savedHistories) {
            const historyItem = document.createElement('li');
            historyItem.classList.add('submenu-item');

            const nameSpan = document.createElement('span');
            nameSpan.classList.add('history-name');
            nameSpan.textContent = historyName;
            nameSpan.onclick = () => loadChatHistoryByName(historyName);

            const deleteButton = document.createElement('button');
            deleteButton.classList.add('delete-history-btn');
            deleteButton.textContent = '...';
            deleteButton.onclick = (event) => {
                event.stopPropagation();
                openDeleteHistoryModal(historyName);
            };

            historyItem.appendChild(nameSpan);
            historyItem.appendChild(deleteButton);
            historiesMenu.appendChild(historyItem);
        }
    }

    // --- Message Rendering Functions ---
    function renderMessage(message) {
        const messagesContainer = document.getElementById('messages-container');
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', message.role === 'user' ? 'user-message' : 'ai-message');

        // Avatar
        const avatarDiv = document.createElement('div');
        avatarDiv.classList.add('avatar');
        const avatarImg = document.createElement('img');
        avatarImg.src = message.role === 'user' ? userAvatar : aiAvatar; // Use avatars
        avatarDiv.appendChild(avatarImg);
        messageDiv.appendChild(avatarDiv);

        messageDiv.innerHTML += message.parts[0].text;
        messagesContainer.appendChild(messageDiv);

        Prism.highlightAllUnder(messageDiv); // Highlight code

        // Add code copy buttons - UPDATED LOGIC
        const codeBlocks = messageDiv.querySelectorAll('pre code');
        codeBlocks.forEach(codeBlock => {
            const preElement = codeBlock.parentNode; // Get the <pre> element
            const codeButtons = document.createElement('div');
            codeButtons.classList.add('code-buttons');

            const copyButton = document.createElement('button');
            copyButton.textContent = 'Sao chép';
            copyButton.addEventListener('click', () => {
                copyToClipboard(codeBlock.textContent); // Directly copy code text
            });
            codeButtons.appendChild(copyButton);

            preElement.style.position = 'relative'; // Ensure the <pre> element is positioned
            preElement.appendChild(codeButtons); // Append to the <pre> element
        });

        messagesContainer.scrollTop = messagesContainer.scrollHeight; // Scroll to bottom
    }

    function renderMessages() {
        const messagesContainer = document.getElementById('messages-container');
        messagesContainer.innerHTML = ''; // Clear existing messages
        conversationHistory.forEach(message => renderMessage(message));
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // --- Gemini API Interaction ---
    async function getGeminiResponse() {
        const userPrompt = document.getElementById('user-prompt').value.trim();
        if (!userPrompt) {
            alert("Vui lòng nhập tin nhắn.");
            return;
        }

        const userMessageObject = { role: 'user', parts: [{ text: userPrompt }] };
        conversationHistory.push(userMessageObject);
        renderMessage(userMessageObject);
        saveChatHistory();
        document.getElementById('user-prompt').value = '';

        try {
            let promptContents = conversationHistory.map(message => ({
                role: message.role,
                parts: message.parts
            }));
            promptContents.unshift({ role: 'user', parts: [{ text: systemPrompt }] });

            const payload = {
                contents: promptContents
            };

            const response = await fetch(geminiAPIUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error("Lỗi API:", errorData);
                const errorMessage = `Lỗi API: ${response.status} - ${errorData.error.message ||
'Không rõ nguyên nhân'}`;
                const aiMessageObject = { role: 'model', parts: [{ text: errorMessage }] };
                conversationHistory.push(aiMessageObject);
                renderMessage(aiMessageObject);
                saveChatHistory();
                return;
            }

            const data = await response.json();
            console.log("Dữ liệu phản hồi từ API:", data);

            if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0].text) {
                let aiResponseText = data.candidates[0].content.parts[0].text;

                const aiMessageObject = { role: 'model', parts: [{ text: aiResponseText }] };
                conversationHistory.push(aiMessageObject);
                renderMessage(aiMessageObject);
                saveChatHistory();

            } else {
                const errorMessage = "Không nhận được phản hồi hợp lệ từ AI.";
                const aiMessageObject = { role: 'model', parts: [{ text: errorMessage }] };
                conversationHistory.push(aiMessageObject);
                renderMessage(aiMessageObject);
                saveChatHistory();
            }

        } catch (error) {
            console.error("Lỗi fetch:", error);
            const errorMessage = "Đã xảy ra lỗi khi kết nối đến API.";
            const aiMessageObject = { role: 'model', parts: [{ text: errorMessage }] };
            conversationHistory.push(aiMessageObject);
            renderMessage(aiMessageObject);
            saveChatHistory();
        }
    }

    // --- Initialization ---
    window.onload = () => {
        loadChatHistory();
        loadSavedHistoriesList();

        // Auto-resize textarea
        const textarea = document.getElementById('user-prompt');
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
    };
</script>
</body>