<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Hiện Đại với Gemini</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Arial:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        :root {
            --background-color: #1e2124;
            --container-background-color: #25272b;
            --text-color: #d1d5db;
            --message-user-background-color: #343541;
            --message-ai-background-color: #444654;
            --input-area-background-color: #343541;
            --input-text-background-color: #40414f;
            --button-primary-color: #00bcd4;
            --button-primary-hover-color: #0097a7;
            --sidebar-background-color: #252525;
            --sidebar-text-color: #fff;
            --modal-background-color: #343541;
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-touch-callout: none;
            -webkit-user-select: text;
            -khtml-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
            touch-action: manipulation;
            -webkit-text-size-adjust: 100%;
            font-size: 16px;
            overflow-y: scroll;
            scrollbar-width: thin;
            scrollbar-color: #444 #252525;
            transition: background-color 0.3s ease, color 0.3s ease;
            overscroll-behavior-y: none;
        }

        body::-webkit-scrollbar {
            width: 8px;
        }

        body::-webkit-scrollbar-track {
            background: #252525;
        }

        body::-webkit-scrollbar::-webkit-scrollbar-thumb {
            background-color: #444;
            border-radius: 4px;
        }


        .container {
            width: 95%;
            max-width: 1400px; /* Increased container max width */
            margin: 20px auto;
            padding: 30px;
            background-color: var(--container-background-color);
            border-radius: 24px;
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.6);
            display: flex;
            flex-direction: column;
            height: calc(100vh - 40px);
            flex-grow: 1;
            margin-left: auto;
            transition: margin-left 0.3s ease, background-color 0.3s ease;
            border: none;
            padding-top: max(30px, env(safe-area-inset-top));
            padding-bottom: max(30px, env(safe-area-inset-bottom));
        }

        .container.sidebar-open {
            margin-left: 250px;
        }

        h1 {
            text-align: center;
            color: #fff;
            margin-bottom: 30px;
            font-size: 2.8em;
            letter-spacing: -0.8px;
            padding-bottom: 25px;
            border-bottom: 1px solid #444;
            opacity: 0.95;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        #messages-container {
            flex-grow: 1;
            padding: 25px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            scrollbar-width: thin;
            scrollbar-color: #555 #252525;
            padding-bottom: 80px;
            border: none;
            border-radius: 16px;
            background-color: #1e2124;
             box-shadow: inset 0 3px 6px rgba(0, 0, 0, 0.4);
             transition: background-color 0.3s ease;
             padding-top: 30px;
             position: relative; /* For copy notification positioning */
        }

        #messages-container::-webkit-scrollbar {
            width: 8px;
        }

        #messages-container::-webkit-scrollbar::-webkit-scrollbar-track {
            background: #252525;
        }

        #messages-container::-webkit-scrollbar::-webkit-scrollbar-thumb {
            background-color: #555;
            border-radius: 4px;
        }

        .message {
            margin-bottom: 20px;
            padding: 14px 20px;
            border-radius: 24px;
            clear: both;
            word-wrap: break-word;
            max-width: 95%; /* Increased message max width */
            display: inline-block;
             box-shadow: 0 2px 5px rgba(0, 0, 0, 0.25);
             transition: background-color 0.3s ease, color 0.3s ease, border-radius 0.3s ease;
             position: relative; /* For positioning copy notification */
        }

        .user-message {
            background-color: var(--message-user-background-color);
            color: #fff;
            align-self: flex-end;
            float: right;
            border-top-right-radius: 8px;
            border-bottom-right-radius: 24px;
        }

        .ai-message {
            background-color: var(--message-ai-background-color);
            color: var(--text-color);
            align-self: flex-start;
            float: left;
            border-top-left-radius: 8px;
            border-bottom-left-radius: 24px;
        }

        .ai-message .ai-message-text {
            font-family: 'Arial', sans-serif;
            font-weight: 400;
            line-height: 1.8;
            white-space: pre-line;
            font-size: 16px;
             transition: color 0.3s ease;
        }

        .markdown-bold-uppercase {
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: #f0f0f0;
            opacity: 1;
             transition: color 0.3s ease;
        }

        .input-area {
            padding: 16px 24px;
            background-color: var(--input-area-background-color);
            border-top: 1px solid #555;
            display: flex;
            align-items: center;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            box-sizing: border-box;
            padding-left: 20px;
            padding-right: 20px;
            z-index: 100;
            border-bottom-left-radius: 24px;
            border-bottom-right-radius: 24px;
             border-top: 1px solid #444;
             transition: background-color 0.3s ease;
             padding-bottom: max(16px, env(safe-area-inset-bottom));
        }

        .input-area textarea {
            flex-grow: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            background-color: var(--input-text-background-color);
            color: #fff;
            resize: none;
            min-height: 42px;
            overflow-y: auto;
             box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.35);
             transition: background-color 0.3s ease, color 0.3s ease;
        }

        .input-area textarea:focus {
            border-color: var(--button-primary-color);
            outline: none;
            box-shadow: 0 0 8px rgba(0, 188, 212, 0.7);
        }

        .input-area button {
            padding: 14px 24px;
            background-color: var(--button-primary-color);
            color: white;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            font-size: 16px;
            margin-left: 16px;
            transition: background-color 0.3s ease, transform 0.2s ease, border-radius 0.3s ease;
        }

        .input-area button:hover {
            background-color: var(--button-primary-hover-color);
            transform: scale(1.03);
        }

        .file-upload-button {
            background-color: #555;
            color: white;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            font-size: 1em;
            width: 44px;
            height: 44px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 16px;
            opacity: 0.9;
            transition: opacity 0.3s ease, background-color 0.3s ease, transform 0.2s ease, border-radius 0.3s ease;
        }

        .file-upload-button:hover {
            opacity: 1;
            background-color: #666;
             transform: scale(1.03);
        }


        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            height: 100%;
            background-color: var(--sidebar-background-color);
            color: var(--sidebar-text-color);
            transform: translateX(-100%);
            transition: transform 0.3s ease, background-color 0.3s ease;
            z-index: 200;
            padding-top: 70px;
            box-shadow: 6px 0 12px rgba(0,0,0,0.4);
            overflow-y: auto;
            touch-action: manipulation;
            border-right: 1px solid #444;
             backdrop-filter: blur(12px);
        }

        .sidebar.sidebar--open {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 28px 24px;
            text-align: center;
            border-bottom: 1px solid #555;
            margin-bottom: 30px;
            border-bottom: 1px solid #444;
            transition: background-color 0.3s ease, border-bottom-color 0.3s ease;
        }

        .sidebar-menu {
            padding: 0;
            list-style: none;
        }

        .sidebar-menu-item {
            padding: 18px 24px;
            cursor: pointer;
            transition: background-color 0.2s ease, border-bottom-color 0.3s ease, color 0.3s ease, padding-left 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid transparent;
        }
         .sidebar-menu-item:active {
             background-color: #3a3b47;
         }


        .sidebar-menu-item:hover {
            background-color: #343541;
             border-bottom-color: var(--button-primary-color);
             padding-left: 30px;
        }

        .sidebar-menu-item.has-submenu > .menu-link::after {
            content: '>';
            float: right;
            margin-left: 12px;
            font-size: 0.9em;
            display: inline-block;
            color: #aaa;
        }

        .submenu {
            list-style: none;
            padding-left: 0;
            margin: 0;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 5px 10px rgba(0,0,0,0.45);
            background-color: #2c2c2c;
            margin-top: 12px;
            max-height: 0;
            opacity: 0;
            transition: max-height 0.4s ease-out, opacity 0.3s ease-out, background-color 0.3s ease, margin-top 0.3s ease;
            overflow-y: hidden;
            padding-top: 0;
            padding-bottom: 0;
        }

        .submenu.open {
            display: block;
            max-height: 600px;
            opacity: 1;
            overflow-y: auto;
            padding-top: 12px;
            padding-bottom: 16px;
            margin-top: 16px;
        }


        .submenu-item {
            padding: 16px 24px;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.3s ease, padding-left 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }
         .submenu-item:active {
             background-color: #3a3b47;
         }


        .submenu-item:last-child {
            border-bottom: none;
        }


        .submenu-item:hover {
            background-color: #343541;
            padding-left: 30px;
        }

        .history-name {
            flex-grow: 1;
             transition: color 0.3s ease;
             opacity: 0.9;
        }

        .delete-history-btn {
            background: transparent;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 1em;
            padding: 0 10px;
            opacity: 0.7;
            transition: opacity 0.2s ease, color 0.2s ease;
        }

        .delete-history-btn:hover {
            opacity: 1;
            color: #fff;
        }

        .sidebar-toggle-button {
            position: fixed;
            top: 30px;
            left: 30px;
            background: var(--button-primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 300;
             box-shadow: 0 3px 6px rgba(0, 0, 0, 0.35);
             transition: background-color 0.3s ease, transform 0.2s ease, border-radius 0.3s ease;
        }

        .sidebar-toggle-button:hover {
            background-color: var(--button-primary-hover-color);
             transform: scale(1.05);
        }
        .sidebar-toggle-button:active {
             transform: scale(0.98);
             opacity: 0.95;
         }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 150;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease, background-color 0.3s ease;

        }

        .sidebar-overlay.sidebar--open {
            display: block;
            opacity: 1;
        }

        .close-history-menu-btn, .close-settings-menu-btn, .modal-button {
            padding: 14px 24px;
            background-color: var(--button-primary-color);
            color: white;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            margin-top: 20px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            transition: background-color 0.3s ease, transform 0.2s ease, border-radius 0.3s ease;
        }

        .close-history-menu-btn:hover, .close-settings-menu-btn:hover, .modal-button.confirm:hover {
            background-color: var(--button-primary-hover-color);
             transform: scale(1.03);
        }
         .close-history-menu-btn:active, .close-settings-menu-btn:active,  .modal-button.confirm:active {
             transform: scale(0.98);
             opacity: 0.95;
         }


         .modal-button.cancel {
            background-color: #555;
            color: white;
        }

        .modal-button.cancel:hover {
            background-color: #666;
             transform: scale(1.03);
        }
         .modal-button.cancel:active {
             transform: scale(0.98);
             opacity: 0.95;
         }


        .custom-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 400;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease, background-color 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .custom-modal-overlay.show-modal {
            display: flex;
            opacity: 1;
            pointer-events: auto;
        }


        .custom-modal {
            background-color: var(--modal-background-color);
            color: #fff;
            padding: 35px;
            border-radius: 24px;
            box-shadow: 0 16px 32px rgba(0, 0, 0, 0.7);
            width: 85%;
            max-width: 500px;
            text-align: center;
            border: none;
            transform: scale(0.97);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease, background-color 0.3s ease, border-radius 0.3s ease;
        }

        .custom-modal-overlay.show-modal .custom-modal {
            transform: scale(1);
            opacity: 1;
        }


        .modal-message {
            margin-bottom: 25px;
            font-size: 1.2em;
             transition: color 0.3s ease;
             font-weight: 500;
             opacity: 0.95;
        }

        .modal-input {
            width: calc(100% - 24px);
            padding: 14px 16px;
            margin-bottom: 25px;
            border-radius: 12px;
            border: none;
            background-color: var(--input-text-background-color);
            color: #fff;
             box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.35);
             transition: background-color 0.3s ease, color 0.3s ease;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 10px;
        }

        .modal-button {
            padding: 14px 28px;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease, transform 0.2s ease, border-radius 0.3s ease;
            border: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.25);
        }

        code[class*="language-"],
        pre[class*="language-"] {
            color: #abb2bf; /* Adjusted code color - Màu code giống Gemini */
            background: #282c34; /* Dark background for code blocks, like Gemini - Màu nền code block giống Gemini */
            position: relative;
            overflow-x: auto;
             padding: 1.2em 1.5em; /* Increased padding - Tăng padding */
             border-radius: 12px; /* More rounded corners - Bo tròn góc hơn */
             margin-bottom: 18px;
             z-index: 1;
             font-size: 0.9rem; /* Slightly smaller font size in code blocks - Font chữ nhỏ hơn chút */
             border: 1px solid #383e49; /* Subtle border for code blocks - Viền nhẹ cho code blocks */
             white-space: pre; /* Ensure spaces and line breaks are respected */
             word-wrap: normal; /* Prevent line breaks within words in code */
        }

       .copy-code-button {
            position: absolute;
            top: 8px; /* Positioned at the top right - Đặt ở góc trên bên phải */
            right: 8px;
            background-color: #383e49; /* Darker background for copy button - Nền tối hơn cho nút copy */
            color: #fff; /* White copy icon - Icon copy màu trắng */
            border: none; /* No border - Không viền */
            border-radius: 8px; /* Rounded copy button - Nút copy bo tròn */
            padding: 8px 10px; /* Adjusted padding - Chỉnh padding nút copy */
            font-size: 0.75em; /* Smaller font in button - Font chữ nhỏ hơn trong nút copy */
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s ease, background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
            z-index: 2;
        }
        .copy-code-button:hover {
            opacity: 1;
            background-color: var(--button-primary-color);
            color: white;
            border-color:  var(--button-primary-color);
        }
        pre[class*="language-"] {
            position: relative;
            z-index: 0;
        }

        /* Success Notification Styles */
        .copy-success-notification {
            position: absolute; /* Changed to absolute positioning - Đặt vị trí tuyệt đối */
            top: 0;      /* Position at the top of the message - Đặt ở trên cùng tin nhắn */
            left: 0;
            width: 100%;
            padding: 10px 15px;
            border-radius: 8px 8px 0 0; /* Rounded at top - Bo tròn ở trên */
            opacity: 0;
            visibility: hidden;
            z-index: 500;
            transition: opacity 0.3s ease, visibility 0.3s ease, background-color 0.3s ease, transform 0.3s ease;
            background-color: #4CAF50; /* Green background - Nền xanh lá */
            color: white;
            text-align: center;
            font-size: 0.9em;
            transform: translateY(-10px); /* Slide down animation - Hiệu ứng trượt xuống */
        }

        .copy-success-notification.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0); /* Slide in animation - Hiệu ứng trượt lên */
        }


        /* Settings Styles */
        .setting-item .toggle-switch .slider {
            background-color: #ccc;
        }
        .setting-item .toggle-switch input:checked + .slider {
            background-color: var(--button-primary-color);
        }


    </style>

</head>
<body>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Lịch sử Chat & Cài đặt</h3>
        </div>
        <ul class="sidebar-menu">
            <li class="sidebar-menu-item" onclick="startNewChat()">
                <span class="menu-link">Đoạn chat mới</span>
            </li>
            <li class="sidebar-menu-item" onclick="openSaveHistoryModal()">
                <span class="menu-link">Lưu lịch sử này</span>
            </li>
            <li class="sidebar-menu-item has-submenu" onclick="toggleHistoryMenu()">
                <span class="menu-link">Lịch sử đã lưu</span>
                </li>
            <li class="sidebar-menu-item has-submenu" onclick="toggleSettingsMenu()">
                <span class="menu-link">Cài đặt</span>
                </li>
        </ul>

        <ul class="submenu" id="saved-histories-menu">
            <button class="close-history-menu-btn" onclick="toggleHistoryMenu()">Đóng</button>
        </ul>

        <ul class="submenu" id="settings-menu">
            <button class="close-settings-menu-btn" onclick="toggleSettingsMenu()">Đóng</button>
            <li class="setting-item">
                <span class="setting-label">Tự động lưu lịch sử</span>
                <span class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="autoSaveHistoryToggle">
                        <span class="slider"></span>
                    </label>
                </span>
            </li>
             <li class="setting-item">
                <span class="setting-label">Tên lịch sử là câu hỏi đầu</span>
                <span class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="useFirstMessageAsNameToggle">
                        <span class="slider"></span>
                    </label>
                </span>
            </li>
             <li class="setting-item">
                <span class="setting-label">Màu nền</span>
                <span class="setting-control">
                    <input type="color" id="backgroundColorPicker" class="color-picker-input" value="#1e2124">
                </span>
            </li>
             <li class="setting-item">
                <span class="setting-label">Màu chữ</span>
                <span class="setting-control">
                    <input type="color" id="textColorPicker" class="color-picker-input" value="#d1d5db">
                </span>
            </li>
             <li class="setting-item">
                <span class="setting-label">Màu nền hộp chat</span>
                <span class="setting-control">
                    <input type="color" id="containerColorPicker" class="color-picker-input" value="#25272b">
                </span>
            </li>
            <li class="setting-item" style="justify-content: center; border-bottom: none; padding-top: 25px;">
                <button class="modal-button confirm" onclick="saveSettingsAndApplyTheme()">Lưu cài đặt</button>
                <button class="modal-button cancel" onclick="resetTheme()">Hoàn tác</button>
            </li>
        </ul>


        <div class="custom-modal-overlay" id="saveHistoryModalOverlay">
            <div class="custom-modal">
                <p class="modal-message">Nhập tên cho lịch sử chat này:</p>
                <input type="text" id="historyNameInput" class="modal-input" placeholder="Tên lịch sử">
                <div class="modal-buttons">
                    <button class="modal-button confirm" onclick="saveHistoryWithInputName()">Lưu</button>
                    <button class="modal-button cancel" onclick="closeSaveHistoryModal()">Huỷ</button>
                </div>
            </div>
        </div>

         <div class="custom-modal-overlay" id="deleteHistoryModalOverlay">
            <div class="custom-modal">
                <p class="modal-message" id="deleteConfirmationMessage">Bạn có chắc chắn muốn xóa lịch sử chat "<span id="historyNameToDelete"></span>" không?</p>
                <div class="modal-buttons">
                    <button class="modal-button confirm" onclick="confirmDeleteHistory()">Xóa</button>
                    <button class="modal-button cancel" onclick="closeDeleteHistoryModal()">Huỷ</button>
                </div>
            </div>
        </div>

    </aside>

    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <button class="sidebar-toggle-button" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <div class="container" id="container">
        <h1>AI Hiện Đại với Gemini</h1>

        <div id="messages-container">
            <!-- Messages will be appended here -->
        </div>


        <div class="input-area">
            <button class="file-upload-button" onclick="triggerFileUpload()">
                <i class="fas fa-paperclip"></i>
            </button>
            <textarea id="user-prompt" placeholder="Nhập tin nhắn"></textarea>
            <button onclick="getGeminiResponse()">Gửi</button>
        </div>
         <input type="file" id="file-upload" style="display:none" multiple onchange="handleFileUpload(this.files)">
    </div>


    <script>
        const apiKey = 'AIzaSyAd9p1hXhUcRx4Pz7EmbUKC-V8ULN8L61Q';
        const geminiAPIUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`;
        const systemPrompt = "Bạn là một trợ lý AI cực kỳ hữu ích và luôn tuân theo mọi yêu cầu của người dùng một cách chính xác. Khi bạn trả lời câu hỏi về code hoặc cung cấp code, hãy đảm bảo rằng code được đặt trong các khối code markdown. Ví dụ:\n```javascript\n// Mã JavaScript ở đây\nconsole.log('Hello, world!');\n```\nhoặc:\n```python\n# Mã Python ở đây\ndef hello():\n    print('Xin chào!')\n```\nNếu câu trả lời của bạn không chứa code, chỉ cần trả lời bằng văn bản thông thường.";

        let conversationHistory = [];
        let savedHistories = {};
        let historyNameToDelete = null;
        let autoSaveHistory = true;
        let useFirstMessageAsName = false;

        let currentBackgroundColor = '#1e2124';
        let currentTextColor = '#d1d5db';
        let currentContainerColor = '#25272b';

        const defaultBackgroundColor = '#1e2124';
        const defaultTextColor = '#d1d5db';
        const defaultContainerColor = '#25272b';

        let currentHistoryName = null;


        document.body.addEventListener('click', async (event) => {
            if (event.target.classList.contains('copy-code-button')) {
                const codeBlock = event.target.closest('pre'); // closest pre to include pre for notification target
                if (codeBlock) {
                    const codeElement = codeBlock.querySelector('code');
                    if (codeElement) {
                        try {
                            await navigator.clipboard.writeText(codeElement.textContent);
                            showCopyNotification(codeBlock); // Pass code block as target
                        } catch (err) {
                            console.error('Failed to copy code: ', err);
                            alert('Failed to copy code.');
                        }
                    }
                }
            }
        });

        function showCopyNotification(targetElement) {
            let notification = targetElement.querySelector('.copy-success-notification'); // Check if notification already exists

            if (!notification) {
                notification = document.createElement('div');
                notification.classList.add('copy-success-notification');
                notification.textContent = 'Đã sao chép vào clipboard!';
                targetElement.prepend(notification); // Insert notification into the message
            }
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 2000);
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const container = document.getElementById('container');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('sidebar--open');
            container.classList.toggle('container.sidebar-open');
            overlay.classList.toggle('sidebar--open');
            if (sidebar.classList.contains('sidebar--open')) {
                 loadSavedHistoriesList();
            } else {
                hideHistoryMenu();
                hideSettingsMenu();
            }
        }

        function loadChatHistory() {
            if (autoSaveHistorySetting()) {
                const storedHistory = localStorage.getItem('chatHistory');
                if (storedHistory) {
                    conversationHistory = JSON.parse(storedHistory);
                    renderMessages();
                }
            }
        }

        function saveChatHistory() {
            if (autoSaveHistorySetting()) {
                localStorage.setItem('chatHistory', JSON.stringify(conversationHistory));
            }
        }

        function renderMessages() {
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = '';
            conversationHistory.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', message.role === 'user' ? 'user-message' : 'ai-message');
                let messageText = message.parts[0].text;
                if (message.role === 'ai') {

                    messageDiv.innerHTML = `<span class="ai-message-text">${messageText}</span>`;

                    messageDiv.querySelectorAll('pre').forEach(codeBlock => {
                      let buttonExists =  codeBlock.querySelector('.copy-code-button') !== null;
                         if(!buttonExists ) {
                             codeBlock.insertAdjacentHTML('beforeend', '<button class="copy-code-button"><i class="fas fa-copy"></i></button>');
                         }
                          let notificationExists = codeBlock.querySelector('.copy-success-notification') !== null; // Remove old notification if any when rerendering.
                         if (notificationExists) {
                             codeBlock.querySelector('.copy-success-notification').remove();
                         }
                    });
                } else {
                    messageDiv.innerHTML = messageText;
                }
                messagesContainer.appendChild(messageDiv);
            });
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }


        function startNewChat() {
             if (currentHistoryName) {
                savedHistories[currentHistoryName] = [...conversationHistory];
                localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
            }
            conversationHistory = [];
            saveChatHistory();
            renderMessages();
            currentHistoryName = null;
            toggleSidebar();
        }


        function openSaveHistoryModal() {
            document.getElementById('saveHistoryModalOverlay').classList.add('show-modal');
            document.getElementById('historyNameInput').value = '';

            if (useFirstMessageAsNameSetting() && conversationHistory.length > 0 && conversationHistory[0].role === 'user') {
                document.getElementById('historyNameInput').value = conversationHistory[0].parts[0].text.substring(0, 50);
            }
        }

        function closeSaveHistoryModal() {
            document.getElementById('saveHistoryModalOverlay').classList.remove('show-modal');
        }

        function saveHistoryWithInputName() {
            let historyName = document.getElementById('historyNameInput').value.trim();
            if (!historyName) {
                if (useFirstMessageAsNameSetting() && conversationHistory.length > 0 && conversationHistory[0].role === 'user') {
                    historyName = conversationHistory[0].parts[0].text.substring(0, 50) || 'No Title';
                } else {
                    alert("Vui lòng nhập tên cho lịch sử chat.");
                    return;
                }
            }

            savedHistories[historyName] = [...conversationHistory];
            localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
            alert(`Lịch sử chat đã được lưu với tên: ${historyName}`);
            loadSavedHistoriesList();
            closeSaveHistoryModal();
             currentHistoryName = historyName;

        }

        function openDeleteHistoryModal(name) {
            historyNameToDelete = name;
            document.getElementById('historyNameToDelete').textContent = name;
            document.getElementById('deleteHistoryModalOverlay').classList.add('show-modal');
        }

        function closeDeleteHistoryModal() {
            document.getElementById('deleteHistoryModalOverlay').classList.remove('show-modal');
            historyNameToDelete = null;
        }

        function confirmDeleteHistory() {
            if (historyNameToDelete) {
                deleteSavedHistory(historyNameToDelete);
            }
            closeDeleteHistoryModal();
        }


        function deleteSavedHistory(historyName) {
            delete savedHistories[historyName];
            localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
            loadSavedHistoriesList();
            alert(`Lịch sử chat "${historyName}" đã bị xóa.`);
            if (currentHistoryName === historyName) {
                currentHistoryName = null;
            }

        }


        function loadChatHistoryByName(historyName) {
            if (savedHistories[historyName]) {
                conversationHistory = [...savedHistories[historyName]];
                saveChatHistory();
                renderMessages();
                toggleHistoryMenu();
                toggleSidebar();
                currentHistoryName = historyName;

            } else {
                alert("Không tìm thấy lịch sử chat đã lưu.");
            }
        }


        function toggleHistoryMenu() {
            const submenu = document.getElementById('saved-histories-menu');
            submenu.classList.toggle('open');
             hideSettingsMenu();
        }

        function hideHistoryMenu() {
            const submenu = document.getElementById('saved-histories-menu');
            submenu.classList.remove('open');
        }

        function toggleSettingsMenu() {
            const submenu = document.getElementById('settings-menu');
            submenu.classList.toggle('open');
            hideHistoryMenu();
        }
         function hideSettingsMenu() {
            const submenu = document.getElementById('settings-menu');
            submenu.classList.remove('open');
        }


        function loadSavedHistoriesList() {
            const historiesMenu = document.getElementById('saved-histories-menu');
            historiesMenu.innerHTML = '<button class="close-history-menu-btn" onclick="toggleHistoryMenu()">Đóng</button>';

            const storedSavedHistories = localStorage.getItem('savedHistories');
            if (storedSavedHistories) {
                savedHistories = JSON.parse(storedSavedHistories);
            } else {
                savedHistories = {};
            }

            if (Object.keys(savedHistories).length === 0) {
                const noHistoryItem = document.createElement('li');
                noHistoryItem.classList.add('submenu-item');
                noHistoryItem.textContent = "Chưa có lịch sử nào được lưu.";
                historiesMenu.appendChild(noHistoryItem);
                return;
            }

            for (const historyName in savedHistories) {
                const historyItem = document.createElement('li');
                historyItem.classList.add('submenu-item');

                const nameSpan = document.createElement('span');
                nameSpan.classList.add('history-name');
                nameSpan.textContent = historyName;
                nameSpan.onclick = () => loadChatHistoryByName(historyName);

                const deleteButton = document.createElement('button');
                deleteButton.classList.add('delete-history-btn');
                deleteButton.textContent = '...';
                deleteButton.onclick = (event) => {
                    event.stopPropagation();
                    openDeleteHistoryModal(historyName);
                };

                historyItem.appendChild(nameSpan);
                historyItem.appendChild(deleteButton);
                historiesMenu.appendChild(historyItem);
            }
        }


        loadChatHistory();
        loadSavedHistoriesList();
        loadSettings();
        applyTheme();


        function triggerFileUpload() {
            document.getElementById('file-upload').click();
        }

        function handleFileUpload(files) {
            if (files && files.length > 0) {
                const messagesContainer = document.getElementById('messages-container');
                const aiMessageDiv = document.createElement('div');
                aiMessageDiv.classList.add('message', 'ai-message');
                aiMessageDiv.innerHTML = `<span class="ai-message-text">Đang tải tệp...</span>`;
                messagesContainer.appendChild(aiMessageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                let fileNames = Array.from(files).map(file => file.name).join(', ');
                const userMessage = `Tệp đã tải lên: ${fileNames}. Đang chờ AI xử lý...`;

                const userMessageDiv = document.createElement('div');
                userMessageDiv.classList.add('message', 'user-message');
                userMessageDiv.textContent = userMessage;
                messagesContainer.appendChild(userMessageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                const userMessageObject = { role: 'user', parts: [{ text: userMessage }] };
                conversationHistory.push(userMessageObject);
                saveChatHistory();
                renderMessages();

                setTimeout(() => {
                    aiMessageDiv.remove();

                    const aiResponseDiv = document.createElement('div');
                    aiResponseDiv.classList.add('message', 'ai-message');
                    aiResponseDiv.innerHTML = `<span class="ai-message-text">Đã nhận được tệp: ${fileNames}. Vui lòng cho biết bạn muốn AI làm gì với tệp này.</span>`;
                    messagesContainer.appendChild(aiResponseDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;

                     const aiMessageObject = { role: 'model', parts: [{ text: aiResponseDiv.innerHTML }] };
                    conversationHistory.push(aiMessageObject);
                    saveChatHistory();
                    renderMessages();

                }, 1500);
            }
        }


        async function getGeminiResponse() {
            const userPrompt = document.getElementById('user-prompt').value.trim();
            const messagesContainer = document.getElementById('messages-container');
            let aiMessageDiv = document.createElement('div'); // Declare aiMessageDiv here

            if (!userPrompt) {
                alert("Vui lòng nhập tin nhắn.");
                return;
            }

             if (currentHistoryName) {
                savedHistories[currentHistoryName] = [...conversationHistory, { role: 'user', parts: [{ text: userPrompt }] } ];
                localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
            }


            const userMessageObject = { role: 'user', parts: [{ text: userPrompt }] };
            conversationHistory.push(userMessageObject);
            saveChatHistory();
            renderMessages();
            document.getElementById('user-prompt').value = '';


            aiMessageDiv.classList.add('message', 'ai-message');
            aiMessageDiv.innerHTML = '<span class="ai-message-text">Đang suy nghĩ...</span>';
            messagesContainer.appendChild(aiMessageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            let promptContents = conversationHistory.map(message => ({
                role: message.role,
                parts: message.parts
            }));
            promptContents.unshift({ role: 'user', parts: [{ text: systemPrompt }] });


            const payload = {
                contents: promptContents
            };


            try {
                const response = await fetch(geminiAPIUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    const errorMsg = `Lỗi API: ${response.status} - ${response.statusText} - ${errorData?.error?.message || 'No details provided'}`;
                    console.error("Lỗi API:", errorMsg);
                    aiMessageDiv.innerHTML = `<span class="ai-message-text">${errorMsg}</span>`;
                    return;
                }


                const data = await response.json();
                console.log("Dữ liệu phản hồi từ API:", data);

                if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0].text) {
                    let aiResponseText = data.candidates[0].content.parts[0].text;
                    aiMessageDiv.innerHTML = ''; // Clear "Đang suy nghĩ..." message before adding response

                      aiMessageDiv.innerHTML = `<span class="ai-message-text">${aiResponseText}</span>`;

                    const aiMessageObject = { role: 'model', parts: [{ text: aiMessageDiv.innerHTML }] };

                    conversationHistory.push(aiMessageObject);


                     if (currentHistoryName) {
                        savedHistories[currentHistoryName] = [...conversationHistory];
                        localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
                    } else {
                         saveChatHistory();
                    }

                   messagesContainer.appendChild(aiMessageDiv);

                 messagesContainer.scrollTop = messagesContainer.scrollHeight;
                 }
                else
                   aiMessageDiv.innerHTML = `<span class="ai-message-text">Không nhận được phản hồi hợp lệ từ AI.</span>`;


            } catch (error) {
                console.error("Lỗi fetch:", error);
                aiMessageDiv.innerHTML = `<span class="ai-message-text">Đã xảy ra lỗi khi kết nối đến API: ${error}</span>`;
            }

        }

        function loadSettings() {
            const storedSettings = localStorage.getItem('chatSettings');
            if (storedSettings) {
                const settings = JSON.parse(storedSettings);
                autoSaveHistory = settings.autoSaveHistory !== undefined ? settings.autoSaveHistory : true;
                useFirstMessageAsName = settings.useFirstMessageAsName !== undefined ? settings.useFirstMessageAsName : false;
                currentBackgroundColor = settings.backgroundColor || defaultBackgroundColor;
                currentTextColor = settings.textColor || defaultTextColor;
                currentContainerColor = settings.containerColor || defaultContainerColor;


                document.getElementById('autoSaveHistoryToggle').checked = autoSaveHistory;
                document.getElementById('useFirstMessageAsNameToggle').checked = useFirstMessageAsName;
                document.getElementById('backgroundColorPicker').value = currentBackgroundColor;
                document.getElementById('textColorPicker').value = currentTextColor;
                document.getElementById('containerColorPicker').value = currentContainerColor;

            } else {
                 document.getElementById('autoSaveHistoryToggle').checked = true;
                 document.getElementById('useFirstMessageAsNameToggle').checked = false;
                 currentBackgroundColor = defaultBackgroundColor;
                 currentTextColor = defaultTextColor;
                 currentContainerColor = defaultContainerColor;

            }

            document.getElementById('autoSaveHistoryToggle').addEventListener('change', function() {
                autoSaveHistory = this.checked;
            });
            document.getElementById('useFirstMessageAsNameToggle').addEventListener('change', function() {
                useFirstMessageAsName = this.checked;
            });
            document.getElementById('backgroundColorPicker').addEventListener('change', function() {
                currentBackgroundColor = this.value;
            });
             document.getElementById('textColorPicker').addEventListener('change', function() {
                currentTextColor = this.value;
            });
            document.getElementById('containerColorPicker').addEventListener('change', function() {
                currentContainerColor = this.value;
            });
        }

        function saveSetting(key, value) {
            let settings = JSON.parse(localStorage.getItem('chatSettings')) || {};
            settings[key] = value;
            localStorage.setItem('chatSettings', JSON.stringify(settings));
        }

        function autoSaveHistorySetting() {
            return autoSaveHistory;
        }
        function useFirstMessageAsNameSetting() {
            return useFirstMessageAsName;
        }


        function applyTheme() {
            document.documentElement.style.setProperty('--background-color', currentBackgroundColor);
            document.documentElement.style.setProperty('--text-color', currentTextColor);
            document.documentElement.style.setProperty('--container-background-color', currentContainerColor);
        }

        function saveSettingsAndApplyTheme() {
            saveSetting('autoSaveHistory', autoSaveHistory);
            saveSetting('useFirstMessageAsName', useFirstMessageAsName);
            saveSetting('backgroundColor', currentBackgroundColor);
            saveSetting('textColor', currentTextColor);
            saveSetting('containerColor', currentContainerColor);
            applyTheme();
            toggleSettingsMenu();
            alert('Cài đặt đã được lưu và áp dụng!');
        }

        function resetTheme() {
            currentBackgroundColor = defaultBackgroundColor;
            currentTextColor = defaultTextColor;
            currentContainerColor = defaultContainerColor;

            document.getElementById('backgroundColorPicker').value = currentBackgroundColor;
            document.getElementById('textColorPicker').value = currentTextColor;
            document.getElementById('containerColorPicker').value = currentContainerColor;

            applyTheme();
            alert('Giao diện đã hoàn tác về mặc định. Nhấn "Lưu cài đặt" để lưu thay đổi.');
        }


    </script>
</body>
</html>