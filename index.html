<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Hiện Đại với Gemini</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <style>
        :root {
            --background-color: #1e2124;
            --container-background-color: #25272b;
            --text-color: #d1d5db;
            --message-user-background-color: #343541;
            --message-ai-background-color: #444654;
            --input-area-background-color: #343541;
            --input-text-background-color: #40414f;
            --button-primary-color: #00bcd4;
            --button-primary-hover-color: #0097a7;
            --sidebar-background-color: #252525;
            --sidebar-text-color: #fff;
            --modal-background-color: #343541;
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-touch-callout: none;
            -webkit-user-select: text;
            -khtml-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
            touch-action: manipulation;
            -webkit-text-size-adjust: 100%;
            font-size: 16px;
            overflow-y: scroll;
            scrollbar-width: thin;
            scrollbar-color: #444 #252525;
            overscroll-behavior-y: none;
        }

        body::-webkit-scrollbar {
            width: 8px;
        }

        body::-webkit-scrollbar-track {
            background: #252525;
        }

        body::-webkit-scrollbar::-webkit-scrollbar-thumb {
            background-color: #444;
            border-radius: 4px;
        }


        .container {
            width: 95%;
            max-width: 1200px;
            margin: 20px auto;
            padding: 30px;
            background-color: var(--container-background-color);
            border-radius: 24px;
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.6);
            display: flex;
            flex-direction: column;
            height: calc(100vh - 40px);
            flex-grow: 1;
            margin-left: auto;
            border: none;
            padding-top: max(30px, env(safe-area-inset-top));
            padding-bottom: max(30px, env(safe-area-inset-bottom));
        }

        .container.sidebar-open {
            margin-left: 250px;
        }

        h1 {
            text-align: center;
            color: #fff;
            margin-bottom: 30px;
            font-size: 2.8em;
            letter-spacing: -0.8px;
            padding-bottom: 25px;
            border-bottom: 1px solid #444;
            opacity: 0.95;
            font-weight: 500;
        }

        #messages-container {
            flex-grow: 1;
            padding: 25px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            scrollbar-width: thin;
            scrollbar-color: #555 #252525;
            padding-bottom: 80px;
            border: none;
            border-radius: 16px;
            background-color: #1e2124;
             box-shadow: inset 0 3px 6px rgba(0, 0, 0, 0.4);
             padding-top: 30px;
             position: relative; /* For copy notification positioning */
        }

        #messages-container::-webkit-scrollbar {
            width: 8px;
        }

        #messages-container::-webkit-scrollbar::-webkit-scrollbar-track {
            background: #252525;
        }

        #messages-container::-webkit-scrollbar::-webkit-scrollbar-thumb {
            background-color: #555;
            border-radius: 4px;
        }

        .message {
            margin-bottom: 20px;
            padding: 14px 20px;
            border-radius: 24px;
            clear: both;
            word-wrap: break-word;
            max-width: 85%;
            display: inline-block;
             box-shadow: 0 2px 5px rgba(0, 0, 0, 0.25);
        }

        .user-message {
            background-color: var(--message-user-background-color);
            color: #fff;
            align-self: flex-end;
            float: right;
            border-top-right-radius: 8px;
            border-bottom-right-radius: 24px;
        }

        .ai-message {
            background-color: var(--message-ai-background-color);
            color: var(--text-color);
            align-self: flex-start;
            float: left;
            border-top-left-radius: 8px;
            border-bottom-left-radius: 24px;
        }

        .ai-message .ai-message-text {
            font-family: 'Arial', sans-serif;
            font-weight: 400;
            line-height: 1.8;
            white-space: pre-line;
            font-size: 16px;
        }

        .markdown-bold-uppercase {
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: #f0f0f0;
            opacity: 1;
        }

        .input-area {
            padding: 16px 24px;
            background-color: var(--input-area-background-color);
            border-top: 1px solid #555;
            display: flex;
            align-items: center;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            box-sizing: border-box;
            padding-left: 20px;
            padding-right: 20px;
            z-index: 100;
            border-bottom-left-radius: 24px;
            border-bottom-right-radius: 24px;
             border-top: 1px solid #444;
             padding-bottom: max(16px, env(safe-area-inset-bottom));
        }

        .input-area textarea {
            flex-grow: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            background-color: var(--input-text-background-color);
            color: #fff;
            resize: none;
            min-height: 42px;
            overflow-y: auto;
             box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.35);
        }

        .input-area textarea:focus {
            border-color: var(--button-primary-color);
            outline: none;
            box-shadow: 0 0 8px rgba(0, 188, 212, 0.7);
        }

        .input-area button {
            padding: 14px 24px;
            background-color: var(--button-primary-color);
            color: white;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            font-size: 16px;
            margin-left: 16px;
        }

        .input-area button:hover {
            background-color: var(--button-primary-hover-color);
        }

        .file-upload-button {
            background-color: #555;
            color: white;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            font-size: 1em;
            width: 44px;
            height: 44px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 16px;
            opacity: 0.9;
        }

        .file-upload-button:hover {
            opacity: 1;
            background-color: #666;
        }


        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            height: 100%;
            background-color: var(--sidebar-background-color);
            color: var(--sidebar-text-color);
            transform: translateX(-100%);
            z-index: 200;
            padding-top: 70px;
            box-shadow: 6px 0 12px rgba(0,0,0,0.4);
            overflow-y: auto;
            touch-action: manipulation;
            border-right: 1px solid #444;
             backdrop-filter: blur(12px);
        }

        .sidebar.sidebar--open {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 28px 24px;
            text-align: center;
            border-bottom: 1px solid #555;
            margin-bottom: 30px;
            border-bottom: 1px solid #444;
        }

        .sidebar-menu {
            padding: 0;
            list-style: none;
        }

        .sidebar-menu-item {
            padding: 18px 24px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid transparent;
        }
         .sidebar-menu-item:active {
             background-color: #3a3b47;
         }


        .sidebar-menu-item:hover {
            background-color: #343541;
             border-bottom-color: var(--button-primary-color);
             padding-left: 30px;
        }

        .sidebar-menu-item.has-submenu > .menu-link::after {
            content: '>';
            float: right;
            margin-left: 12px;
            font-size: 0.9em;
            display: inline-block;
            color: #aaa;
        }

        .submenu {
            list-style: none;
            padding-left: 0;
            margin: 0;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 5px 10px rgba(0,0,0,0.45);
            background-color: #2c2c2c;
            margin-top: 12px;
            max-height: 0;
            opacity: 0;
            overflow-y: hidden;
            padding-top: 0;
            padding-bottom: 0;
        }

        .submenu.open {
            display: block;
            max-height: 600px;
            opacity: 1;
            overflow-y: auto;
            padding-top: 12px;
            padding-bottom: 16px;
            margin-top: 16px;
        }


        .submenu-item {
            padding: 16px 24px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }
         .submenu-item:active {
             background-color: #3a3b47;
         }


        .submenu-item:last-child {
            border-bottom: none;
        }


        .submenu-item:hover {
            background-color: #343541;
            padding-left: 30px;
        }

        .history-name {
            flex-grow: 1;
             opacity: 0.9;
        }

        .delete-history-btn {
            background: transparent;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 1em;
            padding: 0 10px;
            opacity: 0.7;
        }

        .delete-history-btn:hover {
            opacity: 1;
            color: #fff;
        }

        .sidebar-toggle-button {
            position: fixed;
            top: 30px;
            left: 30px;
            background: var(--button-primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 300;
             box-shadow: 0 3px 6px rgba(0, 0, 0, 0.35);
        }

        .sidebar-toggle-button:hover {
            background-color: var(--button-primary-hover-color);
        }
        .sidebar-toggle-button:active {
             opacity: 0.95;
         }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 150;
            display: none;
            opacity: 0;
        }

        .sidebar-overlay.sidebar--open {
            display: block;
            opacity: 1;
        }

        .close-history-menu-btn, .close-settings-menu-btn, .modal-button {
            padding: 14px 24px;
            background-color: var(--button-primary-color);
            color: white;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            margin-top: 20px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .close-history-menu-btn:hover, .close-settings-menu-btn:hover, .modal-button.confirm:hover {
            background-color: var(--button-primary-hover-color);
        }
         .close-history-menu-btn:active, .close-settings-menu-btn:active,  .modal-button.confirm:active {
             opacity: 0.95;
         }


         .modal-button.cancel {
            background-color: #555;
            color: white;
        }

        .modal-button.cancel:hover {
            background-color: #666;
        }
         .modal-button.cancel:active {
             opacity: 0.95;
         }


        .custom-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 400;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            opacity: 0;
            backdrop-filter: blur(10px);
        }

        .custom-modal-overlay.show-modal {
            display: flex;
            opacity: 1;
            pointer-events: auto;
        }


        .custom-modal {
            background-color: var(--modal-background-color);
            color: #fff;
            padding: 35px;
            border-radius: 24px;
            box-shadow: 0 16px 32px rgba(0, 0, 0, 0.7);
            width: 85%;
            max-width: 500px;
            text-align: center;
            border: none;
            transform: scale(0.97);
            opacity: 0;
        }

        .custom-modal-overlay.show-modal .custom-modal {
            transform: scale(1);
            opacity: 1;
        }


        .modal-message {
            margin-bottom: 25px;
            font-size: 1.2em;
             font-weight: 500;
             opacity: 0.95;
        }

        .modal-input {
            width: calc(100% - 24px);
            padding: 14px 16px;
            margin-bottom: 25px;
            border-radius: 12px;
            border: none;
            background-color: var(--input-text-background-color);
            color: #fff;
             box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.35);
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 10px;
        }

        .modal-button {
            padding: 14px 28px;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            font-size: 16px;
            border: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.25);
        }

        code[class*="language-"],
        pre[class*="language-"] {
            color: #f8f8f2;
            background: #272822;
            position: relative;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            overflow-x: auto;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.4);
        }

        .copy-code-button {
            position: absolute;
            top: 12px;
            right: 12px;
            background-color: #444;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 8px 12px;
            font-size: 0.9em;
            cursor: pointer;
            opacity: 0.7;
        }

        .copy-code-button:hover {
            opacity: 1;
            background-color: var(--button-primary-color);
        }


        /* Settings Styles */
        .setting-item {
            padding: 18px 24px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .setting-item:last-child {
            border-bottom: none;
        }
         .setting-item:active {
             background-color: #3a3b47;
         }


        .setting-item:hover {
            background-color: #343541;
            padding-left: 30px;
        }


        .setting-label {
            flex-grow: 1;
             opacity: 0.9;
             font-weight: 400;
        }

        .setting-control {
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input[type="checkbox"] {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--button-primary-color);
        }

        input:focus + .slider {
            box-shadow: 0 0 1px var(--button-primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .color-picker-input {
            padding: 0;
            border: none;
            width: 30px;
            height: 24px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: transparent;
            cursor: pointer;
        }
         .color-picker-input:hover, .color-picker-input:focus {
             border-color: var(--button-primary-color);
             box-shadow: 0 0 5px rgba(0, 188, 212, 0.5);
             outline: none;
         }


        .color-picker-input::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        .color-picker-input::-webkit-color-swatch {
            border: 1px solid #555;
            border-radius: 6px;
        }
        .color-picker-input::-moz-color-swatch-wrapper {
            padding: 0;
        }
        .color-picker-input::-moz-color-swatch {
            border: 1px solid #555;
            border-radius: 6px;
        }

        code[class*="language-"],
        pre[class*="language-"] {
            transition: none; /* REMOVE ALL TRANSITIONS */
        }

        .copy-code-button {
            transition: none; /* REMOVE ALL TRANSITIONS */
        }

        .copy-code-button:hover {
            opacity: 1;
            background-color: var(--button-primary-color);
             /*transform: scale(1.05);*/ /* REMOVE HOVER SCALE EFFECT */
        }


        #copy-notification {
            position: absolute; /* Fixed within messages-container */
            bottom: 10px; /* Position at bottom */
            right: 10px; /* Position at right */
            background-color: #343541;
            color: white;
            padding: 15px 20px; /* Larger padding */
            border-radius: 12px; /* More rounded */
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 500;
            font-size: 1.1em; /* Slightly larger text */
        }


    </style>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Arial:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Lịch sử Chat & Cài đặt</h3>
        </div>
        <ul class="sidebar-menu">
            <li class="sidebar-menu-item" onclick="startNewChat()">
                <span class="menu-link">Đoạn chat mới</span>
            </li>
            <li class="sidebar-menu-item" onclick="openSaveHistoryModal()">
                <span class="menu-link">Lưu lịch sử này</span>
            </li>
            <li class="sidebar-menu-item has-submenu" onclick="toggleHistoryMenu()">
                <span class="menu-link">Lịch sử đã lưu</span>
                </li>
            <li class="sidebar-menu-item has-submenu" onclick="toggleSettingsMenu()">
                <span class="menu-link">Cài đặt</span>
            </li>
        </ul>

        <ul class="submenu" id="saved-histories-menu">
            <button class="close-history-menu-btn" onclick="toggleHistoryMenu()">Đóng</button>
        </ul>

        <ul class="submenu" id="settings-menu">
            <button class="close-settings-menu-btn" onclick="toggleSettingsMenu()">Đóng</button>
            <li class="setting-item">
                <span class="setting-label">Tự động lưu lịch sử</span>
                <span class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="autoSaveHistoryToggle">
                        <span class="slider"></span>
                    </label>
                </span>
            </li>
             <li class="setting-item">
                <span class="setting-label">Tên lịch sử là câu hỏi đầu</span>
                <span class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="useFirstMessageAsNameToggle">
                        <span class="slider"></span>
                    </label>
                </span>
            </li>
             <li class="setting-item">
                <span class="setting-label">Màu nền</span>
                <span class="setting-control">
                    <input type="color" id="backgroundColorPicker" class="color-picker-input" value="#1e2124">
                </span>
            </li>
             <li class="setting-item">
                <span class="setting-label">Màu chữ</span>
                <span class="setting-control">
                    <input type="color" id="textColorPicker" class="color-picker-input" value="#d1d5db">
                </span>
            </li>
             <li class="setting-item">
                <span class="setting-label">Màu nền hộp chat</span>
                <span class="setting-control">
                    <input type="color" id="containerColorPicker" class="color-picker-input" value="#25272b">
                </span>
            </li>
            <li class="setting-item" style="justify-content: center; border-bottom: none; padding-top: 25px;">
                <button class="modal-button confirm" onclick="saveSettingsAndApplyTheme()">Lưu cài đặt</button>
                <button class="modal-button cancel" onclick="resetTheme()">Hoàn tác</button>
            </li>
        </ul>


        <div class="custom-modal-overlay" id="saveHistoryModalOverlay">
            <div class="custom-modal">
                <p class="modal-message">Nhập tên cho lịch sử chat này:</p>
                <input type="text" id="historyNameInput" class="modal-input" placeholder="Tên lịch sử">
                <div class="modal-buttons">
                    <button class="modal-button confirm" onclick="saveHistoryWithInputName()">Lưu</button>
                    <button class="modal-button cancel" onclick="closeSaveHistoryModal()">Huỷ</button>
                </div>
            </div>
        </div>

         <div class="custom-modal-overlay" id="deleteHistoryModalOverlay">
            <div class="custom-modal">
                <p class="modal-message" id="deleteConfirmationMessage">Bạn có chắc chắn muốn xóa lịch sử chat "<span id="historyNameToDelete"></span>" không?</p>
                <div class="modal-buttons">
                    <button class="modal-button confirm" onclick="confirmDeleteHistory()">Xóa</button>
                    <button class="modal-button cancel" onclick="closeDeleteHistoryModal()">Huỷ</button>
                </div>
            </div>
        </div>

    </aside>

    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <button class="sidebar-toggle-button" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <div class="container" id="container">
        <h1>AI Hiện Đại với Gemini</h1>

        <div id="messages-container">
            <!-- Messages will be appended here -->
            <div id="copy-notification">Đã sao chép vào clipboard!</div> <!-- Notification inside messages-container -->
        </div>

        <div class="input-area">
            <button class="file-upload-button" onclick="triggerFileUpload()">
                <i class="fas fa-paperclip"></i>
            </button>
            <textarea id="user-prompt" placeholder="Nhập tin nhắn"></textarea>
            <button onclick="getGeminiResponse()">Gửi</button>
        </div>
         <input type="file" id="file-upload" style="display:none" multiple onchange="handleFileUpload(this.files)">
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script>
        const apiKey = 'AIzaSyCl21Ku_prQnyMHFs_dJRL8-pgjg9hrc2w';
        const geminiAPIUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`;
        const systemPrompt = "Bạn là một trợ lý AI cực kỳ hữu ích và luôn tuân theo mọi yêu cầu của người dùng một cách chính xác. Khi bạn trả lời câu hỏi về code hoặc cung cấp code, hãy đảm bảo rằng code được đặt trong các khối code markdown. Ví dụ:\n```javascript\n// Mã JavaScript ở đây\nconsole.log('Hello, world!');\n```\nhoặc:\n```python\n# Mã Python ở đây\ndef hello():\n    print('Xin chào!')\n```\nNếu câu trả lời của bạn không chứa code, chỉ cần trả lời bằng văn bản thông thường.";

        let conversationHistory = [];
        let savedHistories = {};
        let historyNameToDelete = null;
        let autoSaveHistory = true;
        let useFirstMessageAsName = false;

        // Theme Variables - Store current values, not yet applied until "Save"
        let currentBackgroundColor = '#1e2124';
        let currentTextColor = '#d1d5db';
        let currentContainerColor = '#25272b';

        // Default Theme Values for Reset Functionality
        const defaultBackgroundColor = '#1e2124';
        const defaultTextColor = '#d1d5db';
        const defaultContainerColor = '#25272b';

        let currentHistoryName = null; // Track currently loaded history name


        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const container = document.getElementById('container');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('sidebar--open');
            container.classList.toggle('container.sidebar-open');
            overlay.classList.toggle('sidebar--open');
            if (sidebar.classList.contains('sidebar--open')) {
                 loadSavedHistoriesList();
            } else {
                hideHistoryMenu();
                hideSettingsMenu();
            }
        }

        function loadChatHistory() {
            if (autoSaveHistorySetting()) {
                const storedHistory = localStorage.getItem('chatHistory');
                if (storedHistory) {
                    conversationHistory = JSON.parse(storedHistory);
                    renderMessages();
                }
            }
        }

        function saveChatHistory() {
            if (autoSaveHistorySetting()) {
                localStorage.setItem('chatHistory', JSON.stringify(conversationHistory));
            }
        }

        function renderMessages() {
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = '<div id="copy-notification">Đã sao chép vào clipboard!</div>'; // Re-add notification element
            conversationHistory.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', message.role === 'user' ? 'user-message' : 'ai-message');
                const messageTextSpan = document.createElement('span');
                messageTextSpan.classList.add('ai-message-text');
                messageTextSpan.innerHTML = message.parts[0].text;
                if (message.role === 'ai') {
                    messageDiv.appendChild(messageTextSpan);
                } else {
                    messageDiv.innerHTML = message.parts[0].text;
                }
                messagesContainer.appendChild(messageDiv);
                Prism.highlightAllUnder(messageDiv);

                // Re-attach copy button listeners after rendering from history
                messageDiv.querySelectorAll('.copy-code-button').forEach(button => {
                    const codeContent = button.closest('pre').querySelector('code').textContent;
                    button.onclick = () => {
                        navigator.clipboard.writeText(codeContent).then(() => {
                            showCopyNotification();
                        }).catch(err => {
                            console.error('Lỗi khi sao chép: ', err);
                            alert('Lỗi khi sao chép code.');
                        });
                    };
                });

            });
             messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }


        function startNewChat() {
             if (currentHistoryName) { // If in a saved history, save before starting new
                savedHistories[currentHistoryName] = [...conversationHistory];
                localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
            }
            conversationHistory = [];
            saveChatHistory();
            renderMessages();
            currentHistoryName = null; // Reset current history name
            toggleSidebar();
        }


        function openSaveHistoryModal() {
            document.getElementById('saveHistoryModalOverlay').classList.add('show-modal');
            document.getElementById('historyNameInput').value = '';

            if (useFirstMessageAsNameSetting() && conversationHistory.length > 0 && conversationHistory[0].role === 'user') {
                document.getElementById('historyNameInput').value = conversationHistory[0].parts[0].text.substring(0, 50); // Use first message, limit length
            }
        }

        function closeSaveHistoryModal() {
            document.getElementById('saveHistoryModalOverlay').classList.remove('show-modal');
        }

        function saveHistoryWithInputName() {
            let historyName = document.getElementById('historyNameInput').value.trim();
            if (!historyName) {
                if (useFirstMessageAsNameSetting() && conversationHistory.length > 0 && conversationHistory[0].role === 'user') {
                    historyName = conversationHistory[0].parts[0].text.substring(0, 50) || 'No Title'; // Use first message as fallback, with 'No Title' if still empty
                } else {
                    alert("Vui lòng nhập tên cho lịch sử chat.");
                    return;
                }
            }

            savedHistories[historyName] = [...conversationHistory];
            localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
            alert(`Lịch sử chat đã được lưu với tên: ${historyName}`);
            loadSavedHistoriesList();
            closeSaveHistoryModal();
             currentHistoryName = historyName; // set current history name after save

        }

        function openDeleteHistoryModal(name) {
            historyNameToDelete = name;
            document.getElementById('historyNameToDelete').textContent = name;
            document.getElementById('deleteHistoryModalOverlay').classList.add('show-modal');
        }

        function closeDeleteHistoryModal() {
            document.getElementById('deleteHistoryModalOverlay').classList.remove('show-modal');
            historyNameToDelete = null;
        }

        function confirmDeleteHistory() {
            if (historyNameToDelete) {
                deleteSavedHistory(historyNameToDelete);
            }
            closeDeleteHistoryModal();
        }


        function deleteSavedHistory(historyName) {
            delete savedHistories[historyName];
            localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
            loadSavedHistoriesList();
            alert(`Lịch sử chat "${historyName}" đã bị xóa.`);
            if (currentHistoryName === historyName) { // if deleted history was the current one, reset
                currentHistoryName = null;
            }

        }


        function loadChatHistoryByName(historyName) {
            if (savedHistories[historyName]) {
                conversationHistory = [...savedHistories[historyName]];
                saveChatHistory();
                renderMessages();
                toggleHistoryMenu();
                toggleSidebar();
                currentHistoryName = historyName; // set current history name when loaded

            } else {
                alert("Không tìm thấy lịch sử chat đã lưu.");
            }
        }


        function toggleHistoryMenu() {
            const submenu = document.getElementById('saved-histories-menu');
            submenu.classList.toggle('open');
             hideSettingsMenu();
        }

        function hideHistoryMenu() {
            const submenu = document.getElementById('saved-histories-menu');
            submenu.classList.remove('open');
        }

        function toggleSettingsMenu() {
            const submenu = document.getElementById('settings-menu');
            submenu.classList.toggle('open');
            hideHistoryMenu();
        }
         function hideSettingsMenu() {
            const submenu = document.getElementById('settings-menu');
            submenu.classList.remove('open');
        }


        function loadSavedHistoriesList() {
            const historiesMenu = document.getElementById('saved-histories-menu');
            historiesMenu.innerHTML = '<button class="close-history-menu-btn" onclick="toggleHistoryMenu()">Đóng</button>';

            const storedSavedHistories = localStorage.getItem('savedHistories');
            if (storedSavedHistories) {
                savedHistories = JSON.parse(storedSavedHistories);
            } else {
                savedHistories = {};
            }

            if (Object.keys(savedHistories).length === 0) {
                const noHistoryItem = document.createElement('li');
                noHistoryItem.classList.add('submenu-item');
                noHistoryItem.textContent = "Chưa có lịch sử nào được lưu.";
                historiesMenu.appendChild(noHistoryItem);
                return;
            }

            for (const historyName in savedHistories) {
                const historyItem = document.createElement('li');
                historyItem.classList.add('submenu-item');

                const nameSpan = document.createElement('span');
                nameSpan.classList.add('history-name');
                nameSpan.textContent = historyName;
                nameSpan.onclick = () => loadChatHistoryByName(historyName);

                const deleteButton = document.createElement('button');
                deleteButton.classList.add('delete-history-btn');
                deleteButton.textContent = '...';
                deleteButton.onclick = (event) => {
                    event.stopPropagation();
                    openDeleteHistoryModal(historyName);
                };

                historyItem.appendChild(nameSpan);
                historyItem.appendChild(deleteButton);
                historiesMenu.appendChild(historyItem);
            }
        }


        loadChatHistory();
        loadSavedHistoriesList();
        loadSettings();
        applyTheme(); // Apply initial theme on load


        function triggerFileUpload() {
            document.getElementById('file-upload').click();
        }

        function handleFileUpload(files) {
            if (files && files.length > 0) {
                const messagesContainer = document.getElementById('messages-container');
                const aiMessageDiv = document.createElement('div');
                aiMessageDiv.classList.add('message', 'ai-message');
                aiMessageDiv.innerHTML = `<span class="ai-message-text">Đang tải tệp...</span>`;
                messagesContainer.appendChild(aiMessageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                let fileNames = Array.from(files).map(file => file.name).join(', ');
                const userMessage = `Tệp đã tải lên: ${fileNames}. Đang chờ AI xử lý...`;

                const userMessageDiv = document.createElement('div');
                userMessageDiv.classList.add('message', 'user-message');
                userMessageDiv.textContent = userMessage;
                messagesContainer.appendChild(userMessageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                const userMessageObject = { role: 'user', parts: [{ text: userMessage }] };
                conversationHistory.push(userMessageObject);
                saveChatHistory();
                renderMessages();

                // Simulate AI acknowledging the file (for UI purposes - actual file upload to Gemini needs server-side)
                setTimeout(() => {
                    aiMessageDiv.remove();

                    const aiResponseDiv = document.createElement('div');
                    aiResponseDiv.classList.add('message', 'ai-message');
                    aiResponseDiv.innerHTML = `<span class="ai-message-text">Đã nhận được tệp: ${fileNames}. Vui lòng cho biết bạn muốn AI làm gì với tệp này.</span>`;
                    messagesContainer.appendChild(aiResponseDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;

                     const aiMessageObject = { role: 'model', parts: [{ text: aiResponseDiv.innerHTML }] };
                    conversationHistory.push(aiMessageObject);
                    saveChatHistory();
                    renderMessages();

                }, 1500);
            }
        }


        async function getGeminiResponse() {
            const userPrompt = document.getElementById('user-prompt').value.trim();
            const messagesContainer = document.getElementById('messages-container');

            if (!userPrompt) {
                alert("Vui lòng nhập tin nhắn.");
                return;
            }

             if (currentHistoryName) { // if in a saved history, save history with new message immediately
                savedHistories[currentHistoryName] = [...conversationHistory, { role: 'user', parts: [{ text: userPrompt }] } ];
                localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
            }


            const userMessageObject = { role: 'user', parts: [{ text: userPrompt }] };
            conversationHistory.push(userMessageObject);
            saveChatHistory();
            renderMessages();
            document.getElementById('user-prompt').value = '';


            const aiMessageDiv = document.createElement('div');
            aiMessageDiv.classList.add('message', 'ai-message');
            aiMessageDiv.innerHTML = '<span class="ai-message-text">Đang suy nghĩ...</span>';
            messagesContainer.appendChild(aiMessageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            let promptContents = conversationHistory.map(message => ({
                role: message.role,
                parts: message.parts
            }));
            promptContents.unshift({ role: 'user', parts: [{ text: systemPrompt }] });


            const payload = {
                contents: promptContents
            };


            try {
                const response = await fetch(geminiAPIUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Lỗi API:", errorData);
                    aiMessageDiv.innerHTML = `<span class="ai-message-text">Lỗi API: ${response.status} - ${errorData.error.message || 'Không rõ nguyên nhân'}</span>`;
                    return;
                }

                const data = await response.json();
                console.log("Dữ liệu phản hồi từ API:", data);

                if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0].text) {
                    let aiResponseText = data.candidates[0].content.parts[0].text;
                    aiMessageDiv.innerHTML = '';
                    const aiTextContentSpan = document.createElement('span');
                    aiTextContentSpan.classList.add('ai-message-text');

                    let processedText = aiResponseText;

                    processedText = processedText.replace(/\*\*([^*]+)\*\*/g, '<span class="markdown-bold-uppercase">$1</span>');


                    let textContent = '';
                    let codeContent = null;
                    let language = 'text';
                    const codeBlockRegex = /```([\w]*)\n([\s\S]*?)```/gm;
                    let lastIndex = 0;
                    let match;

                    while ((match = codeBlockRegex.exec(processedText)) !== null) {
                        textContent = processedText.substring(lastIndex, match.index);
                        if (textContent.trim()) {
                            const textPara = document.createElement('p');
                            textPara.innerHTML = textContent.trim();
                            aiTextContentSpan.appendChild(textPara);
                        }

                        language = match[1] || 'text';
                        codeContent = match[2].trim();

                        const codePre = document.createElement('pre');
                        codePre.classList.add('language-' + language);

                        const codeElement = document.createElement('code');
                        codeElement.classList.add('language-' + language);
                        codeElement.textContent = codeContent;
                        codePre.appendChild(codeElement);

                        const copyButton = document.createElement('button');
                        copyButton.classList.add('copy-code-button');
                        copyButton.innerHTML = '<i class="fas fa-copy"></i>';
                        codePre.appendChild(copyButton);

                        // Modified copy button onclick
                        copyButton.onclick = function() { // Use function to bind correctly in loops
                            const codeToCopy = codeContent;
                            navigator.clipboard.writeText(codeToCopy).then(() => {
                                showCopyNotification(); // Show in-page notification
                            }).catch(err => {
                                console.error('Lỗi khi sao chép: ', err);
                                alert('Lỗi khi sao chép code.');
                            });
                        };


                        aiTextContentSpan.appendChild(codePre);

                        lastIndex = codeBlockRegex.lastIndex;
                    }

                    textContent = processedText.substring(lastIndex);
                    if (textContent.trim()) {
                         const textPara = document.createElement('p');
                         textPara.innerHTML = textContent.trim();
                         aiTextContentSpan.appendChild(textPara);
                    }


                    if (!aiTextContentSpan.hasChildNodes() && processedText.trim()) {
                         aiTextContentSpan.innerHTML = processedText.trim();
                    } else if (!aiTextContentSpan.hasChildNodes()) {
                         aiTextContentSpan.textContent = "Không có phản hồi nội dung từ AI.";
                    }

                    aiMessageDiv.appendChild(aiTextContentSpan);

                    const aiMessageObject = { role: 'model', parts: [{ text: aiMessageDiv.innerHTML }] };
                    conversationHistory.push(aiMessageObject);

                     if (currentHistoryName) { // If in saved history, update it with AI response
                        savedHistories[currentHistoryName] = [...conversationHistory];
                        localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
                    } else {
                         saveChatHistory(); // only save to 'chatHistory' if not a named saved history.
                    }

                    Prism.highlightAllUnder(aiMessageDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;


                } else {
                    aiMessageDiv.innerHTML = `<span class="ai-message-text">Không nhận được phản hồi hợp lệ từ AI.</span>`;
                }

            } catch (error) {
                console.error("Lỗi fetch:", error);
                aiMessageDiv.innerHTML = `<span class="ai-message-text">Đã xảy ra lỗi khi kết nối đến API.</span>`;
            }
        }

        // Function to show in-page copy notification
        function showCopyNotification() {
            const notification = document.getElementById('copy-notification');
            notification.style.opacity = '1';
            setTimeout(() => {
                notification.style.opacity = '0';
            }, 2000); // Fade out after 2 seconds
        }


        // Settings Functions
        function loadSettings() {
            const storedSettings = localStorage.getItem('chatSettings');
            if (storedSettings) {
                const settings = JSON.parse(storedSettings);
                autoSaveHistory = settings.autoSaveHistory !== undefined ? settings.autoSaveHistory : true;
                useFirstMessageAsName = settings.useFirstMessageAsName !== undefined ? settings.useFirstMessageAsName : false;
                currentBackgroundColor = settings.backgroundColor || defaultBackgroundColor;
                currentTextColor = settings.textColor || defaultTextColor;
                currentContainerColor = settings.containerColor || defaultContainerColor;


                document.getElementById('autoSaveHistoryToggle').checked = autoSaveHistory;
                document.getElementById('useFirstMessageAsNameToggle').checked = useFirstMessageAsName;
                document.getElementById('backgroundColorPicker').value = currentBackgroundColor;
                document.getElementById('textColorPicker').value = currentTextColor;
                document.getElementById('containerColorPicker').value = currentContainerColor;

            } else {
                 document.getElementById('autoSaveHistoryToggle').checked = true;
                 document.getElementById('useFirstMessageAsNameToggle').checked = false;
                 // Color pickers are already initialized to default values from HTML
                 currentBackgroundColor = defaultBackgroundColor;
                 currentTextColor = defaultTextColor;
                 currentContainerColor = defaultContainerColor;

            }

            document.getElementById('autoSaveHistoryToggle').addEventListener('change', function() {
                autoSaveHistory = this.checked;
                // Settings are only saved to localstorage on "Save" button click now.
            });
            document.getElementById('useFirstMessageAsNameToggle').addEventListener('change', function() {
                useFirstMessageAsName = this.checked;
                // Settings are only saved to localstorage on "Save" button click now.
            });
            document.getElementById('backgroundColorPicker').addEventListener('change', function() {
                currentBackgroundColor = this.value; // Update current value, but apply only on Save
            });
             document.getElementById('textColorPicker').addEventListener('change', function() {
                currentTextColor = this.value; // Update current value, but apply only on Save
            });
            document.getElementById('containerColorPicker').addEventListener('change', function() {
                currentContainerColor = this.value; // Update current value, but apply only on Save
            });
        }

        function saveSetting(key, value) {
            let settings = JSON.parse(localStorage.getItem('chatSettings')) || {};
            settings[key] = value;
            localStorage.setItem('chatSettings', JSON.stringify(settings));
        }

        function autoSaveHistorySetting() {
            return autoSaveHistory;
        }
        function useFirstMessageAsNameSetting() {
            return useFirstMessageAsName;
        }


        function applyTheme() {
            document.documentElement.style.setProperty('--background-color', currentBackgroundColor);
            document.documentElement.style.setProperty('--text-color', currentTextColor);
            document.documentElement.style.setProperty('--container-background-color', currentContainerColor);
        }

        function saveSettingsAndApplyTheme() {
            saveSetting('autoSaveHistory', autoSaveHistory);
            saveSetting('useFirstMessageAsName', useFirstMessageAsName);
            saveSetting('backgroundColor', currentBackgroundColor);
            saveSetting('textColor', currentTextColor);
            saveSetting('containerColor', currentContainerColor);
            applyTheme();
            toggleSettingsMenu();
            alert('Cài đặt đã được lưu và áp dụng!');
        }

        function resetTheme() {
            currentBackgroundColor = defaultBackgroundColor;
            currentTextColor = defaultTextColor;
            currentContainerColor = defaultContainerColor;

            document.getElementById('backgroundColorPicker').value = currentBackgroundColor;
            document.getElementById('textColorPicker').value = currentTextColor;
            document.getElementById('containerColorPicker').value = currentContainerColor;

            applyTheme();
            alert('Giao diện đã hoàn tác về mặc định. Nhấn "Lưu cài đặt" để lưu thay đổi.');
        }


    </script>
</body>
</html>