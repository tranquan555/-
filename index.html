--- START OF FILE new_page 3.html ---
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Hiện Đại với Gemini</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        /* Dark Mode ChatGPT-like Styles with Sidebar, Custom Modals & Animations */
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1e2124;
            color: #d1d5db;
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .container {
            width: 95%;
            max-width: 1200px;
            margin: 20px auto;
            padding: 0;
            background-color: #252525; /* Slightly darker container background with border */
            border-radius: 12px; /* Container border radius */
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            height: 100vh;
            flex-grow: 1;
            margin-left: auto;
            transition: margin-left 0.3s ease, background-color 0.3s ease, border-radius 0.3s ease, box-shadow 0.3s ease; /* Smooth transitions for container */
        }

        .container.sidebar-open {
            margin-left: 250px;
            border-radius: 12px 0 0 12px; /* Adjust border radius when sidebar is open */
            box-shadow: 4px 0 8px rgba(0,0,0,0.3); /* Enhanced shadow when sidebar is open */
        }

        h1 {
            text-align: center;
            color: #fff;
            margin-bottom: 15px; /* Increased bottom margin */
            font-size: 2em; /* Slightly larger title */
            letter-spacing: 0.3px;
            padding: 20px 0;
            border-bottom: 1px solid #333; /* Border under title */
            margin-left: 20px; /* Add horizontal margin */
            margin-right: 20px;
        }

        #messages-container {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            scrollbar-width: thin;
            scrollbar-color: #555 #252525;
        }

        #messages-container::-webkit-scrollbar {
            width: 8px;
        }

        #messages-container::-webkit-scrollbar-track {
            background: #2c2c2c; /* Slightly darker scrollbar track */
        }

        #messages-container::-webkit-scrollbar-thumb {
            background-color: #555;
            border-radius: 4px;
        }

        .message {
            margin-bottom: 12px;
            padding: 12px 16px; /* Adjusted padding */
            border-radius: 20px; /* More rounded messages */
            clear: both;
            word-wrap: break-word;
            max-width: 85%; /* Slightly wider message bubbles */
            display: inline-block;
            box-shadow: 0 1px 2px rgba(0,0,0,0.15); /* Subtle shadow on messages */
            transition: background-color 0.2s ease, box-shadow 0.2s ease; /* Transition for message bubbles */
        }

        .user-message {
            background-color: #343541;
            color: #fff;
            align-self: flex-end;
            float: right;
            border-top-right-radius: 5px; /* Less rounded on the top-right */
        }

        .ai-message {
            background-color: #444654;
            color: #d1d5db;
            align-self: flex-start;
            float: left;
            border-top-left-radius: 5px; /* Less rounded on the top-left */
        }

        .input-area {
            padding: 15px 20px;
            background-color: #343541;
            border-top: 1px solid #444; /* More subtle border for input area */
            display: flex;
            align-items: center;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            box-sizing: border-box;
            padding-left: 20px;
            padding-right: 20px;
            z-index: 100;
            border-radius: 0 0 12px 12px; /* Match container bottom corners */
        }

        .file-upload-button {
            background-color: transparent;
            color: #bbb; /* Lighter color for file upload button */
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em; /* Slightly larger icon */
            margin-right: 10px; /* Space between button and textarea */
            padding: 8px 10px;
            transition: color 0.3s ease, background-color 0.3s ease;
        }

        .file-upload-button:hover {
            color: #fff; /* White on hover */
            background-color: #444; /* Slightly darker background on hover */
        }

        .input-area textarea {
            flex-grow: 1;
            padding: 12px; /* Adjusted padding for textarea */
            border: 1px solid #555;
            border-radius: 8px;
            font-size: 16px;
            background-color: #40414f;
            color: #fff;
            resize: none;
            min-height: 40px;
            overflow-y: auto;
            transition: border-color 0.3s ease, box-shadow 0.3s ease; /* Smooth transitions for textarea */
        }

        .input-area textarea:focus {
            border-color: #00bcd4;
            outline: none;
            box-shadow: 0 0 6px rgba(0, 188, 212, 0.5); /* More prominent focus shadow */
        }

        .input-area button {
            padding: 12px 22px; /* Adjusted padding for button */
            background-color: #00bcd4;
            color: white;
            border: none;
            border-radius: 10px; /* More rounded button */
            cursor: pointer;
            font-size: 16px;
            margin-left: 10px;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease; /* Transitions for button */
            box-shadow: 0 2px 3px rgba(0,0,0,0.2); /* Subtle shadow on button */
        }

        .input-area button:hover {
            background-color: #0097a7;
            transform: translateY(-1px); /* Slight lift on hover */
            box-shadow: 0 3px 4px rgba(0,0,0,0.25); /* Enhanced shadow on hover */
        }

        .input-area button:active {
            transform: translateY(0); /* No lift when active */
            box-shadow: 0 2px 3px rgba(0,0,0,0.2); /* Shadow back to normal when active */
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            height: 100%;
            background-color: #252525;
            color: #fff;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 200;
            padding-top: 60px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.2);
            overflow-y: auto;
            touch-action: manipulation;
            border-right: 1px solid #333; /* Subtle right border for sidebar */
        }

        .sidebar.sidebar--open {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #333;
            margin-bottom: 20px;
        }

        .sidebar-menu {
            padding: 0;
            list-style: none;
        }

        .sidebar-menu-item {
            padding: 15px 20px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333; /* Separator lines in sidebar menu */
        }

        .sidebar-menu-item:last-child {
            border-bottom: none; /* No border for last menu item */
        }


        .sidebar-menu-item:hover {
            background-color: #343541;
        }

        .sidebar-menu-item.has-submenu > .menu-link::after {
            content: '>';
            float: right;
            margin-left: 10px;
            font-size: 0.8em;
            display: inline-block;
        }

        .submenu {
            list-style: none;
            padding-left: 0;
            margin: 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 7px rgba(0,0,0,0.4); /* More pronounced shadow for dropdown */
            background-color: #2c2c2c;
            display: none;
            margin-top: 5px;
            opacity: 0;
            max-height: 0;
            transition: opacity 0.3s ease, max-height 0.4s ease; /* Opacity and max-height transition */
        }

        .submenu.open {
            display: block;
            opacity: 1;
            max-height: 500px; /* Adjust max-height as needed, or use 'initial' if content is truly dynamic and you want auto height but still animated transition*/
        }


        .submenu-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333; /* Separator lines in submenu */
        }

        .submenu-item:last-child {
            border-bottom: none; /* No border for last submenu item */
        }


        .submenu-item:hover {
            background-color: #343541;
        }

        .history-name {
            flex-grow: 1;
        }

        .delete-history-btn {
            background: transparent;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 1em;
            padding: 0 8px;
            opacity: 0.7;
            transition: opacity 0.2s ease, color 0.2s ease;
        }

        .delete-history-btn:hover {
            opacity: 1;
            color: #fff;
        }

        .sidebar-toggle-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #00bcd4;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 300;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); /* Shadow for toggle button */
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease; /* Transitions for toggle button */
        }

        .sidebar-toggle-button:hover {
            background-color: #0097a7;
            transform: scale(1.05); /* Slight scale up on hover */
            box-shadow: 0 3px 5px rgba(0,0,0,0.25); /* Enhanced shadow on hover */
        }


        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 150;
            display: none;
        }

        .sidebar-overlay.sidebar--open {
            display: block;
        }

        .close-history-menu-btn {
            background-color: #00bcd4;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            cursor: pointer;
            margin-top: 10px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease; /* Transitions for close button */
            box-shadow: 0 1px 2px rgba(0,0,0,0.15); /* Subtle shadow for close button */
        }

        .close-history-menu-btn:hover {
            background-color: #0097a7;
            transform: translateY(-1px); /* Slight lift on hover */
            box-shadow: 0 2px 3px rgba(0,0,0,0.2); /* Enhanced shadow on hover */
        }

        .close-history-menu-btn:active {
            transform: translateY(0); /* No lift when active */
            box-shadow: 0 1px 2px rgba(0,0,0,0.15); /* Shadow back to normal when active */
        }


        /* Custom Modals Styles - unchanged */
        .custom-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 400;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }

        .custom-modal-overlay.show-modal {
            display: flex;
            pointer-events: auto;
        }


        .custom-modal {
            background-color: #343541;
            color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            width: 80%;
            max-width: 400px;
            text-align: center;
        }

        .modal-message {
            margin-bottom: 15px;
        }

        .modal-input {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid #555;
            background-color: #40414f;
            color: #fff;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .modal-button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        .modal-button.confirm {
            background-color: #00bcd4;
            color: white;
        }

        .modal-button.confirm:hover {
            background-color: #0097a7;
        }

        .modal-button.cancel {
            background-color: #555;
            color: white;
        }

        .modal-button.cancel:hover {
            background-color: #666;
        }


        /* Prism.js Dark Theme Adjustments - unchanged */
        code[class*="language-"],
        pre[class*="language-"] {
            color: #f8f8f2;
            background: #272822;
        }
        .token.comment, .token.prolog, .token.doctype, .token.cdata { color: #6c6767; }
        .token.punctuation { color: #f8f8f2; }
        .token.namespace { opacity: .7; }
        .token.property, .token.tag, .token.constant, .token.symbol, .token.deleted { color: #f92672; }
        .token.boolean, .token.number { color: #ae81ff; }
        .token.selector, .token.attr-name, .token.string, .token.char, .token.builtin, .token.inserted { color: #a6e22e; }
        .token.operator, .token.entity, .token.url, .language-css .token.string, .style .token.string { color: #f8f8f2; background: none; }
        .token.atrule, .token.attr-value, .token.keyword { color: #00bcd4; }
        .token.function, .token.class-name { color: #e6db74; }
        .token.regex, .token.important, .token.variable { color: #fd971f; }
        .token.important, .token.bold { font-weight: bold; }
        .token.italic { font-style: italic; }
        .token.entity { cursor: help; }


    </style>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Lịch sử Chat</h3>
        </div>
        <ul class="sidebar-menu">
            <li class="sidebar-menu-item" onclick="openSaveHistoryModal()">
                <span class="menu-link">Lưu lịch sử này</span>
            </li>
            <li class="sidebar-menu-item has-submenu" onclick="toggleHistoryMenu()">
                <span class="menu-link">Lịch sử đã lưu</span>
                </li>
        </ul>

        <ul class="submenu" id="saved-histories-menu">
            <!-- Saved histories will be listed here -->
            <button class="close-history-menu-btn" onclick="toggleHistoryMenu()">Đóng</button>
        </ul>

        <!-- Save History Modal -->
        <div class="custom-modal-overlay" id="saveHistoryModalOverlay">
            <div class="custom-modal">
                <p class="modal-message">Nhập tên cho lịch sử chat này:</p>
                <input type="text" id="historyNameInput" class="modal-input" placeholder="Tên lịch sử">
                <div class="modal-buttons">
                    <button class="modal-button confirm" onclick="saveHistoryWithInputName()">Lưu</button>
                    <button class="modal-button cancel" onclick="closeSaveHistoryModal()">Huỷ</button>
                </div>
            </div>
        </div>

         <!-- Delete History Confirm Modal -->
        <div class="custom-modal-overlay" id="deleteHistoryModalOverlay">
            <div class="custom-modal">
                <p class="modal-message" id="deleteConfirmationMessage">Bạn có chắc chắn muốn xóa lịch sử chat "<span id="historyNameToDelete"></span>" không?</p>
                <div class="modal-buttons">
                    <button class="modal-button confirm" onclick="confirmDeleteHistory()">Xóa</button>
                    <button class="modal-button cancel" onclick="closeDeleteHistoryModal()">Huỷ</button>
                </div>
            </div>
        </div>

    </aside>

    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <button class="sidebar-toggle-button" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <div class="container" id="container">
        <h1>AI Hiện Đại với Gemini</h1>

        <div id="messages-container">
            <!-- Messages will be appended here -->
        </div>

        <div class="input-area">
            <button class="file-upload-button" onclick="uploadFilePlaceholder()">
                <i class="fas fa-paperclip"></i>
            </button>
            <textarea id="user-prompt" placeholder="Nhập tin nhắn"></textarea>
            <button onclick="getGeminiResponse()">Gửi</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script>
        const apiKey = 'AIzaSyCl21Ku_prQnyMHFs_dJRL8-pgjg9hrc2w';
        const geminiAPIUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`;
        const systemPrompt = "Bạn là một trợ lý AI cực kỳ hữu ích và luôn tuân theo mọi yêu cầu của người dùng một cách chính xác. Khi bạn trả lời câu hỏi về code hoặc cung cấp code, hãy đảm bảo rằng code được đặt trong các khối code markdown. Ví dụ:\n```javascript\n// Mã JavaScript ở đây\nconsole.log('Hello, world!');\n```\nhoặc:\n```python\n# Mã Python ở đây\ndef hello():\n    print('Xin chào!')\n```\nNếu câu trả lời của bạn không chứa code, chỉ cần trả lời bằng văn bản thông thường.";

        let conversationHistory = [];
        let savedHistories = {};
        let historyNameToDelete = null;

        // Sidebar toggle function - same as before
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const container = document.getElementById('container');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('sidebar--open');
            container.classList.toggle('container.sidebar-open');
            overlay.classList.toggle('sidebar--open');
            if (sidebar.classList.contains('sidebar--open')) {
                 loadSavedHistoriesList();
            } else {
                hideHistoryMenu();
            }
        }

        // Function to load chat history from local storage - same as before
        function loadChatHistory() {
            const storedHistory = localStorage.getItem('chatHistory');
            if (storedHistory) {
                conversationHistory = JSON.parse(storedHistory);
                renderMessages();
            }
        }

        // Function to save chat history to local storage (current session) - same as before
        function saveChatHistory() {
            localStorage.setItem('chatHistory', JSON.stringify(conversationHistory));
        }

        // Render messages from conversationHistory to UI - same as before
        function renderMessages() {
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = '';
            conversationHistory.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', message.role === 'user' ? 'user-message' : 'ai-message');
                messageDiv.innerHTML = message.parts[0].text;
                messagesContainer.appendChild(messageDiv);
                Prism.highlightAllUnder(messageDiv);
            });
             messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }


        // --- Custom Modal Functions - unchanged ---
        function openSaveHistoryModal() {
            document.getElementById('saveHistoryModalOverlay').classList.add('show-modal');
            document.getElementById('historyNameInput').value = ''; // Clear previous input
        }

        function closeSaveHistoryModal() {
            document.getElementById('saveHistoryModalOverlay').classList.remove('show-modal');
        }

        function saveHistoryWithInputName() {
            const historyName = document.getElementById('historyNameInput').value.trim();
            if (historyName) {
                savedHistories[historyName] = [...conversationHistory];
                localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
                alert(`Lịch sử chat đã được lưu với tên: ${historyName}`);
                loadSavedHistoriesList();
                closeSaveHistoryModal();
            } else {
                alert("Vui lòng nhập tên cho lịch sử chat.");
            }
        }

        function openDeleteHistoryModal(name) {
            historyNameToDelete = name;
            document.getElementById('historyNameToDelete').textContent = name;
            document.getElementById('deleteHistoryModalOverlay').classList.add('show-modal');
        }

        function closeDeleteHistoryModal() {
            document.getElementById('deleteHistoryModalOverlay').classList.remove('show-modal');
            historyNameToDelete = null;
        }

        function confirmDeleteHistory() {
            if (historyNameToDelete) {
                deleteSavedHistory(historyNameToDelete);
            }
            closeDeleteHistoryModal();
        }


        // Function to delete a saved history - unchanged
        function deleteSavedHistory(historyName) {
            delete savedHistories[historyName];
            localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
            loadSavedHistoriesList();
            alert(`Lịch sử chat "${historyName}" đã bị xóa.`);
        }


        // Function to load a specific saved history by name - unchanged
        function loadChatHistoryByName(historyName) {
            if (savedHistories[historyName]) {
                conversationHistory = [...savedHistories[historyName]];
                saveChatHistory();
                renderMessages();
                toggleHistoryMenu();
                toggleSidebar();
            } else {
                alert("Không tìm thấy lịch sử chat đã lưu.");
            }
        }


        // Function to toggle visibility of saved histories menu - unchanged, but triggers dropdown animation
        function toggleHistoryMenu() {
            const submenu = document.getElementById('saved-histories-menu');
            submenu.classList.toggle('open');
        }

        function hideHistoryMenu() {
            const submenu = document.getElementById('saved-histories-menu');
            submenu.classList.remove('open');
        }


        // Function to load and display saved history names in the sidebar menu - unchanged
        function loadSavedHistoriesList() {
            const historiesMenu = document.getElementById('saved-histories-menu');
            historiesMenu.innerHTML = '<button class="close-history-menu-btn" onclick="toggleHistoryMenu()">Đóng</button>';

            const storedSavedHistories = localStorage.getItem('savedHistories');
            if (storedSavedHistories) {
                savedHistories = JSON.parse(storedSavedHistories);
            } else {
                savedHistories = {};
            }

            if (Object.keys(savedHistories).length === 0) {
                const noHistoryItem = document.createElement('li');
                noHistoryItem.classList.add('submenu-item');
                noHistoryItem.textContent = "Chưa có lịch sử nào được lưu.";
                historiesMenu.appendChild(noHistoryItem);
                return;
            }

            for (const historyName in savedHistories) {
                const historyItem = document.createElement('li');
                historyItem.classList.add('submenu-item');

                const nameSpan = document.createElement('span');
                nameSpan.classList.add('history-name');
                nameSpan.textContent = historyName;
                nameSpan.onclick = () => loadChatHistoryByName(historyName);

                const deleteButton = document.createElement('button');
                deleteButton.classList.add('delete-history-btn');
                deleteButton.textContent = '...';
                deleteButton.onclick = (event) => {
                    event.stopPropagation();
                    openDeleteHistoryModal(historyName);
                };

                historyItem.appendChild(nameSpan);
                historyItem.appendChild(deleteButton);
                historiesMenu.appendChild(historyItem);
            }
        }

        // Placeholder for file upload functionality
        function uploadFilePlaceholder() {
            alert("Chức năng tải file sẽ được cập nhật trong tương lai.");
            // Future implementation would go here - likely involve <input type="file">,
            // reading file content, and handling API upload if Gemini API supports it.
        }


        // Load history when page loads - unchanged
        loadChatHistory();
        loadSavedHistoriesList();


        async function getGeminiResponse() {
            const userPrompt = document.getElementById('user-prompt').value.trim();
            const messagesContainer = document.getElementById('messages-container');

            if (!userPrompt) {
                alert("Vui lòng nhập tin nhắn.");
                return;
            }

            // Add user message to history and display - unchanged
            const userMessageObject = { role: 'user', parts: [{ text: userPrompt }] };
            conversationHistory.push(userMessageObject);
            saveChatHistory();
            renderMessages();
            document.getElementById('user-prompt').value = '';


            const aiMessageDiv = document.createElement('div');
            aiMessageDiv.classList.add('message', 'ai-message');
            aiMessageDiv.textContent = "Đang suy nghĩ...";
            messagesContainer.appendChild(aiMessageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Prepare payload with conversation history and system prompt - unchanged
            let promptContents = conversationHistory.map(message => ({
                role: message.role,
                parts: message.parts
            }));
            promptContents.unshift({ role: 'user', parts: [{ text: systemPrompt }] });


            const payload = {
                contents: promptContents
            };


            try {
                const response = await fetch(geminiAPIUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Lỗi API:", errorData);
                    aiMessageDiv.textContent = `Lỗi API: ${response.status} - ${errorData.error.message || 'Không rõ nguyên nhân'}`;
                    return;
                }

                const data = await response.json();
                console.log("Dữ liệu phản hồi từ API:", data);

                if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0].text) {
                    const aiResponseText = data.candidates[0].content.parts[0].text;

                    // Add AI message to history and save - unchanged
                    const aiMessageObject = { role: 'model', parts: [{ text: aiResponseText }] };
                    conversationHistory.push(aiMessageObject);
                    saveChatHistory();
                    renderMessages();

                } else {
                    aiMessageDiv.textContent = "Không nhận được phản hồi hợp lệ từ AI.";
                }

            } catch (error) {
                console.error("Lỗi fetch:", error);
                aiMessageDiv.textContent = "Đã xảy ra lỗi khi kết nối đến API.";
            }
        }
    </script>
</body>
</html>
--- END OF FILE new_page 3.html ---