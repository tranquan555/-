<!DOCTYPE html>
<html>
<head>
    <title>AI Chatbot - Gemini API</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        /* CSS Dark Mode hiện đại và Responsive - ChatGPT Interface Style */
        :root {
            --bg-color: #121212;
            --text-color: #f0f0f0;
            --primary-color: #64ffda;
            --secondary-bg: #1e1e1e;
            --border-color: #333;
            --message-user-bg: #2962ff;
            --message-ai-bg: #4caf50;
            --button-bg: #3498db;
            --button-hover-bg: #2980b9;
            --menu-bg: #252525;
            --loading-color: #ffc107;
            --history-list-bg: #252525;
            --history-list-item-hover: #333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-top: 20px;
            margin-bottom: 20px; /* Giảm margin bottom tiêu đề */
        }


        .container {
            width: 98%; /* Container rộng hơn */
            max-width: 900px; /* Max width lớn hơn */
            background-color: var(--secondary-bg);
            padding: 25px; /* Giảm padding container */
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            margin-bottom: 25px; /* Giảm margin bottom container */
        }

        /* Menu danh mục (giữ nguyên) */
        .menu-container {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .menu-button {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background-color: var(--button-bg);
            color: var(--text-color);
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.3s ease-in-out;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            outline: none;
        }

        .menu-button:hover {
            background-color: var(--button-hover-bg);
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.5);
        }


        .menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--menu-bg);
            border-radius: 10px;
            overflow: hidden;
            display: none;
            transform-origin: top right;
            transform: scaleY(0);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 8px 20px rgba(0,0,0,0.6);
            z-index: 10;
        }

        .menu-dropdown.active {
            display: block;
            transform: scaleY(1);
        }

        .menu-dropdown button {
            display: block;
            width: 100%;
            padding: 10px 20px;
            border: none;
            background-color: transparent;
            color: var(--text-color);
            text-align: left;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }

        .menu-dropdown button:hover {
            background-color: var(--history-list-item-hover);
        }


        /* Form đăng nhập/đăng ký (giữ nguyên) */
        .auth-container {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            margin-bottom: 15px; /* Giảm margin bottom form */
        }

        .auth-container h2 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 15px; /* Giảm margin bottom h2 form */
        }

        .auth-container label {
            margin-bottom: 6px; /* Giảm margin bottom label form */
            color: #ccc;
        }

        .auth-container input {
            padding: 10px; /* Giảm padding input form */
            margin-bottom: 15px; /* Giảm margin bottom input form */
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 15px; /* Font size nhỏ hơn input form */
            background-color: var(--secondary-bg);
            color: var(--text-color);
            transition: border-color 0.3s;
        }

        .auth-container button {
            padding: 10px 18px; /* Nút form padding nhỏ hơn */
            border: none;
            border-radius: 10px;
            background-color: var(--button-bg);
            color: var(--text-color);
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.3s ease-in-out;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            outline: none;
        }

        .auth-switch {
            text-align: center;
            margin-top: 8px; /* Giảm margin top auth switch */
            color: #aaa;
            font-size: 14px; /* Font size nhỏ hơn auth switch */
        }


        /* Hiển thị tên người dùng (giữ nguyên) */
        #username-display {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 15px; /* Giảm margin bottom username display */
            text-align: center;
            animation: pulseText 2s infinite alternate;
        }


        #username-display.logged-out-message {
            color: #e74c3c;
            animation: none;
        }


        /* Chat container (EXPANDED HEIGHT, ChatGPT-like) */
        #chat-container {
            border: none; /* Loại bỏ border chat container */
            padding: 0; /* Loại bỏ padding chat container */
            height: calc(100vh - 250px); /* Chiều cao chat container mở rộng */
            overflow-y: scroll;
            margin-bottom: 15px; /* Giảm margin bottom chat container */
            border-radius: 0; /* Loại bỏ border-radius chat container */
            background-color: transparent; /* Nền trong suốt chat container */
            display: flex;
            flex-direction: column;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) transparent; /* Scrollbar màu primary, track trong suốt */
            position: relative;
        }

        /* Chrome, Safari and Opera */
        #chat-container::-webkit-scrollbar {
            width: 8px; /* Scrollbar hẹp hơn */
        }

        #chat-container::-webkit-scrollbar-track {
            background-color: transparent; /* Track trong suốt */
            border-radius: 0; /* Loại bỏ border-radius track */
        }

        #chat-container::-webkit-scrollbar-thumb {
            background-color: var(--primary-color);
            border-radius: 10px;
        }

        .user-message, .ai-message, .loading-message {
            padding: 10px 15px; /* Message padding nhỏ hơn */
            border-radius: 15px; /* Messages bo tròn ít hơn */
            margin-bottom: 8px; /* Message margin nhỏ hơn */
            max-width: 90%; /* Messages max width lớn hơn */
            clear: both;
            word-wrap: break-word;
            animation: messageAppear 0.4s ease-out forwards;
            transform-origin: top;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15); /* Shadow nhẹ hơn cho messages */
        }


        .user-message {
            background-color: #3498db; /* Màu user message giống ChatGPT hơn */
            color: var(--text-color);
            align-self: flex-end;
            text-align: right;
        }

        .ai-message {
            background-color: #4a5568; /* Màu AI message giống ChatGPT hơn (xám đậm) */
            color: var(--text-color);
            align-self: flex-start;
            text-align: left;
        }

        .loading-message {
            background-color: transparent; /* Nền trong suốt loading message */
            color: var(--loading-color);
            align-self: flex-start;
            text-align: left;
            font-style: italic;
            animation: blinkLoading 1.5s infinite;
        }


        /* Input container (FULL WIDTH, ChatGPT-like) */
        #input-container {
            display: flex;
            margin-bottom: 0; /* Loại bỏ margin bottom input container */
            border-top: 1px solid var(--border-color); /* Thêm border top input container */
            padding-top: 10px; /* Thêm padding top input container */
        }


        #prompt-input { /* INPUT FULL WIDTH, ChatGPT-like */
            flex-grow: 1;
            padding: 10px; /* Input padding nhỏ hơn */
            border: none; /* Loại bỏ border input */
            border-radius: 0; /* Loại bỏ border-radius input */
            font-size: 16px;
            background-color: transparent; /* Nền trong suốt input */
            color: var(--text-color);
            transition: border-color 0.3s;
            outline: none;
        }


        #send-button, #upload-button { /* Nút input (ChatGPT-like) */
            padding: 10px 15px; /* Nút input padding nhỏ hơn */
            border: none;
            background-color: var(--button-bg);
            color: var(--text-color);
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.3s ease-in-out;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            border-radius: 0; /* Loại bỏ border-radius nút input */
            margin-left: 5px; /* Thêm margin trái nút send */
        }

        #upload-button {
            border-radius: 8px; /* Nút upload bo tròn hơn */
            margin-right: 5px; /* Thêm margin phải nút upload */
            margin-left: 0; /* Loại bỏ margin trái nút upload */
        }


        /* API Key container (ĐÃ XÓA KHỎI HTML) - CSS không cần thiết nữa */
        #api-key-container {
            display: none;
            margin-bottom: 20px;
        }


        /* Nút chat mới và tải lại lịch sử (ẩn trong menu) - giữ nguyên */
        #new-chat-button, #load-history-button {
            display: none;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            color: var(--text-color);
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s ease-in-out;
            margin-bottom: 20px;
            margin-right: 10px;
        }


        /* Ẩn container chat và prompt khi chưa đăng nhập (giữ nguyên) */
        #chat-interface-container {
            display: none;
        }


        /* Responsive adjustments - Mobile (ChatGPT-like) */
        @media (max-width: 768px) {
            .container {
                padding: 15px; /* Giảm padding container mobile */
                width: 98%; /* Container mobile rộng hơn */
            }

            h1 {
                font-size: 22px; /* Font size nhỏ hơn tiêu đề mobile */
                margin-bottom: 15px; /* Margin bottom nhỏ hơn tiêu đề mobile */
            }

            #chat-container {
                height: calc(100vh - 200px); /* Chiều cao chat container mobile nhỏ hơn */
                margin-bottom: 15px; /* Margin bottom nhỏ hơn chat container mobile */
            }


            #input-container {
                flex-direction: row; /* Input container mobile về row */
                padding-top: 8px; /* Padding top input container mobile nhỏ hơn */
            }


            #send-button, #upload-button {
                border-radius: 0; /* Loại bỏ border-radius nút mobile */
                width: auto; /* Nút mobile width auto */
                margin-bottom: 0;
                padding: 10px 15px; /* Nút mobile padding nhỏ hơn */
                font-size: 15px; /* Nút mobile font size nhỏ hơn */
                margin-left: 2px; /* Giảm margin left nút send mobile */
            }

            #upload-button {
                margin-right: 5px; /* Giảm margin right nút upload mobile */
                border-radius: 8px; /* Nút upload mobile bo tròn hơn */
            }


            .menu-button {
                font-size: 14px; /* Nút menu mobile font size nhỏ hơn */
                padding: 8px 12px; /* Nút menu mobile padding nhỏ hơn */
                border-radius: 8px;
            }
            .menu-dropdown button {
                padding: 10px 15px; /* Item menu mobile padding nhỏ hơn */
                font-size: 14px; /* Item menu mobile font size nhỏ hơn */
            }

            #prompt-input {
                font-size: 15px; /* Input mobile font size nhỏ hơn */
                padding: 10px; /* Input mobile padding nhỏ hơn */
                border-radius: 0; /* Loại bỏ border-radius input mobile */
            }

            .user-message, .ai-message, .loading-message {
                font-size: 15px; /* Message font size nhỏ hơn mobile */
                padding: 10px 12px; /* Message padding nhỏ hơn mobile */
                border-radius: 15px; /* Messages bo tròn ít hơn mobile */
                margin-bottom: 6px; /* Message margin nhỏ hơn mobile */
            }
        }


        /* Danh sách lịch sử chat (giữ nguyên) */
        #history-list-container {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--history-list-bg);
            border-radius: 10px;
            overflow: hidden;
            display: none;
            max-height: 250px;
            overflow-y: scroll;
            box-shadow: 0 8px 20px rgba(0,0,0,0.6);
            z-index: 9;
        }

        #history-list-container.active {
            display: block;
        }

        #history-list-container button {
            display: block;
            width: 100%;
            padding: 12px 22px;
            border: none;
            background-color: transparent;
            color: var(--text-color);
            text-align: left;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #history-list-container button:hover {
            background-color: var(--history-list-item-hover);
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>AI Chatbot - Gemini API</h1>

        <div class="menu-container">
            <button class="menu-button" onclick="toggleMenu()">Danh mục</button>
            <div class="menu-dropdown" id="menuDropdown">
                <button onclick="startNewChatConfirmation()">Bắt đầu cuộc trò chuyện mới</button>
                <button onclick="loadChatHistoryDropdown()">Tải lại lịch sử</button>
                <button onclick="downloadChatHistory()">Tải xuống lịch sử chat</button>
                <button onclick="logoutUser()">Đăng xuất</button>
            </div>
        </div>

        <!-- Container đăng nhập/đăng ký (giữ nguyên) -->
        <div id="auth-forms-container">
            <div id="login-form" class="auth-container">
                <h2>Đăng nhập</h2>
                <label for="login-username">Tên người dùng:</label>
                <input type="text" id="login-username" placeholder="Nhập tên người dùng">
                <label for="login-password">Mật khẩu:</label>
                <input type="password" id="login-password" placeholder="Nhập mật khẩu">
                <button onclick="loginUser()">Đăng nhập</button>
                <div class="auth-switch">
                    <a href="#" onclick="showRegisterForm(); return false;">Chưa có tài khoản? Đăng ký ngay</a>
                </div>
            </div>

            <div id="register-form" class="auth-container" style="display: none;">
                <h2>Đăng ký</h2>
                <label for="register-username">Tên người dùng:</label>
                <input type="text" id="register-username" placeholder="Chọn tên người dùng">
                <label for="register-password">Mật khẩu:</label>
                <input type="password" id="register-password" placeholder="Chọn mật khẩu">
                <button onclick="registerUser()">Đăng ký</button>
                <div class="auth-switch">
                    <a href="#" onclick="showLoginForm(); return false;">Đã có tài khoản? Đăng nhập</a>
                </div>
            </div>
        </div>

        <!-- Hiển thị tên người dùng / thông báo đăng ký (giữ nguyên) -->
        <div id="username-display"></div>

        <!-- Container giao diện chat (ẩn khi chưa đăng nhập) -->
        <div id="chat-interface-container" style="display: none;">


            <div id="chat-container">
                <!-- Tin nhắn chat sẽ hiển thị ở đây -->
                <div id="history-list-container">
                    <!-- Danh sách lịch sử chat sẽ được tạo ở đây -->
                </div>
            </div>


            <div id="input-container">
                <input type="file" id="file-upload" style="display: none;" accept=".txt">
                <button id="upload-button" onclick="document.getElementById('file-upload').click();">Tải tệp lên</button>
                <input type="text" id="prompt-input" placeholder="Nhập tin nhắn..." onkeydown="if (event.keyCode == 13) { sendMessage(); return false; }"> <!-- Placeholder text đã sửa -->
                <button id="send-button" onclick="sendMessage()">Gửi</button>
            </div>
        </div>
    </div>

    <script>
        // ... (JavaScript code - no changes needed from previous version) ...
        const chatContainer = document.getElementById('chat-container');
        const promptInput = document.getElementById('prompt-input');
        const apiKeyInput = document.getElementById('api-key-input');
        const usernameDisplay = document.getElementById('username-display');
        const chatInterfaceContainer = document.getElementById('chat-interface-container');
        const authFormsContainer = document.getElementById('auth-forms-container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginUsernameInput = document.getElementById('login-username');
        const loginPasswordInput = document.getElementById('login-password');
        const registerUsernameInput = document.getElementById('register-username');
        const registerPasswordInput = document.getElementById('register-password');
        const fileUploadInput = document.getElementById('file-upload');
        const menuDropdown = document.getElementById('menuDropdown');
        const historyListContainer = document.getElementById('history-list-container');


        let conversationHistory = [];
        let currentUsername = '';
        let isLoading = false;
        let historySessions = [];

        // API Key Gemini của bạn (CỐ ĐỊNH TRONG CODE)
        const GEMINI_API_KEY_DEFAULT = 'AIzaSyCl21Ku_prQnyMHFs_dJRL8-pgjg9hrc2w';
        let currentApiKey = GEMINI_API_KEY_DEFAULT;
        const FIXED_PROMPT = "Bạn là một trợ lý AI hữu ích, thông minh và luôn trả lời một cách chi tiết và chính xác. Hãy giúp người dùng giải quyết mọi vấn đề và cung cấp thông tin tốt nhất có thể.";


        // --- Hàm hỗ trợ writeFile (mô phỏng lưu file) ---
        function writeFile(filepath, data) {
            localStorage.setItem(filepath, JSON.stringify(data));
        }

        // --- Hàm hỗ trợ readFile (mô phỏng đọc file) ---
        function readFile(filepath) {
            const data = localStorage.getItem(filepath);
            return data ? JSON.parse(data) : null;
        }


        // --- Menu Danh mục (giữ nguyên) ---
        function toggleMenu() {
            menuDropdown.classList.toggle('active');
        }

        window.addEventListener('click', function(event) {
            if (!event.target.matches('.menu-button')) {
                if (menuDropdown.classList.contains('active')) {
                    menuDropdown.classList.remove('active');
                }
            }
        });


        // --- Chuyển đổi form đăng nhập/đăng ký (giữ nguyên) ---
        function showRegisterForm() {
            loginForm.style.display = 'none';
            registerForm.style.display = 'block';
            usernameDisplay.textContent = '';
        }

        function showLoginForm() {
            registerForm.style.display = 'none';
            loginForm.style.display = 'block';
            usernameDisplay.textContent = '';
        }


        // --- Quản lý người dùng và đăng nhập/đăng ký (CẬP NHẬT LƯU FILE) ---
        function registerUser() {
            const username = registerUsernameInput.value.trim();
            const password = registerPasswordInput.value.trim();

            if (!username || !password) {
                alert("Vui lòng nhập tên người dùng và mật khẩu.");
                return;
            }

            // Mô phỏng đường dẫn file thông tin người dùng
            const userFilePath = `user/${username}/info.json`;

            if (readFile(userFilePath)) {
                alert("Tên người dùng đã tồn tại. Vui lòng chọn tên người dùng khác.");
                return;
            }

            // Lưu thông tin người dùng vào "file" info.json
            writeFile(userFilePath, { username: username, password: password });
            alert("Đăng ký thành công. Vui lòng đăng nhập.");
            showLoginForm();
        }


        function loginUser() {
            const username = loginUsernameInput.value.trim();
            const password = loginPasswordInput.value.trim();

            if (!username || !password) {
                alert("Vui lòng nhập tên người dùng và mật khẩu.");
                return;
            }

            const userFilePath = `user/${username}/info.json`;
            const userInfo = readFile(userFilePath);

            if (userInfo && userInfo.password === password) {
                currentUsername = username;
                saveUsername(username);
                displayUsername();
                authFormsContainer.style.display = 'none';
                chatInterfaceContainer.style.display = 'block';
                loadChatHistory();
            } else {
                alert("Đăng nhập thất bại. Tên người dùng hoặc mật khẩu không đúng.");
            }
        }

        function logoutUser() {
            currentUsername = '';
            localStorage.removeItem('geminiChatCurrentUsername');
            conversationHistory = [];
            chatContainer.innerHTML = '';
            chatInterfaceContainer.style.display = 'none';
            authFormsContainer.style.display = 'block';
            usernameDisplay.textContent = '';
            menuDropdown.classList.remove('active');
            historyListContainer.classList.remove('active');
            saveChatHistory(); // LƯU LỊCH SỬ KHI ĐĂNG XUẤT (Omega Update change)
        }


        function saveUsername(username) {
            localStorage.setItem('geminiChatCurrentUsername', username);
        }

        function getUsername() {
            return localStorage.getItem('geminiChatCurrentUsername') || '';
        }

        function displayUsername() {
            currentUsername = getUsername();
            if (currentUsername) {
                usernameDisplay.textContent = `Chào mừng, ${currentUsername}!`;
                usernameDisplay.className = '';
            } else {
                usernameDisplay.textContent = 'Bạn cần đăng ký và đăng nhập để sử dụng chatbot.';
                usernameDisplay.className = 'logged-out-message';
            }
        }

        function checkLoginStatus() {
            if (getUsername()) {
                currentUsername = getUsername();
                displayUsername();
                authFormsContainer.style.display = 'none';
                chatInterfaceContainer.style.display = 'block';
                loadChatHistory();
            } else {
                authFormsContainer.style.display = 'block';
                chatInterfaceContainer.style.display = 'none';
                displayUsername();
            }
        }
        checkLoginStatus();


        // --- Quản lý lịch sử chat (CẬP NHẬT DANH SÁCH LỊCH SỬ - giữ nguyên logic) ---
        function loadChatHistory() {
            if (!currentUsername) return;

            const historyKeys = getHistorySessionKeys();
            if (historyKeys.length > 0) {
                const latestHistoryKey = historyKeys[historyKeys.length - 1];
                loadSpecificHistory(latestHistoryKey);
            } else {
                chatContainer.innerHTML = '';
                conversationHistory = [];
            }
            historyListContainer.classList.remove('active');
            menuDropdown.classList.remove('active');
        }


        function loadChatHistoryDropdown() {
            if (!currentUsername) return;

            historyListContainer.innerHTML = '';
            historySessions = [];

            const historyKeys = getHistorySessionKeys();

            if (historyKeys.length === 0) {
                const noHistoryMessage = document.createElement('button');
                noHistoryMessage.textContent = "Không có lịch sử đã lưu";
                noHistoryMessage.disabled = true;
                historyListContainer.appendChild(noHistoryMessage);
            } else {
                historyKeys.forEach((key, index) => {
                    const historyButton = document.createElement('button');
                    historyButton.textContent = `Lịch sử ${index + 1}`;
                    historyButton.onclick = function() {
                        loadSpecificHistory(key);
                        historyListContainer.classList.remove('active');
                    };
                    historyListContainer.appendChild(historyButton);
                    historySessions.push({ key: key, label: `Lịch sử ${index + 1}` });
                });
            }

            historyListContainer.classList.toggle('active');
            menuDropdown.classList.remove('active');
        }


        function loadSpecificHistory(historyKey) {
            const history = readFile(historyKey);
            if (history) {
                conversationHistory = history;
                chatContainer.innerHTML = '';
                conversationHistory.forEach(message => {
                    if (message.role === 'user') {
                        addUserMessageToUI(message.parts[0].text, 'user-message');
                    } else if (message.role === 'model') {
                        addAiMessageToUI(message.parts[0].text, 'ai-message');
                    }
                });
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }


        function saveChatHistory() { // LƯU LỊCH SỬ - Omega Update - gọi khi logout và new chat
            if (!currentUsername || conversationHistory.length === 0) return;

            const historyKeys = getHistorySessionKeys();
            const sessionIndex = historyKeys.length + 1;
            const historyFilePath = `user/${currentUsername}/history_${sessionIndex}.json`;
            writeFile(historyFilePath, conversationHistory);
        }


        function clearChatHistory() { // KHÔNG XÓA FILE HISTORY NỮA - Omega Update
            if (currentUsername) {
                conversationHistory = [];
                chatContainer.innerHTML = '';
            }
        }

        function startNewChatConfirmation() { // CONFIRMATION DIALOG CHO NEW CHAT - Omega Update
            const confirmNewChat = confirm("Bạn có chắc chắn muốn bắt đầu cuộc trò chuyện mới? Lịch sử chat hiện tại sẽ được lưu lại.");
            if (confirmNewChat) {
                saveChatHistory(); // LƯU LỊCH SỬ TRƯỚC KHI CLEAR - Omega Update
                startNewChat();
            }
        }

        function startNewChat() { // Hàm bắt đầu chat mới (clear chat UI và history array) - Omega Update
            clearChatHistory(); // Chỉ clear UI và history array, KHÔNG xóa file history
            menuDropdown.classList.remove('active');
            historyListContainer.classList.remove('active');
        }


        function downloadChatHistory() { // TẢI XUỐNG LỊCH SỬ CHAT - Omega Update
            if (conversationHistory.length === 0) {
                alert("Không có lịch sử chat để tải xuống.");
                return;
            }

            const historyText = conversationHistory.map(message => `${message.role.toUpperCase()}: ${message.parts[0].text}`).join('\n\n');
            const blob = new Blob([historyText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat_history_${currentUsername}_${new Date().toLocaleDateString()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            menuDropdown.classList.remove('active'); // Đóng menu sau khi tải
        }


        function getHistorySessionKeys() {
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(`user/${currentUsername}/history_`) && key.endsWith('.json')) {
                    keys.push(key);
                }
            }
            return keys.sort();
        }


        // --- Xử lý tải tệp (giữ nguyên, thêm feedback) ---
        fileUploadInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                let fileContent = event.target.result;
                sendMessage(fileContent);
                alert(`Tệp "${file.name}" đã tải lên thành công.`); // Feedback tải file thành công - Omega Update
            };
            reader.readAsText(file);
        });


        // --- Gửi và nhận tin nhắn (giữ nguyên) ---
        function sendMessage(userMessageFromFile = null) {
            if (!currentUsername) {
                alert("Bạn cần đăng nhập để sử dụng chatbot.");
                return;
            }

            let userMessage;
            if (userMessageFromFile) {
                userMessage = userMessageFromFile;
            } else {
                userMessage = promptInput.value;
                promptInput.value = '';
            }


            if (!userMessage && !userMessageFromFile) {
                return;
            }

            const apiKey = currentApiKey;


            addUserMessage(userMessage);
            showLoadingIndicator();

            const combinedPrompt = `${FIXED_PROMPT}\n\n${userMessage}`;

            sendToGeminiAPI(apiKey, combinedPrompt);
        }

        function addUserMessage(message) {
            addUserMessageToUI(message, 'user-message');
            conversationHistory.push({ role: "user", parts: [{ text: message }] });
            // saveChatHistory(); // Lưu lịch sử CHỈ khi bắt đầu chat mới hoặc đăng xuất
        }

        function addUserMessageToUI(message, className) {
            const messageDiv = document.createElement('div');
            messageDiv.className = className;
            messageDiv.textContent = message;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }


        function addAiMessage(message) {
            hideLoadingIndicator();
            addAiMessageToUI(message, 'ai-message');
            conversationHistory.push({ role: "model", parts: [{ text: message }] });
            // saveChatHistory(); // Lưu lịch sử CHỈ khi bắt đầu chat mới hoặc đăng xuất
        }

        function addAiMessageToUI(message, className) {
            const messageDiv = document.createElement('div');
            messageDiv.className = className;
            messageDiv.textContent = message;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // --- Hiển thị/Ẩn "Đang tải..." (giữ nguyên) ---
        function showLoadingIndicator() {
            if (!isLoading) {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'loading-message';
                loadingDiv.textContent = 'Đang tải...';
                loadingDiv.id = 'loading-temp-message';
                chatContainer.appendChild(loadingDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                isLoading = true;
            }
        }

        function hideLoadingIndicator() {
            const loadingMessage = document.getElementById('loading-temp-message');
            if (loadingMessage) {
                loadingMessage.remove();
                isLoading = false;
            }
        }


        async function sendToGeminiAPI(apiKey, prompt) {
            const apiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent';

            const requestBody = {
                contents: conversationHistory.concat([{ role: "user", parts: [{ text: prompt }] }])
            };

            try {
                const response = await fetch(`${apiUrl}?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    hideLoadingIndicator();
                    const errorData = await response.json();
                    console.error("API Error:", errorData);
                    let errorMessage = `Lỗi API: ${response.status}`;
                    if (errorData.error && errorData.error.message) {
                        errorMessage += ` - ${errorData.error.message}`;
                    } else {
                        errorMessage += ` - Không rõ lỗi. Vui lòng kiểm tra API Key và kết nối mạng.`;
                    }
                    addAiMessage(errorMessage);
                    return;
                }

                const data = await response.json();
                if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0].text) {
                    const aiResponse = data.candidates[0].content.parts[0].text;
                    addAiMessage(aiResponse);
                } else {
                    hideLoadingIndicator();
                    addAiMessage("Không nhận được phản hồi hợp lệ từ AI.");
                }

            } catch (error) {
                hideLoadingIndicator();
                console.error("Fetch error:", error);
                addAiMessage("Lỗi kết nối đến API. Vui lòng kiểm tra kết nối mạng của bạn.");
            }
        }
    </script>

</body>
</html>