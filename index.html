<!DOCTYPE html>
<html>
<head>
    <title>AI Chatbot - Gemini API</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        /* CSS Dark Mode hiện đại và Responsive - ChatGPT Interface Style - UPDATED Buttons & Layout */
        :root {
            --bg-color: #121212;
            --text-color: #f0f0f0;
            --primary-color: #64ffda;
            --secondary-bg: #1e1e1e;
            --border-color: #333;
            --message-user-bg: #3498db; /* User message color - ChatGPT like */
            --message-ai-bg: #4a5568;   /* AI message color - ChatGPT like */
            --button-bg: #3498db;
            --button-hover-bg: #2980b9;
            --menu-bg: #252525;
            --loading-color: #ffc107;
            --history-list-bg: #252525;
            --history-list-item-hover: #333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-top: 20px;
            margin-bottom: 20px;
            animation: fadeIn 1s ease-out;
        }


        .container {
            width: 98%;
            max-width: 1000px; /* Container max width wider */
            background-color: var(--secondary-bg);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            margin-bottom: 25px;
            animation: slideUp 0.8s ease-out;
            display: flex; /* Enable flex layout for container */
            flex-direction: column;
        }


        /* Menu danh mục (giữ nguyên) */
        .menu-container {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000; /* Đảm bảo menu luôn ở trên cùng */
        }

        .menu-button {
            padding: 12px 18px;
            border: none;
            border-radius: 8px;
            background-color: var(--button-bg);
            color: var(--text-color);
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.3s ease-in-out;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            outline: none;
            width: auto;
            height: auto;
        }

        .menu-button:hover {
            background-color: var(--button-hover-bg);
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.5);
        }


        .menu-dropdown { /* Dropdown menu hiệu ứng mạnh hơn */
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--menu-bg);
            border-radius: 10px;
            overflow: hidden;
            display: none;
            transform-origin: top right;
            transform: scaleY(0);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 8px 20px rgba(0,0,0,0.6);
            z-index: 999;
            width: 250px;
        }

        .menu-dropdown.active {
            display: block;
            transform: scaleY(1);
        }

        .menu-dropdown button {
            display: block;
            width: 100%;
            padding: 12px 22px;
            border: none;
            background-color: transparent;
            color: var(--text-color);
            text-align: left;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }

        .menu-dropdown button:hover {
            background-color: var(--history-list-item-hover);
        }


        /* Form đăng nhập/đăng ký (giữ nguyên) */
        .auth-container button {
            padding: 10px 18px;
            border: none;
            border-radius: 10px;
            background-color: var(--button-bg);
            color: var(--text-color);
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.3s ease-in-out;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            outline: none;
        }


        /* Chat container (EXPANDED HEIGHT, ChatGPT-like, FLEX for layout) */
        #chat-container {
            border: none;
            padding: 0;
            height: calc(100vh - 300px); /* Adjust for fixed input */
            overflow-y: scroll;
            margin-bottom: 15px;
            border-radius: 0;
            background-color: transparent;
            display: flex; /* Enable flex for chat container */
            flex-direction: column;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) transparent;
            position: relative;
            flex: 2; /* Chat container chiếm phần lớn không gian */
            min-height: 200px; /* Đảm bảo chiều cao tối thiểu */
        }


        /* Chrome, Safari and Opera */
        #chat-container::-webkit-scrollbar {
            width: 8px;
        }

        #chat-container::-webkit-scrollbar-track {
            background-color: transparent;
            border-radius: 0;
        }

        #chat-container::-webkit-scrollbar-thumb {
            background-color: var(--primary-color);
            border-radius: 10px;
        }

        .user-message, .ai-message, .loading-message {
            padding: 10px 15px;
            border-radius: 15px;
            margin-bottom: 8px;
            max-width: 90%;
            clear: both;
            word-wrap: break-word;
            animation: messageAppear 0.4s ease-out forwards;
            transform-origin: top;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
        }


        .user-message {
            background-color: var(--message-user-bg); /* User message color - ChatGPT like */
            color: var(--text-color);
            align-self: flex-end;
            text-align: right;
        }

        .ai-message {
            background-color: var(--message-ai-bg); /* AI message color - ChatGPT like */
            color: var(--text-color);
            align-self: flex-start;
            text-align: left;
        }

        .loading-message {
            background-color: transparent;
            color: var(--loading-color);
            align-self: flex-start;
            text-align: left;
            font-style: italic;
            animation: blinkLoading 1.5s infinite;
        }

        /* Code block style */
        .code-block {
            background-color: #282c34;
            color: #abb2bf;
            padding: 15px;
            border-radius: 10px;
            overflow-x: auto;
            position: relative;
        }

        /* Copy button style */
        .copy-button {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background-color: var(--button-bg);
            color: var(--text-color);
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }


        /* Input container (FULL WIDTH, ChatGPT-like, FLEX LAYOUT UPDATED) */
        #input-container {
            display: flex;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--secondary-bg);
            border-top: 1px solid var(--border-color);
            padding: 10px;
            align-items: center; /* Center items vertically */
            box-sizing: border-box; /* Ensure padding is included in the width */
            max-width: 1000px; /* Match container's max-width */
        }

        #upload-button { /* Nút Upload - Vuông, Bên trái, Nhỏ gọn */
            padding: 8px; /* Giảm padding nút upload */
            border-radius: 8px; /* Vuông bo tròn */
            margin-right: 10px; /* Khoảng cách với input */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            width: 35px; /* Kích thước nút vuông */
            height: 35px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2em; /* Icon upload lớn hơn chút */
            line-height: 0; /* Căn giữa icon dọc */
            background-color: var(--button-bg);
            color: var(--text-color);
            cursor: pointer;
        }


        #prompt-input { /* Input Full Width - Updated to accommodate buttons */
            flex-grow: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            background-color: transparent;
            color: var(--text-color);
            transition: border-color 0.3s;
            outline: none;
            margin-right: 10px; /* Khoảng cách giữa input và send button */
        }


        #send-button { /* Nút Gửi - Bên phải, ChatGPT-like */
            padding: 8px;
            border: none;
            background-color: var(--button-bg);
            color: var(--text-color);
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.3s ease-in-out;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            border-radius: 8px; /* Bo tròn nút send */
            margin-left: 0; /* Loại bỏ margin trái nút send */
            width: 35px;
            height: 35px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2em;
            line-height: 0;
        }


        /* Responsive adjustments - Mobile (ChatGPT-like) - UPDATED Input Layout */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                width: 98%;
            }


            #chat-container {
                height: calc(100vh - 250px);
                margin-bottom: 15px;
            }


            #input-container { /* Input container mobile - Updated to row, wrap */
                flex-direction: row;
                padding-top: 8px;
                flex-wrap: wrap; /* Cho phép các nút xuống hàng nếu không đủ chỗ */
            }


            #upload-button { /* Nút Upload Mobile - Căn chỉnh lại */
                margin-right: 8px; /* Giảm margin right nút upload mobile */
                margin-bottom: 8px; /* Thêm margin bottom nút upload mobile */
            }


            #prompt-input { /* Input Mobile - Chiếm full width trên mobile */
                flex-basis: 100%; /* Chiếm full width input mobile */
                margin-bottom: 8px; /* Thêm margin bottom input mobile */
                margin-right: 0; /* Loại bỏ margin right input mobile */
                border-radius: 8px; /* Bo tròn input mobile */
            }


            #send-button { /* Nút Send Mobile - Chiếm full width trên mobile */
                border-radius: 8px;
                width: 100%; /* Chiếm full width nút send mobile */
                margin-bottom: 0;
                margin-left: 0; /* Loại bỏ margin left nút send mobile */
            }

            .menu-button {
                font-size: 16px;
                padding: 10px 15px;
                border-radius: 8px;
            }
            .menu-dropdown button {
                padding: 10px 15px;
                font-size: 16px;
            }

            #prompt-input, #send-button, #upload-button {
                font-size: 15px;
            }

            .user-message, .ai-message, .loading-message {
                font-size: 15px;
                padding: 10px 12px;
                border-radius: 15px;
                margin-bottom: 6px;
            }
        }


        /* Danh sách lịch sử chat (giữ nguyên) */
        #history-list-container {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--history-list-bg);
            border-radius: 10px;
            overflow: hidden;
            display: none;
            max-height: 250px;
            overflow-y: scroll;
            box-shadow: 0 8px 20px rgba(0,0,0,0.6);
            z-index: 9;
        }

        #history-list-container.active {
            display: block;
        }

        #history-list-container button {
            display: block;
            width: 100%;
            padding: 12px 22px;
            border: none;
            background-color: transparent;
            color: var(--text-color);
            text-align: left;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative; /* Cần thiết cho nút xóa */
        }

        #history-list-container button:hover {
            background-color: var(--history-list-item-hover);
        }

        .history-delete-button { /* Nút Xóa Lịch Sử - Ba chấm */
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            padding: 5px 10px;
            border: none;
            background-color: transparent;
            color: #aaa;
            cursor: pointer;
            font-size: 1em;
            opacity: 0.6;
            transition: opacity 0.2s ease-in-out, color 0.2s ease-in-out;
        }

        .history-list-container button:hover .history-delete-button,
        .history-delete-button:hover {
            opacity: 1;
            color: #eee;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>AI Chatbot - Gemini API</h1>

        <div class="menu-container">
            <button class="menu-button" onclick="toggleMenu()">Danh mục</button>
            <div class="menu-dropdown" id="menuDropdown">
                <button onclick="startNewChatConfirmation()">Bắt đầu cuộc trò chuyện mới</button>
                <button id="loadHistoryButton" onclick="toggleHistoryDropdown()">Tải lại lịch sử</button>
                <button onclick="downloadChatHistory()">Tải xuống lịch sử chat</button>
                <button onclick="logoutUser()">Đăng xuất</button>

                <div id="history-list-container">
                    <!-- Danh sách lịch sử chat sẽ được tạo ở đây -->
                </div>
            </div>
        </div>

        <!-- Container đăng nhập/đăng ký (giữ nguyên) -->
        <div id="auth-forms-container">
            <div id="login-form" class="auth-container">
                <h2>Đăng nhập</h2>
                <label for="login-username">Tên người dùng:</label>
                <input type="text" id="login-username" placeholder="Nhập tên người dùng">
                <label for="login-password">Mật khẩu:</label>
                <input type="password" id="login-password" placeholder="Nhập mật khẩu">
                <button onclick="loginUser()">Đăng nhập</button>
                <div class="auth-switch">
                    <a href="#" onclick="showRegisterForm(); return false;">Chưa có tài khoản? Đăng ký ngay</a>
                </div>
            </div>

            <div id="register-form" class="auth-container" style="display: none;">
                <h2>Đăng ký</h2>
                <label for="register-username">Tên người dùng:</label>
                <input type="text" id="register-username" placeholder="Chọn tên người dùng">
                <label for="register-password">Mật khẩu:</label>
                <input type="password" id="register-password" placeholder="Chọn mật khẩu">
                <button onclick="registerUser()">Đăng ký</button>
                <div class="auth-switch">
                    <a href="#" onclick="showLoginForm(); return false;">Đã có tài khoản? Đăng nhập</a>
                </div>
            </div>
        </div>

        <!-- Hiển thị tên người dùng / thông báo đăng ký (giữ nguyên) -->
        <div id="username-display"></div>

        <!-- Container giao diện chat (ẩn khi chưa đăng nhập) -->
        <div id="chat-interface-container" style="display: none;">


            <div id="chat-container">
                <!-- Tin nhắn chat sẽ hiển thị ở đây -->

            </div>



            <div id="input-container">
                <button id="upload-button" onclick="document.getElementById('file-upload').click();">
                     <!-- Icon Upload - Inbox Tray -->
                </button>
                <input type="text" id="prompt-input" placeholder="Nhập tin nhắn..." onkeydown="if (event.keyCode == 13) { sendMessage(); return false; }">
                <button id="send-button" onclick="sendMessage()">➡</button>
                <input type="file" id="file-upload" style="display: none;" accept=".txt">
            </div>
        </div>
    </div>

    <script>
        // ... (JavaScript code - no changes needed from previous version) ...
        const chatContainer = document.getElementById('chat-container');
        const promptInput = document.getElementById('prompt-input');
        const usernameDisplay = document.getElementById('username-display');
        const chatInterfaceContainer = document.getElementById('chat-interface-container');
        const authFormsContainer = document.getElementById('auth-forms-container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginUsernameInput = document.getElementById('login-username');
        const loginPasswordInput = document.getElementById('login-password');
        const registerUsernameInput = document.getElementById('register-username');
        const registerPasswordInput = document.getElementById('register-password');
        const fileUploadInput = document.getElementById('file-upload');
        const menuDropdown = document.getElementById('menuDropdown');
        const historyListContainer = document.getElementById('history-list-container');
        const loadHistoryButton = document.getElementById('loadHistoryButton');


        let conversationHistory = [];
        let currentUsername = '';
        let isLoading = false;
        let historySessions = [];
        let historyDropdownActive = false;

        // API Key Gemini của bạn (CỐ ĐỊNH TRONG CODE)
        const GEMINI_API_KEY_DEFAULT = 'AIzaSyCl21Ku_prQnyMHFs_dJRL8-pgjg9hrc2w';
        let currentApiKey = GEMINI_API_KEY_DEFAULT;
        const FIXED_PROMPT = "Bạn là một trợ lý AI hữu ích, thông minh và luôn trả lời một cách chi tiết và chính xác. Hãy giúp người dùng giải quyết mọi vấn đề và cung cấp thông tin tốt nhất có thể.";
        const MODEL_NAME = "gemini-2.0-flash-exp";


        // --- Hàm hỗ trợ writeFile (mô phỏng lưu file) ---
        function writeFile(filepath, data) {
            localStorage.setItem(filepath, JSON.stringify(data));
        }

        // --- Hàm hỗ trợ readFile (mô phỏng đọc file) ---
        function readFile(filepath) {
            const data = localStorage.getItem(filepath);
            return data ? JSON.parse(data) : null;
        }


        // --- Menu Danh mục (giữ nguyên) ---
        function toggleMenu() {
            menuDropdown.classList.toggle('active');
            if (!menuDropdown.classList.contains('active')) {
              hideHistoryDropdown(); // Đóng lịch sử khi đóng menu
            }
        }

        window.addEventListener('click', function(event) {
            if (!event.target.matches('.menu-button')) {
                if (menuDropdown.classList.contains('active')) {
                  //  menuDropdown.classList.remove('active');
                }
            }


            if (event.target !== loadHistoryButton && !historyListContainer.contains(event.target) && historyDropdownActive) {
                hideHistoryDropdown();
                menuDropdown.classList.remove('active'); // Đóng menu nếu click ra ngoài lịch sử
            }
        });



        // --- Quản lý người dùng và đăng nhập/đăng ký (CẬP NHẬT LƯU FILE) ---
        function registerUser() {
            const username = registerUsernameInput.value.trim();
            const password = registerPasswordInput.value.trim();

            if (!username || !password) {
                alert("Vui lòng nhập tên người dùng và mật khẩu.");
                return;
            }

            // Mô phỏng đường dẫn file thông tin người dùng
            const userFilePath = `user/${username}/info.json`;

            if (readFile(userFilePath)) {
                alert("Tên người dùng đã tồn tại. Vui lòng chọn tên người dùng khác.");
                return;
            }

            // Lưu thông tin người dùng vào "file" info.json
            writeFile(userFilePath, { username: username, password: password });
            alert("Đăng ký thành công. Vui lòng đăng nhập.");
            showLoginForm();
        }


        function loginUser() {
            const username = loginUsernameInput.value.trim();
            const password = loginPasswordInput.value.trim();

            if (!username || !password) {
                alert("Vui lòng nhập tên người dùng và mật khẩu.");
                return;
            }

            const userFilePath = `user/${username}/info.json`;
            const userInfo = readFile(userFilePath);

            if (userInfo && userInfo.password === password) {
                currentUsername = username;
                saveUsername(username);
                displayUsername();
                authFormsContainer.style.display = 'none';
                chatInterfaceContainer.style.display = 'block';
                loadChatHistory();
            } else {
                alert("Đăng nhập thất bại. Tên người dùng hoặc mật khẩu không đúng.");
            }
        }

        function logoutUser() {
            currentUsername = '';
            localStorage.removeItem('geminiChatCurrentUsername');
            conversationHistory = [];
            chatContainer.innerHTML = '';
            chatInterfaceContainer.style.display = 'none';
            authFormsContainer.style.display = 'block';
            usernameDisplay.textContent = '';
            menuDropdown.classList.remove('active');
            hideHistoryDropdown();
            saveChatHistory(); // LƯU LỊCH SỬ KHI ĐĂNG XUẤT (Omega Update change)
        }


        function saveUsername(username) {
            localStorage.setItem('geminiChatCurrentUsername', username);
        }

        function getUsername() {
            return localStorage.getItem('geminiChatCurrentUsername') || '';
        }

        function displayUsername() {
            currentUsername = getUsername();
            if (currentUsername) {
                usernameDisplay.textContent = `Chào mừng, ${currentUsername}!`;
                usernameDisplay.className = '';
            } else {
                usernameDisplay.textContent = 'Bạn cần đăng ký và đăng nhập để sử dụng chatbot.';
                usernameDisplay.className = 'logged-out-message';
            }
        }

        function checkLoginStatus() {
            if (getUsername()) {
                currentUsername = getUsername();
                displayUsername();
                authFormsContainer.style.display = 'none';
                chatInterfaceContainer.style.display = 'block';
                loadChatHistory();
            } else {
                authFormsContainer.style.display = 'block';
                chatInterfaceContainer.style.display = 'none';
                displayUsername();
            }
        }
        checkLoginStatus();


        // --- Quản lý lịch sử chat (CẬP NHẬT DANH SÁCH LỊCH SỬ - giữ nguyên logic) ---
        function loadChatHistory() {
            if (!currentUsername) return;

            const historyKeys = getHistorySessionKeys();
            if (historyKeys.length > 0) {
                const latestHistoryKey = historyKeys[historyKeys.length - 1];
                loadSpecificHistory(latestHistoryKey);
            } else {
                chatContainer.innerHTML = '';
                conversationHistory = [];
            }
            hideHistoryDropdown();
            menuDropdown.classList.remove('active');
        }


        function toggleHistoryDropdown() {
            loadChatHistoryDropdown();
        }

        function hideHistoryDropdown() {
            historyListContainer.style.display = 'none';
            historyDropdownActive = false;
        }


        function loadChatHistoryDropdown() {
            if (!currentUsername) return;

            historyListContainer.innerHTML = '';
            historySessions = [];

            const historyKeys = getHistorySessionKeys();

            if (historyKeys.length === 0) {
                const noHistoryMessage = document.createElement('button');
                noHistoryMessage.textContent = "Không có lịch sử đã lưu";
                noHistoryMessage.disabled = true;
                historyListContainer.appendChild(noHistoryMessage);
            } else {
                historyKeys.forEach((key, index) => {
                    const historyButton = document.createElement('button');
                    historyButton.textContent = `Lịch sử ${index + 1}`;
                    historyButton.onclick = function() {
                        loadSpecificHistory(key);
                        hideHistoryDropdown();
                        menuDropdown.classList.remove('active');
                    };

                    const deleteButton = document.createElement('button'); // Nút xóa lịch sử
                    deleteButton.className = 'history-delete-button';
                    deleteButton.innerHTML = '⋯'; // Icon ba chấm dọc (Vertical ellipsis)
                    deleteButton.onclick = function(event) {
                        event.stopPropagation(); // Ngăn button lịch sử bị click
                        deleteChatHistory(key); // Gọi hàm xóa lịch sử
                    };


                    const historyItemContainer = document.createElement('div'); // Container cho item lịch sử và nút xóa
                    historyItemContainer.style.position = 'relative'; // Để định vị nút xóa tuyệt đối
                    historyItemContainer.appendChild(historyButton);
                    historyItemContainer.appendChild(deleteButton);


                    historyListContainer.appendChild(historyItemContainer); // Thêm container vào danh sách
                    historySessions.push({ key: key, label: `Lịch sử ${index + 1}` });
                });
            }

            historyListContainer.style.display = 'block';
            historyDropdownActive = true;
             menuDropdown.classList.add('active');
        }

        function deleteChatHistory(historyKey) { // Hàm xóa lịch sử chat
            const confirmDelete = confirm("Bạn có chắc chắn muốn xóa lịch sử chat này?");
            if (confirmDelete) {
                localStorage.removeItem(historyKey); // Xóa lịch sử từ localStorage
                loadChatHistoryDropdown(); // Tải lại danh sách lịch sử
                chatContainer.innerHTML = ''; // Xóa nội dung chat hiện tại nếu có
                conversationHistory = [];   // Xóa lịch sử conversation hiện tại
            }
        }


        function loadSpecificHistory(historyKey) {
           try {
                const history = readFile(historyKey);
                if (history) {
                    conversationHistory = history;
                    chatContainer.innerHTML = '';
                    conversationHistory.forEach(message => {
                        if (message.role === 'user') {
                            addUserMessageToUI(message.parts[0].text, 'user-message');
                        } else if (message.role === 'model') {
                            addAiMessageToUI(message.parts[0].text, 'ai-message');
                        }
                    });
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                } else {
                    console.warn(`Không tìm thấy lịch sử chat với key: ${historyKey}`);
                }
            } catch (error) {
                console.error("Lỗi khi tải lịch sử chat:", error);
                alert("Lỗi khi tải lịch sử chat. Vui lòng thử lại sau.");
            }
        }


       function saveChatHistory() {
            if (!currentUsername) return;

            const historyKeys = getHistorySessionKeys();
            let sessionIndex = historyKeys.length;
            let newHistoryKey = `user/${currentUsername}/history_${sessionIndex + 1}.json`;
            let existingKey = localStorage.getItem(newHistoryKey);

            if (existingKey) {

            } else {
                localStorage.setItem(newHistoryKey, JSON.stringify(conversationHistory));
                console.log("lưu thành công")
            }

            console.log(historyKeys)

        }




        function clearChatHistory() { // KHÔNG XÓA FILE HISTORY NỮA - Omega Update
            if (currentUsername) {
                conversationHistory = [];
                chatContainer.innerHTML = '';
            }
        }

        function startNewChatConfirmation() { // CONFIRMATION DIALOG CHO NEW CHAT - Omega Update
            const confirmNewChat = confirm("Bạn có chắc chắn muốn bắt đầu cuộc trò chuyện mới? Lịch sử chat hiện tại sẽ được lưu lại.");
            if (confirmNewChat) {
                saveChatHistory(); // LƯU LỊCH SỬ TRƯỚC KHI CLEAR - Omega Update
                startNewChat();
            }
        }

        function startNewChat() { // Hàm bắt đầu chat mới (clear chat UI và history array) - Omega Update
            clearChatHistory(); // Chỉ clear UI và history array, KHÔNG xóa file history
            menuDropdown.classList.remove('active');
            hideHistoryDropdown();
        }


        function downloadChatHistory() { // TẢI XUỐNG LỊCH SỬ CHAT - Omega Update
            if (conversationHistory.length === 0) {
                alert("Không có lịch sử chat để tải xuống.");
                return;
            }

            const historyText = conversationHistory.map(message => `${message.role.toUpperCase()}: ${message.parts[0].text}`).join('\n\n');
            const blob = new Blob([historyText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat_history_${currentUsername}_${new Date().toLocaleDateString()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            menuDropdown.classList.remove('active'); // Đóng menu sau khi tải
            hideHistoryDropdown();
        }


        function getHistorySessionKeys() {
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(`user/${currentUsername}/history_`) && key.endsWith('.json')) {
                    keys.push(key);
                }
            }
            return keys.sort();
        }


        // --- Xử lý tải tệp (giữ nguyên, thêm feedback) ---
        fileUploadInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                let fileContent = event.target.result;
                sendMessage(fileContent);
                alert(`Tệp "${file.name}" đã tải lên thành công.`); // Feedback tải file thành công - Omega Update
            };
            reader.readAsText(file);
        });


        // --- Gửi và nhận tin nhắn (giữ nguyên) ---
        function sendMessage(userMessageFromFile = null) {
            if (!currentUsername) {
                alert("Bạn cần đăng nhập để sử dụng chatbot.");
                return;
            }

            let userMessage;
            if (userMessageFromFile) {
                userMessage = userMessageFromFile;
            } else {
                userMessage = promptInput.value;
                promptInput.value = '';
            }


            if (!userMessage && !userMessageFromFile) {
                return;
            }

            const apiKey = currentApiKey;


            addUserMessage(userMessage);
            showLoadingIndicator();

            const combinedPrompt = `${FIXED_PROMPT}\n\n${userMessage}`;

            sendToGeminiAPI(apiKey, combinedPrompt);
        }

        function addUserMessage(message) {
            addUserMessageToUI(message, 'user-message');
            conversationHistory.push({ role: "user", parts: [{ text: message }] });
            // saveChatHistory(); // Lưu lịch sử CHỈ khi bắt đầu chat mới hoặc đăng xuất
        }

        function addUserMessageToUI(message, className) {
            const messageDiv = document.createElement('div');
            messageDiv.className = className;
            messageDiv.textContent = message;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }


        function addAiMessage(message) {
            hideLoadingIndicator();
            const isCode = message.startsWith("```") && message.endsWith("```");
            if (isCode) {
                addCodeMessageToUI(message);
            } else {
                addAiMessageToUI(message, 'ai-message');
            }

            conversationHistory.push({ role: "model", parts: [{ text: message }] });
            // saveChatHistory(); // Lưu lịch sử CHỈ khi bắt đầu chat mới hoặc đăng xuất
        }

         function addCodeMessageToUI(message) {
            const codeBlockDiv = document.createElement('div');
            codeBlockDiv.className = 'ai-message';
            codeBlockDiv.style.textAlign = 'left';

            // Tạo khung code
            const codeDiv = document.createElement('div');
            codeDiv.className = 'code-block';
            codeDiv.innerHTML = `<pre>${message.slice(3, -3)}</pre>`; // Loại bỏ ``` và hiển thị code


            // Tạo nút copy
            const copyButton = document.createElement('button');
            copyButton.className = 'copy-button';
            copyButton.textContent = 'Sao chép';
            copyButton.onclick = () => {
                navigator.clipboard.writeText(message.slice(3, -3)).then(() => {
                    alert('Đã sao chép code vào clipboard!');
                }).catch(err => {
                    console.error('Không thể sao chép code: ', err);
                });
            };

            codeDiv.appendChild(copyButton);
            codeBlockDiv.appendChild(codeDiv);
            chatContainer.appendChild(codeBlockDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addAiMessageToUI(message, className) {
            const messageDiv = document.createElement('div');
            messageDiv.className = className;
            messageDiv.textContent = message;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // --- Hiển thị/Ẩn "Đang tải..." (giữ nguyên) ---
        function showLoadingIndicator() {
            if (!isLoading) {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'loading-message';
                loadingDiv.textContent = 'Đang tải...';
                loadingDiv.id = 'loading-temp-message';
                chatContainer.appendChild(loadingDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                isLoading = true;
            }
        }

        function hideLoadingIndicator() {
            const loadingMessage = document.getElementById('loading-temp-message');
            if (loadingMessage) {
                loadingMessage.remove();
                isLoading = false;
            }
        }


        async function sendToGeminiAPI(apiKey, prompt) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent`;

            const requestBody = {
                contents: conversationHistory.concat([{ role: "user", parts: [{ text: prompt }] }])
            };

            try {
                const response = await fetch(`${apiUrl}?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    hideLoadingIndicator();
                    const errorData = await response.json();
                    console.error("API Error:", errorData);
                    let errorMessage = `Lỗi API: ${response.status}`;
                    if (errorData.error && errorData.error.message) {
                        errorMessage += ` - ${errorData.error.message}`;
                    } else {
                        errorMessage += ` - Không rõ lỗi. Vui lòng kiểm tra API Key và kết nối mạng.`;
                    }
                    addAiMessage(errorMessage);
                    return;
                }

                const data = await response.json();
                if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0].text) {
                    const aiResponse = data.candidates[0].content.parts[0].text;
                    addAiMessage(aiResponse);
                } else {
                    hideLoadingIndicator();
                    addAiMessage("Không nhận được phản hồi hợp lệ từ AI.");
                }

            } catch (error) {
                hideLoadingIndicator();
                console.error("Fetch error:", error);
                addAiMessage("Lỗi kết nối đến API. Vui lòng kiểm tra kết nối mạng của bạn.");
            }
        }
    </script>

</body>
</html>