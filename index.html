<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Hiện Đại với Gemini</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Arial:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        :root {
            --background-color: #1e2124;
            --container-background-color: #25272b;
            --text-color: #d1d5db;
            --message-user-background-color: #343541;
            --message-ai-background-color: #444654;
            --input-area-background-color: #343541;
            --input-text-background-color: #40414f;
            --button-primary-color: #00bcd4;
            --button-primary-hover-color: #0097a7;
            --sidebar-background-color: #252525;
            --sidebar-text-color: #fff;
            --modal-background-color: #343541;
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-touch-callout: none;
            -webkit-user-select: text;
            -khtml-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
            touch-action: manipulation;
            -webkit-text-size-adjust: 100%;
            font-size: 16px;
            overflow-y: scroll; /* Ensure scrollbar for very long content */
            scrollbar-width: thin; /* For Firefox */
            scrollbar-color: #444 #252525; /* For Firefox */
            transition: background-color 0.3s ease, color 0.3s ease; /* Global text and background transition */
            overscroll-behavior-y: none; /* Prevent pull-to-refresh on iOS */
        }

        /* Chrome, Safari and Opera scrollbar styling */
        body::-webkit-scrollbar {
            width: 8px;
        }

        body::-webkit-scrollbar-track {
            background: #252525;
        }

        body::-webkit-scrollbar::-webkit-scrollbar-thumb {
            background-color: #444;
            border-radius: 4px;
        }


        .container {
            width: 95%;
            max-width: 1200px;
            margin: 20px auto;
            padding: 30px; /* Increased padding */
            background-color: var(--container-background-color);
            border-radius: 24px; /* More rounded corners for container */
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.6); /* Deeper shadow, more modern */
            display: flex;
            flex-direction: column;
            height: calc(100vh - 40px); /* Adjusted height with margin */
            flex-grow: 1;
            margin-left: auto;
            transition: margin-left 0.3s ease, background-color 0.3s ease; /* Container background transition */
            border: none; /* Remove default border */
            padding-top: max(30px, env(safe-area-inset-top)); /* iOS safe area padding */
            padding-bottom: max(30px, env(safe-area-inset-bottom));
        }

        .container.sidebar-open {
            margin-left: 250px;
        }

        h1 {
            text-align: center;
            color: #fff;
            margin-bottom: 30px; /* Increased margin bottom for title */
            font-size: 2.8em; /* Slightly larger title */
            letter-spacing: -0.8px; /* Tighter letter spacing for modern look */
            padding-bottom: 25px;
            border-bottom: 1px solid #444; /* Thinner border */
            opacity: 0.95; /* Slightly less opaque text */
            font-weight: 500; /* Medium font weight */
            transition: color 0.3s ease;
        }

        #messages-container {
            flex-grow: 1;
            padding: 25px; /* Increased padding */
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            scrollbar-width: thin;
            scrollbar-color: #555 #252525;
            padding-bottom: 80px;
            border: none; /* Removed border */
            border-radius: 16px; /* Slightly less rounded message container */
            background-color: #1e2124; /* Consistent background */
             box-shadow: inset 0 3px 6px rgba(0, 0, 0, 0.4); /* Deeper inner shadow for depth */
             transition: background-color 0.3s ease; /* Messages container background transition */
             padding-top: 30px; /* Increased padding at top of messages */
        }

        #messages-container::-webkit-scrollbar {
            width: 8px;
        }

        #messages-container::-webkit-scrollbar::-webkit-scrollbar-track {
            background: #252525;
        }

        #messages-container::-webkit-scrollbar::-webkit-scrollbar-thumb {
            background-color: #555;
            border-radius: 4px;
        }

        .message {
            margin-bottom: 20px; /* Further Increased margin between messages */
            padding: 14px 20px; /* Adjusted padding */
            border-radius: 24px; /* Even More rounded message bubbles */
            clear: both;
            word-wrap: break-word;
            max-width: 85%; /* Increased max width for messages */
            display: inline-block;
             box-shadow: 0 2px 5px rgba(0, 0, 0, 0.25); /* More pronounced message shadow */
             transition: background-color 0.3s ease, color 0.3s ease, border-radius 0.3s ease; /* Message transitions - also borderRadius */
        }

        .user-message {
            background-color: var(--message-user-background-color);
            color: #fff;
            align-self: flex-end;
            float: right;
            border-top-right-radius: 8px; /* Slightly less rounded corners for user message */
            border-bottom-right-radius: 24px;
        }

        .ai-message {
            background-color: var(--message-ai-background-color);
            color: var(--text-color);
            align-self: flex-start;
            float: left;
            border-top-left-radius: 8px; /* Slightly less rounded corners for ai message */
            border-bottom-left-radius: 24px;
        }

        .ai-message .ai-message-text {
            font-family: 'Arial', sans-serif;
            font-weight: 400; /* Regular font weight */
            line-height: 1.8; /* Further improved line height */
            white-space: pre-line;
            font-size: 16px;
             transition: color 0.3s ease; /* AI message text color transition */
        }

        .markdown-bold-uppercase {
            font-weight: 600; /* Slightly bolder uppercase text */
            text-transform: uppercase;
            letter-spacing: 0.8px; /* Adjusted letter spacing */
            color: #f0f0f0; /* Slightly lighter color for emphasis */
            opacity: 1; /* Full opacity for emphasized text */
             transition: color 0.3s ease;
        }

        .input-area {
            padding: 16px 24px; /* Adjusted input area padding - more horizontal padding */
            background-color: var(--input-area-background-color);
            border-top: 1px solid #555; /* Thinner border */
            display: flex;
            align-items: center;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            box-sizing: border-box;
            padding-left: 20px;
            padding-right: 20px;
            z-index: 100;
            border-bottom-left-radius: 24px; /* More rounded input area */
            border-bottom-right-radius: 24px;
             border-top: 1px solid #444;
             transition: background-color 0.3s ease; /* Input area background transition */
             padding-bottom: max(16px, env(safe-area-inset-bottom)); /* iOS safe area padding */
        }

        .input-area textarea {
            flex-grow: 1;
            padding: 12px 16px; /* Adjusted textarea padding */
            border: none; /* Remove textarea border */
            border-radius: 16px; /* More rounded textarea */
            font-size: 16px;
            background-color: var(--input-text-background-color);
            color: #fff;
            resize: none;
            min-height: 42px; /* Slightly increased min-height */
            overflow-y: auto;
             box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.35); /* Deeper inner shadow for textarea */
             transition: background-color 0.3s ease, color 0.3s ease; /* Textarea background and text color transition */
        }

        .input-area textarea:focus {
            border-color: var(--button-primary-color);
            outline: none;
            box-shadow: 0 0 8px rgba(0, 188, 212, 0.7); /* More pronounced focus shadow */
        }

        .input-area button {
            padding: 14px 24px; /* Adjusted button padding */
            background-color: var(--button-primary-color);
            color: white;
            border: none;
            border-radius: 16px; /* Rounded button */
            cursor: pointer;
            font-size: 16px;
            margin-left: 16px; /* Increased button margin */
            transition: background-color 0.3s ease, transform 0.2s ease, border-radius 0.3s ease; /* Button transitions - also borderRadius */
        }

        .input-area button:hover {
            background-color: var(--button-primary-hover-color);
            transform: scale(1.03); /* Subtle scale up on hover */
        }

        .file-upload-button {
            background-color: #555;
            color: white;
            border: none;
            border-radius: 16px; /* Rounded file button */
            cursor: pointer;
            font-size: 1em;
            width: 44px; /* Slightly wider file button */
            height: 44px; /* Slightly taller file button */
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 16px; /* Increased margin */
            opacity: 0.9; /* Increased opacity */
            transition: opacity 0.3s ease, background-color 0.3s ease, transform 0.2s ease, border-radius 0.3s ease; /* File button transitions - also borderRadius */
        }

        .file-upload-button:hover {
            opacity: 1;
            background-color: #666;
             transform: scale(1.03); /* Subtle scale up on hover */
        }


        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            height: 100%;
            background-color: var(--sidebar-background-color);
            color: var(--sidebar-text-color);
            transform: translateX(-100%);
            transition: transform 0.3s ease, background-color 0.3s ease; /* Sidebar background transition */
            z-index: 200;
            padding-top: 70px; /* Increased sidebar top padding */
            box-shadow: 6px 0 12px rgba(0,0,0,0.4); /* More pronounced sidebar shadow */
            overflow-y: auto;
            touch-action: manipulation;
            border-right: 1px solid #444;
             backdrop-filter: blur(12px); /* Stronger frosted glass effect */
        }

        .sidebar.sidebar--open {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 28px 24px; /* Adjusted header padding */
            text-align: center;
            border-bottom: 1px solid #555; /* Thinner header border */
            margin-bottom: 30px;
            border-bottom: 1px solid #444;
            transition: background-color 0.3s ease, border-bottom-color 0.3s ease; /* Sidebar header background & border transition */
        }

        .sidebar-menu {
            padding: 0;
            list-style: none;
        }

        .sidebar-menu-item {
            padding: 18px 24px; /* Adjusted menu item padding */
            cursor: pointer;
            transition: background-color 0.2s ease, border-bottom-color 0.3s ease, color 0.3s ease, padding-left 0.2s ease; /* Menu item transitions - also padding-left */
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid transparent; /* Thinner bottom border on hover */
        }
         .sidebar-menu-item:active {
             background-color: #3a3b47; /* slightly darker on active click for feedback */
         }


        .sidebar-menu-item:hover {
            background-color: #343541;
             border-bottom-color: var(--button-primary-color);
             padding-left: 30px; /* Slightly indented on hover for visual feedback */
        }

        .sidebar-menu-item.has-submenu > .menu-link::after {
            content: '>';
            float: right;
            margin-left: 12px;
            font-size: 0.9em;
            display: inline-block;
            color: #aaa; /* Lighter submenu indicator */
        }

        .submenu {
            list-style: none;
            padding-left: 0;
            margin: 0;
            border-radius: 16px; /* Rounded submenu */
            overflow: hidden;
            box-shadow: 0 5px 10px rgba(0,0,0,0.45); /* Deeper submenu shadow */
            background-color: #2c2c2c;
            margin-top: 12px; /* Increased margin top */
            max-height: 0;
            opacity: 0;
            transition: max-height 0.4s ease-out, opacity 0.3s ease-out, background-color 0.3s ease, margin-top 0.3s ease; /* Submenu transitions and background transition & marginTop */
            overflow-y: hidden;
            padding-top: 0;
            padding-bottom: 0;
        }

        .submenu.open {
            display: block;
            max-height: 600px; /* Increased max-height for submenu */
            opacity: 1;
            overflow-y: auto;
            padding-top: 12px;
            padding-bottom: 16px;
            margin-top: 16px; /* increased marginTop when opened */
        }


        .submenu-item {
            padding: 16px 24px; /* Adjusted submenu item padding */
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.3s ease, padding-left 0.2s ease; /* Submenu item transitions - also padding-left */
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }
         .submenu-item:active {
             background-color: #3a3b47; /* slightly darker on active click for feedback */
         }


        .submenu-item:last-child {
            border-bottom: none;
        }


        .submenu-item:hover {
            background-color: #343541;
            padding-left: 30px; /* Indented on submenu item hover too */
        }

        .history-name {
            flex-grow: 1;
             transition: color 0.3s ease; /* History name text color transition */
             opacity: 0.9; /* slightly less opaque history names */
        }

        .delete-history-btn {
            background: transparent;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 1em;
            padding: 0 10px; /* Adjusted delete button padding */
            opacity: 0.7; /* Lower opacity initially */
            transition: opacity 0.2s ease, color 0.2s ease;
        }

        .delete-history-btn:hover {
            opacity: 1;
            color: #fff;
        }

        .sidebar-toggle-button {
            position: fixed;
            top: 30px; /* Adjusted toggle button position */
            left: 30px;
            background: var(--button-primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px; /* Slightly larger toggle button */
            height: 50px; /* Slightly larger toggle button */
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 300;
             box-shadow: 0 3px 6px rgba(0, 0, 0, 0.35); /* Added shadow to toggle button */
             transition: background-color 0.3s ease, transform 0.2s ease, border-radius 0.3s ease; /* Button transitions - also borderRadius */
        }

        .sidebar-toggle-button:hover {
            background-color: var(--button-primary-hover-color);
             transform: scale(1.05); /* Subtle scale up on hover */
        }
        .sidebar-toggle-button:active {
             transform: scale(0.98); /* subtle scale down on active click for feedback */
             opacity: 0.95; /* slight opacity reduction for feedback */
         }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Slightly darker overlay */
            z-index: 150;
            display: none;
            opacity: 0; /* Hidden initially */
            transition: opacity 0.3s ease, background-color 0.3s ease; /* Modal overlay transitions */

        }

        .sidebar-overlay.sidebar--open {
            display: block;
            opacity: 1; /* Fade in when sidebar opens */
        }

        .close-history-menu-btn, .close-settings-menu-btn, .modal-button {
            padding: 14px 24px; /* Adjusted close button padding */
            background-color: var(--button-primary-color);
            color: white;
            border: none;
            border-radius: 16px; /* Rounded close button */
            cursor: pointer;
            margin-top: 20px; /* Increased marginTop for close buttons */
            display: block;
            margin-left: auto;
            margin-right: auto;
            transition: background-color 0.3s ease, transform 0.2s ease, border-radius 0.3s ease; /* Close button transitions - also borderRadius */
        }

        .close-history-menu-btn:hover, .close-settings-menu-btn:hover, .modal-button.confirm:hover {
            background-color: var(--button-primary-hover-color);
             transform: scale(1.03); /* Subtle scale up on hover */
        }
         .close-history-menu-btn:active, .close-settings-menu-btn:active,  .modal-button.confirm:active {
             transform: scale(0.98); /* subtle scale down on active click for feedback */
             opacity: 0.95; /* slight opacity reduction for feedback */
         }


         .modal-button.cancel {
            background-color: #555;
            color: white;
        }

        .modal-button.cancel:hover {
            background-color: #666;
             transform: scale(1.03); /* Subtle scale up on hover */
        }
         .modal-button.cancel:active {
             transform: scale(0.98); /* subtle scale down on active click for feedback */
             opacity: 0.95; /* slight opacity reduction for feedback */
         }


        .custom-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Darker modal overlay */
            z-index: 400;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            opacity: 0; /* Hidden initially */
            transition: opacity 0.3s ease, background-color 0.3s ease; /* Modal overlay transitions */
            backdrop-filter: blur(10px); /* Apply blur to modal overlay */
        }

        .custom-modal-overlay.show-modal {
            display: flex;
            opacity: 1; /* Fade in when modal opens */
            pointer-events: auto;
        }


        .custom-modal {
            background-color: var(--modal-background-color);
            color: #fff;
            padding: 35px; /* Increased modal padding */
            border-radius: 24px; /* More rounded modal */
            box-shadow: 0 16px 32px rgba(0, 0, 0, 0.7); /* Deeper modal shadow */
            width: 85%; /* Slightly wider modal */
            max-width: 500px; /* Increased max width for modal */
            text-align: center;
            border: none; /* Remove default border */
            transform: scale(0.97); /* Start slightly smaller */
            opacity: 0; /* Hidden initially */
            transition: transform 0.3s ease, opacity 0.3s ease, background-color 0.3s ease, border-radius 0.3s ease; /* Modal transitions and background/borderRadius transition */
        }

        .custom-modal-overlay.show-modal .custom-modal {
            transform: scale(1); /* Scale up to normal size when visible */
            opacity: 1; /* Fade in when modal opens */
        }


        .modal-message {
            margin-bottom: 25px; /* Increased modal message margin */
            font-size: 1.2em; /* Slightly larger modal message font */
             transition: color 0.3s ease; /* Modal message text color transition */
             font-weight: 500; /* Medium font weight for modal message */
             opacity: 0.95;
        }

        .modal-input {
            width: calc(100% - 24px);
            padding: 14px 16px; /* Adjusted modal input padding */
            margin-bottom: 25px; /* Increased margin for modal input */
            border-radius: 12px;
            border: none; /* Remove modal input border */
            background-color: var(--input-text-background-color);
            color: #fff;
             box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.35); /* Deeper inner shadow for modal input */
             transition: background-color 0.3s ease, color 0.3s ease; /* Modal input background & text transition */
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 25px; /* Increased gap between modal buttons */
            margin-top: 10px; /* added margin to the modal buttons group */
        }

        .modal-button {
            padding: 14px 28px; /* Adjusted modal button padding */
            border: none;
            border-radius: 16px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease, transform 0.2s ease, border-radius 0.3s ease; /* Modal buttons transitions - also borderRadius */
            border: none; /* Remove modal button border */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.25); /* Add shadow to modal buttons */
        }

        code[class*="language-"],
        pre[class*="language-"] {
            color: black; /* Default code text color */
            background: white; /* White background for code blocks */
            position: relative;
            overflow-x: auto;      /* Scroll only Horizontally */
        }

       .copy-code-button {
            position: absolute;  /* Overlapping but INSIDE  the Padding area!*/
            top: 8px;      /* Slightly adjust from top and from Right */
            right: 8px;   /* Reduced size to fix on OLD displays */
            background-color: var(--copy-button-bg); /* Muted but slightly Dark */
            color: var(--copy-button-text-color);  /* Simple Standard*/
            border: none;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 0.85em;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s ease, background-color 0.2s ease;
        }
        .copy-code-button:hover { /* give better reaction/clue */
            opacity: 1;
            background-color: var(--button-primary-color);
        }
        /* Fix positioning for Copy but need PRE relative position first - Important Note Also keep AFTER so will always have greatest strength to apply.*/
        pre[class*="language-"] {
            position: relative;
        }

        /* Success Notification Styles */
        .copy-success-notification {
            position: fixed;
            bottom: 20px; /* Adjust as needed */
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50; /* Success green color, adjust as desired */
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            opacity: 0;
            visibility: hidden;
            z-index: 500;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .copy-success-notification.show {
            opacity: 1;
            visibility: visible;
        }


        /* Settings Styles */
        .setting-item {
            padding: 18px 24px; /* Adjusted setting-item padding */
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
             transition: background-color 0.3s ease, border-bottom-color 0.3s ease, padding-left 0.2s ease; /* Setting item transitions - also padding-left */
        }

        .setting-item:last-child {
            border-bottom: none;
        }
         .setting-item:active {
             background-color: #3a3b47; /* slightly darker on active click for feedback */
         }


        .setting-item:hover {
            background-color: #343541;
            padding-left: 30px; /* Indent settings items on hover too */
        }


        .setting-label {
            flex-grow: 1;
             transition: color 0.3s ease; /* Setting label text color transition */
             opacity: 0.9; /* slightly less opaque setting label */
             font-weight: 400; /* regular font weight for setting labels */
        }

        .setting-control {
            /* Style for controls like toggle or color picker */
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input[type="checkbox"] {
            opacity: 0;
            width: 0;
            height: 0;
                }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--button-primary-color);
        }

        input:focus + .slider {
            box-shadow: 0 0 1px var(--button-primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .color-picker-input {
            padding: 0;
            border: none;
            width: 30px;
            height: 24px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: transparent;
            cursor: pointer;
             transition: border-color 0.3s ease, box-shadow 0.3s ease; /* Color picker transitions */
        }
         .color-picker-input:hover, .color-picker-input:focus {
             border-color: var(--button-primary-color);
             box-shadow: 0 0 5px rgba(0, 188, 212, 0.5);
             outline: none;
         }


        .color-picker-input::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        .color-picker-input::-webkit-color-swatch {
            border: 1px solid #555;
            border-radius: 6px;
        }
        .color-picker-input::-moz-color-swatch-wrapper {
            padding: 0;
        }
        .color-picker-input::-moz-color-swatch {
            border: 1px solid #555;
            border-radius: 6px;
        }


    </style>

</head>
<body>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Lịch sử Chat & Cài đặt</h3>
        </div>
        <ul class="sidebar-menu">
            <li class="sidebar-menu-item" onclick="startNewChat()">
                <span class="menu-link">Đoạn chat mới</span>
            </li>
            <li class="sidebar-menu-item" onclick="openSaveHistoryModal()">
                <span class="menu-link">Lưu lịch sử này</span>
            </li>
            <li class="sidebar-menu-item has-submenu" onclick="toggleHistoryMenu()">
                <span class="menu-link">Lịch sử đã lưu</span>
                </li>
            <li class="sidebar-menu-item has-submenu" onclick="toggleSettingsMenu()">
                <span class="menu-link">Cài đặt</span>
            </li>
        </ul>

        <ul class="submenu" id="saved-histories-menu">
            <button class="close-history-menu-btn" onclick="toggleHistoryMenu()">Đóng</button>
        </ul>

        <ul class="submenu" id="settings-menu">
            <button class="close-settings-menu-btn" onclick="toggleSettingsMenu()">Đóng</button>
            <li class="setting-item">
                <span class="setting-label">Tự động lưu lịch sử</span>
                <span class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="autoSaveHistoryToggle">
                        <span class="slider"></span>
                    </label>
                </span>
            </li>
             <li class="setting-item">
                <span class="setting-label">Tên lịch sử là câu hỏi đầu</span>
                <span class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="useFirstMessageAsNameToggle">
                        <span class="slider"></span>
                    </label>
                </span>
            </li>
             <li class="setting-item">
                <span class="setting-label">Màu nền</span>
                <span class="setting-control">
                    <input type="color" id="backgroundColorPicker" class="color-picker-input" value="#1e2124">
                </span>
            </li>
             <li class="setting-item">
                <span class="setting-label">Màu chữ</span>
                <span class="setting-control">
                    <input type="color" id="textColorPicker" class="color-picker-input" value="#d1d5db">
                </span>
            </li>
             <li class="setting-item">
                <span class="setting-label">Màu nền hộp chat</span>
                <span class="setting-control">
                    <input type="color" id="containerColorPicker" class="color-picker-input" value="#25272b">
                </span>
            </li>
            <li class="setting-item" style="justify-content: center; border-bottom: none; padding-top: 25px;">
                <button class="modal-button confirm" onclick="saveSettingsAndApplyTheme()">Lưu cài đặt</button>
                <button class="modal-button cancel" onclick="resetTheme()">Hoàn tác</button>
            </li>
        </ul>


        <div class="custom-modal-overlay" id="saveHistoryModalOverlay">
            <div class="custom-modal">
                <p class="modal-message">Nhập tên cho lịch sử chat này:</p>
                <input type="text" id="historyNameInput" class="modal-input" placeholder="Tên lịch sử">
                <div class="modal-buttons">
                    <button class="modal-button confirm" onclick="saveHistoryWithInputName()">Lưu</button>
                    <button class="modal-button cancel" onclick="closeSaveHistoryModal()">Huỷ</button>
                </div>
            </div>
        </div>

         <div class="custom-modal-overlay" id="deleteHistoryModalOverlay">
            <div class="custom-modal">
                <p class="modal-message" id="deleteConfirmationMessage">Bạn có chắc chắn muốn xóa lịch sử chat "<span id="historyNameToDelete"></span>" không?</p>
                <div class="modal-buttons">
                    <button class="modal-button confirm" onclick="confirmDeleteHistory()">Xóa</button>
                    <button class="modal-button cancel" onclick="closeDeleteHistoryModal()">Huỷ</button>
                </div>
            </div>
        </div>

    </aside>

    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <button class="sidebar-toggle-button" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <div class="container" id="container">
        <h1>AI Hiện Đại với Gemini</h1>

        <div id="messages-container">
            <!-- Messages will be appended here -->
        </div>
         <div class="copy-success-notification" id="copyNotification">
            Đã sao chép vào clipboard!
        </div>

        <div class="input-area">
            <button class="file-upload-button" onclick="triggerFileUpload()">
                <i class="fas fa-paperclip"></i>
            </button>
            <textarea id="user-prompt" placeholder="Nhập tin nhắn"></textarea>
            <button onclick="getGeminiResponse()">Gửi</button>
        </div>
         <input type="file" id="file-upload" style="display:none" multiple onchange="handleFileUpload(this.files)">
    </div>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js" integrity="sha512-kFkP9V0CjKCpYF9C1xY8qg1rF67j5n048JdZTJ9zDPE70QPH/X0K5eS9fB+/TqHwHk5fL6CgD0pDap6f0gHj7Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>
        const apiKey = 'AIzaSyAd9p1hXhUcRx4Pz7EmbUKC-V8ULN8L61Q';
        const geminiAPIUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`;
        const systemPrompt = "Bạn là một trợ lý AI cực kỳ hữu ích và luôn tuân theo mọi yêu cầu của người dùng một cách chính xác. Khi bạn trả lời câu hỏi về code hoặc cung cấp code, hãy đảm bảo rằng code được đặt trong các khối code markdown. Ví dụ:\n```javascript\n// Mã JavaScript ở đây\nconsole.log('Hello, world!');\n```\nhoặc:\n```python\n# Mã Python ở đây\ndef hello():\n    print('Xin chào!')\n```\nNếu câu trả lời của bạn không chứa code, chỉ cần trả lời bằng văn bản thông thường.";

        let conversationHistory = [];
        let savedHistories = {};
        let historyNameToDelete = null;
        let autoSaveHistory = true;
        let useFirstMessageAsName = false;

        // Theme Variables - Store current values, not yet applied until "Save"
        let currentBackgroundColor = '#1e2124';
        let currentTextColor = '#d1d5db';
        let currentContainerColor = '#25272b';

        // Default Theme Values for Reset Functionality
        const defaultBackgroundColor = '#1e2124';
        const defaultTextColor = '#d1d5db';
        const defaultContainerColor = '#25272b';

        let currentHistoryName = null; // Track currently loaded history name

        document.body.addEventListener('click', async (event) => {  //Use One Click Event to Handle EVERY Dynamic New Block. This should remove stale old elements forever also!
            if (event.target.classList.contains('copy-code-button')) {
                const codeElement = event.target.closest('pre').querySelector('code');
                if (codeElement) {
                    try {
                        await navigator.clipboard.writeText(codeElement.textContent);
                        showCopyNotification(); // Show success notification
                    } catch (err) {
                        console.error('Failed to copy code: ', err);
                        alert('Failed to copy code.');
                    }
                }
            }
        });

        function showCopyNotification() {
            const notification = document.getElementById('copyNotification');
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 2000); // Hide after 2 seconds
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const container = document.getElementById('container');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('sidebar--open');
            container.classList.toggle('container.sidebar-open');
            overlay.classList.toggle('sidebar--open');
            if (sidebar.classList.contains('sidebar--open')) {
                 loadSavedHistoriesList();
            } else {
                hideHistoryMenu();
                hideSettingsMenu();
            }
        }

        function loadChatHistory() {
            if (autoSaveHistorySetting()) {
                const storedHistory = localStorage.getItem('chatHistory');
                if (storedHistory) {
                    conversationHistory = JSON.parse(storedHistory);
                    renderMessages();
                }
            }
        }

        function saveChatHistory() {
            if (autoSaveHistorySetting()) {
                localStorage.setItem('chatHistory', JSON.stringify(conversationHistory));
            }
        }

        function renderMessages() {
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = '';
            conversationHistory.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', message.role === 'user' ? 'user-message' : 'ai-message');
                let messageText = message.parts[0].text;
                if (message.role === 'ai') { //Now Handles Both to Add Code Button - Modern Design of Copying Function

                    //Recreate
                    messageDiv.innerHTML = `<span class="ai-message-text">${messageText}</span>`;

                    messageDiv.querySelectorAll('pre').forEach(codeBlock => {

                      let buttonExists =  codeBlock.querySelector('.copy-code-button') !== null

                         if(!buttonExists )
                            codeBlock.insertAdjacentHTML('beforeend', '<button class="copy-code-button"><i class="fas fa-copy"></i></button>'); // Add copy-code buttons (Now ALWAYS and all new renders from code added.

                        })
                }

                 else
                    messageDiv.innerHTML = messageText;


                messagesContainer.appendChild(messageDiv);
              //Prism.highlightAllUnder(messageDiv);  // remove highlight
            });

            messagesContainer.scrollTop = messagesContainer.scrollHeight;
          // Prism.highlightAll(); // remove highlight


        }


        function startNewChat() {
             if (currentHistoryName) { // If in a saved history, save before starting new
                savedHistories[currentHistoryName] = [...conversationHistory];
                localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
            }
            conversationHistory = [];
            saveChatHistory();
            renderMessages();
            currentHistoryName = null; // Reset current history name
            toggleSidebar();
        }


        function openSaveHistoryModal() {
            document.getElementById('saveHistoryModalOverlay').classList.add('show-modal');
            document.getElementById('historyNameInput').value = '';

            if (useFirstMessageAsNameSetting() && conversationHistory.length > 0 && conversationHistory[0].role === 'user') {
                document.getElementById('historyNameInput').value = conversationHistory[0].parts[0].text.substring(0, 50); // Use first message, limit length
            }
        }

        function closeSaveHistoryModal() {
            document.getElementById('saveHistoryModalOverlay').classList.remove('show-modal');
        }

        function saveHistoryWithInputName() {
            let historyName = document.getElementById('historyNameInput').value.trim();
            if (!historyName) {
                if (useFirstMessageAsNameSetting() && conversationHistory.length > 0 && conversationHistory[0].role === 'user') {
                    historyName = conversationHistory[0].parts[0].text.substring(0, 50) || 'No Title'; // Use first message as fallback, with 'No Title' if still empty
                } else {
                    alert("Vui lòng nhập tên cho lịch sử chat.");
                    return;
                }
            }

            savedHistories[historyName] = [...conversationHistory];
            localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
            alert(`Lịch sử chat đã được lưu với tên: ${historyName}`);
            loadSavedHistoriesList();
            closeSaveHistoryModal();
             currentHistoryName = historyName; // set current history name after save

        }

        function openDeleteHistoryModal(name) {
            historyNameToDelete = name;
            document.getElementById('historyNameToDelete').textContent = name;
            document.getElementById('deleteHistoryModalOverlay').classList.add('show-modal');
        }

        function closeDeleteHistoryModal() {
            document.getElementById('deleteHistoryModalOverlay').classList.remove('show-modal');
            historyNameToDelete = null;
        }

        function confirmDeleteHistory() {
            if (historyNameToDelete) {
                deleteSavedHistory(historyNameToDelete);
            }
            closeDeleteHistoryModal();
        }


        function deleteSavedHistory(historyName) {
            delete savedHistories[historyName];
            localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
            loadSavedHistoriesList();
            alert(`Lịch sử chat "${historyName}" đã bị xóa.`);
            if (currentHistoryName === historyName) { // if deleted history was the current one, reset
                currentHistoryName = null;
            }

        }


        function loadChatHistoryByName(historyName) {
            if (savedHistories[historyName]) {
                conversationHistory = [...savedHistories[historyName]];
                saveChatHistory();
                renderMessages();
                toggleHistoryMenu();
                toggleSidebar();
                currentHistoryName = historyName; // set current history name when loaded

            } else {
                alert("Không tìm thấy lịch sử chat đã lưu.");
            }
        }


        function toggleHistoryMenu() {
            const submenu = document.getElementById('saved-histories-menu');
            submenu.classList.toggle('open');
             hideSettingsMenu();
        }

        function hideHistoryMenu() {
            const submenu = document.getElementById('saved-histories-menu');
            submenu.classList.remove('open');
        }

        function toggleSettingsMenu() {
            const submenu = document.getElementById('settings-menu');
            submenu.classList.toggle('open');
            hideHistoryMenu();
        }
         function hideSettingsMenu() {
            const submenu = document.getElementById('settings-menu');
            submenu.classList.remove('open');
        }


        function loadSavedHistoriesList() {
            const historiesMenu = document.getElementById('saved-histories-menu');
            historiesMenu.innerHTML = '<button class="close-history-menu-btn" onclick="toggleHistoryMenu()">Đóng</button>';

            const storedSavedHistories = localStorage.getItem('savedHistories');
            if (storedSavedHistories) {
                savedHistories = JSON.parse(storedSavedHistories);
            } else {
                savedHistories = {};
            }

            if (Object.keys(savedHistories).length === 0) {
                const noHistoryItem = document.createElement('li');
                noHistoryItem.classList.add('submenu-item');
                noHistoryItem.textContent = "Chưa có lịch sử nào được lưu.";
                historiesMenu.appendChild(noHistoryItem);
                return;
            }

            for (const historyName in savedHistories) {
                const historyItem = document.createElement('li');
                historyItem.classList.add('submenu-item');

                const nameSpan = document.createElement('span');
                nameSpan.classList.add('history-name');
                nameSpan.textContent = historyName;
                nameSpan.onclick = () => loadChatHistoryByName(historyName);

                const deleteButton = document.createElement('button');
                deleteButton.classList.add('delete-history-btn');
                deleteButton.textContent = '...';
                deleteButton.onclick = (event) => {
                    event.stopPropagation();
                    openDeleteHistoryModal(historyName);
                };

                historyItem.appendChild(nameSpan);
                historyItem.appendChild(deleteButton);
                historiesMenu.appendChild(historyItem);
            }
        }


        loadChatHistory();
        loadSavedHistoriesList();
        loadSettings();
        applyTheme(); // Apply initial theme on load


        function triggerFileUpload() {
            document.getElementById('file-upload').click();
        }

        function handleFileUpload(files) {
            if (files && files.length > 0) {
                const messagesContainer = document.getElementById('messages-container');
                const aiMessageDiv = document.createElement('div');
                aiMessageDiv.classList.add('message', 'ai-message');
                aiMessageDiv.innerHTML = `<span class="ai-message-text">Đang tải tệp...</span>`;
                messagesContainer.appendChild(aiMessageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                let fileNames = Array.from(files).map(file => file.name).join(', ');
                const userMessage = `Tệp đã tải lên: ${fileNames}. Đang chờ AI xử lý...`;

                const userMessageDiv = document.createElement('div');
                userMessageDiv.classList.add('message', 'user-message');
                userMessageDiv.textContent = userMessage;
                messagesContainer.appendChild(userMessageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                const userMessageObject = { role: 'user', parts: [{ text: userMessage }] };
                conversationHistory.push(userMessageObject);
                saveChatHistory();
                renderMessages();

                // Simulate AI acknowledging the file (for UI purposes - actual file upload to Gemini needs server-side)
                setTimeout(() => {
                    aiMessageDiv.remove();

                    const aiResponseDiv = document.createElement('div');
                    aiResponseDiv.classList.add('message', 'ai-message');
                    aiResponseDiv.innerHTML = `<span class="ai-message-text">Đã nhận được tệp: ${fileNames}. Vui lòng cho biết bạn muốn AI làm gì với tệp này.</span>`;
                    messagesContainer.appendChild(aiResponseDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;

                     const aiMessageObject = { role: 'model', parts: [{ text: aiResponseDiv.innerHTML }] };
                    conversationHistory.push(aiMessageObject);
                    saveChatHistory();
                    renderMessages();

                }, 1500);
            }
        }


        async function getGeminiResponse() {
            const userPrompt = document.getElementById('user-prompt').value.trim();
            const messagesContainer = document.getElementById('messages-container');

            if (!userPrompt) {
                alert("Vui lòng nhập tin nhắn.");
                return;
            }

             if (currentHistoryName) { // if in a saved history, save history with new message immediately
                savedHistories[currentHistoryName] = [...conversationHistory, { role: 'user', parts: [{ text: userPrompt }] } ];
                localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
            }


            const userMessageObject = { role: 'user', parts: [{ text: userPrompt }] };
            conversationHistory.push(userMessageObject);
            saveChatHistory();
            renderMessages();
            document.getElementById('user-prompt').value = '';


            const aiMessageDiv = document.createElement('div');
            aiMessageDiv.classList.add('message', 'ai-message');
            aiMessageDiv.innerHTML = '<span class="ai-message-text">Đang suy nghĩ...</span>';
            messagesContainer.appendChild(aiMessageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            let promptContents = conversationHistory.map(message => ({
                role: message.role,
                parts: message.parts
            }));
            promptContents.unshift({ role: 'user', parts: [{ text: systemPrompt }] });


            const payload = {
                contents: promptContents
            };


            try {
                const response = await fetch(geminiAPIUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Lỗi API:", errorData);
                    aiMessageDiv.innerHTML = `<span class="ai-message-text">Lỗi API: ${response.status} - ${errorData.error.message || 'Không rõ nguyên nhân'}</span>`;
                    return;
                }

                const data = await response.json();
                console.log("Dữ liệu phản hồi từ API:", data);

                if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0].text) {
                    let aiResponseText = data.candidates[0].content.parts[0].text;
                    aiMessageDiv.innerHTML = '';
                    const aiTextContentSpan = document.createElement('span');
                    aiTextContentSpan.classList.add('ai-message-text');
                      //Insert Now from message data, using raw string (Not node, that breaks existing codes.)
                      messageDiv.innerHTML = `<span class="ai-message-text">${aiResponseText}</span>`;

                    const aiMessageObject = { role: 'model', parts: [{ text: messageDiv.innerHTML }] };//Only Save Html Code result for speed/clean.   NO need all prior parts ever.  Make SMALL JSON too

                    //Prism.highlightAllUnder(messageDiv); // remove highlight
                    conversationHistory.push(aiMessageObject);


                     if (currentHistoryName) { // If in saved history, update it with AI response
                        savedHistories[currentHistoryName] = [...conversationHistory];
                        localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
                    } else {
                         saveChatHistory(); // only save to 'chatHistory' if not a named saved history.
                    }


                   messagesContainer.appendChild(messageDiv);

                  // let scroll to  latest response:
                 messagesContainer.scrollTop = messagesContainer.scrollHeight;
                 }
                else
                   aiMessageDiv.innerHTML = `<span class="ai-message-text">Không nhận được phản hồi hợp lệ từ AI.</span>`;

             //Prism.highlightAll();// remove highlight


            } catch (error) {
                console.error("Lỗi fetch:", error);
                aiMessageDiv.innerHTML = `<span class="ai-message-text">Đã xảy ra lỗi khi kết nối đến API.</span>`;
            }

        }

        // Settings Functions
        function loadSettings() {
            const storedSettings = localStorage.getItem('chatSettings');
            if (storedSettings) {
                const settings = JSON.parse(storedSettings);
                autoSaveHistory = settings.autoSaveHistory !== undefined ? settings.autoSaveHistory : true;
                useFirstMessageAsName = settings.useFirstMessageAsName !== undefined ? settings.useFirstMessageAsName : false;
                currentBackgroundColor = settings.backgroundColor || defaultBackgroundColor;
                currentTextColor = settings.textColor || defaultTextColor;
                currentContainerColor = settings.containerColor || defaultContainerColor;


                document.getElementById('autoSaveHistoryToggle').checked = autoSaveHistory;
                document.getElementById('useFirstMessageAsNameToggle').checked = useFirstMessageAsName;
                document.getElementById('backgroundColorPicker').value = currentBackgroundColor;
                document.getElementById('textColorPicker').value = currentTextColor;
                document.getElementById('containerColorPicker').value = currentContainerColor;

            } else {
                 document.getElementById('autoSaveHistoryToggle').checked = true;
                 document.getElementById('useFirstMessageAsNameToggle').checked = false;
                 // Color pickers are already initialized to default values from HTML
                 currentBackgroundColor = defaultBackgroundColor;
                 currentTextColor = defaultTextColor;
                 currentContainerColor = defaultContainerColor;

            }

            document.getElementById('autoSaveHistoryToggle').addEventListener('change', function() {
                autoSaveHistory = this.checked;
                // Settings are only saved to localstorage on "Save" button click now.
            });
            document.getElementById('useFirstMessageAsNameToggle').addEventListener('change', function() {
                useFirstMessageAsName = this.checked;
                // Settings are only saved to localstorage on "Save" button click now.
            });
            document.getElementById('backgroundColorPicker').addEventListener('change', function() {
                currentBackgroundColor = this.value; // Update current value, but apply only on Save
            });
             document.getElementById('textColorPicker').addEventListener('change', function() {
                currentTextColor = this.value; // Update current value, but apply only on Save
            });
            document.getElementById('containerColorPicker').addEventListener('change', function() {
                currentContainerColor = this.value; // Update current value, but apply only on Save
            });
        }

        function saveSetting(key, value) {
            let settings = JSON.parse(localStorage.getItem('chatSettings')) || {};
            settings[key] = value;
            localStorage.setItem('chatSettings', JSON.stringify(settings));
        }

        function autoSaveHistorySetting() {
            return autoSaveHistory;
        }
        function useFirstMessageAsNameSetting() {
            return useFirstMessageAsName;
        }


        function applyTheme() {
            document.documentElement.style.setProperty('--background-color', currentBackgroundColor);
            document.documentElement.style.setProperty('--text-color', currentTextColor);
            document.documentElement.style.setProperty('--container-background-color', currentContainerColor);
        }

        function saveSettingsAndApplyTheme() {
            saveSetting('autoSaveHistory', autoSaveHistory);
            saveSetting('useFirstMessageAsName', useFirstMessageAsName);
            saveSetting('backgroundColor', currentBackgroundColor);
            saveSetting('textColor', currentTextColor);
            saveSetting('containerColor', currentContainerColor);
            applyTheme();
            toggleSettingsMenu();
            alert('Cài đặt đã được lưu và áp dụng!');
        }

        function resetTheme() {
            currentBackgroundColor = defaultBackgroundColor;
            currentTextColor = defaultTextColor;
            currentContainerColor = defaultContainerColor;

            document.getElementById('backgroundColorPicker').value = currentBackgroundColor;
            document.getElementById('textColorPicker').value = currentTextColor;
            document.getElementById('containerColorPicker').value = currentContainerColor;

            applyTheme();
            alert('Giao diện đã hoàn tác về mặc định. Nhấn "Lưu cài đặt" để lưu thay đổi.');
        }


     //Prism.highlightAll();// remove highlight

    </script>
</body>
</html>