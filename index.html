<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Hiện Đại với Gemini</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit: cover;">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Arial:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" />

    <style>
        :root {
            --background-color: #1e2124;
            --container-background-color: #25272b;
            --text-color: #d1d5db;
            --message-user-background-color: #343541;
            --message-ai-background-color: #444654;
            --input-area-background-color: #343541;
            --input-text-background-color: #40414f;
            --button-primary-color: #00bcd4;
            --button-primary-hover-color: #0097a7;
            --sidebar-background-color: #252525;
            --sidebar-text-color: #fff;
            --modal-background-color: #343541;
            --code-block-background: #282a36; /* Okaidia theme background */
            --code-block-text: #f8f8f2; /* Okaidia theme text */
            --code-block-comment: #6272a4; /* Okaidia theme comment */
            --code-block-keyword: #ff79c6; /* Okaidia theme keyword */
            --code-block-operator: #ffb86c; /* Okaidia theme operator */
            --code-block-punctuation: #f8f8f2; /* Okaidia theme punctuation */
            --code-block-string: #f1fa8c; /* Okaidia theme string */
            --code-block-number: #bd93f9; /* Okaidia theme number */
            --code-block-function: #50fa7b; /* Okaidia theme function */
            --code-block-class-name: #ffb86c; /* Okaidia theme class-name */
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-touch-callout: none;
            -webkit-user-select: text;
            -khtml-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
            touch-action: manipulation;
            -webkit-text-size-adjust: 100%;
            font-size: 16px;
            overflow-y: scroll;
            scrollbar-width: thin;
            scrollbar-color: #444 #252525;
            transition: background-color 0.3s ease, color 0.3s ease;
            overscroll-behavior-y: none;
        }

        body::-webkit-scrollbar {
            width: 8px;
        }

        body::-webkit-scrollbar-track {
            background: #252525;
        }

        body::-webkit-scrollbar::-webkit-scrollbar-thumb {
            background-color: #444;
            border-radius: 4px;
        }


        .container {
            width: 95%;
            max-width: 1400px;
            margin: 20px auto;
            padding: 30px;
            background-color: var(--container-background-color);
            border-radius: 24px;
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.6);
            display: flex;
            flex-direction: column;
            height: calc(100vh - 40px);
            flex-grow: 1;
            margin-left: auto;
            transition: margin-left 0.3s ease, background-color 0.3s ease;
            border: none;
            padding-top: max(30px, env(safe-area-inset-top));
            padding-bottom: max(30px, env(safe-area-inset-bottom));
        }

        .container.sidebar-open {
            margin-left: 250px;
        }

        h1 {
            text-align: center;
            color: #fff;
            margin-bottom: 30px;
            font-size: 2.8em;
            letter-spacing: -0.8px;
            padding-bottom: 25px;
            border-bottom: 1px solid #444;
            opacity: 0.95;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        #messages-container {
            flex-grow: 1;
            padding: 25px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            scrollbar-width: thin;
            scrollbar-color: #555 #252525;
            padding-bottom: 80px;
            border: none;
            border-radius: 16px;
            background-color: #1e2124;
             box-shadow: inset 0 3px 6px rgba(0, 0, 0, 0.4);
             transition: background-color 0.3s ease;
             padding-top: 30px;
        }

        #messages-container::-webkit-scrollbar {
            width: 8px;
        }

        #messages-container::-webkit-scrollbar::-webkit-scrollbar-track {
            background: #252525;
        }

        #messages-container::-webkit-scrollbar::-webkit-scrollbar-thumb {
            background-color: #555;
            border-radius: 4px;
        }

        .message {
            margin-bottom: 18px; /* Reduced margin-bottom for message spacing */
            padding: 14px 20px;
            border-radius: 18px; /* Slightly less rounded */
            clear: both;
            word-wrap: break-word;
            max-width: 95%;
            display: inline-block;
             box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2); /* Reduced shadow */
             transition: background-color 0.3s ease, color 0.3s ease, border-radius 0.3s ease;
             font-size: 0.95em; /* Slightly smaller message text */
             line-height: 1.6; /* Adjusted line height for better readability */
             border: 1px solid #444; /* Added border as in vip1.html */
        }

        .user-message {
            background-color: #343541;
            color: #fff;
            align-self: flex-end;
            float: right;
            border-top-right-radius: 3px; /* As in vip1.html */
            border-bottom-right-radius: 18px; /* Match general message borderRadius */
            border-bottom-left-radius: 18px; /* Gemini-like borderRadius */
        }

        .ai-message {
            background-color: #444654;
            color: var(--text-color);
            align-self: flex-start;
            float: left;
            border-top-left-radius: 3px; /* As in vip1.html */
            border-bottom-left-radius: 18px; /* Match general message borderRadius */
            border-bottom-right-radius: 18px; /* Gemini-like borderRadius */
        }

        .ai-message .ai-message-text {
            font-family: 'Arial', sans-serif;
            font-weight: 400;
            line-height: 1.7; /* Adjusted line-height */
            white-space: pre-line;
            font-size: 1em;
             transition: color 0.3s ease;
        }

        .markdown-bold-uppercase {
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: #f0f0f0;
            opacity: 1;
             transition: color 0.3s ease;
        }

        .input-area {
            padding: 14px 24px; /* Slightly reduced vertical padding */
            background-color: var(--input-area-background-color);
            border-top: 1px solid #555;
            display: flex;
            align-items: center;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            box-sizing: border-box;
            padding-left: 20px;
            padding-right: 20px;
            z-index: 100;
            border-bottom-left-radius: 24px;
            border-bottom-right-radius: 24px;
             border-top: 1px solid #444;
             transition: background-color 0.3s ease;
             padding-bottom: max(14px, env(safe-area-inset-bottom)); /* Slightly reduced bottom padding */
        }

        .input-area textarea {
            flex-grow: 1;
            padding: 10px 14px; /* Slightly reduced padding */
            border: 1px solid #555; /* Added border as in vip1.html */
            border-radius: 8px; /* As in vip1.html */
            font-size: 1em;
            background-color: var(--input-text-background-color);
            color: #fff;
            resize: none;
            min-height: 40px; /* Slightly smaller input height */
            overflow-y: auto;
             box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.25); /* Reduced shadow */
             transition: background-color 0.3s ease, color 0.3s ease;
        }

        .input-area textarea:focus {
            border-color: var(--button-primary-color);
            outline: none;
            box-shadow: 0 0 6px rgba(0, 188, 212, 0.6); /* Reduced focus shadow */
        }

        .input-area button {
            padding: 12px 22px; /* Slightly reduced padding */
            background-color: var(--button-primary-color);
            color: white;
            border: none;
            border-radius: 8px; /* As in vip1.html */
            cursor: pointer;
            font-size: 1em;
            margin-left: 14px; /* Slightly reduced margin */
            transition: background-color 0.3s ease, transform 0.2s ease, border-radius 0.3s ease;
             box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2); /* Added button shadow */
             border: 1px solid #444; /* Added border as in vip1.html */
        }

        .input-area button:hover {
            background-color: var(--button-primary-hover-color);
            transform: scale(1.02); /* Reduced scale on hover */
             box-shadow: 0 2px 4px rgba(0, 0, 0, 0.25); /* Slightly increased shadow on hover */
        }

        .file-upload-button {
            background-color: #555;
            color: white;
            border: none;
            border-radius: 14px; /* Slightly less rounded file button */
            cursor: pointer;
            font-size: 1em;
            width: 42px; /* Slightly smaller file button */
            height: 42px; /* Slightly smaller file button */
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 14px; /* Slightly reduced margin */
            opacity: 0.9;
            transition: opacity 0.3s ease, background-color 0.3s ease, transform 0.2s ease, border-radius 0.3s ease;
             box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2); /* Added file button shadow */
        }

        .file-upload-button:hover {
            opacity: 1;
            background-color: #666;
             transform: scale(1.02); /* Reduced scale on hover */
              box-shadow: 0 2px 4px rgba(0, 0, 0, 0.25); /* Slightly increased shadow on hover */
        }


        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            height: 100%;
            background-color: var(--sidebar-background-color);
            color: var(--sidebar-text-color);
            transform: translateX(-100%);
            transition: transform 0.3s ease, background-color 0.3s ease;
            z-index: 200;
            padding-top: 60px; /* Adjusted sidebar padding top to be like vip1.html */
            box-shadow: 2px 0 5px rgba(0,0,0,0.2); /* Adjusted sidebar shadow to be like vip1.html */
            overflow-y: auto;
            touch-action: manipulation;
            border-right: 1px solid #444;
             backdrop-filter: blur(12px);
        }

        .sidebar.sidebar--open {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 20px; /* Adjusted sidebar header padding to be like vip1.html */
            text-align: center;
            border-bottom: 1px solid #555;
            margin-bottom: 20px; /* Adjusted sidebar header margin bottom to be like vip1.html */
            border-bottom: 1px solid #444;
            transition: background-color 0.3s ease, border-bottom-color 0.3s ease;
        }

        .sidebar-menu {
            padding: 0;
            list-style: none;
        }

        .sidebar-menu-item {
            padding: 15px 20px; /* Adjusted sidebar menu item padding to be like vip1.html */
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid transparent;
            transition: border-bottom-color 0.3s ease;
            font-size: 1em; /* Adjusted sidebar font size to be like vip1.html */
        }
         .sidebar-menu-item:active {
             background-color: #3a3b47;
         }


        .sidebar-menu-item:hover {
            background-color: #343541;
             border-bottom-color: var(--button-primary-color);
        }

        .sidebar-menu-item.has-submenu > .menu-link::after {
            content: '>';
            float: right;
            margin-left: 10px; /* Adjusted sidebar submenu arrow margin to be like vip1.html */
            font-size: 0.8em; /* Adjusted sidebar submenu arrow font size to be like vip1.html */
            display: inline-block;
            color: #aaa; /* Keep color for arrow */
        }

        .submenu {
            list-style: none;
            padding-left: 0;
            margin: 0;
            border-radius: 8px; /* As in vip1.html */
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); /* Adjusted submenu shadow to be like vip1.html */
            background-color: #2c2c2c;
            margin-top: 5px; /* Adjusted submenu margin top to be like vip1.html */
            max-height: 0;
            opacity: 0;
            transition: max-height 0.3s ease-out, opacity 0.2s ease-out;
            overflow-y: hidden;
            padding-top: 0;
            padding-bottom: 0;
        }

        .submenu.open {
            display: block;
            max-height: 500px; /* Adjusted submenu max height to be like vip1.html */
            opacity: 1;
            overflow-y: auto;
            padding-top: 5px; /* Adjusted submenu padding top to be like vip1.html */
            padding-bottom: 10px; /* Adjusted submenu padding bottom to be like vip1.html */
            margin-top: 5px; /* Adjusted submenu margin top when open to be like vip1.html */
        }


        .submenu-item {
            padding: 12px 20px; /* Adjusted submenu item padding to be like vip1.html */
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
            font-size: 1em; /* Adjusted submenu font size to be like vip1.html */
        }
         .submenu-item:active {
             background-color: #3a3b47;
         }


        .submenu-item:last-child {
            border-bottom: none;
        }


        .submenu-item:hover {
            background-color: #343541;
        }

        .history-name {
            flex-grow: 1;
             transition: color 0.3s ease;
             opacity: 0.9;
        }

        .delete-history-btn {
            background: transparent;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 1em;
            padding: 0 8px; /* Adjusted delete button padding to be like vip1.html */
            opacity: 0.7;
            transition: opacity 0.2s ease, color 0.2s ease;
        }

        .delete-history-btn:hover {
            opacity: 1;
            color: #fff;
        }

        .sidebar-toggle-button {
            position: fixed;
            top: 20px; /* Adjusted sidebar toggle button top to be like vip1.html */
            left: 20px; /* Adjusted sidebar toggle button left to be like vip1.html */
            background: var(--button-primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px; /* Adjusted sidebar toggle button width to be like vip1.html */
            height: 40px; /* Adjusted sidebar toggle button height to be like vip1.html */
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 300;
             box-shadow: 0 0px 0px rgba(0, 0, 0, 0.3); /* Removed toggle button shadow for vip1.html like appearance */
             transition: background-color 0.3s ease, transform 0.2s ease, border-radius 0.3s ease;
        }

        .sidebar-toggle-button:hover {
            background-color: var(--button-primary-hover-color);
        }
        .sidebar-toggle-button:active {
             transform: scale(0.98);
             opacity: 0.95;
         }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* Adjusted sidebar overlay background to be like vip1.html */
            z-index: 150;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease, background-color 0.3s ease;

        }

        .sidebar-overlay.sidebar--open {
            display: block;
            opacity: 1; /* Make sure overlay is visible when sidebar is open */
        }

        .close-history-menu-btn, .close-settings-menu-btn, .modal-button {
            padding: 10px 15px; /* Adjusted modal button padding to be like vip1.html */
            background-color: var(--button-primary-color);
            color: white;
            border: none;
            border-radius: 8px; /* Adjusted modal button border radius to be like vip1.html */
            cursor: pointer;
            margin-top: 10px; /* Adjusted modal button margin top to be like vip1.html */
            display: block;
            margin-left: auto;
            margin-right: auto;
            transition: background-color 0.3s ease, transform 0.2s ease, border-radius 0.3s ease;
             box-shadow: 0 0px 0px rgba(0, 0, 0, 0.2); /* Removed modal button shadow for vip1.html like appearance */
             border: 1px solid #444; /* Added border for modal buttons like in vip1.html */
             font-size: 1em; /* Adjusted modal button font size to be like vip1.html */
        }

        .close-history-menu-btn:hover, .close-settings-menu-btn:hover, .modal-button.confirm:hover {
            background-color: var(--button-primary-hover-color);
        }
         .close-history-menu-btn:active, .close-settings-menu-btn:active,  .modal-button.confirm:active {
             transform: scale(0.98);
             opacity: 0.95;
         }


         .modal-button.cancel {
            background-color: #555;
            color: white;
        }

        .modal-button.cancel:hover {
            background-color: #666;
        }
         .modal-button.cancel:active {
             transform: scale(0.98);
             opacity: 0.95;
         }


        .custom-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Adjusted modal overlay background to be like vip1.html */
            z-index: 400;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease, background-color 0.3s ease;
            backdrop-filter: blur(10px); /* Kept blur effect as it was in vip4, if you don't want, remove this line */
        }

        .custom-modal-overlay.show-modal {
            display: flex;
            opacity: 1;
            pointer-events: auto;
        }


        .custom-modal {
            background-color: #343541;
            color: #fff;
            padding: 20px; /* Adjusted modal padding to be like vip1.html */
            border-radius: 10px; /* Adjusted modal border radius to be like vip1.html */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5); /* Adjusted modal shadow to be like vip1.html */
            width: 80%;
            max-width: 400px; /* Adjusted modal max width to be like vip1.html */
            text-align: center;
            border: 1px solid #444; /* Added border for modal as in vip1.html */
            transform: scale(0.97);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease, background-color 0.3s ease, border-radius 0.3s ease;
        }

        .custom-modal-overlay.show-modal .custom-modal {
            transform: scale(1);
            opacity: 1;
        }


        .modal-message {
            margin-bottom: 15px; /* Adjusted modal message margin bottom to be like vip1.html */
            font-size: 1em; /* Adjusted modal message font size to be like vip1.html */
             transition: color 0.3s ease;
             font-weight: normal; /* Removed strong font weight for vip1.html like appearance */
             opacity: 1; /* Reset opacity if it was changed before */
        }

        .modal-input {
            width: calc(100% - 20px); /* Adjusted modal input width based on padding */
            padding: 10px; /* Adjusted modal input padding to be like vip1.html */
            margin-bottom: 15px; /* Adjusted modal input margin bottom to be like vip1.html */
            border-radius: 8px; /* Adjusted modal input border radius to be like vip1.html */
            border: 1px solid #555; /* Added border for modal input as in vip1.html */
            background-color: var(--input-text-background-color);
            color: #fff;
             box-shadow: none; /* Removed input shadow to match vip1.html style */
             transition: background-color 0.3s ease, color 0.3s ease;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px; /* Adjusted modal button gap to be like vip1.html */
            margin-top: 0px; /* Adjusted modal button margin top to be like vip1.html */
        }

        .modal-button {
            padding: 10px 20px; /* Adjusted modal buttons padding to be like vip1.html */
            border: none;
            border-radius: 8px; /* Adjusted modal buttons border radius to be like vip1.html */
            cursor: pointer;
            font-size: 1em; /* Adjusted modal buttons font size to be like vip1.html */
            transition: background-color 0.3s ease, transform 0.2s ease, border-radius 0.3s ease;
            border: 1px solid #444; /* Added border to modal buttons as in vip1.html */
            box-shadow: none; /* Removed modal button shadow to match vip1.html style */
        }

        code[class*="language-"],
        pre[class*="language-"] {
            color: #f8f8f2;
            background: #272822;
            position: relative; /* for download link positioning */
            overflow-x: auto;
             padding: 1em;
             border-radius: 8px;
             margin-bottom: 18px;
             z-index: 1;
        }

       .copy-code-button {
            position: absolute; /* Changed to absolute */
            top: 0.5em;  /* Position from top */
            right: 0.5em; /* Position from right */
            background-color: #ddd;
            color: black;
            border: 1px solid #bbb;
            border-radius: 6px;
            padding: 5px 8px;
            font-size: 0.75em;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s ease, background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
            z-index: 2;
        }
        .copy-code-button:hover {
            opacity: 1;
            background-color: var(--button-primary-color);
            color: white;
            border-color:  var(--button-primary-color);
        }
        pre[class*="language-"] {
            position: relative;
            z-index: 0;
        }

        /* Success Notification Styles - not used in vip1.html style code block*/
        .copy-success-notification {
            display: none; /* hide success notification for vip1.html style code block */
        }


        /* Settings Styles - kept as is */
        .setting-item .toggle-switch .slider {
            background-color: #ccc;
        }
        .setting-item .toggle-switch input:checked + .slider {
            background-color: var(--button-primary-color);
        }


    </style>

</head>
<body>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Lịch sử Chat & Cài đặt</h3>
        </div>
        <ul class="sidebar-menu">
            <li class="sidebar-menu-item" onclick="startNewChat()">
                <span class="menu-link">Đoạn chat mới</span>
            </li>
            <li class="sidebar-menu-item" onclick="openSaveHistoryModal()">
                <span class="menu-link">Lưu lịch sử này</span>
            </li>
            <li class="sidebar-menu-item has-submenu" onclick="toggleHistoryMenu()">
                <span class="menu-link">Lịch sử đã lưu</span>
                </li>
            <li class="sidebar-menu-item has-submenu" onclick="toggleSettingsMenu()">
                <span class="menu-link">Cài đặt</span>
                </li>
        </ul>

        <ul class="submenu" id="saved-histories-menu">
            <button class="close-history-menu-btn" onclick="toggleHistoryMenu()">Đóng</button>
        </ul>

        <ul class="submenu" id="settings-menu">
            <button class="close-settings-menu-btn" onclick="toggleSettingsMenu()">Đóng</button>
            <li class="setting-item">
                <span class="setting-label">Tự động lưu lịch sử</span>
                <span class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="autoSaveHistoryToggle">
                        <span class="slider"></span>
                    </label>
                </span>
            </li>
             <li class="setting-item">
                <span class="setting-label">Tên lịch sử là câu hỏi đầu</span>
                <span class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="useFirstMessageAsNameToggle">
                        <span class="slider"></span>
                    </label>
                </span>
            </li>
             <li class="setting-item">
                <span class="setting-label">Màu nền</span>
                <span class="setting-control">
                    <input type="color" id="backgroundColorPicker" class="color-picker-input" value="#1e2124">
                </span>
            </li>
             <li class="setting-item">
                <span class="setting-label">Màu chữ</span>
                <span class="setting-control">
                    <input type="color" id="textColorPicker" class="color-picker-input" value="#d1d5db">
                </span>
            </li>
             <li class="setting-item">
                <span class="setting-label">Màu nền hộp chat</span>
                <span class="setting-control">
                    <input type="color" id="containerColorPicker" class="color-picker-input" value="#25272b">
                </span>
            </li>
            <li class="setting-item" style="justify-content: center; border-bottom: none; padding-top: 25px;">
                <button class="modal-button confirm" onclick="saveSettingsAndApplyTheme()">Lưu cài đặt</button>
                <button class="modal-button cancel" onclick="resetTheme()">Hoàn tác</button>
            </li>
        </ul>


        <div class="custom-modal-overlay" id="saveHistoryModalOverlay">
            <div class="custom-modal">
                <p class="modal-message">Nhập tên cho lịch sử chat này:</p>
                <input type="text" id="historyNameInput" class="modal-input" placeholder="Tên lịch sử">
                <div class="modal-buttons">
                    <button class="modal-button confirm" onclick="saveHistoryWithInputName()">Lưu</button>
                    <button class="modal-button cancel" onclick="closeSaveHistoryModal()">Huỷ</button>
                </div>
            </div>
        </div>

         <div class="custom-modal-overlay" id="deleteHistoryModalOverlay">
            <div class="custom-modal">
                <p class="modal-message" id="deleteConfirmationMessage">Bạn có chắc chắn muốn xóa lịch sử chat "<span id="historyNameToDelete"></span>" không?</p>
                <div class="modal-buttons">
                    <button class="modal-button confirm" onclick="confirmDeleteHistory()">Xóa</button>
                    <button class="modal-button cancel" onclick="closeDeleteHistoryModal()">Huỷ</button>
                </div>
            </div>
        </div>

    </aside>

    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <button class="sidebar-toggle-button" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <div class="container" id="container">
        <h1>AI Hiện Đại với Gemini</h1>

        <div id="messages-container">
            <!-- Messages will be appended here -->
        </div>
         <div class="copy-success-notification" id="copyNotification">
            Đã sao chép vào clipboard!
        </div>

        <div class="input-area">
            <button class="file-upload-button" onclick="triggerFileUpload()">
                <i class="fas fa-paperclip"></i>
            </button>
            <textarea id="user-prompt" placeholder="Nhập tin nhắn"></textarea>
            <button onclick="getGeminiResponse()">Gửi</button>
        </div>
         <input type="file" id="file-upload" style="display:none" multiple onchange="handleFileUpload(this.files)">
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
    <script>
        const apiKey = 'AIzaSyAd9p1hXhUcRx4Pz7EmbUKC-V8ULN8L61Q';
        const geminiAPIUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`;
        const systemPrompt = "Bạn là một trợ lý AI cực kỳ hữu ích và luôn tuân theo mọi yêu cầu của người dùng một cách chính xác. Khi bạn trả lời câu hỏi về code hoặc cung cấp code, hãy đảm bảo rằng code được đặt trong các khối code markdown. Ví dụ:\n```javascript\n// Mã JavaScript ở đây\nconsole.log('Hello, world!');\n```\nhoặc:\n```python\n# Mã Python ở đây\ndef hello():\n    print('Xin chào!')\n```\nNếu câu trả lời của bạn không chứa code, chỉ cần trả lời bằng văn bản thông thường.";

        let conversationHistory = [];
        let savedHistories = {};
        let historyNameToDelete = null;
        let autoSaveHistory = true;
        let useFirstMessageAsName = false;

        let currentBackgroundColor = '#1e2124';
        let currentTextColor = '#d1d5db';
        let currentContainerColor = '#25272b';

        const defaultBackgroundColor = '#1e2124';
        const defaultTextColor = '#d1d5db';
        const defaultContainerColor = '#25272b';

        let currentHistoryName = null;


        document.body.addEventListener('click', async (event) => {
            if (event.target.classList.contains('copy-code-button')) {
                const codeElement = event.target.closest('pre').querySelector('code');
                const copyButton = event.target; // Get the button element
                if (codeElement) {
                    try {
                        await navigator.clipboard.writeText(codeElement.textContent);
                        showCopyNotification(copyButton); // Pass the button to the notification function
                    } catch (err) {
                        console.error('Failed to copy code: ', err);
                        alert('Failed to copy code.');
                    }
                }
            }
        });

        function showCopyNotification(buttonElement) {
            const notification = buttonElement.querySelector('.copy-success-notification');
            if (!notification) {
                buttonElement.insertAdjacentHTML('beforeend', '<span class="copy-success-notification">Đã sao chép!</span>');
                const newNotification = buttonElement.querySelector('.copy-success-notification');
                setTimeout(() => {
                    newNotification.classList.add('show');
                    setTimeout(() => {
                        newNotification.classList.remove('show');
                        setTimeout(() => {
                            newNotification.remove(); // Remove notification element after fade out
                        }, 300); // Wait for fade-out transition
                    }, 1500); // Duration notification is visible
                }, 10); // Small delay for animation to start properly
            } else {
                // Notification already exists (shouldn't happen in normal flow, but handling just in case)
                notification.classList.add('show');
                setTimeout(() => {
                    notification.classList.remove('show');
                     setTimeout(() => {
                            notification.remove(); // Remove notification element after fade out
                        }, 300); // Wait for fade-out transition
                }, 1500);
            }
        }


        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const container = document.getElementById('container');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('sidebar--open');
            container.classList.toggle('container.sidebar-open');
            overlay.classList.toggle('sidebar--open');
            if (sidebar.classList.contains('sidebar--open')) {
                 loadSavedHistoriesList();
            } else {
                hideHistoryMenu();
                hideSettingsMenu();
            }
        }

        function loadChatHistory() {
            if (autoSaveHistorySetting()) {
                const storedHistory = localStorage.getItem('chatHistory');
                if (storedHistory) {
                    conversationHistory = JSON.parse(storedHistory);
                    renderMessages();
                }
            }
        }

        function saveChatHistory() {
            if (autoSaveHistorySetting()) {
                localStorage.setItem('chatHistory', JSON.stringify(conversationHistory));
            }
        }

        function renderMessages() {
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = '';
            conversationHistory.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', message.role === 'user' ? 'user-message' : 'ai-message');
                messageDiv.innerHTML = message.parts[0].text;
                messagesContainer.appendChild(messageDiv);
                Prism.highlightAllUnder(messageDiv);
            });
             messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }


        function startNewChat() {
             if (currentHistoryName) {
                savedHistories[currentHistoryName] = [...conversationHistory];
                localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
            }
            conversationHistory = [];
            saveChatHistory();
            renderMessages();
            currentHistoryName = null;
            toggleSidebar();
        }


        function openSaveHistoryModal() {
            document.getElementById('saveHistoryModalOverlay').classList.add('show-modal');
            document.getElementById('historyNameInput').value = '';

            if (useFirstMessageAsNameSetting() && conversationHistory.length > 0 && conversationHistory[0].role === 'user') {
                document.getElementById('historyNameInput').value = conversationHistory[0].parts[0].text.substring(0, 50);
            }
        }

        function closeSaveHistoryModal() {
            document.getElementById('saveHistoryModalOverlay').classList.remove('show-modal');
        }

        function saveHistoryWithInputName() {
            let historyName = document.getElementById('historyNameInput').value.trim();
            if (!historyName) {
                if (useFirstMessageAsNameSetting() && conversationHistory.length > 0 && conversationHistory[0].role === 'user') {
                    historyName = conversationHistory[0].parts[0].text.substring(0, 50) || 'No Title';
                } else {
                    alert("Vui lòng nhập tên cho lịch sử chat.");
                    return;
                }
            }

            savedHistories[historyName] = [...conversationHistory];
            localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
            alert(`Lịch sử chat đã được lưu với tên: ${historyName}`);
            loadSavedHistoriesList();
            closeSaveHistoryModal();
             currentHistoryName = historyName;

        }

        function openDeleteHistoryModal(name) {
            historyNameToDelete = name;
            document.getElementById('historyNameToDelete').textContent = name;
            document.getElementById('deleteHistoryModalOverlay').classList.add('show-modal');
        }

        function closeDeleteHistoryModal() {
            document.getElementById('deleteHistoryModalOverlay').classList.remove('show-modal');
            historyNameToDelete = null;
        }

        function confirmDeleteHistory() {
            if (historyNameToDelete) {
                deleteSavedHistory(historyNameToDelete);
            }
            closeDeleteHistoryModal();
        }


        function deleteSavedHistory(historyName) {
            delete savedHistories[historyName];
            localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
            loadSavedHistoriesList();
            alert(`Lịch sử chat "${historyName}" đã bị xóa.`);
            if (currentHistoryName === historyName) {
                currentHistoryName = null;
            }

        }


        function loadChatHistoryByName(historyName) {
            if (savedHistories[historyName]) {
                conversationHistory = [...savedHistories[historyName]];
                saveChatHistory();
                renderMessages();
                toggleHistoryMenu();
                toggleSidebar();
                currentHistoryName = historyName;

            } else {
                alert("Không tìm thấy lịch sử chat đã lưu.");
            }
        }


        function toggleHistoryMenu() {
            const submenu = document.getElementById('saved-histories-menu');
            submenu.classList.toggle('open');
             hideSettingsMenu();
        }

        function hideHistoryMenu() {
            const submenu = document.getElementById('saved-histories-menu');
            submenu.classList.remove('open');
        }

        function toggleSettingsMenu() {
            const submenu = document.getElementById('settings-menu');
            submenu.classList.toggle('open');
            hideHistoryMenu();
        }
         function hideSettingsMenu() {
            const submenu = document.getElementById('settings-menu');
            submenu.classList.remove('open');
        }


        function loadSavedHistoriesList() {
            const historiesMenu = document.getElementById('saved-histories-menu');
            historiesMenu.innerHTML = '<button class="close-history-menu-btn" onclick="toggleHistoryMenu()">Đóng</button>';

            const storedSavedHistories = localStorage.getItem('savedHistories');
            if (storedSavedHistories) {
                savedHistories = JSON.parse(storedSavedHistories);
            } else {
                savedHistories = {};
            }

            if (Object.keys(savedHistories).length === 0) {
                const noHistoryItem = document.createElement('li');
                noHistoryItem.classList.add('submenu-item');
                noHistoryItem.textContent = "Chưa có lịch sử nào được lưu.";
                historiesMenu.appendChild(noHistoryItem);
                return;
            }

            for (const historyName in savedHistories) {
                const historyItem = document.createElement('li');
                historyItem.classList.add('submenu-item');

                const nameSpan = document.createElement('span');
                nameSpan.classList.add('history-name');
                nameSpan.textContent = historyName;
                nameSpan.onclick = () => loadChatHistoryByName(historyName);

                const deleteButton = document.createElement('button');
                deleteButton.classList.add('delete-history-btn');
                deleteButton.textContent = '...';
                deleteButton.onclick = (event) => {
                    event.stopPropagation();
                    openDeleteHistoryModal(historyName);
                };

                historyItem.appendChild(nameSpan);
                historyItem.appendChild(deleteButton);
                historiesMenu.appendChild(historyItem);
            }
        }


        loadChatHistory();
        loadSavedHistoriesList();
        loadSettings();
        applyTheme();


        function triggerFileUpload() {
            document.getElementById('file-upload').click();
        }

        function handleFileUpload(files) {
            if (files && files.length > 0) {
                const messagesContainer = document.getElementById('messages-container');
                const aiMessageDiv = document.createElement('div');
                aiMessageDiv.classList.add('message', 'ai-message');
                aiMessageDiv.innerHTML = `<span class="ai-message-text">Đang tải tệp...</span>`;
                messagesContainer.appendChild(aiMessageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                let fileNames = Array.from(files).map(file => file.name).join(', ');
                const userMessage = `Tệp đã tải lên: ${fileNames}. Đang chờ AI xử lý...`;

                const userMessageDiv = document.createElement('div');
                userMessageDiv.classList.add('message', 'user-message');
                userMessageDiv.textContent = userMessage;
                messagesContainer.appendChild(userMessageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                const userMessageObject = { role: 'user', parts: [{ text: userMessage }] };
                conversationHistory.push(userMessageObject);
                saveChatHistory();
                renderMessages();

                setTimeout(() => {
                    aiMessageDiv.remove();

                    const aiResponseDiv = document.createElement('div');
                    aiResponseDiv.classList.add('message', 'ai-message');
                    aiResponseDiv.innerHTML = `<span class="ai-message-text">Đã nhận được tệp: ${fileNames}. Vui lòng cho biết bạn muốn AI làm gì với tệp này.</span>`;
                    messagesContainer.appendChild(aiResponseDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;

                     const aiMessageObject = { role: 'model', parts: [{ text: aiResponseDiv.innerHTML }] };
                    conversationHistory.push(aiMessageObject);
                    saveChatHistory();
                    renderMessages();

                }, 1500);
            }
        }


        async function getGeminiResponse() {
            const userPrompt = document.getElementById('user-prompt').value.trim();
            const messagesContainer = document.getElementById('messages-container');
            let aiMessageDiv = document.createElement('div'); // Declare aiMessageDiv here

            if (!userPrompt) {
                alert("Vui lòng nhập tin nhắn.");
                return;
            }

             if (currentHistoryName) {
                savedHistories[currentHistoryName] = [...conversationHistory, { role: 'user', parts: [{ text: userPrompt }] } ];
                localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
            }


            const userMessageObject = { role: 'user', parts: [{ text: userPrompt }] };
            conversationHistory.push(userMessageObject);
            saveChatHistory();
            renderMessages();
            document.getElementById('user-prompt').value = '';


            aiMessageDiv.classList.add('message', 'ai-message');
            aiMessageDiv.textContent = "Đang suy nghĩ...";
            messagesContainer.appendChild(aiMessageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            let promptContents = conversationHistory.map(message => ({
                role: message.role,
                parts: message.parts
            }));
            promptContents.unshift({ role: 'user', parts: [{ text: systemPrompt }] });


            const payload = {
                contents: promptContents
            };


            try {
                const response = await fetch(geminiAPIUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Lỗi API:", errorData);
                    aiMessageDiv.textContent = `Lỗi API: ${response.status} - ${errorData.error.message || 'Không rõ nguyên nhân'}`;
                    return;
                }

                const data = await response.json();
                console.log("Dữ liệu phản hồi từ API:", data);

                if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0].text) {
                    let aiResponseText = data.candidates[0].content.parts[0].text;
                    let codeContent = null;
                    let language = 'text';
                    const codeBlockRegex = /```([\w]*)\n([\s\S]*?)```/gm;
                    const matches = [...aiResponseText.matchAll(codeBlockRegex)];

                    aiMessageDiv.innerHTML = ''; // Clear "Đang suy nghĩ..." before adding content.

                    if (matches.length > 0) {
                        let textContent = aiResponseText.split(codeBlockRegex)[0];
                        if (textContent.trim()) {
                             aiMessageDiv.innerHTML += `<span class="ai-message-text">${textContent.trim()}</span>`; // Add non-code text part first
                        }


                        matches.forEach(match => {
                            language = match[1] || 'text';
                            codeContent = match[2].trim();

                            aiMessageDiv.innerHTML += `<pre class="language-${language}"><code class="language-${language}">${codeContent}</code></pre>`; // Append code block
                            const pre = aiMessageDiv.querySelector(`pre.language-${language}:last-child`); // Get just added pre element.

                            if (pre) {
                                 const blob = new Blob([codeContent], { type: 'text/plain' });
                                const url = URL.createObjectURL(blob);
                                const downloadLink = document.createElement('a');
                                downloadLink.href = url;
                                downloadLink.download = `code.${language}`;
                                downloadLink.textContent = `Tải xuống code ${language}`;
                                downloadLink.style.display = 'block';
                                downloadLink.style.marginTop = '10px';
                                pre.appendChild(downloadLink); // append download link to pre tag.
                            }
                        });

                    } else {
                        aiMessageDiv.innerHTML = `<span class="ai-message-text">${aiResponseText}</span>`;
                    }


                    const aiMessageObject = { role: 'model', parts: [{ text: aiMessageDiv.innerHTML }] };
                    conversationHistory.push(aiMessageObject);
                    saveChatHistory();
                    renderMessages(); // Re-render messages to apply Prism and download links
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;


                } else {
                    aiMessageDiv.textContent = `<span class="ai-message-text">Không nhận được phản hồi hợp lệ từ AI.</span>`;
                }

            } catch (error) {
                console.error("Lỗi fetch:", error);
                aiMessageDiv.textContent = `<span class="ai-message-text">Đã xảy ra lỗi khi kết nối đến API: ${error}</span>`;
            }
        }

        function loadSettings() {
            const storedSettings = localStorage.getItem('chatSettings');
            if (storedSettings) {
                const settings = JSON.parse(storedSettings);
                autoSaveHistory = settings.autoSaveHistory !== undefined ? settings.autoSaveHistory : true;
                useFirstMessageAsName = settings.useFirstMessageAsName !== undefined ? settings.useFirstMessageAsName : false;
                currentBackgroundColor = settings.backgroundColor || defaultBackgroundColor;
                currentTextColor = settings.textColor || defaultTextColor;
                currentContainerColor = settings.containerColor || defaultContainerColor;


                document.getElementById('autoSaveHistoryToggle').checked = autoSaveHistory;
                document.getElementById('useFirstMessageAsNameToggle').checked = useFirstMessageAsName;
                document.getElementById('backgroundColorPicker').value = currentBackgroundColor;
                document.getElementById('textColorPicker').value = currentTextColor;
                document.getElementById('containerColorPicker').value = currentContainerColor;

            } else {
                 document.getElementById('autoSaveHistoryToggle').checked = true;
                 document.getElementById('useFirstMessageAsNameToggle').checked = false;
                 currentBackgroundColor = defaultBackgroundColor;
                 currentTextColor = defaultTextColor;
                 currentContainerColor = defaultContainerColor;

            }

            document.getElementById('autoSaveHistoryToggle').addEventListener('change', function() {
                autoSaveHistory = this.checked;
            });
            document.getElementById('useFirstMessageAsNameToggle').addEventListener('change', function() {
                useFirstMessageAsName = this.checked;
            });
            document.getElementById('backgroundColorPicker').addEventListener('change', function() {
                currentBackgroundColor = this.value;
            });
             document.getElementById('textColorPicker').addEventListener('change', function() {
                currentTextColor = this.value;
            });
            document.getElementById('containerColorPicker').addEventListener('change', function() {
                currentContainerColor = this.value;
            });
        }

        function saveSetting(key, value) {
            let settings = JSON.parse(localStorage.getItem('chatSettings')) || {};
            settings[key] = value;
            localStorage.setItem('chatSettings', JSON.stringify(settings));
        }

        function autoSaveHistorySetting() {
            return autoSaveHistory;
        }
        function useFirstMessageAsNameSetting() {
            return useFirstMessageAsName;
        }


        function applyTheme() {
            document.documentElement.style.setProperty('--background-color', currentBackgroundColor);
            document.documentElement.style.setProperty('--text-color', currentTextColor);
            document.documentElement.style.setProperty('--container-background-color', currentContainerColor);
        }

        function saveSettingsAndApplyTheme() {
            saveSetting('autoSaveHistory', autoSaveHistory);
            saveSetting('useFirstMessageAsName', useFirstMessageAsName);
            saveSetting('backgroundColor', currentBackgroundColor);
            saveSetting('textColor', currentTextColor);
            saveSetting('containerColor', currentContainerColor);
            applyTheme();
            toggleSettingsMenu();
            alert('Cài đặt đã được lưu và áp dụng!');
        }

        function resetTheme() {
            currentBackgroundColor = defaultBackgroundColor;
            currentTextColor = defaultTextColor;
            currentContainerColor = defaultContainerColor;

            document.getElementById('backgroundColorPicker').value = currentBackgroundColor;
            document.getElementById('textColorPicker').value = currentTextColor;
            document.getElementById('containerColorPicker').value = currentContainerColor;

            applyTheme();
            alert('Giao diện đã hoàn tác về mặc định. Nhấn "Lưu cài đặt" để lưu thay đổi.');
        }


    </script>
</body>
</html>