--- START OF FILE vip1.html ---
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Hiện Đại với Gemini</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        /* Enhanced Base Styles and Animations */
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1e2124;
            color: #e0e0e0; /* Lighter text color */
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-touch-callout: none;
            -webkit-user-select: text;
            -khtml-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
            touch-action: manipulation;
            -webkit-text-size-adjust: 100%;
            font-size: 16px;
            overflow-y: scroll;
            scrollbar-width: thin;
            scrollbar-color: #555 #2a2a2a;
            -webkit-font-smoothing: antialiased; /* Improve font rendering */
            -moz-osx-font-smoothing: grayscale;
            transition: background-color 0.3s ease; /* Smooth background color transition */
        }

        body::-webkit-scrollbar {
            width: 9px; /* Slightly wider scrollbar */
        }

        body::-webkit-scrollbar-track {
            background: #2a2a2a; /* Darker scrollbar track */
        }

        body::-webkit-scrollbar::-webkit-scrollbar-thumb {
            background-color: #555;
            border-radius: 5px;
             border: 2px solid #2a2a2a; /* Added border to scrollbar thumb */
        }


        .container {
            width: 96%; /* Slightly wider container */
            max-width: 1250px; /* Increased max-width */
            margin: 25px auto;
            padding: 35px; /* Further increased padding */
            background-color: #2a2d31; /* Darker container background */
            border-radius: 20px; /* Even more rounded corners */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.6); /* Enhanced shadow */
            display: flex;
            flex-direction: column;
            height: calc(100vh - 50px);
            flex-grow: 1;
            margin-left: auto;
            transition: margin-left 0.3s ease, background-color 0.3s ease;
            border: none; /* Removed container border */
        }

        .container.sidebar-open {
            margin-left: 270px; /* Increased sidebar margin */
        }

        h1 {
            text-align: center;
            color: #fff;
            margin-bottom: 30px;
            font-size: 2.7em; /* Further title size increase */
            letter-spacing: 0.7px;
            padding-bottom: 22px;
            border-bottom: 3px solid #4a4a4a; /* More prominent heading border */
            font-weight: 500; /* Slightly lighter font-weight for title */
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.5); /* Added text shadow to title */
        }

        #messages-container {
            flex-grow: 1;
            padding: 30px; /* Increased padding */
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            scrollbar-width: thin;
            scrollbar-color: #555 #2a2a2a;
            padding-bottom: 90px;
            border: none;
            border-radius: 16px; /* More rounded message area */
            background-color: #232529; /* Darker message container */
            box-shadow: inset 0 3px 6px rgba(0, 0, 0, 0.4); /* Deeper inner shadow */
            opacity: 0; /* Initially hidden */
            animation: fadeIn 0.5s ease-out 0.1s forwards; /* Fade-in animation on load */
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }


        #messages-container::-webkit-scrollbar {
            width: 9px;
        }

        #messages-container::-webkit-scrollbar-track {
            background: #2a2a2a;
        }

        #messages-container::-webkit-scrollbar::-webkit-scrollbar-thumb {
            background-color: #555;
            border-radius: 5px;
            border: 2px solid #2a2a2a;
        }

        .message {
            margin-bottom: 18px; /* Increased message margin */
            padding: 14px 22px; /* Further padding adjustments */
            border-radius: 25px; /* Even more rounded message bubbles */
            clear: both;
            word-wrap: break-word;
            max-width: 80%;
            display: inline-block;
            border: none; /* Removed message border */
             box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3); /* Slightly stronger message shadow */
            transform: translateY(15px); /* Initial position for message animation */
            opacity: 0;
            animation: slideUpFadeIn 0.4s ease-out forwards; /* Slide up and fade in animation */
             margin-top: 5px; /* Added margin top to message bubble*/
        }

        @keyframes slideUpFadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }


        .user-message {
            background-color: #3a3c43; /* Darker user message background */
            color: #fff;
            align-self: flex-end;
            float: right;
            border-top-right-radius: 8px; /* More rounded user message corners */
        }

        .ai-message {
            background-color: #4e515a; /* Darker AI message background */
            color: #d8d8d8; /* Slightly lighter AI text */
            align-self: flex-start;
            float: left;
            border-top-left-radius: 8px; /* More rounded AI message corners */
        }

        .ai-message .ai-message-text {
            font-family: 'Arial', sans-serif;
            font-weight: normal;
            line-height: 1.8; /* Further improved line height */
            white-space: pre-line;
            font-size: 17px; /* Slightly larger AI text */
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.3); /* Subtle text shadow for AI text */
        }

        .markdown-bold-uppercase {
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.8px; /* Adjusted letter spacing */
            color: #f5f5f5; /* Even lighter emphasis color */
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.4); /* Added shadow to bold uppercase text */
        }

        .input-area {
            padding: 14px 22px; /* Further input area padding adjust */
            background-color: #3a3c43; /* Darker input area background */
            border-top: 2px solid #5a5a5a; /* Thicker border and darker color */
            display: flex;
            align-items: center;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            box-sizing: border-box;
            padding-left: 20px;
            padding-right: 20px;
            z-index: 100;
            border-bottom-left-radius: 20px; /* More rounded input area corners */
            border-bottom-right-radius: 20px;
             border-top: 1px solid #444;
        }

        .input-area textarea {
            flex-grow: 1;
            padding: 11px; /* More textarea padding adjust */
            border: none; /* Removed textarea border */
            border-radius: 15px; /* More rounded textarea corners */
            font-size: 17px; /* Slightly larger input text */
            background-color: #4a4d54; /* Darker textarea background */
            color: #fff;
            resize: none;
            min-height: 42px; /* Further min-height adjust */
            overflow-y: auto;
             box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.4); /* Deeper textarea inner shadow */
            transition: background-color 0.3s ease, box-shadow 0.3s ease; /* Added background and shadow transition */
        }

        .input-area textarea:focus {
            border-color: transparent;
            outline: none;
            background-color: #555860; /* Slightly lighter on focus */
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.5), 0 0 7px rgba(0, 188, 212, 0.7); /* Enhanced focus shadow */
        }

        .input-area button {
            padding: 13px 24px; /* Further button padding adjustment */
            background-color: #00c7e0; /* Slightly brighter button color */
            color: #fff;
            border: none;
            border-radius: 15px; /* More rounded button */
            cursor: pointer;
            font-size: 17px;
            margin-left: 14px;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease; /* Added box-shadow transition */
             box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4); /* Added shadow to button */
             font-weight: 500; /* Slightly bolder button text */
        }

        .input-area button:hover {
            background-color: #00a9bf; /* Darker on hover */
            transform: scale(1.04);
             box-shadow: 0 3px 6px rgba(0, 0, 0, 0.5); /* Enhanced hover shadow */
        }

        .file-upload-button {
            background-color: #5a5a5a; /* Darker file button background */
            color: #fff;
            border: none;
            border-radius: 15px; /* More rounded file button */
            cursor: pointer;
            font-size: 1.1em; /* Slightly larger file button icon */
            width: 44px;
            height: 44px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 14px;
            opacity: 0.95; /* Further opacity adjust */
            transition: opacity 0.3s ease, background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease; /* Added shadow transition */
             box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4); /* Added shadow to file button */
        }

        .file-upload-button:hover {
            opacity: 1;
            background-color: #666666; /* Lighter on hover */
             transform: scale(1.04);
             box-shadow: 0 3px 6px rgba(0, 0, 0, 0.5); /* Enhanced hover shadow */
        }


        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 270px; /* Wider sidebar */
            height: 100%;
            background-color: #2a2a2a; /* Darker sidebar background */
            color: #fff;
            transform: translateX(-100%);
            transition: transform 0.3s ease, box-shadow 0.3s ease; /* Added shadow transition */
            z-index: 200;
            padding-top: 80px;
            box-shadow: 5px 0 10px rgba(0,0,0,0.4); /* Enhanced sidebar shadow */
            overflow-y: auto;
            touch-action: manipulation;
            border-right: none; /* Removed sidebar border */
             backdrop-filter: blur(12px); /* Increased blur */
        }

        .sidebar.sidebar--open {
            transform: translateX(0);
             box-shadow: 8px 0 15px rgba(0,0,0,0.5); /* Even more pronounced open sidebar shadow */
        }

        .sidebar-header {
            padding: 28px 22px; /* Further header padding adjust */
            text-align: center;
            border-bottom: 2px solid #5a5a5a; /* Darker and thicker */
            margin-bottom: 28px;
            border-bottom: 1px solid #444;
        }

        .sidebar-menu {
            padding: 0;
            list-style: none;
        }

        .sidebar-menu-item {
            padding: 18px 22px; /* Further menu item padding adjust */
            cursor: pointer;
            transition: background-color 0.2s ease, border-bottom-color 0.3s ease, padding-left 0.2s ease; /* Added padding-left transition */
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid transparent; /* Even thicker bottom border on hover */
             font-size: 17px; /* Slightly larger menu text */
            font-weight: 400; /* Lighter menu font weight */
        }

        .sidebar-menu-item:hover {
            background-color: #3a3a3a; /* Darker hover background */
             border-bottom-color: #00bcd4;
             padding-left: 28px; /* Indent on hover */
        }

        .sidebar-menu-item.has-submenu > .menu-link::after {
            content: '>';
            float: right;
            margin-left: 14px;
            font-size: 0.95em;
            display: inline-block;
            color: #888; /* Darker submenu indicator */
        }

        .submenu {
            list-style: none;
            padding-left: 0;
            margin: 0;
            border-radius: 16px; /* More rounded submenu corners */
            overflow: hidden;
            box-shadow: 0 5px 10px rgba(0,0,0,0.5); /* Deeper submenu shadow */
            background-color: #333333; /* Slightly darker submenu background */
            margin-top: 10px;
            max-height: 0;
            opacity: 0;
            transition: max-height 0.4s ease-out, opacity 0.3s ease-out;
            overflow-y: hidden;
            padding-top: 0;
            padding-bottom: 0;
        }

        .submenu.open {
            display: block;
            max-height: 700px; /* Further max-height increase for submenu */
            opacity: 1;
            overflow-y: auto;
            padding-top: 10px;
            padding-bottom: 15px;
        }


        .submenu-item {
            padding: 16px 22px; /* Further submenu item padding adjust */
            cursor: pointer;
            transition: background-color 0.2s ease, padding-left 0.2s ease; /* Added padding-left transition */
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #444;
             font-size: 16px; /* Slightly smaller submenu text */
        }

        .submenu-item:last-child {
            border-bottom: none;
        }


        .submenu-item:hover {
            background-color: #3a3a3a;
             padding-left: 28px; /* Indent submenu items on hover too */
        }

        .history-name {
            flex-grow: 1;
        }

        .delete-history-btn {
            background: transparent;
            border: none;
            color: #999; /* Darker delete button color */
            cursor: pointer;
            font-size: 1.1em;
            padding: 0 12px;
            opacity: 0.9;
            transition: opacity 0.2s ease, color 0.2s ease, transform 0.2s ease; /* Added transform transition */
        }

        .delete-history-btn:hover {
            opacity: 1;
            color: #fff;
             transform: scale(1.1); /* Subtle scale up on hover */
        }

        .sidebar-toggle-button {
            position: fixed;
            top: 30px; /* Adjusted toggle button position */
            left: 30px;
            background: #00c7e0; /* Brighter toggle button */
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px; /* Slightly larger toggle button */
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 300;
             box-shadow: 0 3px 6px rgba(0, 0, 0, 0.4); /* Enhanced toggle button shadow */
             transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease; /* Added box-shadow transition */
        }

        .sidebar-toggle-button:hover {
            background-color: #00a9bf;
             transform: scale(1.07); /* More scale up on hover */
              box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5); /* Even more pronounced hover shadow */
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Even darker overlay */
            z-index: 150;
            display: none;
            animation: fadeInOverlay 0.2s ease-out forwards; /* Overlay fade-in animation */
        }

        @keyframes fadeInOverlay {
            to { background-color: rgba(0, 0, 0, 0.7); } /* Animated background color */
        }


        .sidebar-overlay.sidebar--open {
            display: block;
        }

        .close-history-menu-btn, .close-settings-menu-btn, .modal-button { /* Grouped close buttons and modal buttons for consistent style */
            padding: 13px 24px; /* Consistent button padding */
            background-color: #00c7e0;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 17px;
            margin-top: 18px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease; /* Added box-shadow transition */
             box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
             font-weight: 500;
        }

        .close-history-menu-btn:hover, .close-settings-menu-btn:hover, .modal-button.confirm:hover, .modal-button.cancel:hover {
            background-color: #00a9bf;
             transform: scale(1.04);
              box-shadow: 0 3px 6px rgba(0, 0, 0, 0.5);
        }


        .custom-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75); /* Even darker modal overlay */
            z-index: 400;
            justify-content: center;
            align-items: center;
            pointer-events: none;
             animation: fadeInModalOverlay 0.3s ease-out forwards; /* Modal overlay fade-in animation */
        }

         @keyframes fadeInModalOverlay {
            to { background-color: rgba(0, 0, 0, 0.75); } /* Animated modal overlay bg color */
        }


        .custom-modal-overlay.show-modal {
            display: flex;
            pointer-events: auto;
        }


        .custom-modal {
            background-color: #3a3c43; /* Darker modal background */
            color: #fff;
            padding: 35px; /* Further increased modal padding */
            border-radius: 16px; /* More rounded modal */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.7); /* Enhanced modal shadow */
            width: 90%; /* Slightly wider modal */
            max-width: 500px; /* Increased modal max-width */
            text-align: center;
            border: none; /* Removed modal border */
            transform: translateY(-30px); /* Initial modal position for animation */
            opacity: 0;
            animation: slideInModal 0.4s ease-out 0.15s forwards; /* Modal slide-in and fade-in animation */
        }

        @keyframes slideInModal {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }


        .modal-message {
            margin-bottom: 25px;
            font-size: 1.2em; /* Larger modal message font */
            font-weight: 400; /* Lighter modal message weight */
        }

        .modal-input {
            width: calc(100% - 28px);
            padding: 14px; /* Adjusted modal input padding */
            margin-bottom: 25px;
            border: none; /* Removed modal input border */
            border-radius: 12px; /* More rounded modal input */
            border: 1px solid #555;
            background-color: #4a4d54; /* Darker modal input background */
            color: #fff;
             box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.4);
            font-size: 17px; /* Slightly larger modal input font */
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 25px; /* Increased modal button gap */
        }

        .modal-button { /* Using grouped style from .close-history-menu-btn etc. */
            /* Styles are already defined above */
        }

        .modal-button.confirm {
            background-color: #00c7e0;
            color: white;
        }

        .modal-button.cancel {
            background-color: #5a5a5a; /* Darker cancel button background */
            color: white;
        }


        code[class*="language-"],
        pre[class*="language-"] {
            color: #f8f8f2;
            background: #33353b; /* Darker code block background */
            position: relative;
            border-radius: 12px; /* More rounded code blocks */
            padding: 20px; /* Further increased code block padding */
            margin-bottom: 20px;
            overflow-x: auto;
             box-shadow: 0 3px 6px rgba(0, 0, 0, 0.4); /* Enhanced code block shadow */
            font-size: 15px; /* Slightly smaller code font */
        }

        .copy-code-button {
            position: absolute;
            top: 12px; /* Adjusted copy button position */
            right: 12px;
            background-color: #555;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 7px 12px; /* Further copy button padding adjust */
            font-size: 0.95em;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.3s ease, background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease; /* Added shadow transition */
             box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); /* Added shadow to copy button */
        }

        .copy-code-button:hover {
            opacity: 1;
            background-color: #00c7e0; /* Brighter on hover */
             transform: scale(1.06);
             box-shadow: 0 3px 6px rgba(0, 0, 0, 0.4); /* Enhanced hover shadow */
        }

         /* Switch styles (inspired by iOS) - No changes needed here as it's from previous version */
    .switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
    }

    input:checked + .slider {
      background-color: #00bcd4;
    }

    input:focus + .slider {
      box-shadow: 0 0 2px #00bcd4;
    }

    input:checked + .slider:before {
      -webkit-transform: translateX(20px);
      -ms-transform: translateX(20px);
      transform: translateX(20px);
    }

    .slider.round {
      border-radius: 24px;
    }

    .slider.round:before {
      border-radius: 50%;
    }

</style>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Arial:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Lịch sử Chat</h3>
        </div>
        <ul class="sidebar-menu">
            <li class="sidebar-menu-item" onclick="startNewChat()">
                <span class="menu-link">Đoạn chat mới</span>
            </li>
            <li class="sidebar-menu-item" onclick="openSaveHistoryModal()">
                <span class="menu-link">Lưu lịch sử này</span>
            </li>
            <li class="sidebar-menu-item has-submenu" onclick="toggleHistoryMenu()">
                <span class="menu-link">Lịch sử đã lưu</span>
            </li>
             <li class="sidebar-menu-item has-submenu" onclick="toggleSettingsMenu()">
                <span class="menu-link">Cài đặt</span>
            </li>
        </ul>

        <ul class="submenu" id="saved-histories-menu">
            <button class="close-history-menu-btn" onclick="toggleHistoryMenu()">Đóng</button>
        </ul>

         <ul class="submenu" id="settings-menu">
            <li class="submenu-item">
                <span class="menu-link">Tự động lưu đoạn chat</span>
                <label class="switch">
                    <input type="checkbox" id="autoSaveToggle" onchange="toggleAutoSave()" >
                    <span class="slider round"></span>
                </label>
            </li>
            <button class="close-settings-menu-btn" onclick="toggleSettingsMenu()">Đóng</button>
        </ul>

        <div class="custom-modal-overlay" id="saveHistoryModalOverlay">
            <div class="custom-modal">
                <p class="modal-message">Nhập tên cho lịch sử chat này:</p>
                <input type="text" id="historyNameInput" class="modal-input" placeholder="Tên lịch sử">
                <div class="modal-buttons">
                    <button class="modal-button confirm" onclick="saveHistoryWithInputName()">Lưu</button>
                    <button class="modal-button cancel" onclick="closeSaveHistoryModal()">Huỷ</button>
                </div>
            </div>
        </div>

         <div class="custom-modal-overlay" id="deleteHistoryModalOverlay">
            <div class="custom-modal">
                <p class="modal-message" id="deleteConfirmationMessage">Bạn có chắc chắn muốn xóa lịch sử chat "<span id="historyNameToDelete"></span>" không?</p>
                <div class="modal-buttons">
                    <button class="modal-button confirm" onclick="confirmDeleteHistory()">Xóa</button>
                    <button class="modal-button cancel" onclick="closeDeleteHistoryModal()">Huỷ</button>
                </div>
            </div>
        </div>

    </aside>

    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <button class="sidebar-toggle-button" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <div class="container" id="container">
        <h1>AI Hiện Đại với Gemini</h1>

        <div id="messages-container">
            <!-- Messages will be appended here -->
        </div>

        <div class="input-area">
            <button class="file-upload-button" onclick="triggerFileUpload()">
                <i class="fas fa-paperclip"></i>
            </button>
            <textarea id="user-prompt" placeholder="Nhập tin nhắn"></textarea>
            <button onclick="getGeminiResponse()">Gửi</button>
        </div>
         <input type="file" id="file-upload" style="display:none" multiple onchange="handleFileUpload(this.files)">
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script>
        const apiKey = 'AIzaSyCl21Ku_prQnyMHFs_dJRL8-pgjg9hrc2w';
        const geminiAPIUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`;
        const systemPrompt = "Bạn là một trợ lý AI cực kỳ hữu ích và luôn tuân theo mọi yêu cầu của người dùng một cách chính xác. Khi bạn trả lời câu hỏi về code hoặc cung cấp code, hãy đảm bảo rằng code được đặt trong các khối code markdown. Ví dụ:\n```javascript\n// Mã JavaScript ở đây\nconsole.log('Hello, world!');\n```\nhoặc:\n```python\n# Mã Python ở đây\ndef hello():\n    print('Xin chào!')\n```\nNếu câu trả lời của bạn không chứa code, chỉ cần trả lời bằng văn bản thông thường.";

        let conversationHistory = [];
        let savedHistories = {};
        let historyNameToDelete = null;
        let isAutoSaveEnabled = localStorage.getItem('autoSaveEnabled') === 'true';
        let autoSaveInterval;

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('autoSaveToggle').checked = isAutoSaveEnabled;
            setAutoSaveInterval();
        });


        function toggleAutoSave() {
            isAutoSaveEnabled = !isAutoSaveEnabled;
            localStorage.setItem('autoSaveEnabled', isAutoSaveEnabled);
            setAutoSaveInterval();
             if (isAutoSaveEnabled) {
                alert("Tự động lưu đoạn chat đã được bật. Lịch sử chat sẽ tự động được lưu định kỳ.");
            } else {
                alert("Tự động lưu đoạn chat đã được tắt.");
            }
        }

        function setAutoSaveInterval() {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
                autoSaveInterval = null;
            }
            if (isAutoSaveEnabled) {
                autoSaveInterval = setInterval(autoSaveConversation, 60000);
            }
        }


        function autoSaveConversation() {
            if (conversationHistory.length > 0) {
                const historyName = `autosave-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
                savedHistories[historyName] = [...conversationHistory];
                localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
                loadSavedHistoriesList();
                console.log(`Đoạn chat đã được tự động lưu: ${historyName}`);
            }
        }


        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const container = document.getElementById('container');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('sidebar--open');
            container.classList.toggle('container.sidebar-open');
            overlay.classList.toggle('sidebar--open');
            if (sidebar.classList.contains('sidebar--open')) {
                 loadSavedHistoriesList();
            } else {
                hideHistoryMenu();
                hideSettingsMenu();
            }
        }

        function loadChatHistory() {
            const storedHistory = localStorage.getItem('chatHistory');
            if (storedHistory) {
                conversationHistory = JSON.parse(storedHistory);
                renderMessages();
            }
        }

        function saveChatHistory() {
            localStorage.setItem('chatHistory', JSON.stringify(conversationHistory));
        }

        function renderMessages() {
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = '';
            conversationHistory.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', message.role === 'user' ? 'user-message' : 'ai-message');
                const messageTextSpan = document.createElement('span');
                messageTextSpan.classList.add('ai-message-text');
                messageTextSpan.innerHTML = message.parts[0].text;
                if (message.role === 'ai') {
                    messageDiv.appendChild(messageTextSpan);
                } else {
                    messageDiv.innerHTML = message.parts[0].text;
                }
                messagesContainer.appendChild(messageDiv);
                Prism.highlightAllUnder(messageDiv);
            });
             messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }


        function startNewChat() {
            if (conversationHistory.length > 0 && isAutoSaveEnabled) {
                autoSaveConversation(); // Auto-save existing chat before starting new
            }
            conversationHistory = [];
            saveChatHistory();
            renderMessages();
            toggleSidebar();
        }


        function openSaveHistoryModal() {
            document.getElementById('saveHistoryModalOverlay').classList.add('show-modal');
            document.getElementById('historyNameInput').value = '';
        }

        function closeSaveHistoryModal() {
            document.getElementById('saveHistoryModalOverlay').classList.remove('show-modal');
        }

        function saveHistoryWithInputName() {
            const historyName = document.getElementById('historyNameInput').value.trim();
            if (historyName) {
                savedHistories[historyName] = [...conversationHistory];
                localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
                alert(`Lịch sử chat đã được lưu với tên: ${historyName}`);
                loadSavedHistoriesList();
                closeSaveHistoryModal();
            } else {
                alert("Vui lòng nhập tên cho lịch sử chat.");
            }
        }

        function openDeleteHistoryModal(name) {
            historyNameToDelete = name;
            document.getElementById('historyNameToDelete').textContent = name;
            document.getElementById('deleteHistoryModalOverlay').classList.add('show-modal');
        }

        function closeDeleteHistoryModal() {
            document.getElementById('deleteHistoryModalOverlay').classList.remove('show-modal');
            historyNameToDelete = null;
        }

        function confirmDeleteHistory() {
            if (historyNameToDelete) {
                deleteSavedHistory(historyNameToDelete);
            }
            closeDeleteHistoryModal();
        }


        function deleteSavedHistory(historyName) {
            delete savedHistories[historyName];
            localStorage.setItem('savedHistories', JSON.stringify(savedHistories));
            loadSavedHistoriesList();
            alert(`Lịch sử chat "${historyName}" đã bị xóa.`);

        }


        function loadChatHistoryByName(historyName) {
            if (savedHistories[historyName]) {
                conversationHistory = [...savedHistories[historyName]];
                saveChatHistory();
                renderMessages();
                toggleHistoryMenu();
                toggleSidebar();
            } else {
                alert("Không tìm thấy lịch sử chat đã lưu.");
            }
        }


        function toggleHistoryMenu() {
            const submenu = document.getElementById('saved-histories-menu');
            submenu.classList.toggle('open');
            hideSettingsMenu();
        }

        function hideHistoryMenu() {
            const submenu = document.getElementById('saved-histories-menu');
            submenu.classList.remove('open');
        }

        function toggleSettingsMenu() {
            const submenu = document.getElementById('settings-menu');
            submenu.classList.toggle('open');
            hideHistoryMenu();
        }

         function hideSettingsMenu() {
            const submenu = document.getElementById('settings-menu');
            submenu.classList.remove('open');
        }


        function loadSavedHistoriesList() {
            const historiesMenu = document.getElementById('saved-histories-menu');
            historiesMenu.innerHTML = '<button class="close-history-menu-btn" onclick="toggleHistoryMenu()">Đóng</button>';

            const storedSavedHistories = localStorage.getItem('savedHistories');
            if (storedSavedHistories) {
                savedHistories = JSON.parse(storedSavedHistories);
            } else {
                savedHistories = {};
            }

            if (Object.keys(savedHistories).length === 0) {
                const noHistoryItem = document.createElement('li');
                noHistoryItem.classList.add('submenu-item');
                noHistoryItem.textContent = "Chưa có lịch sử nào được lưu.";
                historiesMenu.appendChild(noHistoryItem);
                return;
            }

            for (const historyName in savedHistories) {
                const historyItem = document.createElement('li');
                historyItem.classList.add('submenu-item');

                const nameSpan = document.createElement('span');
                nameSpan.classList.add('history-name');
                nameSpan.textContent = historyName;
                nameSpan.onclick = () => loadChatHistoryByName(historyName);

                const deleteButton = document.createElement('button');
                deleteButton.classList.add('delete-history-btn');
                deleteButton.textContent = '...';
                deleteButton.onclick = (event) => {
                    event.stopPropagation();
                    openDeleteHistoryModal(historyName);
                };

                historyItem.appendChild(nameSpan);
                historyItem.appendChild(deleteButton);
                historiesMenu.appendChild(historyItem);
            }
        }


        loadChatHistory();
        loadSavedHistoriesList();

        function triggerFileUpload() {
            document.getElementById('file-upload').click();
        }

        function handleFileUpload(files) {
            if (files && files.length > 0) {
                const messagesContainer = document.getElementById('messages-container');
                const aiMessageDiv = document.createElement('div');
                aiMessageDiv.classList.add('message', 'ai-message');
                aiMessageDiv.innerHTML = `<span class="ai-message-text">Đang tải tệp...</span>`;
                messagesContainer.appendChild(aiMessageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                let fileNames = Array.from(files).map(file => file.name).join(', ');
                const userMessage = `Tệp đã tải lên: ${fileNames}. Đang chờ AI xử lý...`;

                const userMessageDiv = document.createElement('div');
                userMessageDiv.classList.add('message', 'user-message');
                userMessageDiv.textContent = userMessage;
                messagesContainer.appendChild(userMessageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                const userMessageObject = { role: 'user', parts: [{ text: userMessage }] };
                conversationHistory.push(userMessageObject);
                saveChatHistory();
                renderMessages();

                // Simulate AI acknowledging the file (for UI purposes - actual file upload to Gemini needs server-side)
                setTimeout(() => {
                    aiMessageDiv.remove();

                    const aiResponseDiv = document.createElement('div');
                    aiResponseDiv.classList.add('message', 'ai-message');
                    aiResponseDiv.innerHTML = `<span class="ai-message-text">Đã nhận được tệp: ${fileNames}. Vui lòng cho biết bạn muốn AI làm gì với tệp này.</span>`;
                    messagesContainer.appendChild(aiResponseDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;

                     const aiMessageObject = { role: 'model', parts: [{ text: aiResponseDiv.innerHTML }] };
                    conversationHistory.push(aiMessageObject);
                    saveChatHistory();
                    renderMessages();

                }, 1500);
            }
        }


        async function getGeminiResponse() {
            const userPrompt = document.getElementById('user-prompt').value.trim();
            const messagesContainer = document.getElementById('messages-container');

            if (!userPrompt) {
                alert("Vui lòng nhập tin nhắn.");
                return;
            }

            const userMessageObject = { role: 'user', parts: [{ text: userPrompt }] };
            conversationHistory.push(userMessageObject);
            saveChatHistory();
            renderMessages();
            document.getElementById('user-prompt').value = '';


            const aiMessageDiv = document.createElement('div');
            aiMessageDiv.classList.add('message', 'ai-message');
            aiMessageDiv.innerHTML = '<span class="ai-message-text">Đang suy nghĩ...</span>';
            messagesContainer.appendChild(aiMessageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            let promptContents = conversationHistory.map(message => ({
                role: message.role,
                parts: message.parts
            }));
            promptContents.unshift({ role: 'user', parts: [{ text: systemPrompt }] });


            const payload = {
                contents: promptContents
            };


            try {
                const response = await fetch(geminiAPIUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Lỗi API:", errorData);
                    aiMessageDiv.innerHTML = `<span class="ai-message-text">Lỗi API: ${response.status} - ${errorData.error.message || 'Không rõ nguyên nhân'}</span>`;
                    return;
                }

                const data = await response.json();
                console.log("Dữ liệu phản hồi từ API:", data);

                if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0].text) {
                    let aiResponseText = data.candidates[0].content.parts[0].text;
                    aiMessageDiv.innerHTML = '';
                    const aiTextContentSpan = document.createElement('span');
                    aiTextContentSpan.classList.add('ai-message-text');

                    let processedText = aiResponseText;

                    processedText = processedText.replace(/\*\*([^*]+)\*\*/g, '<span class="markdown-bold-uppercase">$1</span>');


                    let textContent = '';
                    let codeContent = null;
                    let language = 'text';
                    const codeBlockRegex = /```([\w]*)\n([\s\S]*?)```/gm;
                    let lastIndex = 0;
                    let match;

                    while ((match = codeBlockRegex.exec(processedText)) !== null) {
                        textContent = processedText.substring(lastIndex, match.index);
                        if (textContent.trim()) {
                            const textPara = document.createElement('p');
                            textPara.innerHTML = textContent.trim();
                            aiTextContentSpan.appendChild(textPara);
                        }

                        language = match[1] || 'text';
                        codeContent = match[2].trim();

                        const codePre = document.createElement('pre');
                        codePre.classList.add('language-' + language);

                        const codeElement = document.createElement('code');
                        codeElement.classList.add('language-' + language);
                        codeElement.textContent = codeContent;
                        codePre.appendChild(codeElement);

                        const copyButton = document.createElement('button');
                        copyButton.classList.add('copy-code-button');
                        copyButton.innerHTML = '<i class="fas fa-copy"></i>';
                        copyButton.onclick = () => {
                            navigator.clipboard.writeText(codeContent).then(() => {
                                alert('Đã sao chép code vào clipboard!');
                            }).catch(err => {
                                console.error('Lỗi khi sao chép: ', err);
                                alert('Lỗi khi sao chép code.');
                            });
                        };
                        codePre.appendChild(copyButton);

                        aiTextContentSpan.appendChild(codePre);

                        lastIndex = codeBlockRegex.lastIndex;
                    }

                    textContent = processedText.substring(lastIndex);
                    if (textContent.trim()) {
                         const textPara = document.createElement('p');
                         textPara.innerHTML = textContent.trim();
                         aiTextContentSpan.appendChild(textPara);
                    }


                    if (!aiTextContentSpan.hasChildNodes() && processedText.trim()) {
                         aiTextContentSpan.innerHTML = processedText.trim();
                    } else if (!aiTextContentSpan.hasChildNodes()) {
                         aiTextContentSpan.textContent = "Không có phản hồi nội dung từ AI.";
                    }

                    aiMessageDiv.appendChild(aiTextContentSpan);

                    const aiMessageObject = { role: 'model', parts: [{ text: aiMessageDiv.innerHTML }] };
                    conversationHistory.push(aiMessageObject);
                    saveChatHistory();
                    Prism.highlightAllUnder(aiMessageDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;


                } else {
                    aiMessageDiv.innerHTML = `<span class="ai-message-text">Không nhận được phản hồi hợp lệ từ AI.</span>`;
                }

            } catch (error) {
                console.error("Lỗi fetch:", error);
                aiMessageDiv.innerHTML = `<span class="ai-message-text">Đã xảy ra lỗi khi kết nối đến API.</span>`;
            }
        }
    </script>


</body>
</html>